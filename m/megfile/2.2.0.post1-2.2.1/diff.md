# Comparing `tmp/megfile-2.2.0.post1-py3-none-any.whl.zip` & `tmp/megfile-2.2.1-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,47 +1,49 @@
-Zip file size: 109689 bytes, number of entries: 45
+Zip file size: 113233 bytes, number of entries: 47
 -rw-rw-r--  2.0 unx     5721 b- defN 23-Aug-01 02:09 megfile/__init__.py
--rw-rw-r--  2.0 unx    12806 b- defN 23-Aug-03 05:11 megfile/cli.py
+-rw-rw-r--  2.0 unx    13045 b- defN 23-Aug-07 10:08 megfile/cli.py
 -rw-rw-r--  2.0 unx    11491 b- defN 23-Aug-03 05:11 megfile/errors.py
--rw-rw-r--  2.0 unx    11621 b- defN 23-Jul-24 07:01 megfile/fs.py
+-rw-rw-r--  2.0 unx    11621 b- defN 23-Aug-07 10:01 megfile/fs.py
 -rw-rw-r--  2.0 unx    38532 b- defN 23-Jul-07 05:32 megfile/fs_path.py
--rw-rw-r--  2.0 unx     2477 b- defN 23-Jul-24 07:01 megfile/http.py
--rw-rw-r--  2.0 unx     5360 b- defN 23-Jul-11 07:49 megfile/http_path.py
+-rw-rw-r--  2.0 unx     2032 b- defN 23-Aug-07 10:17 megfile/http.py
+-rw-rw-r--  2.0 unx     8966 b- defN 23-Aug-07 10:17 megfile/http_path.py
 -rw-rw-r--  2.0 unx     6219 b- defN 23-Jul-07 04:07 megfile/interfaces.py
--rw-rw-r--  2.0 unx    29307 b- defN 23-Jul-07 04:07 megfile/pathlike.py
--rw-rw-r--  2.0 unx    12437 b- defN 23-Jul-24 07:01 megfile/s3.py
--rw-rw-r--  2.0 unx    85287 b- defN 23-Aug-03 06:45 megfile/s3_path.py
--rw-rw-r--  2.0 unx    11943 b- defN 23-Jul-24 07:01 megfile/sftp.py
--rw-rw-r--  2.0 unx    47288 b- defN 23-Aug-03 06:45 megfile/sftp_path.py
--rw-rw-r--  2.0 unx    32694 b- defN 23-Jul-24 03:23 megfile/smart.py
+-rw-rw-r--  2.0 unx    29258 b- defN 23-Aug-07 10:08 megfile/pathlike.py
+-rw-rw-r--  2.0 unx    12437 b- defN 23-Aug-07 10:01 megfile/s3.py
+-rw-rw-r--  2.0 unx    85655 b- defN 23-Aug-07 10:08 megfile/s3_path.py
+-rw-rw-r--  2.0 unx    12590 b- defN 23-Aug-07 10:08 megfile/sftp.py
+-rw-rw-r--  2.0 unx    47982 b- defN 23-Aug-07 10:08 megfile/sftp_path.py
+-rw-rw-r--  2.0 unx    32997 b- defN 23-Aug-07 10:08 megfile/smart.py
 -rw-rw-r--  2.0 unx     6708 b- defN 23-Jul-21 05:33 megfile/smart_path.py
--rw-rw-r--  2.0 unx      559 b- defN 23-Jul-24 07:01 megfile/stdio.py
--rw-rw-r--  2.0 unx     2682 b- defN 23-Jun-16 02:18 megfile/stdio_path.py
--rw-rw-r--  2.0 unx       25 b- defN 23-Aug-03 06:59 megfile/version.py
+-rw-rw-r--  2.0 unx      700 b- defN 23-Aug-07 10:08 megfile/stdio.py
+-rw-rw-r--  2.0 unx     2866 b- defN 23-Aug-07 10:08 megfile/stdio_path.py
+-rw-rw-r--  2.0 unx       19 b- defN 23-Aug-07 10:28 megfile/version.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-May-25 06:42 megfile/lib/__init__.py
--rw-rw-r--  2.0 unx     4546 b- defN 23-Aug-03 06:32 megfile/lib/combine_reader.py
+-rw-rw-r--  2.0 unx    13262 b- defN 23-Aug-07 10:17 megfile/lib/base_prefetch_reader.py
+-rw-rw-r--  2.0 unx     4546 b- defN 23-Aug-07 10:01 megfile/lib/combine_reader.py
 -rw-rw-r--  2.0 unx     2233 b- defN 23-Jun-13 05:49 megfile/lib/compare.py
 -rw-rw-r--  2.0 unx     3033 b- defN 23-Aug-01 01:53 megfile/lib/compat.py
 -rw-rw-r--  2.0 unx     4054 b- defN 23-May-25 06:42 megfile/lib/fnmatch.py
 -rw-rw-r--  2.0 unx     9732 b- defN 23-Jul-07 05:32 megfile/lib/glob.py
+-rw-rw-r--  2.0 unx     3116 b- defN 23-Aug-07 10:17 megfile/lib/http_prefetch_reader.py
 -rw-rw-r--  2.0 unx      929 b- defN 23-May-25 06:42 megfile/lib/joinpath.py
 -rw-rw-r--  2.0 unx     1915 b- defN 23-May-25 06:42 megfile/lib/lazy_handler.py
 -rw-rw-r--  2.0 unx     6934 b- defN 23-May-25 06:42 megfile/lib/s3_buffered_writer.py
 -rw-rw-r--  2.0 unx     1322 b- defN 23-May-25 06:42 megfile/lib/s3_cached_handler.py
 -rw-rw-r--  2.0 unx     6037 b- defN 23-Jul-07 05:32 megfile/lib/s3_limited_seekable_writer.py
 -rw-rw-r--  2.0 unx     3725 b- defN 23-May-25 06:42 megfile/lib/s3_memory_handler.py
 -rw-rw-r--  2.0 unx     3384 b- defN 23-Jul-07 05:32 megfile/lib/s3_pipe_handler.py
--rw-rw-r--  2.0 unx    15113 b- defN 23-Aug-03 06:45 megfile/lib/s3_prefetch_reader.py
--rw-rw-r--  2.0 unx     3771 b- defN 23-Aug-03 06:32 megfile/lib/s3_share_cache_reader.py
+-rw-rw-r--  2.0 unx     4066 b- defN 23-Aug-07 10:17 megfile/lib/s3_prefetch_reader.py
+-rw-rw-r--  2.0 unx     3771 b- defN 23-Aug-07 10:01 megfile/lib/s3_share_cache_reader.py
 -rw-rw-r--  2.0 unx     2683 b- defN 23-May-25 06:42 megfile/lib/shadow_handler.py
 -rw-rw-r--  2.0 unx     2044 b- defN 23-May-25 06:42 megfile/lib/stdio_handler.py
 -rw-rw-r--  2.0 unx      103 b- defN 23-Jun-16 02:18 megfile/lib/url.py
--rw-rw-r--  2.0 unx     9005 b- defN 23-Jul-07 05:32 megfile/utils/__init__.py
+-rw-rw-r--  2.0 unx     9162 b- defN 23-Aug-07 10:08 megfile/utils/__init__.py
 -rw-rw-r--  2.0 unx     2538 b- defN 23-Jul-13 03:47 megfile/utils/mutex.py
--rw-rw-r--  2.0 unx    11357 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/LICENSE
--rw-rw-r--  2.0 unx     1080 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/LICENSE.pyre
--rw-rw-r--  2.0 unx    10601 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/WHEEL
--rw-rw-r--  2.0 unx       49 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/entry_points.txt
--rw-rw-r--  2.0 unx        8 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     3645 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/RECORD
-45 files, 433090 bytes uncompressed, 103975 bytes compressed:  76.0%
+-rw-rw-r--  2.0 unx    11357 b- defN 23-Aug-07 10:29 megfile-2.2.1.dist-info/LICENSE
+-rw-rw-r--  2.0 unx     1080 b- defN 23-Aug-07 10:29 megfile-2.2.1.dist-info/LICENSE.pyre
+-rw-rw-r--  2.0 unx    10595 b- defN 23-Aug-07 10:29 megfile-2.2.1.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Aug-07 10:29 megfile-2.2.1.dist-info/WHEEL
+-rw-rw-r--  2.0 unx       49 b- defN 23-Aug-07 10:29 megfile-2.2.1.dist-info/entry_points.txt
+-rw-rw-r--  2.0 unx        8 b- defN 23-Aug-07 10:29 megfile-2.2.1.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     3787 b- defN 23-Aug-07 10:29 megfile-2.2.1.dist-info/RECORD
+47 files, 444396 bytes uncompressed, 107311 bytes compressed:  75.9%
```

## zipnote {}

```diff
@@ -51,14 +51,17 @@
 
 Filename: megfile/version.py
 Comment: 
 
 Filename: megfile/lib/__init__.py
 Comment: 
 
+Filename: megfile/lib/base_prefetch_reader.py
+Comment: 
+
 Filename: megfile/lib/combine_reader.py
 Comment: 
 
 Filename: megfile/lib/compare.py
 Comment: 
 
 Filename: megfile/lib/compat.py
@@ -66,14 +69,17 @@
 
 Filename: megfile/lib/fnmatch.py
 Comment: 
 
 Filename: megfile/lib/glob.py
 Comment: 
 
+Filename: megfile/lib/http_prefetch_reader.py
+Comment: 
+
 Filename: megfile/lib/joinpath.py
 Comment: 
 
 Filename: megfile/lib/lazy_handler.py
 Comment: 
 
 Filename: megfile/lib/s3_buffered_writer.py
@@ -108,29 +114,29 @@
 
 Filename: megfile/utils/__init__.py
 Comment: 
 
 Filename: megfile/utils/mutex.py
 Comment: 
 
-Filename: megfile-2.2.0.post1.dist-info/LICENSE
+Filename: megfile-2.2.1.dist-info/LICENSE
 Comment: 
 
-Filename: megfile-2.2.0.post1.dist-info/LICENSE.pyre
+Filename: megfile-2.2.1.dist-info/LICENSE.pyre
 Comment: 
 
-Filename: megfile-2.2.0.post1.dist-info/METADATA
+Filename: megfile-2.2.1.dist-info/METADATA
 Comment: 
 
-Filename: megfile-2.2.0.post1.dist-info/WHEEL
+Filename: megfile-2.2.1.dist-info/WHEEL
 Comment: 
 
-Filename: megfile-2.2.0.post1.dist-info/entry_points.txt
+Filename: megfile-2.2.1.dist-info/entry_points.txt
 Comment: 
 
-Filename: megfile-2.2.0.post1.dist-info/top_level.txt
+Filename: megfile-2.2.1.dist-info/top_level.txt
 Comment: 
 
-Filename: megfile-2.2.0.post1.dist-info/RECORD
+Filename: megfile-2.2.1.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## megfile/cli.py

```diff
@@ -144,15 +144,20 @@
                     src_path, dst_path, followlinks=True, map_func=executor.map)
             else:
                 smart_sync(
                     src_path, dst_path, followlinks=True, map_func=executor.map)
     else:
         if progress_bar:
             file_size = smart_stat(src_path).size
-            sbar = tqdm(total=file_size, unit='B', ascii=True, unit_scale=True)
+            sbar = tqdm(
+                total=file_size,
+                unit='B',
+                ascii=True,
+                unit_scale=True,
+                unit_divisor=1024)
 
             def callback(length: int):
                 sbar.update(length)
 
             smart_copy(src_path, dst_path, callback=callback)
             sbar.close()
         else:
@@ -200,15 +205,19 @@
             if src_protocol == dst_protocol:
                 with tqdm(total=1) as t:
                     SmartPath(src_path).rename(dst_path)
                     t.update(1)
             else:
                 file_size = smart_stat(src_path).size
                 sbar = tqdm(
-                    total=file_size, unit='B', ascii=True, unit_scale=True)
+                    total=file_size,
+                    unit='B',
+                    ascii=True,
+                    unit_scale=True,
+                    unit_divisor=1024)
 
                 def callback(length: int):
                     sbar.update(length)
 
                 smart_copy(src_path, dst_path, callback=callback)
                 smart_unlink(src_path)
                 sbar.close()
@@ -249,15 +258,16 @@
             path_stats = []
             for dir_or_file in smart_glob(src_path, recursive=True,
                                           missing_ok=True):
                 path_stats.extend(list(smart_scan_stat(dir_or_file)))
 
             if progress_bar:
                 tbar = tqdm(total=len(path_stats), ascii=True)
-                sbar = tqdm(unit='B', ascii=True, unit_scale=True)
+                sbar = tqdm(
+                    unit='B', ascii=True, unit_scale=True, unit_divisor=1024)
 
                 def callback(_filename: str, length: int):
                     sbar.update(length)
 
                 def callback_after_copy_file(src_file_path, dst_file_path):
                     tbar.update(1)
```

## megfile/http.py

```diff
@@ -1,37 +1,21 @@
-from io import BufferedReader
-
-from megfile.http_path import HttpPath, HttpsPath, get_http_session, is_http
+from megfile.http_path import HttpPath, HttpsPath, get_http_session, http_open, is_http
 from megfile.interfaces import PathLike, StatResult
 
 __all__ = [
     'get_http_session',
     'is_http',
     'http_open',
     'http_stat',
     'http_getsize',
     'http_getmtime',
     'http_exists',
 ]
 
 
-def http_open(path: PathLike, mode: str = 'rb') -> BufferedReader:
-    '''Open a BytesIO to read binary data of given http(s) url
-
-    .. note ::
-
-        Essentially, it reads data of http(s) url to memory by requests, and then return BytesIO to user.
-
-    :param path: Given path
-    :param mode: Only supports 'rb' mode now
-    :return: BytesIO initialized with http(s) data
-    '''
-    return HttpPath(path).open(mode)
-
-
 def http_stat(path: PathLike, follow_symlinks=True) -> StatResult:
     '''
     Get StatResult of http_url response, including size and mtime, referring to http_getsize and http_getmtime
 
     :param path: Given path
     :param follow_symlinks: Ignore this parameter, just for compatibility
     :returns: StatResult
```

## megfile/http_path.py

```diff
@@ -1,35 +1,41 @@
 import time
 from functools import partial
 from io import BufferedReader
 from logging import getLogger as get_logger
-from typing import Iterable
+from typing import Iterable, Optional, Union
 
 import requests
 
 from megfile.errors import http_should_retry, patch_method, translate_http_error
 from megfile.interfaces import PathLike, StatResult, URIPath
+from megfile.lib.base_prefetch_reader import DEFAULT_BLOCK_SIZE
 from megfile.lib.compat import fspath
+from megfile.lib.http_prefetch_reader import HttpPrefetchReader
+from megfile.lib.s3_buffered_writer import DEFAULT_MAX_BUFFER_SIZE
 from megfile.lib.url import get_url_scheme
+from megfile.pathlike import PathLike
 from megfile.smart_path import SmartPath
 from megfile.utils import binary_open
 
 __all__ = [
     'HttpPath',
     'HttpsPath',
     'get_http_session',
     'is_http',
+    'http_open',
 ]
 
 _logger = get_logger(__name__)
 max_retries = 10
 
 
 def get_http_session(
-        timeout: int = 10, status_forcelist: Iterable[int] = (502, 503, 504)):
+        timeout: int = 10,
+        status_forcelist: Iterable[int] = (502, 503, 504)) -> requests.Session:
     session = requests.Session()
 
     def after_callback(response, *args, **kwargs):
         if response.status_code in status_forcelist:
             response.raise_for_status()
         return response
 
@@ -60,55 +66,125 @@
                                          path.startswith('https://')):
         return False
 
     scheme = get_url_scheme(path)
     return scheme == 'http' or scheme == 'https'
 
 
+def http_open(
+        path: PathLike,
+        mode: str = 'rb',
+        *,
+        encoding: Optional[str] = None,
+        errors: Optional[str] = None,
+        max_concurrency: Optional[int] = None,
+        max_buffer_size: int = DEFAULT_MAX_BUFFER_SIZE,
+        forward_ratio: Optional[float] = None,
+        block_size: int = DEFAULT_BLOCK_SIZE,
+        **kwargs) -> Union[BufferedReader, HttpPrefetchReader]:
+    '''Open a BytesIO to read binary data of given http(s) url
+
+    .. note ::
+
+        Essentially, it reads data of http(s) url to memory by requests, and then return BytesIO to user.
+
+    :param path: Given path
+    :param mode: Only supports 'rb' mode now
+    :param encoding: encoding is the name of the encoding used to decode or encode the file. This should only be used in text mode.
+    :param errors: errors is an optional string that specifies how encoding and decoding errors are to be handled—this cannot be used in binary mode.
+    :param max_concurrency: Max download thread number, None by default
+    :param max_buffer_size: Max cached buffer size in memory, 128MB by default
+    :param block_size: Size of single block, 8MB by default. Each block will be uploaded or downloaded by single thread.
+    :return: BytesIO initialized with http(s) data
+    '''
+    return HttpPath(path).open(
+        mode,
+        encoding=encoding,
+        errors=errors,
+        max_concurrency=max_concurrency,
+        max_buffer_size=max_buffer_size,
+        forward_ratio=forward_ratio,
+        block_size=block_size)
+
+
 @SmartPath.register
 class HttpPath(URIPath):
 
     protocol = "http"
 
+    def __init__(self, path: PathLike, *other_paths: PathLike):
+        if str(path).startswith('https://'):
+            self.protocol = 'https'
+        super().__init__(path, *other_paths)
+
     @binary_open
-    def open(self, mode: str = 'rb', **kwargs) -> BufferedReader:
+    def open(
+            self,
+            mode: str = 'rb',
+            *,
+            max_concurrency: Optional[int] = None,
+            max_buffer_size: int = DEFAULT_MAX_BUFFER_SIZE,
+            forward_ratio: Optional[float] = None,
+            block_size: int = DEFAULT_BLOCK_SIZE,
+            **kwargs) -> Union[BufferedReader, HttpPrefetchReader]:
         '''Open a BytesIO to read binary data of given http(s) url
 
         .. note ::
 
             Essentially, it reads data of http(s) url to memory by requests, and then return BytesIO to user.
 
         :param mode: Only supports 'rb' mode now
+        :param encoding: encoding is the name of the encoding used to decode or encode the file. This should only be used in text mode.
+        :param errors: errors is an optional string that specifies how encoding and decoding errors are to be handled—this cannot be used in binary mode.
+        :param max_concurrency: Max download thread number, None by default
+        :param max_buffer_size: Max cached buffer size in memory, 128MB by default
+        :param block_size: Size of single block, 8MB by default. Each block will be uploaded or downloaded by single thread.
         :return: BytesIO initialized with http(s) data
         '''
         if mode not in ('rb',):
             raise ValueError('unacceptable mode: %r' % mode)
 
         try:
-            response = requests.get(
-                self.path_with_protocol, stream=True, timeout=10.0)
+            response = get_http_session(status_forcelist=()).get(
+                self.path_with_protocol, stream=True)
             response.raise_for_status()
         except Exception as error:
             raise translate_http_error(error, self.path_with_protocol)
 
+        if response.headers.get('Accept-Ranges') == 'bytes':
+            block_capacity = max_buffer_size // block_size
+            if forward_ratio is None:
+                block_forward = None
+            else:
+                block_forward = max(int(block_capacity * forward_ratio), 1)
+
+            return HttpPrefetchReader(
+                self.path_with_protocol,
+                content_size=int(response.headers['Content-Length']),
+                max_retries=max_retries,
+                max_workers=max_concurrency,
+                block_capacity=block_capacity,
+                block_forward=block_forward,
+                block_size=block_size,
+            )
         response.raw.auto_close = False
         return BufferedReader(response.raw)
 
     def stat(self, follow_symlinks=True) -> StatResult:
         '''
         Get StatResult of http_url response, including size and mtime, referring to http_getsize and http_getmtime
 
         :param follow_symlinks: Ignore this parameter, just for compatibility
         :returns: StatResult
         :raises: HttpPermissionError, HttpFileNotFoundError
         '''
 
         try:
-            response = requests.get(
-                self.path_with_protocol, stream=True, timeout=10.0)
+            response = get_http_session(status_forcelist=()).get(
+                self.path_with_protocol, stream=True)
             response.raise_for_status()
         except Exception as error:
             raise translate_http_error(error, self.path_with_protocol)
 
         size = response.headers.get('Content-Length')
         if size:
             size = int(size)
@@ -151,16 +227,16 @@
 
         :param followlinks: ignore this parameter, just for compatibility
         :type followlinks: bool, optional
         :return: return True if exists
         :rtype: bool
         """
         try:
-            response = requests.get(
-                self.path_with_protocol, stream=True, timeout=10.0)
+            response = get_http_session(status_forcelist=()).get(
+                self.path_with_protocol, stream=True)
             if response.status_code == 404:
                 return False
             return True
         except requests.exceptions.ConnectionError:
             return False
```

### encoding

```diff
@@ -1 +1 @@
-us-ascii
+utf-8
```

## megfile/pathlike.py

```diff
@@ -313,16 +313,15 @@
         """Create a directory."""
 
     @method_not_implemented
     def rmdir(self) -> None:
         """Remove (delete) the directory."""
 
     @method_not_implemented
-    def open(self, mode: str, s3_open_func: Callable[[str, str], BinaryIO]
-            ) -> IO[AnyStr]:  # type: ignore
+    def open(self, mode: str, **kwargs) -> IO[AnyStr]:  # type: ignore
         """Open the file with mode."""
 
     @method_not_implemented
     def walk(self, followlinks: bool = False
             ) -> Iterator[Tuple[str, List[str], List[str]]]:  # type: ignore
         """Generate the file names in a directory tree by walking the tree."""
```

## megfile/s3_path.py

```diff
@@ -1122,4210 +1122,4233 @@
 00004610: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
 00004620: 7565 0a20 2020 2072 6574 7572 6e20 4661  ue.    return Fa
 00004630: 6c73 650a 0a0a 6465 6620 5f73 335f 6269  lse...def _s3_bi
 00004640: 6e61 7279 5f6d 6f64 6528 7333 5f6f 7065  nary_mode(s3_ope
 00004650: 6e5f 6675 6e63 293a 0a0a 2020 2020 4077  n_func):..    @w
 00004660: 7261 7073 2873 335f 6f70 656e 5f66 756e  raps(s3_open_fun
 00004670: 6329 0a20 2020 2064 6566 2077 7261 7070  c).    def wrapp
-00004680: 6572 2873 335f 7572 6c2c 206d 6f64 653a  er(s3_url, mode:
-00004690: 2073 7472 203d 2027 7262 272c 202a 2a6b   str = 'rb', **k
-000046a0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-000046b0: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-000046c0: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
-000046d0: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
-000046e0: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
-000046f0: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
-00004700: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
-00004710: 7228 2745 6d70 7479 2062 7563 6b65 7420  r('Empty bucket 
-00004720: 6e61 6d65 3a20 2572 2720 2520 7333 5f75  name: %r' % s3_u
-00004730: 726c 290a 0a20 2020 2020 2020 2069 6620  rl)..        if 
-00004740: 6e6f 7420 6b65 7920 6f72 206b 6579 2e65  not key or key.e
-00004750: 6e64 7377 6974 6828 272f 2729 3a0a 2020  ndswith('/'):.  
-00004760: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00004770: 5333 4973 4144 6972 6563 746f 7279 4572  S3IsADirectoryEr
-00004780: 726f 7228 2749 7320 6120 6469 7265 6374  ror('Is a direct
-00004790: 6f72 793a 2025 7227 2025 2073 335f 7572  ory: %r' % s3_ur
-000047a0: 6c29 0a0a 2020 2020 2020 2020 6966 2027  l)..        if '
-000047b0: 7827 2069 6e20 6d6f 6465 3a0a 2020 2020  x' in mode:.    
-000047c0: 2020 2020 2020 2020 6966 2053 3350 6174          if S3Pat
-000047d0: 6828 7333 5f75 726c 292e 6973 5f66 696c  h(s3_url).is_fil
-000047e0: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
-000047f0: 2020 2020 2072 6169 7365 2053 3346 696c       raise S3Fil
-00004800: 6545 7869 7374 7345 7272 6f72 2827 4669  eExistsError('Fi
-00004810: 6c65 2065 7869 7374 733a 2025 7227 2025  le exists: %r' %
-00004820: 2073 335f 7572 6c29 0a20 2020 2020 2020   s3_url).       
-00004830: 2020 2020 206d 6f64 6520 3d20 6d6f 6465       mode = mode
-00004840: 2e72 6570 6c61 6365 2827 7827 2c20 2777  .replace('x', 'w
-00004850: 2729 0a0a 2020 2020 2020 2020 6966 2027  ')..        if '
-00004860: 7727 2069 6e20 6d6f 6465 206f 7220 2761  w' in mode or 'a
-00004870: 2720 696e 206d 6f64 653a 0a20 2020 2020  ' in mode:.     
-00004880: 2020 2020 2020 2069 6620 6e6f 7420 5333         if not S3
-00004890: 5061 7468 2873 335f 7572 6c29 2e68 6173  Path(s3_url).has
-000048a0: 6275 636b 6574 2829 3a0a 2020 2020 2020  bucket():.      
-000048b0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000048c0: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
-000048d0: 4572 726f 7228 274e 6f20 7375 6368 2062  Error('No such b
-000048e0: 7563 6b65 743a 2025 7227 2025 2073 335f  ucket: %r' % s3_
-000048f0: 7572 6c29 0a0a 2020 2020 2020 2020 6669  url)..        fi
-00004900: 6c65 6f62 6a20 3d20 7333 5f6f 7065 6e5f  leobj = s3_open_
-00004910: 6675 6e63 2873 335f 7572 6c2c 2067 6574  func(s3_url, get
-00004920: 5f62 696e 6172 795f 6d6f 6465 286d 6f64  _binary_mode(mod
-00004930: 6529 2c20 2a2a 6b77 6172 6773 290a 2020  e), **kwargs).  
-00004940: 2020 2020 2020 6966 2027 6227 206e 6f74        if 'b' not
-00004950: 2069 6e20 6d6f 6465 3a0a 2020 2020 2020   in mode:.      
-00004960: 2020 2020 2020 6669 6c65 6f62 6a20 3d20        fileobj = 
-00004970: 696f 2e54 6578 7449 4f57 7261 7070 6572  io.TextIOWrapper
-00004980: 2866 696c 656f 626a 2920 2023 2070 7974  (fileobj)  # pyt
-00004990: 7970 653a 2064 6973 6162 6c65 3d77 726f  ype: disable=wro
-000049a0: 6e67 2d61 7267 2d74 7970 6573 0a20 2020  ng-arg-types.   
-000049b0: 2020 2020 2020 2020 2066 696c 656f 626a           fileobj
-000049c0: 2e6d 6f64 6520 3d20 6d6f 6465 0a20 2020  .mode = mode.   
-000049d0: 2020 2020 2072 6574 7572 6e20 6669 6c65       return file
-000049e0: 6f62 6a0a 0a20 2020 2072 6574 7572 6e20  obj..    return 
-000049f0: 7772 6170 7065 720a 0a0a 405f 7333 5f62  wrapper...@_s3_b
-00004a00: 696e 6172 795f 6d6f 6465 0a64 6566 2073  inary_mode.def s
-00004a10: 335f 7072 6566 6574 6368 5f6f 7065 6e28  3_prefetch_open(
-00004a20: 0a20 2020 2020 2020 2073 335f 7572 6c3a  .        s3_url:
-00004a30: 2050 6174 684c 696b 652c 0a20 2020 2020   PathLike,.     
-00004a40: 2020 206d 6f64 653a 2073 7472 203d 2027     mode: str = '
-00004a50: 7262 272c 0a20 2020 2020 2020 2066 6f6c  rb',.        fol
-00004a60: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-00004a70: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
-00004a80: 2a2c 0a20 2020 2020 2020 206d 6178 5f63  *,.        max_c
-00004a90: 6f6e 6375 7272 656e 6379 3a20 4f70 7469  oncurrency: Opti
-00004aa0: 6f6e 616c 5b69 6e74 5d20 3d20 4e6f 6e65  onal[int] = None
-00004ab0: 2c0a 2020 2020 2020 2020 6d61 785f 626c  ,.        max_bl
-00004ac0: 6f63 6b5f 7369 7a65 3a20 696e 7420 3d20  ock_size: int = 
-00004ad0: 4445 4641 554c 545f 424c 4f43 4b5f 5349  DEFAULT_BLOCK_SI
-00004ae0: 5a45 2920 2d3e 2053 3350 7265 6665 7463  ZE) -> S3Prefetc
-00004af0: 6852 6561 6465 723a 0a20 2020 2027 2727  hReader:.    '''
-00004b00: 4f70 656e 2061 2061 7379 6e63 6872 6f6e  Open a asynchron
-00004b10: 6f75 7320 7072 6566 6574 6368 2072 6561  ous prefetch rea
-00004b20: 6465 722c 2074 6f20 7375 7070 6f72 7420  der, to support 
-00004b30: 6661 7374 2073 6571 7565 6e74 6961 6c20  fast sequential 
-00004b40: 7265 6164 2061 6e64 2072 616e 646f 6d20  read and random 
-00004b50: 7265 6164 0a0a 2020 2020 2e2e 206e 6f74  read..    .. not
-00004b60: 6520 3a3a 0a0a 2020 2020 2020 2020 5573  e ::..        Us
-00004b70: 6572 2073 686f 756c 6420 6d61 6b65 2073  er should make s
-00004b80: 7572 6520 7468 6174 2072 6561 6465 7220  ure that reader 
-00004b90: 2f20 7772 6974 6572 2061 7265 2063 6c6f  / writer are clo
-00004ba0: 7365 6420 636f 7272 6563 746c 790a 0a20  sed correctly.. 
-00004bb0: 2020 2020 2020 2053 7570 706f 7274 7320         Supports 
-00004bc0: 636f 6e74 6578 7420 6d61 6e61 6765 720a  context manager.
-00004bd0: 0a20 2020 2020 2020 2053 6f6d 6520 7061  .        Some pa
-00004be0: 7261 6d65 7465 7220 7365 7474 696e 6720  rameter setting 
-00004bf0: 6d61 7920 7065 7266 6f72 6d20 7765 6c6c  may perform well
-00004c00: 3a20 6d61 785f 636f 6e63 7572 7265 6e63  : max_concurrenc
-00004c10: 793d 3130 206f 7220 3230 2c20 6d61 785f  y=10 or 20, max_
-00004c20: 626c 6f63 6b5f 7369 7a65 3d38 206f 7220  block_size=8 or 
-00004c30: 3136 204d 422c 2064 6566 6175 6c74 2076  16 MB, default v
-00004c40: 616c 7565 204e 6f6e 6520 6d65 616e 7320  alue None means 
-00004c50: 7573 696e 6720 676c 6f62 616c 2074 6872  using global thr
-00004c60: 6561 6420 706f 6f6c 0a0a 2020 2020 3a70  ead pool..    :p
-00004c70: 6172 616d 206d 6178 5f63 6f6e 6375 7272  aram max_concurr
-00004c80: 656e 6379 3a20 4d61 7820 646f 776e 6c6f  ency: Max downlo
-00004c90: 6164 2074 6872 6561 6420 6e75 6d62 6572  ad thread number
-00004ca0: 2c20 4e6f 6e65 2062 7920 6465 6661 756c  , None by defaul
-00004cb0: 740a 2020 2020 3a70 6172 616d 206d 6178  t.    :param max
-00004cc0: 5f62 6c6f 636b 5f73 697a 653a 204d 6178  _block_size: Max
-00004cd0: 2064 6174 6120 7369 7a65 2064 6f77 6e6c   data size downl
-00004ce0: 6f61 6465 6420 6279 2065 6163 6820 7468  oaded by each th
-00004cf0: 7265 6164 2c20 696e 2062 7974 6573 2c20  read, in bytes, 
-00004d00: 384d 4220 6279 2064 6566 6175 6c74 0a20  8MB by default. 
-00004d10: 2020 203a 7265 7475 726e 733a 2041 6e20     :returns: An 
-00004d20: 6f70 656e 6564 2053 3350 7265 6665 7463  opened S3Prefetc
-00004d30: 6852 6561 6465 7220 6f62 6a65 6374 0a20  hReader object. 
-00004d40: 2020 203a 7261 6973 6573 3a20 5333 4669     :raises: S3Fi
-00004d50: 6c65 4e6f 7446 6f75 6e64 4572 726f 720a  leNotFoundError.
-00004d60: 2020 2020 2727 270a 2020 2020 6966 206d      '''.    if m
-00004d70: 6f64 6520 213d 2027 7262 273a 0a20 2020  ode != 'rb':.   
-00004d80: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00004d90: 4572 726f 7228 2775 6e61 6363 6570 7461  Error('unaccepta
-00004da0: 626c 6520 6d6f 6465 3a20 2572 2720 2520  ble mode: %r' % 
-00004db0: 6d6f 6465 290a 2020 2020 7333 5f75 726c  mode).    s3_url
-00004dc0: 203d 2053 3350 6174 6828 7333 5f75 726c   = S3Path(s3_url
-00004dd0: 290a 2020 2020 6966 2066 6f6c 6c6f 776c  ).    if followl
-00004de0: 696e 6b73 3a0a 2020 2020 2020 2020 7472  inks:.        tr
-00004df0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
-00004e00: 335f 7572 6c20 3d20 7333 5f75 726c 2e72  3_url = s3_url.r
-00004e10: 6561 646c 696e 6b28 290a 2020 2020 2020  eadlink().      
-00004e20: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
-00004e30: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
-00004e40: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-00004e50: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-00004e60: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
-00004e70: 6c2e 7061 7468 5f77 6974 685f 7072 6f74  l.path_with_prot
-00004e80: 6f63 6f6c 290a 2020 2020 636f 6e66 6967  ocol).    config
-00004e90: 203d 2062 6f74 6f63 6f72 652e 636f 6e66   = botocore.conf
-00004ea0: 6967 2e43 6f6e 6669 6728 6d61 785f 706f  ig.Config(max_po
-00004eb0: 6f6c 5f63 6f6e 6e65 6374 696f 6e73 3d6d  ol_connections=m
-00004ec0: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
-00004ed0: 6f6e 7329 0a20 2020 2063 6c69 656e 7420  ons).    client 
-00004ee0: 3d20 6765 745f 7333 5f63 6c69 656e 7428  = get_s3_client(
-00004ef0: 0a20 2020 2020 2020 2063 6f6e 6669 673d  .        config=
-00004f00: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
-00004f10: 6361 6368 655f 6b65 793d 2773 335f 6669  cache_key='s3_fi
-00004f20: 6c65 6c69 6b65 5f63 6c69 656e 7427 2c0a  lelike_client',.
-00004f30: 2020 2020 2020 2020 7072 6f66 696c 655f          profile_
-00004f40: 6e61 6d65 3d73 335f 7572 6c2e 5f70 726f  name=s3_url._pro
-00004f50: 6669 6c65 5f6e 616d 6529 0a20 2020 2072  file_name).    r
-00004f60: 6574 7572 6e20 5333 5072 6566 6574 6368  eturn S3Prefetch
-00004f70: 5265 6164 6572 280a 2020 2020 2020 2020  Reader(.        
-00004f80: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
-00004f90: 6b65 792c 0a20 2020 2020 2020 2073 335f  key,.        s3_
-00004fa0: 636c 6965 6e74 3d63 6c69 656e 742c 0a20  client=client,. 
-00004fb0: 2020 2020 2020 206d 6178 5f72 6574 7269         max_retri
-00004fc0: 6573 3d6d 6178 5f72 6574 7269 6573 2c0a  es=max_retries,.
-00004fd0: 2020 2020 2020 2020 6d61 785f 776f 726b          max_work
-00004fe0: 6572 733d 6d61 785f 636f 6e63 7572 7265  ers=max_concurre
-00004ff0: 6e63 792c 0a20 2020 2020 2020 2062 6c6f  ncy,.        blo
-00005000: 636b 5f73 697a 653d 6d61 785f 626c 6f63  ck_size=max_bloc
-00005010: 6b5f 7369 7a65 290a 0a0a 405f 7333 5f62  k_size)...@_s3_b
-00005020: 696e 6172 795f 6d6f 6465 0a64 6566 2073  inary_mode.def s
-00005030: 335f 7368 6172 655f 6361 6368 655f 6f70  3_share_cache_op
-00005040: 656e 280a 2020 2020 2020 2020 7333 5f75  en(.        s3_u
-00005050: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
-00005060: 2020 2020 2020 6d6f 6465 3a20 7374 7220        mode: str 
-00005070: 3d20 2772 6227 2c0a 2020 2020 2020 2020  = 'rb',.        
-00005080: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-00005090: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
-000050a0: 2020 202a 2c0a 2020 2020 2020 2020 6361     *,.        ca
-000050b0: 6368 655f 6b65 793a 2073 7472 203d 2027  che_key: str = '
-000050c0: 6c72 7527 2c0a 2020 2020 2020 2020 6d61  lru',.        ma
-000050d0: 785f 636f 6e63 7572 7265 6e63 793a 204f  x_concurrency: O
-000050e0: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
-000050f0: 6f6e 652c 0a20 2020 2020 2020 206d 6178  one,.        max
-00005100: 5f62 6c6f 636b 5f73 697a 653a 2069 6e74  _block_size: int
-00005110: 203d 2044 4546 4155 4c54 5f42 4c4f 434b   = DEFAULT_BLOCK
-00005120: 5f53 495a 4529 202d 3e20 5333 5368 6172  _SIZE) -> S3Shar
-00005130: 6543 6163 6865 5265 6164 6572 3a0a 2020  eCacheReader:.  
-00005140: 2020 2727 274f 7065 6e20 6120 6173 796e    '''Open a asyn
-00005150: 6368 726f 6e6f 7573 2070 7265 6665 7463  chronous prefetc
-00005160: 6820 7265 6164 6572 2c20 746f 2073 7570  h reader, to sup
-00005170: 706f 7274 2066 6173 7420 7365 7175 656e  port fast sequen
-00005180: 7469 616c 2072 6561 6420 616e 6420 7261  tial read and ra
-00005190: 6e64 6f6d 2072 6561 640a 0a20 2020 202e  ndom read..    .
-000051a0: 2e20 6e6f 7465 203a 3a0a 0a20 2020 2020  . note ::..     
-000051b0: 2020 2055 7365 7220 7368 6f75 6c64 206d     User should m
-000051c0: 616b 6520 7375 7265 2074 6861 7420 7265  ake sure that re
-000051d0: 6164 6572 202f 2077 7269 7465 7220 6172  ader / writer ar
-000051e0: 6520 636c 6f73 6564 2063 6f72 7265 6374  e closed correct
-000051f0: 6c79 0a0a 2020 2020 2020 2020 5375 7070  ly..        Supp
-00005200: 6f72 7473 2063 6f6e 7465 7874 206d 616e  orts context man
-00005210: 6167 6572 0a0a 2020 2020 2020 2020 536f  ager..        So
-00005220: 6d65 2070 6172 616d 6574 6572 2073 6574  me parameter set
-00005230: 7469 6e67 206d 6179 2070 6572 666f 726d  ting may perform
-00005240: 2077 656c 6c3a 206d 6178 5f63 6f6e 6375   well: max_concu
-00005250: 7272 656e 6379 3d31 3020 6f72 2032 302c  rrency=10 or 20,
-00005260: 206d 6178 5f62 6c6f 636b 5f73 697a 653d   max_block_size=
-00005270: 3820 6f72 2031 3620 4d42 2c20 6465 6661  8 or 16 MB, defa
-00005280: 756c 7420 7661 6c75 6520 4e6f 6e65 206d  ult value None m
-00005290: 6561 6e73 2075 7369 6e67 2067 6c6f 6261  eans using globa
-000052a0: 6c20 7468 7265 6164 2070 6f6f 6c0a 0a20  l thread pool.. 
-000052b0: 2020 203a 7061 7261 6d20 6d61 785f 636f     :param max_co
-000052c0: 6e63 7572 7265 6e63 793a 204d 6178 2064  ncurrency: Max d
-000052d0: 6f77 6e6c 6f61 6420 7468 7265 6164 206e  ownload thread n
-000052e0: 756d 6265 722c 204e 6f6e 6520 6279 2064  umber, None by d
-000052f0: 6566 6175 6c74 0a20 2020 203a 7061 7261  efault.    :para
-00005300: 6d20 6d61 785f 626c 6f63 6b5f 7369 7a65  m max_block_size
-00005310: 3a20 4d61 7820 6461 7461 2073 697a 6520  : Max data size 
-00005320: 646f 776e 6c6f 6164 6564 2062 7920 6561  downloaded by ea
-00005330: 6368 2074 6872 6561 642c 2069 6e20 6279  ch thread, in by
-00005340: 7465 732c 2038 4d42 2062 7920 6465 6661  tes, 8MB by defa
-00005350: 756c 740a 2020 2020 3a72 6574 7572 6e73  ult.    :returns
-00005360: 3a20 416e 206f 7065 6e65 6420 5333 5368  : An opened S3Sh
-00005370: 6172 6543 6163 6865 5265 6164 6572 206f  areCacheReader o
-00005380: 626a 6563 740a 2020 2020 3a72 6169 7365  bject.    :raise
-00005390: 733a 2053 3346 696c 654e 6f74 466f 756e  s: S3FileNotFoun
-000053a0: 6445 7272 6f72 0a20 2020 2027 2727 0a20  dError.    '''. 
-000053b0: 2020 2069 6620 6d6f 6465 2021 3d20 2772     if mode != 'r
-000053c0: 6227 3a0a 2020 2020 2020 2020 7261 6973  b':.        rais
-000053d0: 6520 5661 6c75 6545 7272 6f72 2827 756e  e ValueError('un
-000053e0: 6163 6365 7074 6162 6c65 206d 6f64 653a  acceptable mode:
-000053f0: 2025 7227 2025 206d 6f64 6529 0a0a 2020   %r' % mode)..  
-00005400: 2020 7333 5f75 726c 203d 2053 3350 6174    s3_url = S3Pat
-00005410: 6828 7333 5f75 726c 290a 2020 2020 6966  h(s3_url).    if
-00005420: 2066 6f6c 6c6f 776c 696e 6b73 3a0a 2020   followlinks:.  
-00005430: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00005440: 2020 2020 2020 2073 335f 7572 6c20 3d20         s3_url = 
-00005450: 7333 5f75 726c 2e72 6561 646c 696e 6b28  s3_url.readlink(
-00005460: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-00005470: 2053 334e 6f74 414c 696e 6b45 7272 6f72   S3NotALinkError
-00005480: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
-00005490: 7373 0a0a 2020 2020 6275 636b 6574 2c20  ss..    bucket, 
-000054a0: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
-000054b0: 726c 2873 335f 7572 6c2e 7061 7468 5f77  rl(s3_url.path_w
-000054c0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-000054d0: 2020 636f 6e66 6967 203d 2062 6f74 6f63    config = botoc
-000054e0: 6f72 652e 636f 6e66 6967 2e43 6f6e 6669  ore.config.Confi
-000054f0: 6728 6d61 785f 706f 6f6c 5f63 6f6e 6e65  g(max_pool_conne
-00005500: 6374 696f 6e73 3d6d 6178 5f70 6f6f 6c5f  ctions=max_pool_
-00005510: 636f 6e6e 6563 7469 6f6e 7329 0a20 2020  connections).   
-00005520: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
-00005530: 5f63 6c69 656e 7428 0a20 2020 2020 2020  _client(.       
-00005540: 2063 6f6e 6669 673d 636f 6e66 6967 2c0a   config=config,.
-00005550: 2020 2020 2020 2020 6361 6368 655f 6b65          cache_ke
-00005560: 793d 2773 335f 6669 6c65 6c69 6b65 5f63  y='s3_filelike_c
-00005570: 6c69 656e 7427 2c0a 2020 2020 2020 2020  lient',.        
-00005580: 7072 6f66 696c 655f 6e61 6d65 3d73 335f  profile_name=s3_
-00005590: 7572 6c2e 5f70 726f 6669 6c65 5f6e 616d  url._profile_nam
-000055a0: 6529 0a20 2020 2072 6574 7572 6e20 5333  e).    return S3
-000055b0: 5368 6172 6543 6163 6865 5265 6164 6572  ShareCacheReader
-000055c0: 280a 2020 2020 2020 2020 6275 636b 6574  (.        bucket
-000055d0: 2c0a 2020 2020 2020 2020 6b65 792c 0a20  ,.        key,. 
-000055e0: 2020 2020 2020 2063 6163 6865 5f6b 6579         cache_key
-000055f0: 3d63 6163 6865 5f6b 6579 2c0a 2020 2020  =cache_key,.    
-00005600: 2020 2020 7333 5f63 6c69 656e 743d 636c      s3_client=cl
-00005610: 6965 6e74 2c0a 2020 2020 2020 2020 6d61  ient,.        ma
-00005620: 785f 7265 7472 6965 733d 6d61 785f 7265  x_retries=max_re
-00005630: 7472 6965 732c 0a20 2020 2020 2020 206d  tries,.        m
-00005640: 6178 5f77 6f72 6b65 7273 3d6d 6178 5f63  ax_workers=max_c
-00005650: 6f6e 6375 7272 656e 6379 2c0a 2020 2020  oncurrency,.    
-00005660: 2020 2020 626c 6f63 6b5f 7369 7a65 3d6d      block_size=m
-00005670: 6178 5f62 6c6f 636b 5f73 697a 6529 0a0a  ax_block_size)..
-00005680: 0a40 5f73 335f 6269 6e61 7279 5f6d 6f64  .@_s3_binary_mod
-00005690: 650a 6465 6620 7333 5f70 6970 655f 6f70  e.def s3_pipe_op
-000056a0: 656e 280a 2020 2020 2020 2020 7333 5f75  en(.        s3_u
-000056b0: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
-000056c0: 2020 2020 2020 6d6f 6465 3a20 7374 722c        mode: str,
-000056d0: 0a20 2020 2020 2020 2066 6f6c 6c6f 776c  .        followl
-000056e0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
-000056f0: 7365 2c0a 2020 2020 2020 2020 2a2c 0a20  se,.        *,. 
-00005700: 2020 2020 2020 206a 6f69 6e5f 7468 7265         join_thre
-00005710: 6164 3a20 626f 6f6c 203d 2054 7275 6529  ad: bool = True)
-00005720: 202d 3e20 5333 5069 7065 4861 6e64 6c65   -> S3PipeHandle
-00005730: 723a 0a20 2020 2027 2727 4f70 656e 2061  r:.    '''Open a
-00005740: 2061 7379 6e63 6872 6f6e 6f75 7320 7265   asynchronous re
-00005750: 6164 2d77 7269 7465 2072 6561 6465 7220  ad-write reader 
-00005760: 2f20 7772 6974 6572 2c20 746f 2073 7570  / writer, to sup
-00005770: 706f 7274 2066 6173 7420 7365 7175 656e  port fast sequen
-00005780: 7469 616c 2072 6561 6420 2f20 7772 6974  tial read / writ
-00005790: 650a 0a20 2020 202e 2e20 6e6f 7465 203a  e..    .. note :
-000057a0: 3a0a 0a20 2020 2020 2020 2055 7365 7220  :..        User 
-000057b0: 7368 6f75 6c64 206d 616b 6520 7375 7265  should make sure
-000057c0: 2074 6861 7420 7265 6164 6572 202f 2077   that reader / w
-000057d0: 7269 7465 7220 6172 6520 636c 6f73 6564  riter are closed
-000057e0: 2063 6f72 7265 6374 6c79 0a0a 2020 2020   correctly..    
-000057f0: 2020 2020 5375 7070 6f72 7473 2063 6f6e      Supports con
-00005800: 7465 7874 206d 616e 6167 6572 0a0a 2020  text manager..  
-00005810: 2020 2020 2020 5768 656e 206a 6f69 6e5f        When join_
-00005820: 7468 7265 6164 2069 7320 4661 6c73 652c  thread is False,
-00005830: 2077 6869 6c65 2074 6865 2066 696c 6520   while the file 
-00005840: 6861 6e64 6c65 2061 7265 2063 6c6f 7369  handle are closi
-00005850: 6e67 2c20 7468 6973 2066 756e 6374 696f  ng, this functio
-00005860: 6e20 7769 6c6c 206e 6f74 2077 6169 7420  n will not wait 
-00005870: 756e 7469 6c20 7468 6520 6173 796e 6368  until the asynch
-00005880: 726f 6e6f 7573 2077 7269 7469 6e67 2066  ronous writing f
-00005890: 696e 6973 6865 733b 0a20 2020 2020 2020  inishes;.       
-000058a0: 2046 616c 7365 2064 6f65 736e 2774 2061   False doesn't a
-000058b0: 6666 6563 7420 7265 6164 2d68 616e 646c  ffect read-handl
-000058c0: 652c 2062 7574 2074 6869 7320 6361 6e20  e, but this can 
-000058d0: 7370 6565 6420 7570 2077 7269 7465 2d68  speed up write-h
-000058e0: 616e 646c 6520 6265 6361 7573 6520 6669  andle because fi
-000058f0: 6c65 2077 696c 6c20 6265 2077 7269 7474  le will be writt
-00005900: 656e 2061 7379 6e63 6872 6f6e 6f75 736c  en asynchronousl
-00005910: 792e 0a20 2020 2020 2020 2042 7574 2061  y..        But a
-00005920: 7379 6e63 6872 6f6e 6f75 7320 6265 6861  synchronous beha
-00005930: 7669 6f75 7220 6361 6e20 6775 6172 616e  viour can guaran
-00005940: 7465 6520 7468 6520 6669 6c65 2061 7265  tee the file are
-00005950: 2073 7563 6365 7373 6675 6c6c 7920 7772   successfully wr
-00005960: 6974 7465 6e2c 2061 6e64 2066 7265 7175  itten, and frequ
-00005970: 656e 7420 6578 6563 7574 696f 6e20 6d61  ent execution ma
-00005980: 7920 6361 7573 6520 7468 7265 6164 2061  y cause thread a
-00005990: 6e64 2066 696c 6520 6861 6e64 6c65 2065  nd file handle e
-000059a0: 7868 6175 7374 696f 6e0a 0a20 2020 203a  xhaustion..    :
-000059b0: 7061 7261 6d20 6d6f 6465 3a20 4d6f 6465  param mode: Mode
-000059c0: 2074 6f20 6f70 656e 2066 696c 652c 2065   to open file, e
-000059d0: 6974 6865 7220 2272 6222 206f 7220 2277  ither "rb" or "w
-000059e0: 6222 0a20 2020 203a 7061 7261 6d20 6a6f  b".    :param jo
-000059f0: 696e 5f74 6872 6561 643a 2049 6620 7761  in_thread: If wa
-00005a00: 6974 2061 6674 6572 2066 756e 6374 696f  it after functio
-00005a10: 6e20 6578 6563 7574 696f 6e20 756e 7469  n execution unti
-00005a20: 6c20 7333 2066 696e 6973 6865 7320 7772  l s3 finishes wr
-00005a30: 6974 696e 670a 2020 2020 3a72 6574 7572  iting.    :retur
-00005a40: 6e73 3a20 416e 206f 7065 6e65 6420 4275  ns: An opened Bu
-00005a50: 6666 6572 6564 5265 6164 6572 202f 2042  fferedReader / B
-00005a60: 7566 6665 7265 6457 7269 7465 7220 6f62  ufferedWriter ob
-00005a70: 6a65 6374 0a20 2020 2027 2727 0a20 2020  ject.    '''.   
-00005a80: 2069 6620 6d6f 6465 206e 6f74 2069 6e20   if mode not in 
-00005a90: 2827 7262 272c 2027 7762 2729 3a0a 2020  ('rb', 'wb'):.  
-00005aa0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00005ab0: 6545 7272 6f72 2827 756e 6163 6365 7074  eError('unaccept
-00005ac0: 6162 6c65 206d 6f64 653a 2025 7227 2025  able mode: %r' %
-00005ad0: 206d 6f64 6529 0a0a 2020 2020 6966 206d   mode)..    if m
-00005ae0: 6f64 655b 305d 203d 3d20 2772 2720 616e  ode[0] == 'r' an
-00005af0: 6420 6e6f 7420 5333 5061 7468 2873 335f  d not S3Path(s3_
-00005b00: 7572 6c29 2e69 735f 6669 6c65 2829 3a0a  url).is_file():.
-00005b10: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-00005b20: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-00005b30: 7228 274e 6f20 7375 6368 2066 696c 653a  r('No such file:
-00005b40: 2025 7227 2025 2073 335f 7572 6c29 0a0a   %r' % s3_url)..
-00005b50: 2020 2020 7333 5f75 726c 203d 2053 3350      s3_url = S3P
-00005b60: 6174 6828 7333 5f75 726c 290a 2020 2020  ath(s3_url).    
-00005b70: 6966 2066 6f6c 6c6f 776c 696e 6b73 3a0a  if followlinks:.
-00005b80: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00005b90: 2020 2020 2020 2020 2073 335f 7572 6c20           s3_url 
-00005ba0: 3d20 7333 5f75 726c 2e72 6561 646c 696e  = s3_url.readlin
-00005bb0: 6b28 290a 2020 2020 2020 2020 6578 6365  k().        exce
-00005bc0: 7074 2053 334e 6f74 414c 696e 6b45 7272  pt S3NotALinkErr
-00005bd0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00005be0: 7061 7373 0a0a 2020 2020 6275 636b 6574  pass..    bucket
-00005bf0: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
-00005c00: 5f75 726c 2873 335f 7572 6c2e 7061 7468  _url(s3_url.path
-00005c10: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-00005c20: 2020 2020 636f 6e66 6967 203d 2062 6f74      config = bot
-00005c30: 6f63 6f72 652e 636f 6e66 6967 2e43 6f6e  ocore.config.Con
-00005c40: 6669 6728 6d61 785f 706f 6f6c 5f63 6f6e  fig(max_pool_con
-00005c50: 6e65 6374 696f 6e73 3d6d 6178 5f70 6f6f  nections=max_poo
-00005c60: 6c5f 636f 6e6e 6563 7469 6f6e 7329 0a20  l_connections). 
-00005c70: 2020 2063 6c69 656e 7420 3d20 6765 745f     client = get_
-00005c80: 7333 5f63 6c69 656e 7428 0a20 2020 2020  s3_client(.     
-00005c90: 2020 2063 6f6e 6669 673d 636f 6e66 6967     config=config
-00005ca0: 2c0a 2020 2020 2020 2020 6361 6368 655f  ,.        cache_
-00005cb0: 6b65 793d 2773 335f 6669 6c65 6c69 6b65  key='s3_filelike
-00005cc0: 5f63 6c69 656e 7427 2c0a 2020 2020 2020  _client',.      
-00005cd0: 2020 7072 6f66 696c 655f 6e61 6d65 3d73    profile_name=s
-00005ce0: 335f 7572 6c2e 5f70 726f 6669 6c65 5f6e  3_url._profile_n
-00005cf0: 616d 6529 0a20 2020 2072 6574 7572 6e20  ame).    return 
-00005d00: 5333 5069 7065 4861 6e64 6c65 7228 0a20  S3PipeHandler(. 
-00005d10: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
-00005d20: 6579 2c20 6d6f 6465 2c20 7333 5f63 6c69  ey, mode, s3_cli
-00005d30: 656e 743d 636c 6965 6e74 2c20 6a6f 696e  ent=client, join
-00005d40: 5f74 6872 6561 643d 6a6f 696e 5f74 6872  _thread=join_thr
-00005d50: 6561 6429 0a0a 0a40 5f73 335f 6269 6e61  ead)...@_s3_bina
-00005d60: 7279 5f6d 6f64 650a 6465 6620 7333 5f63  ry_mode.def s3_c
-00005d70: 6163 6865 645f 6f70 656e 280a 2020 2020  ached_open(.    
-00005d80: 2020 2020 7333 5f75 726c 3a20 5061 7468      s3_url: Path
-00005d90: 4c69 6b65 2c0a 2020 2020 2020 2020 6d6f  Like,.        mo
-00005da0: 6465 3a20 7374 722c 0a20 2020 2020 2020  de: str,.       
-00005db0: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
-00005dc0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-00005dd0: 2020 2020 2a2c 0a20 2020 2020 2020 2063      *,.        c
-00005de0: 6163 6865 5f70 6174 683a 204f 7074 696f  ache_path: Optio
-00005df0: 6e61 6c5b 7374 725d 203d 204e 6f6e 6529  nal[str] = None)
-00005e00: 202d 3e20 5333 4361 6368 6564 4861 6e64   -> S3CachedHand
-00005e10: 6c65 723a 0a20 2020 2027 2727 4f70 656e  ler:.    '''Open
-00005e20: 2061 206c 6f63 616c 2d63 6163 6865 2066   a local-cache f
-00005e30: 696c 6520 7265 6164 6572 202f 2077 7269  ile reader / wri
-00005e40: 7465 722c 2066 6f72 2066 7265 7175 656e  ter, for frequen
-00005e50: 7420 7261 6e64 6f6d 2072 6561 6420 2f20  t random read / 
-00005e60: 7772 6974 650a 0a20 2020 202e 2e20 6e6f  write..    .. no
-00005e70: 7465 203a 3a0a 0a20 2020 2020 2020 2055  te ::..        U
-00005e80: 7365 7220 7368 6f75 6c64 206d 616b 6520  ser should make 
-00005e90: 7375 7265 2074 6861 7420 7265 6164 6572  sure that reader
-00005ea0: 202f 2077 7269 7465 7220 6172 6520 636c   / writer are cl
-00005eb0: 6f73 6564 2063 6f72 7265 6374 6c79 0a0a  osed correctly..
-00005ec0: 2020 2020 2020 2020 5375 7070 6f72 7473          Supports
-00005ed0: 2063 6f6e 7465 7874 206d 616e 6167 6572   context manager
-00005ee0: 0a0a 2020 2020 2020 2020 6361 6368 655f  ..        cache_
-00005ef0: 7061 7468 2063 616e 2073 7065 6369 6679  path can specify
-00005f00: 2074 6865 2070 6174 6820 6f66 2063 6163   the path of cac
-00005f10: 6865 2066 696c 652e 2050 6572 666f 726d  he file. Perform
-00005f20: 616e 6365 2063 6f75 6c64 2062 6520 6265  ance could be be
-00005f30: 7474 6572 2069 6620 6361 6368 6520 6669  tter if cache fi
-00005f40: 6c65 2070 6174 6820 6973 206f 6e20 7373  le path is on ss
-00005f50: 6420 6f72 2074 6d70 6673 0a0a 2020 2020  d or tmpfs..    
-00005f60: 3a70 6172 616d 206d 6f64 653a 204d 6f64  :param mode: Mod
-00005f70: 6520 746f 206f 7065 6e20 6669 6c65 2c20  e to open file, 
-00005f80: 636f 756c 6420 6265 206f 6e65 206f 6620  could be one of 
-00005f90: 2272 6222 2c20 2277 6222 206f 7220 2261  "rb", "wb" or "a
-00005fa0: 6222 0a20 2020 203a 7061 7261 6d20 6361  b".    :param ca
-00005fb0: 6368 655f 7061 7468 3a20 6361 6368 6520  che_path: cache 
-00005fc0: 6669 6c65 2070 6174 680a 2020 2020 3a72  file path.    :r
-00005fd0: 6574 7572 6e73 3a20 416e 206f 7065 6e65  eturns: An opene
-00005fe0: 6420 4275 6666 6572 6564 5265 6164 6572  d BufferedReader
-00005ff0: 202f 2042 7566 6665 7265 6457 7269 7465   / BufferedWrite
-00006000: 7220 6f62 6a65 6374 0a20 2020 2027 2727  r object.    '''
-00006010: 0a20 2020 2069 6620 6d6f 6465 206e 6f74  .    if mode not
-00006020: 2069 6e20 2827 7262 272c 2027 7762 272c   in ('rb', 'wb',
-00006030: 2027 6162 272c 2027 7262 2b27 2c20 2777   'ab', 'rb+', 'w
-00006040: 622b 272c 2027 6162 2b27 293a 0a20 2020  b+', 'ab+'):.   
-00006050: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00006060: 4572 726f 7228 2775 6e61 6363 6570 7461  Error('unaccepta
-00006070: 626c 6520 6d6f 6465 3a20 2572 2720 2520  ble mode: %r' % 
-00006080: 6d6f 6465 290a 2020 2020 7333 5f75 726c  mode).    s3_url
-00006090: 203d 2053 3350 6174 6828 7333 5f75 726c   = S3Path(s3_url
-000060a0: 290a 2020 2020 6966 2066 6f6c 6c6f 776c  ).    if followl
-000060b0: 696e 6b73 3a0a 2020 2020 2020 2020 7472  inks:.        tr
-000060c0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
-000060d0: 335f 7572 6c20 3d20 7333 5f75 726c 2e72  3_url = s3_url.r
-000060e0: 6561 646c 696e 6b28 290a 2020 2020 2020  eadlink().      
-000060f0: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
-00006100: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
-00006110: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-00006120: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-00006130: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
-00006140: 6c2e 7061 7468 5f77 6974 685f 7072 6f74  l.path_with_prot
-00006150: 6f63 6f6c 290a 2020 2020 636f 6e66 6967  ocol).    config
-00006160: 203d 2062 6f74 6f63 6f72 652e 636f 6e66   = botocore.conf
-00006170: 6967 2e43 6f6e 6669 6728 6d61 785f 706f  ig.Config(max_po
-00006180: 6f6c 5f63 6f6e 6e65 6374 696f 6e73 3d6d  ol_connections=m
-00006190: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
-000061a0: 6f6e 7329 0a20 2020 2063 6c69 656e 7420  ons).    client 
-000061b0: 3d20 6765 745f 7333 5f63 6c69 656e 7428  = get_s3_client(
-000061c0: 0a20 2020 2020 2020 2063 6f6e 6669 673d  .        config=
-000061d0: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
-000061e0: 6361 6368 655f 6b65 793d 2773 335f 6669  cache_key='s3_fi
-000061f0: 6c65 6c69 6b65 5f63 6c69 656e 7427 2c0a  lelike_client',.
-00006200: 2020 2020 2020 2020 7072 6f66 696c 655f          profile_
-00006210: 6e61 6d65 3d73 335f 7572 6c2e 5f70 726f  name=s3_url._pro
-00006220: 6669 6c65 5f6e 616d 6529 0a20 2020 2072  file_name).    r
-00006230: 6574 7572 6e20 5333 4361 6368 6564 4861  eturn S3CachedHa
-00006240: 6e64 6c65 7228 0a20 2020 2020 2020 2062  ndler(.        b
-00006250: 7563 6b65 742c 206b 6579 2c20 6d6f 6465  ucket, key, mode
-00006260: 2c20 7333 5f63 6c69 656e 743d 636c 6965  , s3_client=clie
-00006270: 6e74 2c20 6361 6368 655f 7061 7468 3d63  nt, cache_path=c
-00006280: 6163 6865 5f70 6174 6829 0a0a 0a40 5f73  ache_path)...@_s
-00006290: 335f 6269 6e61 7279 5f6d 6f64 650a 6465  3_binary_mode.de
-000062a0: 6620 7333 5f62 7566 6665 7265 645f 6f70  f s3_buffered_op
-000062b0: 656e 280a 2020 2020 2020 2020 7333 5f75  en(.        s3_u
-000062c0: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
-000062d0: 2020 2020 2020 6d6f 6465 3a20 7374 722c        mode: str,
-000062e0: 0a20 2020 2020 2020 2066 6f6c 6c6f 776c  .        followl
-000062f0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
-00006300: 7365 2c0a 2020 2020 2020 2020 2a2c 0a20  se,.        *,. 
-00006310: 2020 2020 2020 206d 6178 5f63 6f6e 6375         max_concu
-00006320: 7272 656e 6379 3a20 4f70 7469 6f6e 616c  rrency: Optional
-00006330: 5b69 6e74 5d20 3d20 4e6f 6e65 2c0a 2020  [int] = None,.  
-00006340: 2020 2020 2020 6d61 785f 6275 6666 6572        max_buffer
-00006350: 5f73 697a 653a 2069 6e74 203d 2044 4546  _size: int = DEF
-00006360: 4155 4c54 5f4d 4158 5f42 5546 4645 525f  AULT_MAX_BUFFER_
-00006370: 5349 5a45 2c0a 2020 2020 2020 2020 666f  SIZE,.        fo
-00006380: 7277 6172 645f 7261 7469 6f3a 204f 7074  rward_ratio: Opt
-00006390: 696f 6e61 6c5b 666c 6f61 745d 203d 204e  ional[float] = N
-000063a0: 6f6e 652c 0a20 2020 2020 2020 2062 6c6f  one,.        blo
-000063b0: 636b 5f73 697a 653a 2069 6e74 203d 2044  ck_size: int = D
-000063c0: 4546 4155 4c54 5f42 4c4f 434b 5f53 495a  EFAULT_BLOCK_SIZ
-000063d0: 452c 0a20 2020 2020 2020 206c 696d 6974  E,.        limit
-000063e0: 6564 5f73 6565 6b61 626c 653a 2062 6f6f  ed_seekable: boo
-000063f0: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
-00006400: 2020 2062 7566 6665 7265 643a 2062 6f6f     buffered: boo
-00006410: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
-00006420: 2020 7368 6172 655f 6361 6368 655f 6b65    share_cache_ke
-00006430: 793a 204f 7074 696f 6e61 6c5b 7374 725d  y: Optional[str]
-00006440: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00006450: 2063 6163 6865 5f70 6174 683a 204f 7074   cache_path: Opt
-00006460: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00006470: 650a 2920 2d3e 2055 6e69 6f6e 5b53 3350  e.) -> Union[S3P
-00006480: 7265 6665 7463 6852 6561 6465 722c 2053  refetchReader, S
-00006490: 3342 7566 6665 7265 6457 7269 7465 722c  3BufferedWriter,
-000064a0: 2069 6f2e 4275 6666 6572 6564 5265 6164   io.BufferedRead
-000064b0: 6572 2c20 696f 2e0a 2020 2020 2020 2020  er, io..        
-000064c0: 2020 2042 7566 6665 7265 6457 7269 7465     BufferedWrite
-000064d0: 722c 2053 334d 656d 6f72 7948 616e 646c  r, S3MemoryHandl
-000064e0: 6572 5d3a 0a20 2020 2027 2727 4f70 656e  er]:.    '''Open
-000064f0: 2061 6e20 6173 796e 6368 726f 6e6f 7573   an asynchronous
-00006500: 2070 7265 6665 7463 6820 7265 6164 6572   prefetch reader
-00006510: 2c20 746f 2073 7570 706f 7274 2066 6173  , to support fas
-00006520: 7420 7365 7175 656e 7469 616c 2072 6561  t sequential rea
-00006530: 640a 0a20 2020 202e 2e20 6e6f 7465 203a  d..    .. note :
-00006540: 3a0a 0a20 2020 2020 2020 2055 7365 7220  :..        User 
-00006550: 7368 6f75 6c64 206d 616b 6520 7375 7265  should make sure
-00006560: 2074 6861 7420 7265 6164 6572 202f 2077   that reader / w
-00006570: 7269 7465 7220 6172 6520 636c 6f73 6564  riter are closed
-00006580: 2063 6f72 7265 6374 6c79 0a0a 2020 2020   correctly..    
-00006590: 2020 2020 5375 7070 6f72 7473 2063 6f6e      Supports con
-000065a0: 7465 7874 206d 616e 6167 6572 0a0a 2020  text manager..  
-000065b0: 2020 2020 2020 536f 6d65 2070 6172 616d        Some param
-000065c0: 6574 6572 2073 6574 7469 6e67 206d 6179  eter setting may
-000065d0: 2070 6572 666f 726d 2077 656c 6c3a 206d   perform well: m
-000065e0: 6178 5f63 6f6e 6375 7272 656e 6379 3d31  ax_concurrency=1
-000065f0: 3020 6f72 2032 302c 206d 6178 5f62 6c6f  0 or 20, max_blo
-00006600: 636b 5f73 697a 653d 3820 6f72 2031 3620  ck_size=8 or 16 
-00006610: 4d42 2c20 6465 6661 756c 7420 7661 6c75  MB, default valu
-00006620: 6520 4e6f 6e65 206d 6561 6e73 2075 7369  e None means usi
-00006630: 6e67 2067 6c6f 6261 6c20 7468 7265 6164  ng global thread
-00006640: 2070 6f6f 6c0a 0a20 2020 203a 7061 7261   pool..    :para
-00006650: 6d20 6d61 785f 636f 6e63 7572 7265 6e63  m max_concurrenc
-00006660: 793a 204d 6178 2064 6f77 6e6c 6f61 6420  y: Max download 
-00006670: 7468 7265 6164 206e 756d 6265 722c 204e  thread number, N
-00006680: 6f6e 6520 6279 2064 6566 6175 6c74 0a20  one by default. 
-00006690: 2020 203a 7061 7261 6d20 6d61 785f 6275     :param max_bu
-000066a0: 6666 6572 5f73 697a 653a 204d 6178 2063  ffer_size: Max c
-000066b0: 6163 6865 6420 6275 6666 6572 2073 697a  ached buffer siz
-000066c0: 6520 696e 206d 656d 6f72 792c 2031 3238  e in memory, 128
-000066d0: 4d42 2062 7920 6465 6661 756c 740a 2020  MB by default.  
-000066e0: 2020 3a70 6172 616d 2062 6c6f 636b 5f73    :param block_s
-000066f0: 697a 653a 2053 697a 6520 6f66 2073 696e  ize: Size of sin
-00006700: 676c 6520 626c 6f63 6b2c 2038 4d42 2062  gle block, 8MB b
-00006710: 7920 6465 6661 756c 742e 2045 6163 6820  y default. Each 
-00006720: 626c 6f63 6b20 7769 6c6c 2062 6520 7570  block will be up
-00006730: 6c6f 6164 6564 206f 7220 646f 776e 6c6f  loaded or downlo
-00006740: 6164 6564 2062 7920 7369 6e67 6c65 2074  aded by single t
-00006750: 6872 6561 642e 0a20 2020 203a 7061 7261  hread..    :para
-00006760: 6d20 6c69 6d69 7465 645f 7365 656b 6162  m limited_seekab
-00006770: 6c65 3a20 4966 2077 7269 7465 2d68 616e  le: If write-han
-00006780: 646c 6520 7375 7070 6f72 7473 206c 696d  dle supports lim
-00006790: 6974 6564 2073 6565 6b20 2862 6f74 6820  ited seek (both 
-000067a0: 6669 6c65 2068 6561 6420 7061 7274 2061  file head part a
-000067b0: 6e64 2074 6169 6c20 7061 7274 2063 616e  nd tail part can
-000067c0: 2073 6565 6b20 626c 6f63 6b5f 7369 7a65   seek block_size
-000067d0: 292e 204e 6f74 6573 3a20 5468 6973 2070  ). Notes: This p
-000067e0: 6172 616d 6574 6572 2061 7265 2076 616c  arameter are val
-000067f0: 6964 206f 6e6c 7920 666f 7220 7772 6974  id only for writ
-00006800: 652d 6861 6e64 6c65 2e20 5265 6164 2d68  e-handle. Read-h
-00006810: 616e 646c 6520 7375 7070 6f72 7420 6172  andle support ar
-00006820: 6269 7472 6172 7920 7365 656b 0a20 2020  bitrary seek.   
-00006830: 203a 7265 7475 726e 733a 2041 6e20 6f70   :returns: An op
-00006840: 656e 6564 2053 3350 7265 6665 7463 6852  ened S3PrefetchR
-00006850: 6561 6465 7220 6f62 6a65 6374 0a20 2020  eader object.   
-00006860: 203a 7261 6973 6573 3a20 5333 4669 6c65   :raises: S3File
-00006870: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
-00006880: 2020 2727 270a 2020 2020 6966 206d 6f64    '''.    if mod
-00006890: 6520 6e6f 7420 696e 2028 2772 6227 2c20  e not in ('rb', 
-000068a0: 2777 6227 2c20 2761 6227 2c20 2772 622b  'wb', 'ab', 'rb+
-000068b0: 272c 2027 7762 2b27 2c20 2761 622b 2729  ', 'wb+', 'ab+')
-000068c0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-000068d0: 5661 6c75 6545 7272 6f72 2827 756e 6163  ValueError('unac
-000068e0: 6365 7074 6162 6c65 206d 6f64 653a 2025  ceptable mode: %
-000068f0: 7227 2025 206d 6f64 6529 0a20 2020 2073  r' % mode).    s
-00006900: 335f 7572 6c20 3d20 5333 5061 7468 2873  3_url = S3Path(s
-00006910: 335f 7572 6c29 0a20 2020 2069 6620 666f  3_url).    if fo
-00006920: 6c6c 6f77 6c69 6e6b 733a 0a20 2020 2020  llowlinks:.     
-00006930: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00006940: 2020 2020 7333 5f75 726c 203d 2073 335f      s3_url = s3_
-00006950: 7572 6c2e 7265 6164 6c69 6e6b 2829 0a20  url.readlink(). 
-00006960: 2020 2020 2020 2065 7863 6570 7420 5333         except S3
-00006970: 4e6f 7441 4c69 6e6b 4572 726f 723a 0a20  NotALinkError:. 
-00006980: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00006990: 0a20 2020 2062 7563 6b65 742c 206b 6579  .    bucket, key
-000069a0: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
-000069b0: 7333 5f75 726c 2e70 6174 685f 7769 7468  s3_url.path_with
-000069c0: 5f70 726f 746f 636f 6c29 0a20 2020 2063  _protocol).    c
-000069d0: 6f6e 6669 6720 3d20 626f 746f 636f 7265  onfig = botocore
-000069e0: 2e63 6f6e 6669 672e 436f 6e66 6967 286d  .config.Config(m
-000069f0: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
-00006a00: 6f6e 733d 6d61 785f 706f 6f6c 5f63 6f6e  ons=max_pool_con
-00006a10: 6e65 6374 696f 6e73 290a 2020 2020 636c  nections).    cl
-00006a20: 6965 6e74 203d 2067 6574 5f73 335f 636c  ient = get_s3_cl
-00006a30: 6965 6e74 280a 2020 2020 2020 2020 636f  ient(.        co
-00006a40: 6e66 6967 3d63 6f6e 6669 672c 0a20 2020  nfig=config,.   
-00006a50: 2020 2020 2063 6163 6865 5f6b 6579 3d27       cache_key='
-00006a60: 7333 5f66 696c 656c 696b 655f 636c 6965  s3_filelike_clie
-00006a70: 6e74 272c 0a20 2020 2020 2020 2070 726f  nt',.        pro
-00006a80: 6669 6c65 5f6e 616d 653d 7333 5f75 726c  file_name=s3_url
-00006a90: 2e5f 7072 6f66 696c 655f 6e61 6d65 290a  ._profile_name).
-00006aa0: 0a20 2020 2069 6620 2761 2720 696e 206d  .    if 'a' in m
-00006ab0: 6f64 6520 6f72 2027 2b27 2069 6e20 6d6f  ode or '+' in mo
-00006ac0: 6465 3a0a 2020 2020 2020 2020 6966 2063  de:.        if c
-00006ad0: 6163 6865 5f70 6174 6820 6973 204e 6f6e  ache_path is Non
-00006ae0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00006af0: 6574 7572 6e20 5333 4d65 6d6f 7279 4861  eturn S3MemoryHa
-00006b00: 6e64 6c65 7228 6275 636b 6574 2c20 6b65  ndler(bucket, ke
-00006b10: 792c 206d 6f64 652c 2073 335f 636c 6965  y, mode, s3_clie
-00006b20: 6e74 3d63 6c69 656e 7429 0a20 2020 2020  nt=client).     
-00006b30: 2020 2072 6574 7572 6e20 5333 4361 6368     return S3Cach
-00006b40: 6564 4861 6e64 6c65 7228 0a20 2020 2020  edHandler(.     
-00006b50: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
-00006b60: 6579 2c20 6d6f 6465 2c20 7333 5f63 6c69  ey, mode, s3_cli
-00006b70: 656e 743d 636c 6965 6e74 2c20 6361 6368  ent=client, cach
-00006b80: 655f 7061 7468 3d63 6163 6865 5f70 6174  e_path=cache_pat
-00006b90: 6829 0a0a 2020 2020 6966 206d 6f64 6520  h)..    if mode 
-00006ba0: 3d3d 2027 7262 273a 0a20 2020 2020 2020  == 'rb':.       
-00006bb0: 2023 2041 2072 6f75 6768 2063 6f6e 7665   # A rough conve
-00006bc0: 7273 696f 6e20 616c 676f 7269 7468 6d20  rsion algorithm 
-00006bd0: 746f 2061 6c69 676e 2032 2074 7970 6573  to align 2 types
-00006be0: 206f 6620 5265 6164 6572 202f 2057 7269   of Reader / Wri
-00006bf0: 7465 7220 7061 7261 6d65 7465 7273 0a20  ter parameters. 
-00006c00: 2020 2020 2020 2023 2054 4f44 4f3a 204f         # TODO: O
-00006c10: 7074 696d 697a 6520 7468 6520 636f 6e76  ptimize the conv
-00006c20: 6572 7369 6f6e 2061 6c67 6f72 6974 686d  ersion algorithm
-00006c30: 0a20 2020 2020 2020 2062 6c6f 636b 5f63  .        block_c
-00006c40: 6170 6163 6974 7920 3d20 6d61 785f 6275  apacity = max_bu
-00006c50: 6666 6572 5f73 697a 6520 2f2f 2062 6c6f  ffer_size // blo
-00006c60: 636b 5f73 697a 650a 2020 2020 2020 2020  ck_size.        
-00006c70: 6966 2066 6f72 7761 7264 5f72 6174 696f  if forward_ratio
-00006c80: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00006c90: 2020 2020 2020 626c 6f63 6b5f 666f 7277        block_forw
-00006ca0: 6172 6420 3d20 4e6f 6e65 0a20 2020 2020  ard = None.     
-00006cb0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00006cc0: 2020 2020 2062 6c6f 636b 5f66 6f72 7761       block_forwa
-00006cd0: 7264 203d 206d 6178 2869 6e74 2862 6c6f  rd = max(int(blo
-00006ce0: 636b 5f63 6170 6163 6974 7920 2a20 666f  ck_capacity * fo
-00006cf0: 7277 6172 645f 7261 7469 6f29 2c20 3129  rward_ratio), 1)
-00006d00: 0a20 2020 2020 2020 2069 6620 7368 6172  .        if shar
-00006d10: 655f 6361 6368 655f 6b65 7920 6973 206e  e_cache_key is n
-00006d20: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00006d30: 2020 2020 2072 6561 6465 7220 3d20 5333       reader = S3
-00006d40: 5368 6172 6543 6163 6865 5265 6164 6572  ShareCacheReader
-00006d50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00006d60: 2020 6275 636b 6574 2c0a 2020 2020 2020    bucket,.      
-00006d70: 2020 2020 2020 2020 2020 6b65 792c 0a20            key,. 
-00006d80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00006d90: 6163 6865 5f6b 6579 3d73 6861 7265 5f63  ache_key=share_c
-00006da0: 6163 6865 5f6b 6579 2c0a 2020 2020 2020  ache_key,.      
-00006db0: 2020 2020 2020 2020 2020 7333 5f63 6c69            s3_cli
-00006dc0: 656e 743d 636c 6965 6e74 2c0a 2020 2020  ent=client,.    
-00006dd0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
-00006de0: 7265 7472 6965 733d 6d61 785f 7265 7472  retries=max_retr
-00006df0: 6965 732c 0a20 2020 2020 2020 2020 2020  ies,.           
-00006e00: 2020 2020 206d 6178 5f77 6f72 6b65 7273       max_workers
-00006e10: 3d6d 6178 5f63 6f6e 6375 7272 656e 6379  =max_concurrency
-00006e20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006e30: 2020 626c 6f63 6b5f 7369 7a65 3d62 6c6f    block_size=blo
-00006e40: 636b 5f73 697a 652c 0a20 2020 2020 2020  ck_size,.       
-00006e50: 2020 2020 2020 2020 2062 6c6f 636b 5f66           block_f
-00006e60: 6f72 7761 7264 3d62 6c6f 636b 5f66 6f72  orward=block_for
-00006e70: 7761 7264 290a 2020 2020 2020 2020 656c  ward).        el
-00006e80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00006e90: 7265 6164 6572 203d 2053 3350 7265 6665  reader = S3Prefe
-00006ea0: 7463 6852 6561 6465 7228 0a20 2020 2020  tchReader(.     
-00006eb0: 2020 2020 2020 2020 2020 2062 7563 6b65             bucke
-00006ec0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00006ed0: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
-00006ee0: 2020 2020 2020 2020 7333 5f63 6c69 656e          s3_clien
-00006ef0: 743d 636c 6965 6e74 2c0a 2020 2020 2020  t=client,.      
-00006f00: 2020 2020 2020 2020 2020 6d61 785f 7265            max_re
-00006f10: 7472 6965 733d 6d61 785f 7265 7472 6965  tries=max_retrie
-00006f20: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00006f30: 2020 206d 6178 5f77 6f72 6b65 7273 3d6d     max_workers=m
-00006f40: 6178 5f63 6f6e 6375 7272 656e 6379 2c0a  ax_concurrency,.
-00006f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f60: 626c 6f63 6b5f 6361 7061 6369 7479 3d62  block_capacity=b
-00006f70: 6c6f 636b 5f63 6170 6163 6974 792c 0a20  lock_capacity,. 
-00006f80: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00006f90: 6c6f 636b 5f66 6f72 7761 7264 3d62 6c6f  lock_forward=blo
-00006fa0: 636b 5f66 6f72 7761 7264 2c0a 2020 2020  ck_forward,.    
-00006fb0: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
-00006fc0: 6b5f 7369 7a65 3d62 6c6f 636b 5f73 697a  k_size=block_siz
-00006fd0: 6529 0a20 2020 2020 2020 2069 6620 6275  e).        if bu
-00006fe0: 6666 6572 6564 3a0a 2020 2020 2020 2020  ffered:.        
-00006ff0: 2020 2020 7265 6164 6572 203d 2069 6f2e      reader = io.
-00007000: 4275 6666 6572 6564 5265 6164 6572 2872  BufferedReader(r
-00007010: 6561 6465 7229 2020 2320 7079 7479 7065  eader)  # pytype
-00007020: 3a20 6469 7361 626c 653d 7772 6f6e 672d  : disable=wrong-
-00007030: 6172 672d 7479 7065 730a 2020 2020 2020  arg-types.      
-00007040: 2020 7265 7475 726e 2072 6561 6465 720a    return reader.
-00007050: 0a20 2020 2069 6620 6c69 6d69 7465 645f  .    if limited_
-00007060: 7365 656b 6162 6c65 3a0a 2020 2020 2020  seekable:.      
-00007070: 2020 7772 6974 6572 203d 2053 334c 696d    writer = S3Lim
-00007080: 6974 6564 5365 656b 6162 6c65 5772 6974  itedSeekableWrit
-00007090: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-000070a0: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
-000070b0: 2020 2020 6b65 792c 0a20 2020 2020 2020      key,.       
-000070c0: 2020 2020 2073 335f 636c 6965 6e74 3d63       s3_client=c
-000070d0: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
-000070e0: 2020 206d 6178 5f77 6f72 6b65 7273 3d6d     max_workers=m
-000070f0: 6178 5f63 6f6e 6375 7272 656e 6379 2c0a  ax_concurrency,.
-00007100: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
-00007110: 6275 6666 6572 5f73 697a 653d 6d61 785f  buffer_size=max_
-00007120: 6275 6666 6572 5f73 697a 652c 0a20 2020  buffer_size,.   
-00007130: 2020 2020 2020 2020 2062 6c6f 636b 5f73           block_s
-00007140: 697a 653d 626c 6f63 6b5f 7369 7a65 290a  ize=block_size).
-00007150: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00007160: 2020 7772 6974 6572 203d 2053 3342 7566    writer = S3Buf
-00007170: 6665 7265 6457 7269 7465 7228 0a20 2020  feredWriter(.   
-00007180: 2020 2020 2020 2020 2062 7563 6b65 742c           bucket,
-00007190: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
-000071a0: 2c0a 2020 2020 2020 2020 2020 2020 7333  ,.            s3
-000071b0: 5f63 6c69 656e 743d 636c 6965 6e74 2c0a  _client=client,.
-000071c0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
-000071d0: 776f 726b 6572 733d 6d61 785f 636f 6e63  workers=max_conc
-000071e0: 7572 7265 6e63 792c 0a20 2020 2020 2020  urrency,.       
-000071f0: 2020 2020 206d 6178 5f62 7566 6665 725f       max_buffer_
-00007200: 7369 7a65 3d6d 6178 5f62 7566 6665 725f  size=max_buffer_
-00007210: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
-00007220: 2020 626c 6f63 6b5f 7369 7a65 3d62 6c6f    block_size=blo
-00007230: 636b 5f73 697a 6529 0a20 2020 2069 6620  ck_size).    if 
-00007240: 6275 6666 6572 6564 3a0a 2020 2020 2020  buffered:.      
-00007250: 2020 7772 6974 6572 203d 2069 6f2e 4275    writer = io.Bu
-00007260: 6666 6572 6564 5772 6974 6572 2877 7269  fferedWriter(wri
-00007270: 7465 7229 2020 2320 7079 7479 7065 3a20  ter)  # pytype: 
-00007280: 6469 7361 626c 653d 7772 6f6e 672d 6172  disable=wrong-ar
-00007290: 672d 7479 7065 730a 2020 2020 7265 7475  g-types.    retu
-000072a0: 726e 2077 7269 7465 720a 0a0a 405f 7333  rn writer...@_s3
-000072b0: 5f62 696e 6172 795f 6d6f 6465 0a64 6566  _binary_mode.def
-000072c0: 2073 335f 6d65 6d6f 7279 5f6f 7065 6e28   s3_memory_open(
-000072d0: 0a20 2020 2020 2020 2073 335f 7572 6c3a  .        s3_url:
-000072e0: 2050 6174 684c 696b 652c 206d 6f64 653a   PathLike, mode:
-000072f0: 2073 7472 2c0a 2020 2020 2020 2020 666f   str,.        fo
-00007300: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
-00007310: 3d20 4661 6c73 6529 202d 3e20 5333 4d65  = False) -> S3Me
-00007320: 6d6f 7279 4861 6e64 6c65 723a 0a20 2020  moryHandler:.   
-00007330: 2027 2727 4f70 656e 2061 206d 656d 6f72   '''Open a memor
-00007340: 792d 6361 6368 6520 6669 6c65 2072 6561  y-cache file rea
-00007350: 6465 7220 2f20 7772 6974 6572 2c20 666f  der / writer, fo
-00007360: 7220 6672 6571 7565 6e74 2072 616e 646f  r frequent rando
-00007370: 6d20 7265 6164 202f 2077 7269 7465 0a0a  m read / write..
-00007380: 2020 2020 2e2e 206e 6f74 6520 3a3a 0a0a      .. note ::..
-00007390: 2020 2020 2020 2020 5573 6572 2073 686f          User sho
-000073a0: 756c 6420 6d61 6b65 2073 7572 6520 7468  uld make sure th
-000073b0: 6174 2072 6561 6465 7220 2f20 7772 6974  at reader / writ
-000073c0: 6572 2061 7265 2063 6c6f 7365 6420 636f  er are closed co
-000073d0: 7272 6563 746c 790a 0a20 2020 2020 2020  rrectly..       
-000073e0: 2053 7570 706f 7274 7320 636f 6e74 6578   Supports contex
-000073f0: 7420 6d61 6e61 6765 720a 0a20 2020 203a  t manager..    :
-00007400: 7061 7261 6d20 6d6f 6465 3a20 4d6f 6465  param mode: Mode
-00007410: 2074 6f20 6f70 656e 2066 696c 652c 2063   to open file, c
-00007420: 6f75 6c64 2062 6520 6f6e 6520 6f66 2022  ould be one of "
-00007430: 7262 222c 2022 7762 222c 2022 6162 222c  rb", "wb", "ab",
-00007440: 2022 7262 2b22 2c20 2277 622b 2220 6f72   "rb+", "wb+" or
-00007450: 2022 6162 2b22 0a20 2020 203a 7265 7475   "ab+".    :retu
-00007460: 726e 733a 2041 6e20 6f70 656e 6564 2042  rns: An opened B
-00007470: 7566 6665 7265 6452 6561 6465 7220 2f20  ufferedReader / 
-00007480: 4275 6666 6572 6564 5772 6974 6572 206f  BufferedWriter o
-00007490: 626a 6563 740a 2020 2020 2727 270a 2020  bject.    '''.  
-000074a0: 2020 6966 206d 6f64 6520 6e6f 7420 696e    if mode not in
-000074b0: 2028 2772 6227 2c20 2777 6227 2c20 2761   ('rb', 'wb', 'a
-000074c0: 6227 2c20 2772 622b 272c 2027 7762 2b27  b', 'rb+', 'wb+'
-000074d0: 2c20 2761 622b 2729 3a0a 2020 2020 2020  , 'ab+'):.      
-000074e0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-000074f0: 6f72 2827 756e 6163 6365 7074 6162 6c65  or('unacceptable
-00007500: 206d 6f64 653a 2025 7227 2025 206d 6f64   mode: %r' % mod
-00007510: 6529 0a20 2020 2073 335f 7572 6c20 3d20  e).    s3_url = 
-00007520: 5333 5061 7468 2873 335f 7572 6c29 0a20  S3Path(s3_url). 
-00007530: 2020 2069 6620 666f 6c6c 6f77 6c69 6e6b     if followlink
-00007540: 733a 0a20 2020 2020 2020 2074 7279 3a0a  s:.        try:.
-00007550: 2020 2020 2020 2020 2020 2020 7333 5f75              s3_u
-00007560: 726c 203d 2073 335f 7572 6c2e 7265 6164  rl = s3_url.read
-00007570: 6c69 6e6b 2829 0a20 2020 2020 2020 2065  link().        e
-00007580: 7863 6570 7420 5333 4e6f 7441 4c69 6e6b  xcept S3NotALink
-00007590: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-000075a0: 2020 2070 6173 730a 0a20 2020 2062 7563     pass..    buc
-000075b0: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
-000075c0: 5f73 335f 7572 6c28 7333 5f75 726c 2e70  _s3_url(s3_url.p
-000075d0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-000075e0: 6c29 0a20 2020 2063 6f6e 6669 6720 3d20  l).    config = 
-000075f0: 626f 746f 636f 7265 2e63 6f6e 6669 672e  botocore.config.
-00007600: 436f 6e66 6967 286d 6178 5f70 6f6f 6c5f  Config(max_pool_
-00007610: 636f 6e6e 6563 7469 6f6e 733d 6d61 785f  connections=max_
-00007620: 706f 6f6c 5f63 6f6e 6e65 6374 696f 6e73  pool_connections
-00007630: 290a 2020 2020 636c 6965 6e74 203d 2067  ).    client = g
-00007640: 6574 5f73 335f 636c 6965 6e74 280a 2020  et_s3_client(.  
-00007650: 2020 2020 2020 636f 6e66 6967 3d63 6f6e        config=con
-00007660: 6669 672c 0a20 2020 2020 2020 2063 6163  fig,.        cac
-00007670: 6865 5f6b 6579 3d27 7333 5f66 696c 656c  he_key='s3_filel
-00007680: 696b 655f 636c 6965 6e74 272c 0a20 2020  ike_client',.   
-00007690: 2020 2020 2070 726f 6669 6c65 5f6e 616d       profile_nam
-000076a0: 653d 7333 5f75 726c 2e5f 7072 6f66 696c  e=s3_url._profil
-000076b0: 655f 6e61 6d65 290a 2020 2020 7265 7475  e_name).    retu
-000076c0: 726e 2053 334d 656d 6f72 7948 616e 646c  rn S3MemoryHandl
-000076d0: 6572 2862 7563 6b65 742c 206b 6579 2c20  er(bucket, key, 
-000076e0: 6d6f 6465 2c20 7333 5f63 6c69 656e 743d  mode, s3_client=
-000076f0: 636c 6965 6e74 290a 0a0a 7333 5f6f 7065  client)...s3_ope
-00007700: 6e20 3d20 7333 5f62 7566 6665 7265 645f  n = s3_buffered_
-00007710: 6f70 656e 0a0a 0a64 6566 2073 335f 646f  open...def s3_do
-00007720: 776e 6c6f 6164 280a 2020 2020 2020 2020  wnload(.        
-00007730: 7372 635f 7572 6c3a 2050 6174 684c 696b  src_url: PathLik
-00007740: 652c 0a20 2020 2020 2020 2064 7374 5f75  e,.        dst_u
-00007750: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
-00007760: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
-00007770: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-00007780: 0a20 2020 2020 2020 2063 616c 6c62 6163  .        callbac
-00007790: 6b3a 204f 7074 696f 6e61 6c5b 4361 6c6c  k: Optional[Call
-000077a0: 6162 6c65 5b5b 696e 745d 2c20 4e6f 6e65  able[[int], None
-000077b0: 5d5d 203d 204e 6f6e 6529 202d 3e20 4e6f  ]] = None) -> No
-000077c0: 6e65 3a0a 2020 2020 2727 270a 2020 2020  ne:.    '''.    
-000077d0: 446f 776e 6c6f 6164 7320 6120 6669 6c65  Downloads a file
-000077e0: 2066 726f 6d20 7333 2074 6f20 6c6f 6361   from s3 to loca
-000077f0: 6c20 6669 6c65 7379 7374 656d 2e0a 2020  l filesystem..  
-00007800: 2020 3a70 6172 616d 2073 7263 5f75 726c    :param src_url
-00007810: 3a20 736f 7572 6365 2073 3320 7061 7468  : source s3 path
-00007820: 0a20 2020 203a 7061 7261 6d20 6473 745f  .    :param dst_
-00007830: 7572 6c3a 2074 6172 6765 7420 6673 2070  url: target fs p
-00007840: 6174 680a 2020 2020 3a70 6172 616d 2063  ath.    :param c
-00007850: 616c 6c62 6163 6b3a 2043 616c 6c65 6420  allback: Called 
-00007860: 7065 7269 6f64 6963 616c 6c79 2064 7572  periodically dur
-00007870: 696e 6720 636f 7079 2c20 616e 6420 7468  ing copy, and th
-00007880: 6520 696e 7075 7420 7061 7261 6d65 7465  e input paramete
-00007890: 7220 6973 2074 6865 2064 6174 6120 7369  r is the data si
-000078a0: 7a65 2028 696e 2062 7974 6573 2920 6f66  ze (in bytes) of
-000078b0: 2063 6f70 7920 7369 6e63 6520 7468 6520   copy since the 
-000078c0: 6c61 7374 2063 616c 6c0a 2020 2020 2727  last call.    ''
-000078d0: 270a 2020 2020 6672 6f6d 206d 6567 6669  '.    from megfi
-000078e0: 6c65 2e66 7320 696d 706f 7274 2069 735f  le.fs import is_
-000078f0: 6673 0a20 2020 2066 726f 6d20 6d65 6766  fs.    from megf
-00007900: 696c 652e 6673 5f70 6174 6820 696d 706f  ile.fs_path impo
-00007910: 7274 2046 5350 6174 680a 0a20 2020 2073  rt FSPath..    s
-00007920: 7263 5f75 726c 203d 2053 3350 6174 6828  rc_url = S3Path(
-00007930: 7372 635f 7572 6c29 0a20 2020 2069 6620  src_url).    if 
-00007940: 666f 6c6c 6f77 6c69 6e6b 733a 0a20 2020  followlinks:.   
-00007950: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00007960: 2020 2020 2020 7372 635f 7572 6c20 3d20        src_url = 
-00007970: 7372 635f 7572 6c2e 7265 6164 6c69 6e6b  src_url.readlink
-00007980: 2829 0a20 2020 2020 2020 2065 7863 6570  ().        excep
-00007990: 7420 5333 4e6f 7441 4c69 6e6b 4572 726f  t S3NotALinkErro
-000079a0: 723a 0a20 2020 2020 2020 2020 2020 2070  r:.            p
-000079b0: 6173 730a 2020 2020 7372 635f 6275 636b  ass.    src_buck
-000079c0: 6574 2c20 7372 635f 6b65 7920 3d20 7061  et, src_key = pa
-000079d0: 7273 655f 7333 5f75 726c 2873 7263 5f75  rse_s3_url(src_u
-000079e0: 726c 2e70 6174 685f 7769 7468 5f70 726f  rl.path_with_pro
-000079f0: 746f 636f 6c29 0a20 2020 2069 6620 6e6f  tocol).    if no
-00007a00: 7420 7372 635f 6275 636b 6574 3a0a 2020  t src_bucket:.  
-00007a10: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
-00007a20: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
-00007a30: 7228 0a20 2020 2020 2020 2020 2020 2027  r(.            '
-00007a40: 456d 7074 7920 6275 636b 6574 206e 616d  Empty bucket nam
-00007a50: 653a 2025 7227 2025 2073 7263 5f75 726c  e: %r' % src_url
-00007a60: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-00007a70: 636f 6c29 0a0a 2020 2020 6966 206e 6f74  col)..    if not
-00007a80: 2073 7263 5f75 726c 2e65 7869 7374 7328   src_url.exists(
-00007a90: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
-00007aa0: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
-00007ab0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00007ac0: 2020 2746 696c 6520 6e6f 7420 666f 756e    'File not foun
-00007ad0: 643a 2025 7227 2025 2073 7263 5f75 726c  d: %r' % src_url
-00007ae0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-00007af0: 636f 6c29 0a0a 2020 2020 6966 206e 6f74  col)..    if not
-00007b00: 2073 7263 5f75 726c 2e69 735f 6669 6c65   src_url.is_file
-00007b10: 2829 3a0a 2020 2020 2020 2020 7261 6973  ():.        rais
-00007b20: 6520 5333 4973 4144 6972 6563 746f 7279  e S3IsADirectory
-00007b30: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-00007b40: 2020 2027 4973 2061 2064 6972 6563 746f     'Is a directo
-00007b50: 7279 3a20 2572 2720 2520 7372 635f 7572  ry: %r' % src_ur
-00007b60: 6c2e 7061 7468 5f77 6974 685f 7072 6f74  l.path_with_prot
-00007b70: 6f63 6f6c 290a 0a20 2020 2064 7374 5f75  ocol)..    dst_u
-00007b80: 726c 203d 2066 7370 6174 6828 6473 745f  rl = fspath(dst_
-00007b90: 7572 6c29 0a20 2020 2069 6620 6e6f 7420  url).    if not 
-00007ba0: 6973 5f66 7328 6473 745f 7572 6c29 3a0a  is_fs(dst_url):.
-00007bb0: 2020 2020 2020 2020 7261 6973 6520 4f53          raise OS
-00007bc0: 4572 726f 7228 6627 6473 745f 7572 6c20  Error(f'dst_url 
-00007bd0: 6973 206e 6f74 2066 7320 7061 7468 3a20  is not fs path: 
-00007be0: 7b64 7374 5f75 726c 7d27 290a 2020 2020  {dst_url}').    
-00007bf0: 6966 206e 6f74 2064 7374 5f75 726c 206f  if not dst_url o
-00007c00: 7220 6473 745f 7572 6c2e 656e 6473 7769  r dst_url.endswi
-00007c10: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
-00007c20: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
-00007c30: 6374 6f72 7945 7272 6f72 2827 4973 2061  ctoryError('Is a
-00007c40: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
-00007c50: 2520 6473 745f 7572 6c29 0a0a 2020 2020  % dst_url)..    
-00007c60: 6473 745f 7061 7468 203d 2046 5350 6174  dst_path = FSPat
-00007c70: 6828 6473 745f 7572 6c29 0a20 2020 2064  h(dst_url).    d
-00007c80: 7374 5f64 6972 6563 746f 7279 203d 206f  st_directory = o
-00007c90: 732e 7061 7468 2e64 6972 6e61 6d65 2864  s.path.dirname(d
-00007ca0: 7374 5f70 6174 682e 7061 7468 5f77 6974  st_path.path_wit
-00007cb0: 686f 7574 5f70 726f 746f 636f 6c29 0a20  hout_protocol). 
-00007cc0: 2020 2069 6620 6473 745f 6469 7265 6374     if dst_direct
-00007cd0: 6f72 7920 213d 2027 273a 0a20 2020 2020  ory != '':.     
-00007ce0: 2020 206f 732e 6d61 6b65 6469 7273 2864     os.makedirs(d
-00007cf0: 7374 5f64 6972 6563 746f 7279 2c20 6578  st_directory, ex
-00007d00: 6973 745f 6f6b 3d54 7275 6529 0a0a 2020  ist_ok=True)..  
-00007d10: 2020 636c 6965 6e74 203d 2067 6574 5f73    client = get_s
-00007d20: 335f 636c 6965 6e74 2870 726f 6669 6c65  3_client(profile
-00007d30: 5f6e 616d 653d 7372 635f 7572 6c2e 5f70  _name=src_url._p
-00007d40: 726f 6669 6c65 5f6e 616d 6529 0a20 2020  rofile_name).   
-00007d50: 2074 7279 3a0a 2020 2020 2020 2020 636c   try:.        cl
-00007d60: 6965 6e74 2e64 6f77 6e6c 6f61 645f 6669  ient.download_fi
-00007d70: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-00007d80: 7372 635f 6275 636b 6574 2c0a 2020 2020  src_bucket,.    
-00007d90: 2020 2020 2020 2020 7372 635f 6b65 792c          src_key,
-00007da0: 0a20 2020 2020 2020 2020 2020 2064 7374  .            dst
-00007db0: 5f70 6174 682e 7061 7468 5f77 6974 686f  _path.path_witho
-00007dc0: 7574 5f70 726f 746f 636f 6c2c 0a20 2020  ut_protocol,.   
-00007dd0: 2020 2020 2020 2020 2043 616c 6c62 6163           Callbac
-00007de0: 6b3d 6361 6c6c 6261 636b 290a 2020 2020  k=callback).    
-00007df0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00007e00: 2061 7320 6572 726f 723a 0a20 2020 2020   as error:.     
-00007e10: 2020 2065 7272 6f72 203d 2074 7261 6e73     error = trans
-00007e20: 6c61 7465 5f66 735f 6572 726f 7228 6572  late_fs_error(er
-00007e30: 726f 722c 2064 7374 5f75 726c 290a 2020  ror, dst_url).  
-00007e40: 2020 2020 2020 6572 726f 7220 3d20 7472        error = tr
-00007e50: 616e 736c 6174 655f 7333 5f65 7272 6f72  anslate_s3_error
-00007e60: 2865 7272 6f72 2c20 7372 635f 7572 6c2e  (error, src_url.
-00007e70: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-00007e80: 6f6c 290a 2020 2020 2020 2020 7261 6973  ol).        rais
-00007e90: 6520 6572 726f 720a 0a20 2020 2073 7263  e error..    src
-00007ea0: 5f73 7461 7420 3d20 7372 635f 7572 6c2e  _stat = src_url.
-00007eb0: 7374 6174 2829 0a20 2020 206f 732e 7574  stat().    os.ut
-00007ec0: 696d 6528 0a20 2020 2020 2020 2064 7374  ime(.        dst
-00007ed0: 5f70 6174 682e 7061 7468 5f77 6974 686f  _path.path_witho
-00007ee0: 7574 5f70 726f 746f 636f 6c2c 2028 7372  ut_protocol, (sr
-00007ef0: 635f 7374 6174 2e73 745f 6d74 696d 652c  c_stat.st_mtime,
-00007f00: 2073 7263 5f73 7461 742e 7374 5f6d 7469   src_stat.st_mti
-00007f10: 6d65 2929 0a0a 0a64 6566 2073 335f 7570  me))...def s3_up
-00007f20: 6c6f 6164 280a 2020 2020 2020 2020 7372  load(.        sr
-00007f30: 635f 7572 6c3a 2050 6174 684c 696b 652c  c_url: PathLike,
-00007f40: 0a20 2020 2020 2020 2064 7374 5f75 726c  .        dst_url
-00007f50: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
-00007f60: 2020 2020 6361 6c6c 6261 636b 3a20 4f70      callback: Op
-00007f70: 7469 6f6e 616c 5b43 616c 6c61 626c 655b  tional[Callable[
-00007f80: 5b69 6e74 5d2c 204e 6f6e 655d 5d20 3d20  [int], None]] = 
-00007f90: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2a  None,.        **
-00007fa0: 6b77 6172 6773 2920 2d3e 204e 6f6e 653a  kwargs) -> None:
-00007fb0: 0a20 2020 2027 2727 0a20 2020 2055 706c  .    '''.    Upl
-00007fc0: 6f61 6473 2061 2066 696c 6520 6672 6f6d  oads a file from
-00007fd0: 206c 6f63 616c 2066 696c 6573 7973 7465   local filesyste
-00007fe0: 6d20 746f 2073 332e 0a20 2020 203a 7061  m to s3..    :pa
-00007ff0: 7261 6d20 7372 635f 7572 6c3a 2073 6f75  ram src_url: sou
-00008000: 7263 6520 6673 2070 6174 680a 2020 2020  rce fs path.    
-00008010: 3a70 6172 616d 2064 7374 5f75 726c 3a20  :param dst_url: 
-00008020: 7461 7267 6574 2073 3320 7061 7468 0a20  target s3 path. 
-00008030: 2020 203a 7061 7261 6d20 6361 6c6c 6261     :param callba
-00008040: 636b 3a20 4361 6c6c 6564 2070 6572 696f  ck: Called perio
-00008050: 6469 6361 6c6c 7920 6475 7269 6e67 2063  dically during c
-00008060: 6f70 792c 2061 6e64 2074 6865 2069 6e70  opy, and the inp
-00008070: 7574 2070 6172 616d 6574 6572 2069 7320  ut parameter is 
-00008080: 7468 6520 6461 7461 2073 697a 6520 2869  the data size (i
-00008090: 6e20 6279 7465 7329 206f 6620 636f 7079  n bytes) of copy
-000080a0: 2073 696e 6365 2074 6865 206c 6173 7420   since the last 
-000080b0: 6361 6c6c 0a20 2020 2027 2727 0a20 2020  call.    '''.   
-000080c0: 2066 726f 6d20 6d65 6766 696c 652e 6673   from megfile.fs
-000080d0: 2069 6d70 6f72 7420 6973 5f66 730a 2020   import is_fs.  
-000080e0: 2020 6672 6f6d 206d 6567 6669 6c65 2e66    from megfile.f
-000080f0: 735f 7061 7468 2069 6d70 6f72 7420 4653  s_path import FS
-00008100: 5061 7468 0a0a 2020 2020 6966 206e 6f74  Path..    if not
-00008110: 2069 735f 6673 2873 7263 5f75 726c 293a   is_fs(src_url):
-00008120: 0a20 2020 2020 2020 2072 6169 7365 204f  .        raise O
-00008130: 5345 7272 6f72 2866 2773 7263 5f75 726c  SError(f'src_url
-00008140: 2069 7320 6e6f 7420 6673 2070 6174 683a   is not fs path:
-00008150: 207b 7372 635f 7572 6c7d 2729 0a20 2020   {src_url}').   
-00008160: 2073 7263 5f70 6174 6820 3d20 4653 5061   src_path = FSPa
-00008170: 7468 2873 7263 5f75 726c 290a 0a20 2020  th(src_url)..   
-00008180: 2064 7374 5f62 7563 6b65 742c 2064 7374   dst_bucket, dst
-00008190: 5f6b 6579 203d 2070 6172 7365 5f73 335f  _key = parse_s3_
-000081a0: 7572 6c28 6473 745f 7572 6c29 0a20 2020  url(dst_url).   
-000081b0: 2069 6620 6e6f 7420 6473 745f 6275 636b   if not dst_buck
-000081c0: 6574 3a0a 2020 2020 2020 2020 7261 6973  et:.        rais
-000081d0: 6520 5333 4275 636b 6574 4e6f 7446 6f75  e S3BucketNotFou
-000081e0: 6e64 4572 726f 7228 2745 6d70 7479 2062  ndError('Empty b
-000081f0: 7563 6b65 7420 6e61 6d65 3a20 2572 2720  ucket name: %r' 
-00008200: 2520 6473 745f 7572 6c29 0a20 2020 2069  % dst_url).    i
-00008210: 6620 6e6f 7420 6473 745f 6b65 7920 6f72  f not dst_key or
-00008220: 2064 7374 5f6b 6579 2e65 6e64 7377 6974   dst_key.endswit
-00008230: 6828 272f 2729 3a0a 2020 2020 2020 2020  h('/'):.        
-00008240: 7261 6973 6520 5333 4973 4144 6972 6563  raise S3IsADirec
-00008250: 746f 7279 4572 726f 7228 2749 7320 6120  toryError('Is a 
-00008260: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
-00008270: 2064 7374 5f75 726c 290a 0a20 2020 2063   dst_url)..    c
-00008280: 6c69 656e 7420 3d20 6765 745f 7333 5f63  lient = get_s3_c
-00008290: 6c69 656e 7428 7072 6f66 696c 655f 6e61  lient(profile_na
-000082a0: 6d65 3d53 3350 6174 6828 6473 745f 7572  me=S3Path(dst_ur
-000082b0: 6c29 2e5f 7072 6f66 696c 655f 6e61 6d65  l)._profile_name
-000082c0: 290a 2020 2020 7769 7468 206f 7065 6e28  ).    with open(
-000082d0: 7372 635f 7061 7468 2e70 6174 685f 7769  src_path.path_wi
-000082e0: 7468 6f75 745f 7072 6f74 6f63 6f6c 2c20  thout_protocol, 
-000082f0: 2772 6227 2920 6173 2073 7263 3a0a 2020  'rb') as src:.  
-00008300: 2020 2020 2020 7769 7468 2072 6169 7365        with raise
-00008310: 5f73 335f 6572 726f 7228 6473 745f 7572  _s3_error(dst_ur
-00008320: 6c29 3a0a 2020 2020 2020 2020 2020 2020  l):.            
-00008330: 636c 6965 6e74 2e75 706c 6f61 645f 6669  client.upload_fi
-00008340: 6c65 6f62 6a28 0a20 2020 2020 2020 2020  leobj(.         
-00008350: 2020 2020 2020 2073 7263 2c20 4275 636b         src, Buck
-00008360: 6574 3d64 7374 5f62 7563 6b65 742c 204b  et=dst_bucket, K
-00008370: 6579 3d64 7374 5f6b 6579 2c20 4361 6c6c  ey=dst_key, Call
-00008380: 6261 636b 3d63 616c 6c62 6163 6b29 0a0a  back=callback)..
-00008390: 0a64 6566 2073 335f 6c6f 6164 5f63 6f6e  .def s3_load_con
-000083a0: 7465 6e74 280a 2020 2020 2020 2020 7333  tent(.        s3
-000083b0: 5f75 726c 2c0a 2020 2020 2020 2020 7374  _url,.        st
-000083c0: 6172 743a 204f 7074 696f 6e61 6c5b 696e  art: Optional[in
-000083d0: 745d 203d 204e 6f6e 652c 0a20 2020 2020  t] = None,.     
-000083e0: 2020 2073 746f 703a 204f 7074 696f 6e61     stop: Optiona
-000083f0: 6c5b 696e 745d 203d 204e 6f6e 652c 0a20  l[int] = None,. 
-00008400: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
-00008410: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
-00008420: 2920 2d3e 2062 7974 6573 3a0a 2020 2020  ) -> bytes:.    
-00008430: 2727 270a 2020 2020 4765 7420 7370 6563  '''.    Get spec
-00008440: 6966 6965 6420 6669 6c65 2066 726f 6d20  ified file from 
-00008450: 5b73 7461 7274 2c20 7374 6f70 2920 696e  [start, stop) in
-00008460: 2062 7974 6573 0a0a 2020 2020 3a70 6172   bytes..    :par
-00008470: 616d 2073 335f 7572 6c3a 2053 7065 6369  am s3_url: Speci
-00008480: 6669 6564 2070 6174 680a 2020 2020 3a70  fied path.    :p
-00008490: 6172 616d 2073 7461 7274 3a20 7374 6172  aram start: star
-000084a0: 7420 696e 6465 780a 2020 2020 3a70 6172  t index.    :par
-000084b0: 616d 2073 746f 703a 2073 746f 7020 696e  am stop: stop in
-000084c0: 6465 780a 2020 2020 3a72 6574 7572 6e73  dex.    :returns
-000084d0: 3a20 6279 7465 7320 636f 6e74 656e 7420  : bytes content 
-000084e0: 696e 2072 616e 6765 205b 7374 6172 742c  in range [start,
-000084f0: 2073 746f 7029 0a20 2020 2027 2727 0a0a   stop).    '''..
-00008500: 2020 2020 6465 6620 5f67 6574 5f6f 626a      def _get_obj
-00008510: 6563 7428 636c 6965 6e74 2c20 6275 636b  ect(client, buck
-00008520: 6574 2c20 6b65 792c 2072 616e 6765 5f73  et, key, range_s
-00008530: 7472 293a 0a20 2020 2020 2020 2072 6574  tr):.        ret
-00008540: 7572 6e20 636c 6965 6e74 2e67 6574 5f6f  urn client.get_o
-00008550: 626a 6563 7428 0a20 2020 2020 2020 2020  bject(.         
-00008560: 2020 2042 7563 6b65 743d 6275 636b 6574     Bucket=bucket
-00008570: 2c20 4b65 793d 6b65 792c 2052 616e 6765  , Key=key, Range
-00008580: 3d72 616e 6765 5f73 7472 295b 2742 6f64  =range_str)['Bod
-00008590: 7927 5d2e 7265 6164 2829 0a0a 2020 2020  y'].read()..    
-000085a0: 7333 5f75 726c 203d 2053 3350 6174 6828  s3_url = S3Path(
-000085b0: 7333 5f75 726c 290a 2020 2020 6966 2066  s3_url).    if f
-000085c0: 6f6c 6c6f 776c 696e 6b73 3a0a 2020 2020  ollowlinks:.    
-000085d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000085e0: 2020 2020 2073 335f 7572 6c20 3d20 7333       s3_url = s3
-000085f0: 5f75 726c 2e72 6561 646c 696e 6b28 290a  _url.readlink().
-00008600: 2020 2020 2020 2020 6578 6365 7074 2053          except S
-00008610: 334e 6f74 414c 696e 6b45 7272 6f72 3a0a  3NotALinkError:.
-00008620: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-00008630: 0a0a 2020 2020 6275 636b 6574 2c20 6b65  ..    bucket, ke
-00008640: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
-00008650: 2873 335f 7572 6c2e 7061 7468 5f77 6974  (s3_url.path_wit
-00008660: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
-00008670: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
-00008680: 2020 2020 2020 2072 6169 7365 2053 3342         raise S3B
-00008690: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
-000086a0: 6f72 2827 456d 7074 7920 6275 636b 6574  or('Empty bucket
-000086b0: 206e 616d 653a 2025 7227 2025 2073 335f   name: %r' % s3_
-000086c0: 7572 6c29 0a20 2020 2069 6620 6e6f 7420  url).    if not 
-000086d0: 6b65 7920 6f72 206b 6579 2e65 6e64 7377  key or key.endsw
-000086e0: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
-000086f0: 2020 7261 6973 6520 5333 4973 4144 6972    raise S3IsADir
-00008700: 6563 746f 7279 4572 726f 7228 2749 7320  ectoryError('Is 
-00008710: 6120 6469 7265 6374 6f72 793a 2025 7227  a directory: %r'
-00008720: 2025 2073 335f 7572 6c29 0a0a 2020 2020   % s3_url)..    
-00008730: 7374 6172 742c 2073 746f 7020 3d20 6765  start, stop = ge
-00008740: 745f 636f 6e74 656e 745f 6f66 6673 6574  t_content_offset
-00008750: 280a 2020 2020 2020 2020 7374 6172 742c  (.        start,
-00008760: 2073 746f 702c 2073 335f 7572 6c2e 6765   stop, s3_url.ge
-00008770: 7473 697a 6528 666f 6c6c 6f77 5f73 796d  tsize(follow_sym
-00008780: 6c69 6e6b 733d 4661 6c73 6529 290a 2020  links=False)).  
-00008790: 2020 6966 2073 7461 7274 203d 3d20 3020    if start == 0 
-000087a0: 616e 6420 7374 6f70 203d 3d20 303a 0a20  and stop == 0:. 
-000087b0: 2020 2020 2020 2072 6574 7572 6e20 6227         return b'
-000087c0: 270a 2020 2020 7261 6e67 655f 7374 7220  '.    range_str 
-000087d0: 3d20 2762 7974 6573 3d25 642d 2564 2720  = 'bytes=%d-%d' 
-000087e0: 2520 2873 7461 7274 2c20 7374 6f70 202d  % (start, stop -
-000087f0: 2031 290a 0a20 2020 2063 6c69 656e 7420   1)..    client 
-00008800: 3d20 6765 745f 7333 5f63 6c69 656e 7428  = get_s3_client(
-00008810: 7072 6f66 696c 655f 6e61 6d65 3d73 335f  profile_name=s3_
-00008820: 7572 6c2e 5f70 726f 6669 6c65 5f6e 616d  url._profile_nam
-00008830: 6529 0a20 2020 2077 6974 6820 7261 6973  e).    with rais
-00008840: 655f 7333 5f65 7272 6f72 2873 335f 7572  e_s3_error(s3_ur
-00008850: 6c2e 7061 7468 293a 0a20 2020 2020 2020  l.path):.       
-00008860: 2072 6574 7572 6e20 7061 7463 685f 6d65   return patch_me
-00008870: 7468 6f64 280a 2020 2020 2020 2020 2020  thod(.          
-00008880: 2020 5f67 6574 5f6f 626a 6563 742c 0a20    _get_object,. 
-00008890: 2020 2020 2020 2020 2020 206d 6178 5f72             max_r
-000088a0: 6574 7269 6573 3d6d 6178 5f72 6574 7269  etries=max_retri
-000088b0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-000088c0: 7368 6f75 6c64 5f72 6574 7279 3d73 335f  should_retry=s3_
-000088d0: 7368 6f75 6c64 5f72 6574 7279 2c0a 2020  should_retry,.  
-000088e0: 2020 2020 2020 2928 636c 6965 6e74 2c20        )(client, 
-000088f0: 6275 636b 6574 2c20 6b65 792c 2072 616e  bucket, key, ran
-00008900: 6765 5f73 7472 290a 0a0a 6465 6620 7333  ge_str)...def s3
-00008910: 5f72 6561 646c 696e 6b28 7061 7468 2920  _readlink(path) 
-00008920: 2d3e 2073 7472 3a0a 2020 2020 2727 270a  -> str:.    '''.
-00008930: 2020 2020 5265 7475 726e 2061 2073 7472      Return a str
-00008940: 696e 6720 7265 7072 6573 656e 7469 6e67  ing representing
-00008950: 2074 6865 2070 6174 6820 746f 2077 6869   the path to whi
-00008960: 6368 2074 6865 2073 796d 626f 6c69 6320  ch the symbolic 
-00008970: 6c69 6e6b 2070 6f69 6e74 732e 0a0a 2020  link points...  
-00008980: 2020 3a72 6574 7572 6e73 3a20 5265 7475    :returns: Retu
-00008990: 726e 2061 2073 7472 696e 6720 7265 7072  rn a string repr
-000089a0: 6573 656e 7469 6e67 2074 6865 2070 6174  esenting the pat
-000089b0: 6820 746f 2077 6869 6368 2074 6865 2073  h to which the s
-000089c0: 796d 626f 6c69 6320 6c69 6e6b 2070 6f69  ymbolic link poi
-000089d0: 6e74 732e 0a20 2020 203a 7261 6973 6573  nts..    :raises
-000089e0: 3a20 5333 4e61 6d65 546f 6f4c 6f6e 6745  : S3NameTooLongE
-000089f0: 7272 6f72 2c20 5333 4275 636b 6574 4e6f  rror, S3BucketNo
-00008a00: 7446 6f75 6e64 4572 726f 722c 2053 3349  tFoundError, S3I
-00008a10: 7341 4469 7265 6374 6f72 7945 7272 6f72  sADirectoryError
-00008a20: 2c20 5333 4e6f 7441 4c69 6e6b 4572 726f  , S3NotALinkErro
-00008a30: 720a 2020 2020 2727 270a 2020 2020 7265  r.    '''.    re
-00008a40: 7475 726e 2053 3350 6174 6828 7061 7468  turn S3Path(path
-00008a50: 292e 7265 6164 6c69 6e6b 2829 2e70 6174  ).readlink().pat
-00008a60: 685f 7769 7468 5f70 726f 746f 636f 6c0a  h_with_protocol.
-00008a70: 0a0a 6465 6620 7333 5f72 656e 616d 6528  ..def s3_rename(
-00008a80: 7372 635f 7572 6c3a 2050 6174 684c 696b  src_url: PathLik
-00008a90: 652c 2064 7374 5f75 726c 3a20 5061 7468  e, dst_url: Path
-00008aa0: 4c69 6b65 293a 0a20 2020 2027 2727 0a20  Like):.    '''. 
-00008ab0: 2020 204d 6f76 6520 7333 2066 696c 6520     Move s3 file 
-00008ac0: 7061 7468 2066 726f 6d20 7372 635f 7572  path from src_ur
-00008ad0: 6c20 746f 2064 7374 5f75 726c 0a0a 2020  l to dst_url..  
-00008ae0: 2020 3a70 6172 616d 2064 7374 5f75 726c    :param dst_url
-00008af0: 3a20 4769 7665 6e20 6465 7374 696e 6174  : Given destinat
-00008b00: 696f 6e20 7061 7468 0a20 2020 2027 2727  ion path.    '''
-00008b10: 0a20 2020 2073 7263 5f70 6174 685f 696e  .    src_path_in
-00008b20: 7320 3d20 5333 5061 7468 2873 7263 5f75  s = S3Path(src_u
-00008b30: 726c 290a 2020 2020 6966 2073 7263 5f70  rl).    if src_p
-00008b40: 6174 685f 696e 732e 6973 5f66 696c 6528  ath_ins.is_file(
-00008b50: 293a 0a20 2020 2020 2020 2073 7263 5f70  ):.        src_p
-00008b60: 6174 685f 696e 732e 636f 7079 2864 7374  ath_ins.copy(dst
-00008b70: 5f75 726c 290a 2020 2020 656c 7365 3a0a  _url).    else:.
-00008b80: 2020 2020 2020 2020 7372 635f 7061 7468          src_path
-00008b90: 5f69 6e73 2e73 796e 6328 6473 745f 7572  _ins.sync(dst_ur
-00008ba0: 6c29 0a20 2020 2073 7263 5f70 6174 685f  l).    src_path_
-00008bb0: 696e 732e 7265 6d6f 7665 2829 0a0a 0a63  ins.remove()...c
-00008bc0: 6c61 7373 2053 3343 6163 6865 7228 4669  lass S3Cacher(Fi
-00008bd0: 6c65 4361 6368 6572 293a 0a20 2020 2063  leCacher):.    c
-00008be0: 6163 6865 5f70 6174 6820 3d20 4e6f 6e65  ache_path = None
-00008bf0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-00008c00: 5f5f 280a 2020 2020 2020 2020 2020 2020  __(.            
-00008c10: 7365 6c66 2c20 7061 7468 3a20 7374 722c  self, path: str,
-00008c20: 2063 6163 6865 5f70 6174 683a 204f 7074   cache_path: Opt
-00008c30: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00008c40: 652c 206d 6f64 653a 2073 7472 203d 2027  e, mode: str = '
-00008c50: 7227 293a 0a20 2020 2020 2020 2069 6620  r'):.        if 
-00008c60: 6d6f 6465 206e 6f74 2069 6e20 2827 7227  mode not in ('r'
-00008c70: 2c20 2777 272c 2027 6127 293a 0a20 2020  , 'w', 'a'):.   
-00008c80: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00008c90: 616c 7565 4572 726f 7228 2775 6e61 6363  alueError('unacc
-00008ca0: 6570 7461 626c 6520 6d6f 6465 3a20 2572  eptable mode: %r
-00008cb0: 2720 2520 6d6f 6465 290a 2020 2020 2020  ' % mode).      
-00008cc0: 2020 6966 206d 6f64 6520 696e 2028 2772    if mode in ('r
-00008cd0: 272c 2027 6127 293a 0a20 2020 2020 2020  ', 'a'):.       
-00008ce0: 2020 2020 2069 6620 6361 6368 655f 7061       if cache_pa
-00008cf0: 7468 2069 7320 4e6f 6e65 3a0a 2020 2020  th is None:.    
-00008d00: 2020 2020 2020 2020 2020 2020 6361 6368              cach
-00008d10: 655f 7061 7468 203d 2067 656e 6572 6174  e_path = generat
-00008d20: 655f 6361 6368 655f 7061 7468 2870 6174  e_cache_path(pat
-00008d30: 6829 0a20 2020 2020 2020 2020 2020 2073  h).            s
-00008d40: 335f 646f 776e 6c6f 6164 2870 6174 682c  3_download(path,
-00008d50: 2063 6163 6865 5f70 6174 6829 0a20 2020   cache_path).   
-00008d60: 2020 2020 2073 656c 662e 6e61 6d65 203d       self.name =
-00008d70: 2070 6174 680a 2020 2020 2020 2020 7365   path.        se
-00008d80: 6c66 2e6d 6f64 6520 3d20 6d6f 6465 0a20  lf.mode = mode. 
-00008d90: 2020 2020 2020 2073 656c 662e 6361 6368         self.cach
-00008da0: 655f 7061 7468 203d 2063 6163 6865 5f70  e_path = cache_p
-00008db0: 6174 680a 0a20 2020 2064 6566 205f 636c  ath..    def _cl
-00008dc0: 6f73 6528 7365 6c66 293a 0a20 2020 2020  ose(self):.     
-00008dd0: 2020 2069 6620 7365 6c66 2e63 6163 6865     if self.cache
-00008de0: 5f70 6174 6820 6973 206e 6f74 204e 6f6e  _path is not Non
-00008df0: 6520 616e 6420 5c0a 2020 2020 2020 2020  e and \.        
-00008e00: 2020 2020 6f73 2e70 6174 682e 6578 6973      os.path.exis
-00008e10: 7473 2873 656c 662e 6361 6368 655f 7061  ts(self.cache_pa
-00008e20: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
-00008e30: 2069 6620 7365 6c66 2e6d 6f64 6520 696e   if self.mode in
-00008e40: 2028 2777 272c 2027 6127 293a 0a20 2020   ('w', 'a'):.   
-00008e50: 2020 2020 2020 2020 2020 2020 2073 335f               s3_
-00008e60: 7570 6c6f 6164 2873 656c 662e 6361 6368  upload(self.cach
-00008e70: 655f 7061 7468 2c20 7365 6c66 2e6e 616d  e_path, self.nam
-00008e80: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
-00008e90: 732e 756e 6c69 6e6b 2873 656c 662e 6361  s.unlink(self.ca
-00008ea0: 6368 655f 7061 7468 290a 0a0a 6465 6620  che_path)...def 
-00008eb0: 7333 5f67 6c6f 6228 0a20 2020 2020 2020  s3_glob(.       
-00008ec0: 2070 6174 683a 2050 6174 684c 696b 652c   path: PathLike,
-00008ed0: 0a20 2020 2020 2020 2072 6563 7572 7369  .        recursi
-00008ee0: 7665 3a20 626f 6f6c 203d 2054 7275 652c  ve: bool = True,
-00008ef0: 0a20 2020 2020 2020 206d 6973 7369 6e67  .        missing
-00008f00: 5f6f 6b3a 2062 6f6f 6c20 3d20 5472 7565  _ok: bool = True
-00008f10: 2c0a 2020 2020 2020 2020 666f 6c6c 6f77  ,.        follow
-00008f20: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
-00008f30: 6c73 652c 0a29 202d 3e20 4c69 7374 5b73  lse,.) -> List[s
-00008f40: 7472 5d3a 0a20 2020 2027 2727 5265 7475  tr]:.    '''Retu
-00008f50: 726e 2073 3320 7061 7468 206c 6973 7420  rn s3 path list 
-00008f60: 696e 2061 7363 656e 6469 6e67 2061 6c70  in ascending alp
-00008f70: 6861 6265 7469 6361 6c20 6f72 6465 722c  habetical order,
-00008f80: 2069 6e20 7768 6963 6820 7061 7468 206d   in which path m
-00008f90: 6174 6368 6573 2067 6c6f 6220 7061 7474  atches glob patt
-00008fa0: 6572 6e0a 2020 2020 4e6f 7465 733a 204f  ern.    Notes: O
-00008fb0: 6e6c 7920 676c 6f62 2069 6e20 6275 636b  nly glob in buck
-00008fc0: 6574 2e20 4966 2074 7279 696e 6720 746f  et. If trying to
-00008fd0: 206d 6174 6368 2062 7563 6b65 7420 7769   match bucket wi
-00008fe0: 7468 2077 696c 6463 6172 6420 6368 6172  th wildcard char
-00008ff0: 6163 7465 7273 2c20 7261 6973 6520 556e  acters, raise Un
-00009000: 7375 7070 6f72 7465 6445 7272 6f72 0a0a  supportedError..
-00009010: 2020 2020 3a70 6172 616d 2072 6563 7572      :param recur
-00009020: 7369 7665 3a20 4966 2046 616c 7365 2c20  sive: If False, 
-00009030: 602a 2a60 2077 696c 6c20 6e6f 7420 7365  `**` will not se
-00009040: 6172 6368 2064 6972 6563 746f 7279 2072  arch directory r
-00009050: 6563 7572 7369 7665 6c79 0a20 2020 203a  ecursively.    :
-00009060: 7061 7261 6d20 6d69 7373 696e 675f 6f6b  param missing_ok
-00009070: 3a20 4966 2046 616c 7365 2061 6e64 2074  : If False and t
-00009080: 6172 6765 7420 7061 7468 2064 6f65 736e  arget path doesn
-00009090: 2774 206d 6174 6368 2061 6e79 2066 696c  't match any fil
-000090a0: 652c 2072 6169 7365 2046 696c 654e 6f74  e, raise FileNot
-000090b0: 466f 756e 6445 7272 6f72 0a20 2020 203a  FoundError.    :
-000090c0: 7261 6973 6573 3a20 556e 7375 7070 6f72  raises: Unsuppor
-000090d0: 7465 6445 7272 6f72 2c20 7768 656e 2062  tedError, when b
-000090e0: 7563 6b65 7420 7061 7274 2063 6f6e 7461  ucket part conta
-000090f0: 696e 7320 7769 6c64 6361 7264 2063 6861  ins wildcard cha
-00009100: 7261 6374 6572 730a 2020 2020 3a72 6574  racters.    :ret
-00009110: 7572 6e73 3a20 4120 6c69 7374 2063 6f6e  urns: A list con
-00009120: 7461 696e 7320 7061 7468 7320 6d61 7463  tains paths matc
-00009130: 6820 6073 335f 7061 7468 6e61 6d65 600a  h `s3_pathname`.
-00009140: 2020 2020 2727 270a 2020 2020 7265 7475      '''.    retu
-00009150: 726e 206c 6973 7428 0a20 2020 2020 2020  rn list(.       
-00009160: 2073 335f 6967 6c6f 6228 0a20 2020 2020   s3_iglob(.     
-00009170: 2020 2020 2020 2070 6174 683d 7061 7468         path=path
-00009180: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-00009190: 6375 7273 6976 653d 7265 6375 7273 6976  cursive=recursiv
-000091a0: 652c 0a20 2020 2020 2020 2020 2020 206d  e,.            m
-000091b0: 6973 7369 6e67 5f6f 6b3d 6d69 7373 696e  issing_ok=missin
-000091c0: 675f 6f6b 2c0a 2020 2020 2020 2020 2020  g_ok,.          
-000091d0: 2020 666f 6c6c 6f77 6c69 6e6b 733d 666f    followlinks=fo
-000091e0: 6c6c 6f77 6c69 6e6b 7329 290a 0a0a 6465  llowlinks))...de
-000091f0: 6620 7333 5f67 6c6f 625f 7374 6174 280a  f s3_glob_stat(.
-00009200: 2020 2020 2020 2020 7061 7468 3a20 5061          path: Pa
-00009210: 7468 4c69 6b65 2c0a 2020 2020 2020 2020  thLike,.        
-00009220: 7265 6375 7273 6976 653a 2062 6f6f 6c20  recursive: bool 
-00009230: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-00009240: 6d69 7373 696e 675f 6f6b 3a20 626f 6f6c  missing_ok: bool
-00009250: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-00009260: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
-00009270: 6f6c 203d 2046 616c 7365 2920 2d3e 2049  ol = False) -> I
-00009280: 7465 7261 746f 725b 4669 6c65 456e 7472  terator[FileEntr
-00009290: 795d 3a0a 2020 2020 2727 2752 6574 7572  y]:.    '''Retur
-000092a0: 6e20 6120 6765 6e65 7261 746f 7220 636f  n a generator co
-000092b0: 6e74 6169 6e73 2074 7570 6c65 7320 6f66  ntains tuples of
-000092c0: 2070 6174 6820 616e 6420 6669 6c65 2073   path and file s
-000092d0: 7461 742c 2069 6e20 6173 6365 6e64 696e  tat, in ascendin
-000092e0: 6720 616c 7068 6162 6574 6963 616c 206f  g alphabetical o
-000092f0: 7264 6572 2c20 696e 2077 6869 6368 2070  rder, in which p
-00009300: 6174 6820 6d61 7463 6865 7320 676c 6f62  ath matches glob
-00009310: 2070 6174 7465 726e 0a20 2020 204e 6f74   pattern.    Not
-00009320: 6573 3a20 4f6e 6c79 2067 6c6f 6220 696e  es: Only glob in
-00009330: 2062 7563 6b65 742e 2049 6620 7472 7969   bucket. If tryi
-00009340: 6e67 2074 6f20 6d61 7463 6820 6275 636b  ng to match buck
-00009350: 6574 2077 6974 6820 7769 6c64 6361 7264  et with wildcard
-00009360: 2063 6861 7261 6374 6572 732c 2072 6169   characters, rai
-00009370: 7365 2055 6e73 7570 706f 7274 6564 4572  se UnsupportedEr
-00009380: 726f 720a 0a20 2020 203a 7061 7261 6d20  ror..    :param 
-00009390: 7265 6375 7273 6976 653a 2049 6620 4661  recursive: If Fa
-000093a0: 6c73 652c 2060 2a2a 6020 7769 6c6c 206e  lse, `**` will n
-000093b0: 6f74 2073 6561 7263 6820 6469 7265 6374  ot search direct
-000093c0: 6f72 7920 7265 6375 7273 6976 656c 790a  ory recursively.
-000093d0: 2020 2020 3a70 6172 616d 206d 6973 7369      :param missi
-000093e0: 6e67 5f6f 6b3a 2049 6620 4661 6c73 6520  ng_ok: If False 
-000093f0: 616e 6420 7461 7267 6574 2070 6174 6820  and target path 
-00009400: 646f 6573 6e27 7420 6d61 7463 6820 616e  doesn't match an
-00009410: 7920 6669 6c65 2c20 7261 6973 6520 4669  y file, raise Fi
-00009420: 6c65 4e6f 7446 6f75 6e64 4572 726f 720a  leNotFoundError.
-00009430: 2020 2020 3a72 6169 7365 733a 2055 6e73      :raises: Uns
-00009440: 7570 706f 7274 6564 4572 726f 722c 2077  upportedError, w
-00009450: 6865 6e20 6275 636b 6574 2070 6172 7420  hen bucket part 
-00009460: 636f 6e74 6169 6e73 2077 696c 6463 6172  contains wildcar
-00009470: 6420 6368 6172 6163 7465 7273 0a20 2020  d characters.   
-00009480: 203a 7265 7475 726e 733a 2041 2067 656e   :returns: A gen
-00009490: 6572 6174 6f72 2063 6f6e 7461 696e 7320  erator contains 
-000094a0: 7475 706c 6573 206f 6620 7061 7468 2061  tuples of path a
-000094b0: 6e64 2066 696c 6520 7374 6174 2c20 696e  nd file stat, in
-000094c0: 2077 6869 6368 2070 6174 6873 206d 6174   which paths mat
-000094d0: 6368 2060 7333 5f70 6174 686e 616d 6560  ch `s3_pathname`
-000094e0: 0a20 2020 2027 2727 0a20 2020 2072 6574  .    '''.    ret
-000094f0: 7572 6e20 5333 5061 7468 2870 6174 6829  urn S3Path(path)
-00009500: 2e67 6c6f 625f 7374 6174 280a 2020 2020  .glob_stat(.    
-00009510: 2020 2020 7061 7474 6572 6e3d 2222 2c0a      pattern="",.
-00009520: 2020 2020 2020 2020 7265 6375 7273 6976          recursiv
-00009530: 653d 7265 6375 7273 6976 652c 0a20 2020  e=recursive,.   
-00009540: 2020 2020 206d 6973 7369 6e67 5f6f 6b3d       missing_ok=
-00009550: 6d69 7373 696e 675f 6f6b 2c0a 2020 2020  missing_ok,.    
-00009560: 2020 2020 666f 6c6c 6f77 6c69 6e6b 733d      followlinks=
-00009570: 666f 6c6c 6f77 6c69 6e6b 7329 0a0a 0a64  followlinks)...d
-00009580: 6566 2073 335f 6967 6c6f 6228 0a20 2020  ef s3_iglob(.   
-00009590: 2020 2020 2070 6174 683a 2050 6174 684c       path: PathL
-000095a0: 696b 652c 0a20 2020 2020 2020 2072 6563  ike,.        rec
-000095b0: 7572 7369 7665 3a20 626f 6f6c 203d 2054  ursive: bool = T
-000095c0: 7275 652c 0a20 2020 2020 2020 206d 6973  rue,.        mis
-000095d0: 7369 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20  sing_ok: bool = 
-000095e0: 5472 7565 2c0a 2020 2020 2020 2020 666f  True,.        fo
-000095f0: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
-00009600: 3d20 4661 6c73 652c 0a29 202d 3e20 4974  = False,.) -> It
-00009610: 6572 6174 6f72 5b73 7472 5d3a 0a20 2020  erator[str]:.   
-00009620: 2027 2727 5265 7475 726e 2073 3320 7061   '''Return s3 pa
-00009630: 7468 2069 7465 7261 746f 7220 696e 2061  th iterator in a
-00009640: 7363 656e 6469 6e67 2061 6c70 6861 6265  scending alphabe
-00009650: 7469 6361 6c20 6f72 6465 722c 2069 6e20  tical order, in 
-00009660: 7768 6963 6820 7061 7468 206d 6174 6368  which path match
-00009670: 6573 2067 6c6f 6220 7061 7474 6572 6e0a  es glob pattern.
-00009680: 2020 2020 4e6f 7465 733a 204f 6e6c 7920      Notes: Only 
-00009690: 676c 6f62 2069 6e20 6275 636b 6574 2e20  glob in bucket. 
-000096a0: 4966 2074 7279 696e 6720 746f 206d 6174  If trying to mat
-000096b0: 6368 2062 7563 6b65 7420 7769 7468 2077  ch bucket with w
-000096c0: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
-000096d0: 7273 2c20 7261 6973 6520 556e 7375 7070  rs, raise Unsupp
-000096e0: 6f72 7465 6445 7272 6f72 0a0a 2020 2020  ortedError..    
-000096f0: 3a70 6172 616d 2072 6563 7572 7369 7665  :param recursive
-00009700: 3a20 4966 2046 616c 7365 2c20 602a 2a60  : If False, `**`
-00009710: 2077 696c 6c20 6e6f 7420 7365 6172 6368   will not search
-00009720: 2064 6972 6563 746f 7279 2072 6563 7572   directory recur
-00009730: 7369 7665 6c79 0a20 2020 203a 7061 7261  sively.    :para
-00009740: 6d20 6d69 7373 696e 675f 6f6b 3a20 4966  m missing_ok: If
-00009750: 2046 616c 7365 2061 6e64 2074 6172 6765   False and targe
-00009760: 7420 7061 7468 2064 6f65 736e 2774 206d  t path doesn't m
-00009770: 6174 6368 2061 6e79 2066 696c 652c 2072  atch any file, r
-00009780: 6169 7365 2046 696c 654e 6f74 466f 756e  aise FileNotFoun
-00009790: 6445 7272 6f72 0a20 2020 203a 7261 6973  dError.    :rais
-000097a0: 6573 3a20 556e 7375 7070 6f72 7465 6445  es: UnsupportedE
-000097b0: 7272 6f72 2c20 7768 656e 2062 7563 6b65  rror, when bucke
-000097c0: 7420 7061 7274 2063 6f6e 7461 696e 7320  t part contains 
-000097d0: 7769 6c64 6361 7264 2063 6861 7261 6374  wildcard charact
-000097e0: 6572 730a 2020 2020 3a72 6574 7572 6e73  ers.    :returns
-000097f0: 3a20 416e 2069 7465 7261 746f 7220 636f  : An iterator co
-00009800: 6e74 6169 6e73 2070 6174 6873 206d 6174  ntains paths mat
-00009810: 6368 2060 7333 5f70 6174 686e 616d 6560  ch `s3_pathname`
-00009820: 0a20 2020 2027 2727 0a20 2020 2066 6f72  .    '''.    for
-00009830: 2070 6174 685f 6f62 6a20 696e 2053 3350   path_obj in S3P
-00009840: 6174 6828 7061 7468 292e 6967 6c6f 6228  ath(path).iglob(
-00009850: 7061 7474 6572 6e3d 2222 2c20 7265 6375  pattern="", recu
-00009860: 7273 6976 653d 7265 6375 7273 6976 652c  rsive=recursive,
-00009870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009890: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
-000098a0: 6f6b 3d6d 6973 7369 6e67 5f6f 6b2c 0a20  ok=missing_ok,. 
-000098b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000098c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000098d0: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
-000098e0: 733d 666f 6c6c 6f77 6c69 6e6b 7329 3a0a  s=followlinks):.
-000098f0: 2020 2020 2020 2020 7969 656c 6420 7061          yield pa
-00009900: 7468 5f6f 626a 2e70 6174 685f 7769 7468  th_obj.path_with
-00009910: 5f70 726f 746f 636f 6c0a 0a0a 6465 6620  _protocol...def 
-00009920: 7333 5f6d 616b 6564 6972 7328 7061 7468  s3_makedirs(path
-00009930: 3a20 5061 7468 4c69 6b65 2c20 6578 6973  : PathLike, exis
-00009940: 745f 6f6b 3a20 626f 6f6c 203d 2046 616c  t_ok: bool = Fal
-00009950: 7365 293a 0a20 2020 2027 2727 0a20 2020  se):.    '''.   
-00009960: 2043 7265 6174 6520 616e 2073 3320 6469   Create an s3 di
-00009970: 7265 6374 6f72 792e 0a20 2020 2050 7572  rectory..    Pur
-00009980: 656c 7920 6372 6561 7469 6e67 2064 6972  ely creating dir
-00009990: 6563 746f 7279 2069 7320 696e 7661 6c69  ectory is invali
-000099a0: 6420 6265 6361 7573 6520 6974 2773 2075  d because it's u
-000099b0: 6e61 7661 696c 6162 6c65 206f 6e20 4f53  navailable on OS
-000099c0: 532e 0a20 2020 2054 6869 7320 6675 6e63  S..    This func
-000099d0: 7469 6f6e 2069 7320 746f 2074 6573 7420  tion is to test 
-000099e0: 7468 6520 7461 7267 6574 2062 7563 6b65  the target bucke
-000099f0: 7420 6861 7665 2057 5249 5445 2061 6363  t have WRITE acc
-00009a00: 6573 732e 0a0a 2020 2020 3a70 6172 616d  ess...    :param
-00009a10: 2070 6174 683a 2047 6976 656e 2070 6174   path: Given pat
-00009a20: 680a 2020 2020 3a70 6172 616d 2065 7869  h.    :param exi
-00009a30: 7374 5f6f 6b3a 2049 6620 4661 6c73 6520  st_ok: If False 
-00009a40: 616e 6420 7461 7267 6574 2064 6972 6563  and target direc
-00009a50: 746f 7279 2065 7869 7374 732c 2072 6169  tory exists, rai
-00009a60: 7365 2053 3346 696c 6545 7869 7374 7345  se S3FileExistsE
-00009a70: 7272 6f72 0a20 2020 203a 7261 6973 6573  rror.    :raises
-00009a80: 3a20 5333 4275 636b 6574 4e6f 7446 6f75  : S3BucketNotFou
-00009a90: 6e64 4572 726f 722c 2053 3346 696c 6545  ndError, S3FileE
-00009aa0: 7869 7374 7345 7272 6f72 0a20 2020 2027  xistsError.    '
-00009ab0: 2727 0a20 2020 2072 6574 7572 6e20 5333  ''.    return S3
-00009ac0: 5061 7468 2870 6174 6829 2e6d 6b64 6972  Path(path).mkdir
-00009ad0: 2870 6172 656e 7473 3d54 7275 652c 2065  (parents=True, e
-00009ae0: 7869 7374 5f6f 6b3d 6578 6973 745f 6f6b  xist_ok=exist_ok
-00009af0: 290a 0a0a 6465 6620 5f67 726f 7570 5f73  )...def _group_s
-00009b00: 7263 5f70 6174 6873 5f62 795f 626c 6f63  rc_paths_by_bloc
-00009b10: 6b28 0a20 2020 2020 2020 2073 7263 5f70  k(.        src_p
-00009b20: 6174 6873 3a20 4c69 7374 5b50 6174 684c  aths: List[PathL
-00009b30: 696b 655d 2c20 626c 6f63 6b5f 7369 7a65  ike], block_size
-00009b40: 3a20 696e 7420 3d20 4445 4641 554c 545f  : int = DEFAULT_
-00009b50: 424c 4f43 4b5f 5349 5a45 0a29 202d 3e20  BLOCK_SIZE.) -> 
-00009b60: 4c69 7374 5b4c 6973 745b 5475 706c 655b  List[List[Tuple[
-00009b70: 5061 7468 4c69 6b65 2c20 4f70 7469 6f6e  PathLike, Option
-00009b80: 616c 5b73 7472 5d5d 5d5d 3a0a 2020 2020  al[str]]]]:.    
-00009b90: 6772 6f75 7073 203d 205b 5d0a 2020 2020  groups = [].    
-00009ba0: 6375 7272 656e 745f 6772 6f75 702c 2063  current_group, c
-00009bb0: 7572 7265 6e74 5f67 726f 7570 5f73 697a  urrent_group_siz
-00009bc0: 6520 3d20 5b5d 2c20 300a 2020 2020 666f  e = [], 0.    fo
-00009bd0: 7220 7372 635f 7061 7468 2069 6e20 7372  r src_path in sr
-00009be0: 635f 7061 7468 733a 0a20 2020 2020 2020  c_paths:.       
-00009bf0: 2063 7572 7265 6e74 5f66 696c 655f 7369   current_file_si
-00009c00: 7a65 203d 2053 3350 6174 6828 7372 635f  ze = S3Path(src_
-00009c10: 7061 7468 292e 7374 6174 2829 2e73 697a  path).stat().siz
-00009c20: 650a 2020 2020 2020 2020 6966 2063 7572  e.        if cur
-00009c30: 7265 6e74 5f66 696c 655f 7369 7a65 203d  rent_file_size =
-00009c40: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00009c50: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-00009c60: 2020 2069 6620 6375 7272 656e 745f 6669     if current_fi
-00009c70: 6c65 5f73 697a 6520 3e3d 2062 6c6f 636b  le_size >= block
-00009c80: 5f73 697a 653a 0a20 2020 2020 2020 2020  _size:.         
-00009c90: 2020 2069 6620 6c65 6e28 6772 6f75 7073     if len(groups
-00009ca0: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
-00009cb0: 2020 2020 2020 2020 6966 2063 7572 7265          if curre
-00009cc0: 6e74 5f67 726f 7570 5f73 697a 6520 2b20  nt_group_size + 
-00009cd0: 6375 7272 656e 745f 6669 6c65 5f73 697a  current_file_siz
-00009ce0: 6520 3e20 3220 2a20 626c 6f63 6b5f 7369  e > 2 * block_si
-00009cf0: 7a65 3a0a 2020 2020 2020 2020 2020 2020  ze:.            
-00009d00: 2020 2020 2020 2020 6772 6f75 705f 6c61          group_la
-00009d10: 636b 5f73 697a 6520 3d20 626c 6f63 6b5f  ck_size = block_
-00009d20: 7369 7a65 202d 2063 7572 7265 6e74 5f67  size - current_g
-00009d30: 726f 7570 5f73 697a 650a 2020 2020 2020  roup_size.      
-00009d40: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-00009d50: 7272 656e 745f 6772 6f75 702e 6170 7065  rrent_group.appe
-00009d60: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
-00009d70: 2020 2020 2020 2020 2020 2020 2873 7263              (src
-00009d80: 5f70 6174 682c 2066 2762 7974 6573 3d30  _path, f'bytes=0
-00009d90: 2d7b 6772 6f75 705f 6c61 636b 5f73 697a  -{group_lack_siz
-00009da0: 652d 317d 2729 290a 2020 2020 2020 2020  e-1}')).        
-00009db0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-00009dc0: 7073 2e65 7874 656e 6428 0a20 2020 2020  ps.extend(.     
-00009dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009de0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00009df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e00: 2063 7572 7265 6e74 5f67 726f 7570 2c0a   current_group,.
-00009e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e20: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
-00009e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e40: 2020 2020 2020 2020 2020 2020 2020 280a                (.
-00009e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e70: 2020 2020 7372 635f 7061 7468 2c0a 2020      src_path,.  
+00004680: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00004690: 7333 5f75 726c 2c0a 2020 2020 2020 2020  s3_url,.        
+000046a0: 2020 2020 6d6f 6465 3a20 7374 7220 3d20      mode: str = 
+000046b0: 2772 6227 2c0a 2020 2020 2020 2020 2020  'rb',.          
+000046c0: 2020 656e 636f 6469 6e67 3a20 4f70 7469    encoding: Opti
+000046d0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+000046e0: 2c0a 2020 2020 2020 2020 2020 2020 6572  ,.            er
+000046f0: 726f 7273 3a20 4f70 7469 6f6e 616c 5b73  rors: Optional[s
+00004700: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
+00004710: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00004720: 293a 0a20 2020 2020 2020 2062 7563 6b65  ):.        bucke
+00004730: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+00004740: 335f 7572 6c28 7333 5f75 726c 290a 2020  3_url(s3_url).  
+00004750: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
+00004760: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
+00004770: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
+00004780: 6f74 466f 756e 6445 7272 6f72 2827 456d  otFoundError('Em
+00004790: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
+000047a0: 2025 7227 2025 2073 335f 7572 6c29 0a0a   %r' % s3_url)..
+000047b0: 2020 2020 2020 2020 6966 206e 6f74 206b          if not k
+000047c0: 6579 206f 7220 6b65 792e 656e 6473 7769  ey or key.endswi
+000047d0: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
+000047e0: 2020 2020 2072 6169 7365 2053 3349 7341       raise S3IsA
+000047f0: 4469 7265 6374 6f72 7945 7272 6f72 2827  DirectoryError('
+00004800: 4973 2061 2064 6972 6563 746f 7279 3a20  Is a directory: 
+00004810: 2572 2720 2520 7333 5f75 726c 290a 0a20  %r' % s3_url).. 
+00004820: 2020 2020 2020 2069 6620 2778 2720 696e         if 'x' in
+00004830: 206d 6f64 653a 0a20 2020 2020 2020 2020   mode:.         
+00004840: 2020 2069 6620 5333 5061 7468 2873 335f     if S3Path(s3_
+00004850: 7572 6c29 2e69 735f 6669 6c65 2829 3a0a  url).is_file():.
+00004860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004870: 7261 6973 6520 5333 4669 6c65 4578 6973  raise S3FileExis
+00004880: 7473 4572 726f 7228 2746 696c 6520 6578  tsError('File ex
+00004890: 6973 7473 3a20 2572 2720 2520 7333 5f75  ists: %r' % s3_u
+000048a0: 726c 290a 2020 2020 2020 2020 2020 2020  rl).            
+000048b0: 6d6f 6465 203d 206d 6f64 652e 7265 706c  mode = mode.repl
+000048c0: 6163 6528 2778 272c 2027 7727 290a 0a20  ace('x', 'w').. 
+000048d0: 2020 2020 2020 2069 6620 2777 2720 696e         if 'w' in
+000048e0: 206d 6f64 6520 6f72 2027 6127 2069 6e20   mode or 'a' in 
+000048f0: 6d6f 6465 3a0a 2020 2020 2020 2020 2020  mode:.          
+00004900: 2020 6966 206e 6f74 2053 3350 6174 6828    if not S3Path(
+00004910: 7333 5f75 726c 292e 6861 7362 7563 6b65  s3_url).hasbucke
+00004920: 7428 293a 0a20 2020 2020 2020 2020 2020  t():.           
+00004930: 2020 2020 2072 6169 7365 2053 3342 7563       raise S3Buc
+00004940: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
+00004950: 2827 4e6f 2073 7563 6820 6275 636b 6574  ('No such bucket
+00004960: 3a20 2572 2720 2520 7333 5f75 726c 290a  : %r' % s3_url).
+00004970: 0a20 2020 2020 2020 2066 696c 656f 626a  .        fileobj
+00004980: 203d 2073 335f 6f70 656e 5f66 756e 6328   = s3_open_func(
+00004990: 7333 5f75 726c 2c20 6765 745f 6269 6e61  s3_url, get_bina
+000049a0: 7279 5f6d 6f64 6528 6d6f 6465 292c 202a  ry_mode(mode), *
+000049b0: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
+000049c0: 2069 6620 2762 2720 6e6f 7420 696e 206d   if 'b' not in m
+000049d0: 6f64 653a 0a20 2020 2020 2020 2020 2020  ode:.           
+000049e0: 2066 696c 656f 626a 203d 2069 6f2e 5465   fileobj = io.Te
+000049f0: 7874 494f 5772 6170 7065 7228 0a20 2020  xtIOWrapper(.   
+00004a00: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+00004a10: 656f 626a 2c20 656e 636f 6469 6e67 3d65  eobj, encoding=e
+00004a20: 6e63 6f64 696e 672c 2065 7272 6f72 733d  ncoding, errors=
+00004a30: 6572 726f 7273 2920 2023 2070 7974 7970  errors)  # pytyp
+00004a40: 653a 2064 6973 6162 6c65 3d77 726f 6e67  e: disable=wrong
+00004a50: 2d61 7267 2d74 7970 6573 0a20 2020 2020  -arg-types.     
+00004a60: 2020 2020 2020 2066 696c 656f 626a 2e6d         fileobj.m
+00004a70: 6f64 6520 3d20 6d6f 6465 0a20 2020 2020  ode = mode.     
+00004a80: 2020 2072 6574 7572 6e20 6669 6c65 6f62     return fileob
+00004a90: 6a0a 0a20 2020 2072 6574 7572 6e20 7772  j..    return wr
+00004aa0: 6170 7065 720a 0a0a 405f 7333 5f62 696e  apper...@_s3_bin
+00004ab0: 6172 795f 6d6f 6465 0a64 6566 2073 335f  ary_mode.def s3_
+00004ac0: 7072 6566 6574 6368 5f6f 7065 6e28 0a20  prefetch_open(. 
+00004ad0: 2020 2020 2020 2073 335f 7572 6c3a 2050         s3_url: P
+00004ae0: 6174 684c 696b 652c 0a20 2020 2020 2020  athLike,.       
+00004af0: 206d 6f64 653a 2073 7472 203d 2027 7262   mode: str = 'rb
+00004b00: 272c 0a20 2020 2020 2020 2066 6f6c 6c6f  ',.        follo
+00004b10: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
+00004b20: 616c 7365 2c0a 2020 2020 2020 2020 2a2c  alse,.        *,
+00004b30: 0a20 2020 2020 2020 206d 6178 5f63 6f6e  .        max_con
+00004b40: 6375 7272 656e 6379 3a20 4f70 7469 6f6e  currency: Option
+00004b50: 616c 5b69 6e74 5d20 3d20 4e6f 6e65 2c0a  al[int] = None,.
+00004b60: 2020 2020 2020 2020 6d61 785f 626c 6f63          max_bloc
+00004b70: 6b5f 7369 7a65 3a20 696e 7420 3d20 4445  k_size: int = DE
+00004b80: 4641 554c 545f 424c 4f43 4b5f 5349 5a45  FAULT_BLOCK_SIZE
+00004b90: 2920 2d3e 2053 3350 7265 6665 7463 6852  ) -> S3PrefetchR
+00004ba0: 6561 6465 723a 0a20 2020 2027 2727 4f70  eader:.    '''Op
+00004bb0: 656e 2061 2061 7379 6e63 6872 6f6e 6f75  en a asynchronou
+00004bc0: 7320 7072 6566 6574 6368 2072 6561 6465  s prefetch reade
+00004bd0: 722c 2074 6f20 7375 7070 6f72 7420 6661  r, to support fa
+00004be0: 7374 2073 6571 7565 6e74 6961 6c20 7265  st sequential re
+00004bf0: 6164 2061 6e64 2072 616e 646f 6d20 7265  ad and random re
+00004c00: 6164 0a0a 2020 2020 2e2e 206e 6f74 6520  ad..    .. note 
+00004c10: 3a3a 0a0a 2020 2020 2020 2020 5573 6572  ::..        User
+00004c20: 2073 686f 756c 6420 6d61 6b65 2073 7572   should make sur
+00004c30: 6520 7468 6174 2072 6561 6465 7220 2f20  e that reader / 
+00004c40: 7772 6974 6572 2061 7265 2063 6c6f 7365  writer are close
+00004c50: 6420 636f 7272 6563 746c 790a 0a20 2020  d correctly..   
+00004c60: 2020 2020 2053 7570 706f 7274 7320 636f       Supports co
+00004c70: 6e74 6578 7420 6d61 6e61 6765 720a 0a20  ntext manager.. 
+00004c80: 2020 2020 2020 2053 6f6d 6520 7061 7261         Some para
+00004c90: 6d65 7465 7220 7365 7474 696e 6720 6d61  meter setting ma
+00004ca0: 7920 7065 7266 6f72 6d20 7765 6c6c 3a20  y perform well: 
+00004cb0: 6d61 785f 636f 6e63 7572 7265 6e63 793d  max_concurrency=
+00004cc0: 3130 206f 7220 3230 2c20 6d61 785f 626c  10 or 20, max_bl
+00004cd0: 6f63 6b5f 7369 7a65 3d38 206f 7220 3136  ock_size=8 or 16
+00004ce0: 204d 422c 2064 6566 6175 6c74 2076 616c   MB, default val
+00004cf0: 7565 204e 6f6e 6520 6d65 616e 7320 7573  ue None means us
+00004d00: 696e 6720 676c 6f62 616c 2074 6872 6561  ing global threa
+00004d10: 6420 706f 6f6c 0a0a 2020 2020 3a70 6172  d pool..    :par
+00004d20: 616d 206d 6178 5f63 6f6e 6375 7272 656e  am max_concurren
+00004d30: 6379 3a20 4d61 7820 646f 776e 6c6f 6164  cy: Max download
+00004d40: 2074 6872 6561 6420 6e75 6d62 6572 2c20   thread number, 
+00004d50: 4e6f 6e65 2062 7920 6465 6661 756c 740a  None by default.
+00004d60: 2020 2020 3a70 6172 616d 206d 6178 5f62      :param max_b
+00004d70: 6c6f 636b 5f73 697a 653a 204d 6178 2064  lock_size: Max d
+00004d80: 6174 6120 7369 7a65 2064 6f77 6e6c 6f61  ata size downloa
+00004d90: 6465 6420 6279 2065 6163 6820 7468 7265  ded by each thre
+00004da0: 6164 2c20 696e 2062 7974 6573 2c20 384d  ad, in bytes, 8M
+00004db0: 4220 6279 2064 6566 6175 6c74 0a20 2020  B by default.   
+00004dc0: 203a 7265 7475 726e 733a 2041 6e20 6f70   :returns: An op
+00004dd0: 656e 6564 2053 3350 7265 6665 7463 6852  ened S3PrefetchR
+00004de0: 6561 6465 7220 6f62 6a65 6374 0a20 2020  eader object.   
+00004df0: 203a 7261 6973 6573 3a20 5333 4669 6c65   :raises: S3File
+00004e00: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
+00004e10: 2020 2727 270a 2020 2020 6966 206d 6f64    '''.    if mod
+00004e20: 6520 213d 2027 7262 273a 0a20 2020 2020  e != 'rb':.     
+00004e30: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00004e40: 726f 7228 2775 6e61 6363 6570 7461 626c  ror('unacceptabl
+00004e50: 6520 6d6f 6465 3a20 2572 2720 2520 6d6f  e mode: %r' % mo
+00004e60: 6465 290a 2020 2020 7333 5f75 726c 203d  de).    s3_url =
+00004e70: 2053 3350 6174 6828 7333 5f75 726c 290a   S3Path(s3_url).
+00004e80: 2020 2020 6966 2066 6f6c 6c6f 776c 696e      if followlin
+00004e90: 6b73 3a0a 2020 2020 2020 2020 7472 793a  ks:.        try:
+00004ea0: 0a20 2020 2020 2020 2020 2020 2073 335f  .            s3_
+00004eb0: 7572 6c20 3d20 7333 5f75 726c 2e72 6561  url = s3_url.rea
+00004ec0: 646c 696e 6b28 290a 2020 2020 2020 2020  dlink().        
+00004ed0: 6578 6365 7074 2053 334e 6f74 414c 696e  except S3NotALin
+00004ee0: 6b45 7272 6f72 3a0a 2020 2020 2020 2020  kError:.        
+00004ef0: 2020 2020 7061 7373 0a0a 2020 2020 6275      pass..    bu
+00004f00: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
+00004f10: 655f 7333 5f75 726c 2873 335f 7572 6c2e  e_s3_url(s3_url.
+00004f20: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+00004f30: 6f6c 290a 2020 2020 636f 6e66 6967 203d  ol).    config =
+00004f40: 2062 6f74 6f63 6f72 652e 636f 6e66 6967   botocore.config
+00004f50: 2e43 6f6e 6669 6728 6d61 785f 706f 6f6c  .Config(max_pool
+00004f60: 5f63 6f6e 6e65 6374 696f 6e73 3d6d 6178  _connections=max
+00004f70: 5f70 6f6f 6c5f 636f 6e6e 6563 7469 6f6e  _pool_connection
+00004f80: 7329 0a20 2020 2063 6c69 656e 7420 3d20  s).    client = 
+00004f90: 6765 745f 7333 5f63 6c69 656e 7428 0a20  get_s3_client(. 
+00004fa0: 2020 2020 2020 2063 6f6e 6669 673d 636f         config=co
+00004fb0: 6e66 6967 2c0a 2020 2020 2020 2020 6361  nfig,.        ca
+00004fc0: 6368 655f 6b65 793d 2773 335f 6669 6c65  che_key='s3_file
+00004fd0: 6c69 6b65 5f63 6c69 656e 7427 2c0a 2020  like_client',.  
+00004fe0: 2020 2020 2020 7072 6f66 696c 655f 6e61        profile_na
+00004ff0: 6d65 3d73 335f 7572 6c2e 5f70 726f 6669  me=s3_url._profi
+00005000: 6c65 5f6e 616d 6529 0a20 2020 2072 6574  le_name).    ret
+00005010: 7572 6e20 5333 5072 6566 6574 6368 5265  urn S3PrefetchRe
+00005020: 6164 6572 280a 2020 2020 2020 2020 6275  ader(.        bu
+00005030: 636b 6574 2c0a 2020 2020 2020 2020 6b65  cket,.        ke
+00005040: 792c 0a20 2020 2020 2020 2073 335f 636c  y,.        s3_cl
+00005050: 6965 6e74 3d63 6c69 656e 742c 0a20 2020  ient=client,.   
+00005060: 2020 2020 206d 6178 5f72 6574 7269 6573       max_retries
+00005070: 3d6d 6178 5f72 6574 7269 6573 2c0a 2020  =max_retries,.  
+00005080: 2020 2020 2020 6d61 785f 776f 726b 6572        max_worker
+00005090: 733d 6d61 785f 636f 6e63 7572 7265 6e63  s=max_concurrenc
+000050a0: 792c 0a20 2020 2020 2020 2062 6c6f 636b  y,.        block
+000050b0: 5f73 697a 653d 6d61 785f 626c 6f63 6b5f  _size=max_block_
+000050c0: 7369 7a65 290a 0a0a 405f 7333 5f62 696e  size)...@_s3_bin
+000050d0: 6172 795f 6d6f 6465 0a64 6566 2073 335f  ary_mode.def s3_
+000050e0: 7368 6172 655f 6361 6368 655f 6f70 656e  share_cache_open
+000050f0: 280a 2020 2020 2020 2020 7333 5f75 726c  (.        s3_url
+00005100: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
+00005110: 2020 2020 6d6f 6465 3a20 7374 7220 3d20      mode: str = 
+00005120: 2772 6227 2c0a 2020 2020 2020 2020 666f  'rb',.        fo
+00005130: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
+00005140: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+00005150: 202a 2c0a 2020 2020 2020 2020 6361 6368   *,.        cach
+00005160: 655f 6b65 793a 2073 7472 203d 2027 6c72  e_key: str = 'lr
+00005170: 7527 2c0a 2020 2020 2020 2020 6d61 785f  u',.        max_
+00005180: 636f 6e63 7572 7265 6e63 793a 204f 7074  concurrency: Opt
+00005190: 696f 6e61 6c5b 696e 745d 203d 204e 6f6e  ional[int] = Non
+000051a0: 652c 0a20 2020 2020 2020 206d 6178 5f62  e,.        max_b
+000051b0: 6c6f 636b 5f73 697a 653a 2069 6e74 203d  lock_size: int =
+000051c0: 2044 4546 4155 4c54 5f42 4c4f 434b 5f53   DEFAULT_BLOCK_S
+000051d0: 495a 4529 202d 3e20 5333 5368 6172 6543  IZE) -> S3ShareC
+000051e0: 6163 6865 5265 6164 6572 3a0a 2020 2020  acheReader:.    
+000051f0: 2727 274f 7065 6e20 6120 6173 796e 6368  '''Open a asynch
+00005200: 726f 6e6f 7573 2070 7265 6665 7463 6820  ronous prefetch 
+00005210: 7265 6164 6572 2c20 746f 2073 7570 706f  reader, to suppo
+00005220: 7274 2066 6173 7420 7365 7175 656e 7469  rt fast sequenti
+00005230: 616c 2072 6561 6420 616e 6420 7261 6e64  al read and rand
+00005240: 6f6d 2072 6561 640a 0a20 2020 202e 2e20  om read..    .. 
+00005250: 6e6f 7465 203a 3a0a 0a20 2020 2020 2020  note ::..       
+00005260: 2055 7365 7220 7368 6f75 6c64 206d 616b   User should mak
+00005270: 6520 7375 7265 2074 6861 7420 7265 6164  e sure that read
+00005280: 6572 202f 2077 7269 7465 7220 6172 6520  er / writer are 
+00005290: 636c 6f73 6564 2063 6f72 7265 6374 6c79  closed correctly
+000052a0: 0a0a 2020 2020 2020 2020 5375 7070 6f72  ..        Suppor
+000052b0: 7473 2063 6f6e 7465 7874 206d 616e 6167  ts context manag
+000052c0: 6572 0a0a 2020 2020 2020 2020 536f 6d65  er..        Some
+000052d0: 2070 6172 616d 6574 6572 2073 6574 7469   parameter setti
+000052e0: 6e67 206d 6179 2070 6572 666f 726d 2077  ng may perform w
+000052f0: 656c 6c3a 206d 6178 5f63 6f6e 6375 7272  ell: max_concurr
+00005300: 656e 6379 3d31 3020 6f72 2032 302c 206d  ency=10 or 20, m
+00005310: 6178 5f62 6c6f 636b 5f73 697a 653d 3820  ax_block_size=8 
+00005320: 6f72 2031 3620 4d42 2c20 6465 6661 756c  or 16 MB, defaul
+00005330: 7420 7661 6c75 6520 4e6f 6e65 206d 6561  t value None mea
+00005340: 6e73 2075 7369 6e67 2067 6c6f 6261 6c20  ns using global 
+00005350: 7468 7265 6164 2070 6f6f 6c0a 0a20 2020  thread pool..   
+00005360: 203a 7061 7261 6d20 6d61 785f 636f 6e63   :param max_conc
+00005370: 7572 7265 6e63 793a 204d 6178 2064 6f77  urrency: Max dow
+00005380: 6e6c 6f61 6420 7468 7265 6164 206e 756d  nload thread num
+00005390: 6265 722c 204e 6f6e 6520 6279 2064 6566  ber, None by def
+000053a0: 6175 6c74 0a20 2020 203a 7061 7261 6d20  ault.    :param 
+000053b0: 6d61 785f 626c 6f63 6b5f 7369 7a65 3a20  max_block_size: 
+000053c0: 4d61 7820 6461 7461 2073 697a 6520 646f  Max data size do
+000053d0: 776e 6c6f 6164 6564 2062 7920 6561 6368  wnloaded by each
+000053e0: 2074 6872 6561 642c 2069 6e20 6279 7465   thread, in byte
+000053f0: 732c 2038 4d42 2062 7920 6465 6661 756c  s, 8MB by defaul
+00005400: 740a 2020 2020 3a72 6574 7572 6e73 3a20  t.    :returns: 
+00005410: 416e 206f 7065 6e65 6420 5333 5368 6172  An opened S3Shar
+00005420: 6543 6163 6865 5265 6164 6572 206f 626a  eCacheReader obj
+00005430: 6563 740a 2020 2020 3a72 6169 7365 733a  ect.    :raises:
+00005440: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
+00005450: 7272 6f72 0a20 2020 2027 2727 0a20 2020  rror.    '''.   
+00005460: 2069 6620 6d6f 6465 2021 3d20 2772 6227   if mode != 'rb'
+00005470: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00005480: 5661 6c75 6545 7272 6f72 2827 756e 6163  ValueError('unac
+00005490: 6365 7074 6162 6c65 206d 6f64 653a 2025  ceptable mode: %
+000054a0: 7227 2025 206d 6f64 6529 0a0a 2020 2020  r' % mode)..    
+000054b0: 7333 5f75 726c 203d 2053 3350 6174 6828  s3_url = S3Path(
+000054c0: 7333 5f75 726c 290a 2020 2020 6966 2066  s3_url).    if f
+000054d0: 6f6c 6c6f 776c 696e 6b73 3a0a 2020 2020  ollowlinks:.    
+000054e0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000054f0: 2020 2020 2073 335f 7572 6c20 3d20 7333       s3_url = s3
+00005500: 5f75 726c 2e72 6561 646c 696e 6b28 290a  _url.readlink().
+00005510: 2020 2020 2020 2020 6578 6365 7074 2053          except S
+00005520: 334e 6f74 414c 696e 6b45 7272 6f72 3a0a  3NotALinkError:.
+00005530: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+00005540: 0a0a 2020 2020 6275 636b 6574 2c20 6b65  ..    bucket, ke
+00005550: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+00005560: 2873 335f 7572 6c2e 7061 7468 5f77 6974  (s3_url.path_wit
+00005570: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+00005580: 636f 6e66 6967 203d 2062 6f74 6f63 6f72  config = botocor
+00005590: 652e 636f 6e66 6967 2e43 6f6e 6669 6728  e.config.Config(
+000055a0: 6d61 785f 706f 6f6c 5f63 6f6e 6e65 6374  max_pool_connect
+000055b0: 696f 6e73 3d6d 6178 5f70 6f6f 6c5f 636f  ions=max_pool_co
+000055c0: 6e6e 6563 7469 6f6e 7329 0a20 2020 2063  nnections).    c
+000055d0: 6c69 656e 7420 3d20 6765 745f 7333 5f63  lient = get_s3_c
+000055e0: 6c69 656e 7428 0a20 2020 2020 2020 2063  lient(.        c
+000055f0: 6f6e 6669 673d 636f 6e66 6967 2c0a 2020  onfig=config,.  
+00005600: 2020 2020 2020 6361 6368 655f 6b65 793d        cache_key=
+00005610: 2773 335f 6669 6c65 6c69 6b65 5f63 6c69  's3_filelike_cli
+00005620: 656e 7427 2c0a 2020 2020 2020 2020 7072  ent',.        pr
+00005630: 6f66 696c 655f 6e61 6d65 3d73 335f 7572  ofile_name=s3_ur
+00005640: 6c2e 5f70 726f 6669 6c65 5f6e 616d 6529  l._profile_name)
+00005650: 0a20 2020 2072 6574 7572 6e20 5333 5368  .    return S3Sh
+00005660: 6172 6543 6163 6865 5265 6164 6572 280a  areCacheReader(.
+00005670: 2020 2020 2020 2020 6275 636b 6574 2c0a          bucket,.
+00005680: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
+00005690: 2020 2020 2063 6163 6865 5f6b 6579 3d63       cache_key=c
+000056a0: 6163 6865 5f6b 6579 2c0a 2020 2020 2020  ache_key,.      
+000056b0: 2020 7333 5f63 6c69 656e 743d 636c 6965    s3_client=clie
+000056c0: 6e74 2c0a 2020 2020 2020 2020 6d61 785f  nt,.        max_
+000056d0: 7265 7472 6965 733d 6d61 785f 7265 7472  retries=max_retr
+000056e0: 6965 732c 0a20 2020 2020 2020 206d 6178  ies,.        max
+000056f0: 5f77 6f72 6b65 7273 3d6d 6178 5f63 6f6e  _workers=max_con
+00005700: 6375 7272 656e 6379 2c0a 2020 2020 2020  currency,.      
+00005710: 2020 626c 6f63 6b5f 7369 7a65 3d6d 6178    block_size=max
+00005720: 5f62 6c6f 636b 5f73 697a 6529 0a0a 0a40  _block_size)...@
+00005730: 5f73 335f 6269 6e61 7279 5f6d 6f64 650a  _s3_binary_mode.
+00005740: 6465 6620 7333 5f70 6970 655f 6f70 656e  def s3_pipe_open
+00005750: 280a 2020 2020 2020 2020 7333 5f75 726c  (.        s3_url
+00005760: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
+00005770: 2020 2020 6d6f 6465 3a20 7374 722c 0a20      mode: str,. 
+00005780: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
+00005790: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
+000057a0: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+000057b0: 2020 2020 206a 6f69 6e5f 7468 7265 6164       join_thread
+000057c0: 3a20 626f 6f6c 203d 2054 7275 6529 202d  : bool = True) -
+000057d0: 3e20 5333 5069 7065 4861 6e64 6c65 723a  > S3PipeHandler:
+000057e0: 0a20 2020 2027 2727 4f70 656e 2061 2061  .    '''Open a a
+000057f0: 7379 6e63 6872 6f6e 6f75 7320 7265 6164  synchronous read
+00005800: 2d77 7269 7465 2072 6561 6465 7220 2f20  -write reader / 
+00005810: 7772 6974 6572 2c20 746f 2073 7570 706f  writer, to suppo
+00005820: 7274 2066 6173 7420 7365 7175 656e 7469  rt fast sequenti
+00005830: 616c 2072 6561 6420 2f20 7772 6974 650a  al read / write.
+00005840: 0a20 2020 202e 2e20 6e6f 7465 203a 3a0a  .    .. note ::.
+00005850: 0a20 2020 2020 2020 2055 7365 7220 7368  .        User sh
+00005860: 6f75 6c64 206d 616b 6520 7375 7265 2074  ould make sure t
+00005870: 6861 7420 7265 6164 6572 202f 2077 7269  hat reader / wri
+00005880: 7465 7220 6172 6520 636c 6f73 6564 2063  ter are closed c
+00005890: 6f72 7265 6374 6c79 0a0a 2020 2020 2020  orrectly..      
+000058a0: 2020 5375 7070 6f72 7473 2063 6f6e 7465    Supports conte
+000058b0: 7874 206d 616e 6167 6572 0a0a 2020 2020  xt manager..    
+000058c0: 2020 2020 5768 656e 206a 6f69 6e5f 7468      When join_th
+000058d0: 7265 6164 2069 7320 4661 6c73 652c 2077  read is False, w
+000058e0: 6869 6c65 2074 6865 2066 696c 6520 6861  hile the file ha
+000058f0: 6e64 6c65 2061 7265 2063 6c6f 7369 6e67  ndle are closing
+00005900: 2c20 7468 6973 2066 756e 6374 696f 6e20  , this function 
+00005910: 7769 6c6c 206e 6f74 2077 6169 7420 756e  will not wait un
+00005920: 7469 6c20 7468 6520 6173 796e 6368 726f  til the asynchro
+00005930: 6e6f 7573 2077 7269 7469 6e67 2066 696e  nous writing fin
+00005940: 6973 6865 733b 0a20 2020 2020 2020 2046  ishes;.        F
+00005950: 616c 7365 2064 6f65 736e 2774 2061 6666  alse doesn't aff
+00005960: 6563 7420 7265 6164 2d68 616e 646c 652c  ect read-handle,
+00005970: 2062 7574 2074 6869 7320 6361 6e20 7370   but this can sp
+00005980: 6565 6420 7570 2077 7269 7465 2d68 616e  eed up write-han
+00005990: 646c 6520 6265 6361 7573 6520 6669 6c65  dle because file
+000059a0: 2077 696c 6c20 6265 2077 7269 7474 656e   will be written
+000059b0: 2061 7379 6e63 6872 6f6e 6f75 736c 792e   asynchronously.
+000059c0: 0a20 2020 2020 2020 2042 7574 2061 7379  .        But asy
+000059d0: 6e63 6872 6f6e 6f75 7320 6265 6861 7669  nchronous behavi
+000059e0: 6f75 7220 6361 6e20 6775 6172 616e 7465  our can guarante
+000059f0: 6520 7468 6520 6669 6c65 2061 7265 2073  e the file are s
+00005a00: 7563 6365 7373 6675 6c6c 7920 7772 6974  uccessfully writ
+00005a10: 7465 6e2c 2061 6e64 2066 7265 7175 656e  ten, and frequen
+00005a20: 7420 6578 6563 7574 696f 6e20 6d61 7920  t execution may 
+00005a30: 6361 7573 6520 7468 7265 6164 2061 6e64  cause thread and
+00005a40: 2066 696c 6520 6861 6e64 6c65 2065 7868   file handle exh
+00005a50: 6175 7374 696f 6e0a 0a20 2020 203a 7061  austion..    :pa
+00005a60: 7261 6d20 6d6f 6465 3a20 4d6f 6465 2074  ram mode: Mode t
+00005a70: 6f20 6f70 656e 2066 696c 652c 2065 6974  o open file, eit
+00005a80: 6865 7220 2272 6222 206f 7220 2277 6222  her "rb" or "wb"
+00005a90: 0a20 2020 203a 7061 7261 6d20 6a6f 696e  .    :param join
+00005aa0: 5f74 6872 6561 643a 2049 6620 7761 6974  _thread: If wait
+00005ab0: 2061 6674 6572 2066 756e 6374 696f 6e20   after function 
+00005ac0: 6578 6563 7574 696f 6e20 756e 7469 6c20  execution until 
+00005ad0: 7333 2066 696e 6973 6865 7320 7772 6974  s3 finishes writ
+00005ae0: 696e 670a 2020 2020 3a72 6574 7572 6e73  ing.    :returns
+00005af0: 3a20 416e 206f 7065 6e65 6420 4275 6666  : An opened Buff
+00005b00: 6572 6564 5265 6164 6572 202f 2042 7566  eredReader / Buf
+00005b10: 6665 7265 6457 7269 7465 7220 6f62 6a65  feredWriter obje
+00005b20: 6374 0a20 2020 2027 2727 0a20 2020 2069  ct.    '''.    i
+00005b30: 6620 6d6f 6465 206e 6f74 2069 6e20 2827  f mode not in ('
+00005b40: 7262 272c 2027 7762 2729 3a0a 2020 2020  rb', 'wb'):.    
+00005b50: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00005b60: 7272 6f72 2827 756e 6163 6365 7074 6162  rror('unacceptab
+00005b70: 6c65 206d 6f64 653a 2025 7227 2025 206d  le mode: %r' % m
+00005b80: 6f64 6529 0a0a 2020 2020 6966 206d 6f64  ode)..    if mod
+00005b90: 655b 305d 203d 3d20 2772 2720 616e 6420  e[0] == 'r' and 
+00005ba0: 6e6f 7420 5333 5061 7468 2873 335f 7572  not S3Path(s3_ur
+00005bb0: 6c29 2e69 735f 6669 6c65 2829 3a0a 2020  l).is_file():.  
+00005bc0: 2020 2020 2020 7261 6973 6520 5333 4669        raise S3Fi
+00005bd0: 6c65 4e6f 7446 6f75 6e64 4572 726f 7228  leNotFoundError(
+00005be0: 274e 6f20 7375 6368 2066 696c 653a 2025  'No such file: %
+00005bf0: 7227 2025 2073 335f 7572 6c29 0a0a 2020  r' % s3_url)..  
+00005c00: 2020 7333 5f75 726c 203d 2053 3350 6174    s3_url = S3Pat
+00005c10: 6828 7333 5f75 726c 290a 2020 2020 6966  h(s3_url).    if
+00005c20: 2066 6f6c 6c6f 776c 696e 6b73 3a0a 2020   followlinks:.  
+00005c30: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00005c40: 2020 2020 2020 2073 335f 7572 6c20 3d20         s3_url = 
+00005c50: 7333 5f75 726c 2e72 6561 646c 696e 6b28  s3_url.readlink(
+00005c60: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00005c70: 2053 334e 6f74 414c 696e 6b45 7272 6f72   S3NotALinkError
+00005c80: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+00005c90: 7373 0a0a 2020 2020 6275 636b 6574 2c20  ss..    bucket, 
+00005ca0: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
+00005cb0: 726c 2873 335f 7572 6c2e 7061 7468 5f77  rl(s3_url.path_w
+00005cc0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+00005cd0: 2020 636f 6e66 6967 203d 2062 6f74 6f63    config = botoc
+00005ce0: 6f72 652e 636f 6e66 6967 2e43 6f6e 6669  ore.config.Confi
+00005cf0: 6728 6d61 785f 706f 6f6c 5f63 6f6e 6e65  g(max_pool_conne
+00005d00: 6374 696f 6e73 3d6d 6178 5f70 6f6f 6c5f  ctions=max_pool_
+00005d10: 636f 6e6e 6563 7469 6f6e 7329 0a20 2020  connections).   
+00005d20: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
+00005d30: 5f63 6c69 656e 7428 0a20 2020 2020 2020  _client(.       
+00005d40: 2063 6f6e 6669 673d 636f 6e66 6967 2c0a   config=config,.
+00005d50: 2020 2020 2020 2020 6361 6368 655f 6b65          cache_ke
+00005d60: 793d 2773 335f 6669 6c65 6c69 6b65 5f63  y='s3_filelike_c
+00005d70: 6c69 656e 7427 2c0a 2020 2020 2020 2020  lient',.        
+00005d80: 7072 6f66 696c 655f 6e61 6d65 3d73 335f  profile_name=s3_
+00005d90: 7572 6c2e 5f70 726f 6669 6c65 5f6e 616d  url._profile_nam
+00005da0: 6529 0a20 2020 2072 6574 7572 6e20 5333  e).    return S3
+00005db0: 5069 7065 4861 6e64 6c65 7228 0a20 2020  PipeHandler(.   
+00005dc0: 2020 2020 2062 7563 6b65 742c 206b 6579       bucket, key
+00005dd0: 2c20 6d6f 6465 2c20 7333 5f63 6c69 656e  , mode, s3_clien
+00005de0: 743d 636c 6965 6e74 2c20 6a6f 696e 5f74  t=client, join_t
+00005df0: 6872 6561 643d 6a6f 696e 5f74 6872 6561  hread=join_threa
+00005e00: 6429 0a0a 0a40 5f73 335f 6269 6e61 7279  d)...@_s3_binary
+00005e10: 5f6d 6f64 650a 6465 6620 7333 5f63 6163  _mode.def s3_cac
+00005e20: 6865 645f 6f70 656e 280a 2020 2020 2020  hed_open(.      
+00005e30: 2020 7333 5f75 726c 3a20 5061 7468 4c69    s3_url: PathLi
+00005e40: 6b65 2c0a 2020 2020 2020 2020 6d6f 6465  ke,.        mode
+00005e50: 3a20 7374 722c 0a20 2020 2020 2020 2066  : str,.        f
+00005e60: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
+00005e70: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+00005e80: 2020 2a2c 0a20 2020 2020 2020 2063 6163    *,.        cac
+00005e90: 6865 5f70 6174 683a 204f 7074 696f 6e61  he_path: Optiona
+00005ea0: 6c5b 7374 725d 203d 204e 6f6e 6529 202d  l[str] = None) -
+00005eb0: 3e20 5333 4361 6368 6564 4861 6e64 6c65  > S3CachedHandle
+00005ec0: 723a 0a20 2020 2027 2727 4f70 656e 2061  r:.    '''Open a
+00005ed0: 206c 6f63 616c 2d63 6163 6865 2066 696c   local-cache fil
+00005ee0: 6520 7265 6164 6572 202f 2077 7269 7465  e reader / write
+00005ef0: 722c 2066 6f72 2066 7265 7175 656e 7420  r, for frequent 
+00005f00: 7261 6e64 6f6d 2072 6561 6420 2f20 7772  random read / wr
+00005f10: 6974 650a 0a20 2020 202e 2e20 6e6f 7465  ite..    .. note
+00005f20: 203a 3a0a 0a20 2020 2020 2020 2055 7365   ::..        Use
+00005f30: 7220 7368 6f75 6c64 206d 616b 6520 7375  r should make su
+00005f40: 7265 2074 6861 7420 7265 6164 6572 202f  re that reader /
+00005f50: 2077 7269 7465 7220 6172 6520 636c 6f73   writer are clos
+00005f60: 6564 2063 6f72 7265 6374 6c79 0a0a 2020  ed correctly..  
+00005f70: 2020 2020 2020 5375 7070 6f72 7473 2063        Supports c
+00005f80: 6f6e 7465 7874 206d 616e 6167 6572 0a0a  ontext manager..
+00005f90: 2020 2020 2020 2020 6361 6368 655f 7061          cache_pa
+00005fa0: 7468 2063 616e 2073 7065 6369 6679 2074  th can specify t
+00005fb0: 6865 2070 6174 6820 6f66 2063 6163 6865  he path of cache
+00005fc0: 2066 696c 652e 2050 6572 666f 726d 616e   file. Performan
+00005fd0: 6365 2063 6f75 6c64 2062 6520 6265 7474  ce could be bett
+00005fe0: 6572 2069 6620 6361 6368 6520 6669 6c65  er if cache file
+00005ff0: 2070 6174 6820 6973 206f 6e20 7373 6420   path is on ssd 
+00006000: 6f72 2074 6d70 6673 0a0a 2020 2020 3a70  or tmpfs..    :p
+00006010: 6172 616d 206d 6f64 653a 204d 6f64 6520  aram mode: Mode 
+00006020: 746f 206f 7065 6e20 6669 6c65 2c20 636f  to open file, co
+00006030: 756c 6420 6265 206f 6e65 206f 6620 2272  uld be one of "r
+00006040: 6222 2c20 2277 6222 206f 7220 2261 6222  b", "wb" or "ab"
+00006050: 0a20 2020 203a 7061 7261 6d20 6361 6368  .    :param cach
+00006060: 655f 7061 7468 3a20 6361 6368 6520 6669  e_path: cache fi
+00006070: 6c65 2070 6174 680a 2020 2020 3a72 6574  le path.    :ret
+00006080: 7572 6e73 3a20 416e 206f 7065 6e65 6420  urns: An opened 
+00006090: 4275 6666 6572 6564 5265 6164 6572 202f  BufferedReader /
+000060a0: 2042 7566 6665 7265 6457 7269 7465 7220   BufferedWriter 
+000060b0: 6f62 6a65 6374 0a20 2020 2027 2727 0a20  object.    '''. 
+000060c0: 2020 2069 6620 6d6f 6465 206e 6f74 2069     if mode not i
+000060d0: 6e20 2827 7262 272c 2027 7762 272c 2027  n ('rb', 'wb', '
+000060e0: 6162 272c 2027 7262 2b27 2c20 2777 622b  ab', 'rb+', 'wb+
+000060f0: 272c 2027 6162 2b27 293a 0a20 2020 2020  ', 'ab+'):.     
+00006100: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00006110: 726f 7228 2775 6e61 6363 6570 7461 626c  ror('unacceptabl
+00006120: 6520 6d6f 6465 3a20 2572 2720 2520 6d6f  e mode: %r' % mo
+00006130: 6465 290a 2020 2020 7333 5f75 726c 203d  de).    s3_url =
+00006140: 2053 3350 6174 6828 7333 5f75 726c 290a   S3Path(s3_url).
+00006150: 2020 2020 6966 2066 6f6c 6c6f 776c 696e      if followlin
+00006160: 6b73 3a0a 2020 2020 2020 2020 7472 793a  ks:.        try:
+00006170: 0a20 2020 2020 2020 2020 2020 2073 335f  .            s3_
+00006180: 7572 6c20 3d20 7333 5f75 726c 2e72 6561  url = s3_url.rea
+00006190: 646c 696e 6b28 290a 2020 2020 2020 2020  dlink().        
+000061a0: 6578 6365 7074 2053 334e 6f74 414c 696e  except S3NotALin
+000061b0: 6b45 7272 6f72 3a0a 2020 2020 2020 2020  kError:.        
+000061c0: 2020 2020 7061 7373 0a0a 2020 2020 6275      pass..    bu
+000061d0: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
+000061e0: 655f 7333 5f75 726c 2873 335f 7572 6c2e  e_s3_url(s3_url.
+000061f0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+00006200: 6f6c 290a 2020 2020 636f 6e66 6967 203d  ol).    config =
+00006210: 2062 6f74 6f63 6f72 652e 636f 6e66 6967   botocore.config
+00006220: 2e43 6f6e 6669 6728 6d61 785f 706f 6f6c  .Config(max_pool
+00006230: 5f63 6f6e 6e65 6374 696f 6e73 3d6d 6178  _connections=max
+00006240: 5f70 6f6f 6c5f 636f 6e6e 6563 7469 6f6e  _pool_connection
+00006250: 7329 0a20 2020 2063 6c69 656e 7420 3d20  s).    client = 
+00006260: 6765 745f 7333 5f63 6c69 656e 7428 0a20  get_s3_client(. 
+00006270: 2020 2020 2020 2063 6f6e 6669 673d 636f         config=co
+00006280: 6e66 6967 2c0a 2020 2020 2020 2020 6361  nfig,.        ca
+00006290: 6368 655f 6b65 793d 2773 335f 6669 6c65  che_key='s3_file
+000062a0: 6c69 6b65 5f63 6c69 656e 7427 2c0a 2020  like_client',.  
+000062b0: 2020 2020 2020 7072 6f66 696c 655f 6e61        profile_na
+000062c0: 6d65 3d73 335f 7572 6c2e 5f70 726f 6669  me=s3_url._profi
+000062d0: 6c65 5f6e 616d 6529 0a20 2020 2072 6574  le_name).    ret
+000062e0: 7572 6e20 5333 4361 6368 6564 4861 6e64  urn S3CachedHand
+000062f0: 6c65 7228 0a20 2020 2020 2020 2062 7563  ler(.        buc
+00006300: 6b65 742c 206b 6579 2c20 6d6f 6465 2c20  ket, key, mode, 
+00006310: 7333 5f63 6c69 656e 743d 636c 6965 6e74  s3_client=client
+00006320: 2c20 6361 6368 655f 7061 7468 3d63 6163  , cache_path=cac
+00006330: 6865 5f70 6174 6829 0a0a 0a40 5f73 335f  he_path)...@_s3_
+00006340: 6269 6e61 7279 5f6d 6f64 650a 6465 6620  binary_mode.def 
+00006350: 7333 5f62 7566 6665 7265 645f 6f70 656e  s3_buffered_open
+00006360: 280a 2020 2020 2020 2020 7333 5f75 726c  (.        s3_url
+00006370: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
+00006380: 2020 2020 6d6f 6465 3a20 7374 722c 0a20      mode: str,. 
+00006390: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
+000063a0: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
+000063b0: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+000063c0: 2020 2020 206d 6178 5f63 6f6e 6375 7272       max_concurr
+000063d0: 656e 6379 3a20 4f70 7469 6f6e 616c 5b69  ency: Optional[i
+000063e0: 6e74 5d20 3d20 4e6f 6e65 2c0a 2020 2020  nt] = None,.    
+000063f0: 2020 2020 6d61 785f 6275 6666 6572 5f73      max_buffer_s
+00006400: 697a 653a 2069 6e74 203d 2044 4546 4155  ize: int = DEFAU
+00006410: 4c54 5f4d 4158 5f42 5546 4645 525f 5349  LT_MAX_BUFFER_SI
+00006420: 5a45 2c0a 2020 2020 2020 2020 666f 7277  ZE,.        forw
+00006430: 6172 645f 7261 7469 6f3a 204f 7074 696f  ard_ratio: Optio
+00006440: 6e61 6c5b 666c 6f61 745d 203d 204e 6f6e  nal[float] = Non
+00006450: 652c 0a20 2020 2020 2020 2062 6c6f 636b  e,.        block
+00006460: 5f73 697a 653a 2069 6e74 203d 2044 4546  _size: int = DEF
+00006470: 4155 4c54 5f42 4c4f 434b 5f53 495a 452c  AULT_BLOCK_SIZE,
+00006480: 0a20 2020 2020 2020 206c 696d 6974 6564  .        limited
+00006490: 5f73 6565 6b61 626c 653a 2062 6f6f 6c20  _seekable: bool 
+000064a0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+000064b0: 2062 7566 6665 7265 643a 2062 6f6f 6c20   buffered: bool 
+000064c0: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
+000064d0: 7368 6172 655f 6361 6368 655f 6b65 793a  share_cache_key:
+000064e0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+000064f0: 204e 6f6e 652c 0a20 2020 2020 2020 2063   None,.        c
+00006500: 6163 6865 5f70 6174 683a 204f 7074 696f  ache_path: Optio
+00006510: 6e61 6c5b 7374 725d 203d 204e 6f6e 650a  nal[str] = None.
+00006520: 2920 2d3e 2055 6e69 6f6e 5b53 3350 7265  ) -> Union[S3Pre
+00006530: 6665 7463 6852 6561 6465 722c 2053 3342  fetchReader, S3B
+00006540: 7566 6665 7265 6457 7269 7465 722c 2069  ufferedWriter, i
+00006550: 6f2e 4275 6666 6572 6564 5265 6164 6572  o.BufferedReader
+00006560: 2c20 696f 2e0a 2020 2020 2020 2020 2020  , io..          
+00006570: 2042 7566 6665 7265 6457 7269 7465 722c   BufferedWriter,
+00006580: 2053 334d 656d 6f72 7948 616e 646c 6572   S3MemoryHandler
+00006590: 5d3a 0a20 2020 2027 2727 4f70 656e 2061  ]:.    '''Open a
+000065a0: 6e20 6173 796e 6368 726f 6e6f 7573 2070  n asynchronous p
+000065b0: 7265 6665 7463 6820 7265 6164 6572 2c20  refetch reader, 
+000065c0: 746f 2073 7570 706f 7274 2066 6173 7420  to support fast 
+000065d0: 7365 7175 656e 7469 616c 2072 6561 640a  sequential read.
+000065e0: 0a20 2020 202e 2e20 6e6f 7465 203a 3a0a  .    .. note ::.
+000065f0: 0a20 2020 2020 2020 2055 7365 7220 7368  .        User sh
+00006600: 6f75 6c64 206d 616b 6520 7375 7265 2074  ould make sure t
+00006610: 6861 7420 7265 6164 6572 202f 2077 7269  hat reader / wri
+00006620: 7465 7220 6172 6520 636c 6f73 6564 2063  ter are closed c
+00006630: 6f72 7265 6374 6c79 0a0a 2020 2020 2020  orrectly..      
+00006640: 2020 5375 7070 6f72 7473 2063 6f6e 7465    Supports conte
+00006650: 7874 206d 616e 6167 6572 0a0a 2020 2020  xt manager..    
+00006660: 2020 2020 536f 6d65 2070 6172 616d 6574      Some paramet
+00006670: 6572 2073 6574 7469 6e67 206d 6179 2070  er setting may p
+00006680: 6572 666f 726d 2077 656c 6c3a 206d 6178  erform well: max
+00006690: 5f63 6f6e 6375 7272 656e 6379 3d31 3020  _concurrency=10 
+000066a0: 6f72 2032 302c 206d 6178 5f62 6c6f 636b  or 20, max_block
+000066b0: 5f73 697a 653d 3820 6f72 2031 3620 4d42  _size=8 or 16 MB
+000066c0: 2c20 6465 6661 756c 7420 7661 6c75 6520  , default value 
+000066d0: 4e6f 6e65 206d 6561 6e73 2075 7369 6e67  None means using
+000066e0: 2067 6c6f 6261 6c20 7468 7265 6164 2070   global thread p
+000066f0: 6f6f 6c0a 0a20 2020 203a 7061 7261 6d20  ool..    :param 
+00006700: 6d61 785f 636f 6e63 7572 7265 6e63 793a  max_concurrency:
+00006710: 204d 6178 2064 6f77 6e6c 6f61 6420 7468   Max download th
+00006720: 7265 6164 206e 756d 6265 722c 204e 6f6e  read number, Non
+00006730: 6520 6279 2064 6566 6175 6c74 0a20 2020  e by default.   
+00006740: 203a 7061 7261 6d20 6d61 785f 6275 6666   :param max_buff
+00006750: 6572 5f73 697a 653a 204d 6178 2063 6163  er_size: Max cac
+00006760: 6865 6420 6275 6666 6572 2073 697a 6520  hed buffer size 
+00006770: 696e 206d 656d 6f72 792c 2031 3238 4d42  in memory, 128MB
+00006780: 2062 7920 6465 6661 756c 740a 2020 2020   by default.    
+00006790: 3a70 6172 616d 2062 6c6f 636b 5f73 697a  :param block_siz
+000067a0: 653a 2053 697a 6520 6f66 2073 696e 676c  e: Size of singl
+000067b0: 6520 626c 6f63 6b2c 2038 4d42 2062 7920  e block, 8MB by 
+000067c0: 6465 6661 756c 742e 2045 6163 6820 626c  default. Each bl
+000067d0: 6f63 6b20 7769 6c6c 2062 6520 7570 6c6f  ock will be uplo
+000067e0: 6164 6564 206f 7220 646f 776e 6c6f 6164  aded or download
+000067f0: 6564 2062 7920 7369 6e67 6c65 2074 6872  ed by single thr
+00006800: 6561 642e 0a20 2020 203a 7061 7261 6d20  ead..    :param 
+00006810: 6c69 6d69 7465 645f 7365 656b 6162 6c65  limited_seekable
+00006820: 3a20 4966 2077 7269 7465 2d68 616e 646c  : If write-handl
+00006830: 6520 7375 7070 6f72 7473 206c 696d 6974  e supports limit
+00006840: 6564 2073 6565 6b20 2862 6f74 6820 6669  ed seek (both fi
+00006850: 6c65 2068 6561 6420 7061 7274 2061 6e64  le head part and
+00006860: 2074 6169 6c20 7061 7274 2063 616e 2073   tail part can s
+00006870: 6565 6b20 626c 6f63 6b5f 7369 7a65 292e  eek block_size).
+00006880: 204e 6f74 6573 3a20 5468 6973 2070 6172   Notes: This par
+00006890: 616d 6574 6572 2061 7265 2076 616c 6964  ameter are valid
+000068a0: 206f 6e6c 7920 666f 7220 7772 6974 652d   only for write-
+000068b0: 6861 6e64 6c65 2e20 5265 6164 2d68 616e  handle. Read-han
+000068c0: 646c 6520 7375 7070 6f72 7420 6172 6269  dle support arbi
+000068d0: 7472 6172 7920 7365 656b 0a20 2020 203a  trary seek.    :
+000068e0: 7265 7475 726e 733a 2041 6e20 6f70 656e  returns: An open
+000068f0: 6564 2053 3350 7265 6665 7463 6852 6561  ed S3PrefetchRea
+00006900: 6465 7220 6f62 6a65 6374 0a20 2020 203a  der object.    :
+00006910: 7261 6973 6573 3a20 5333 4669 6c65 4e6f  raises: S3FileNo
+00006920: 7446 6f75 6e64 4572 726f 720a 2020 2020  tFoundError.    
+00006930: 2727 270a 2020 2020 6966 206d 6f64 6520  '''.    if mode 
+00006940: 6e6f 7420 696e 2028 2772 6227 2c20 2777  not in ('rb', 'w
+00006950: 6227 2c20 2761 6227 2c20 2772 622b 272c  b', 'ab', 'rb+',
+00006960: 2027 7762 2b27 2c20 2761 622b 2729 3a0a   'wb+', 'ab+'):.
+00006970: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00006980: 6c75 6545 7272 6f72 2827 756e 6163 6365  lueError('unacce
+00006990: 7074 6162 6c65 206d 6f64 653a 2025 7227  ptable mode: %r'
+000069a0: 2025 206d 6f64 6529 0a20 2020 2073 335f   % mode).    s3_
+000069b0: 7572 6c20 3d20 5333 5061 7468 2873 335f  url = S3Path(s3_
+000069c0: 7572 6c29 0a20 2020 2069 6620 666f 6c6c  url).    if foll
+000069d0: 6f77 6c69 6e6b 733a 0a20 2020 2020 2020  owlinks:.       
+000069e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+000069f0: 2020 7333 5f75 726c 203d 2073 335f 7572    s3_url = s3_ur
+00006a00: 6c2e 7265 6164 6c69 6e6b 2829 0a20 2020  l.readlink().   
+00006a10: 2020 2020 2065 7863 6570 7420 5333 4e6f       except S3No
+00006a20: 7441 4c69 6e6b 4572 726f 723a 0a20 2020  tALinkError:.   
+00006a30: 2020 2020 2020 2020 2070 6173 730a 0a20           pass.. 
+00006a40: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
+00006a50: 2070 6172 7365 5f73 335f 7572 6c28 7333   parse_s3_url(s3
+00006a60: 5f75 726c 2e70 6174 685f 7769 7468 5f70  _url.path_with_p
+00006a70: 726f 746f 636f 6c29 0a20 2020 2063 6f6e  rotocol).    con
+00006a80: 6669 6720 3d20 626f 746f 636f 7265 2e63  fig = botocore.c
+00006a90: 6f6e 6669 672e 436f 6e66 6967 286d 6178  onfig.Config(max
+00006aa0: 5f70 6f6f 6c5f 636f 6e6e 6563 7469 6f6e  _pool_connection
+00006ab0: 733d 6d61 785f 706f 6f6c 5f63 6f6e 6e65  s=max_pool_conne
+00006ac0: 6374 696f 6e73 290a 2020 2020 636c 6965  ctions).    clie
+00006ad0: 6e74 203d 2067 6574 5f73 335f 636c 6965  nt = get_s3_clie
+00006ae0: 6e74 280a 2020 2020 2020 2020 636f 6e66  nt(.        conf
+00006af0: 6967 3d63 6f6e 6669 672c 0a20 2020 2020  ig=config,.     
+00006b00: 2020 2063 6163 6865 5f6b 6579 3d27 7333     cache_key='s3
+00006b10: 5f66 696c 656c 696b 655f 636c 6965 6e74  _filelike_client
+00006b20: 272c 0a20 2020 2020 2020 2070 726f 6669  ',.        profi
+00006b30: 6c65 5f6e 616d 653d 7333 5f75 726c 2e5f  le_name=s3_url._
+00006b40: 7072 6f66 696c 655f 6e61 6d65 290a 0a20  profile_name).. 
+00006b50: 2020 2069 6620 2761 2720 696e 206d 6f64     if 'a' in mod
+00006b60: 6520 6f72 2027 2b27 2069 6e20 6d6f 6465  e or '+' in mode
+00006b70: 3a0a 2020 2020 2020 2020 6966 2063 6163  :.        if cac
+00006b80: 6865 5f70 6174 6820 6973 204e 6f6e 653a  he_path is None:
+00006b90: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00006ba0: 7572 6e20 5333 4d65 6d6f 7279 4861 6e64  urn S3MemoryHand
+00006bb0: 6c65 7228 6275 636b 6574 2c20 6b65 792c  ler(bucket, key,
+00006bc0: 206d 6f64 652c 2073 335f 636c 6965 6e74   mode, s3_client
+00006bd0: 3d63 6c69 656e 7429 0a20 2020 2020 2020  =client).       
+00006be0: 2072 6574 7572 6e20 5333 4361 6368 6564   return S3Cached
+00006bf0: 4861 6e64 6c65 7228 0a20 2020 2020 2020  Handler(.       
+00006c00: 2020 2020 2062 7563 6b65 742c 206b 6579       bucket, key
+00006c10: 2c20 6d6f 6465 2c20 7333 5f63 6c69 656e  , mode, s3_clien
+00006c20: 743d 636c 6965 6e74 2c20 6361 6368 655f  t=client, cache_
+00006c30: 7061 7468 3d63 6163 6865 5f70 6174 6829  path=cache_path)
+00006c40: 0a0a 2020 2020 6966 206d 6f64 6520 3d3d  ..    if mode ==
+00006c50: 2027 7262 273a 0a20 2020 2020 2020 2023   'rb':.        #
+00006c60: 2041 2072 6f75 6768 2063 6f6e 7665 7273   A rough convers
+00006c70: 696f 6e20 616c 676f 7269 7468 6d20 746f  ion algorithm to
+00006c80: 2061 6c69 676e 2032 2074 7970 6573 206f   align 2 types o
+00006c90: 6620 5265 6164 6572 202f 2057 7269 7465  f Reader / Write
+00006ca0: 7220 7061 7261 6d65 7465 7273 0a20 2020  r parameters.   
+00006cb0: 2020 2020 2023 2054 4f44 4f3a 204f 7074       # TODO: Opt
+00006cc0: 696d 697a 6520 7468 6520 636f 6e76 6572  imize the conver
+00006cd0: 7369 6f6e 2061 6c67 6f72 6974 686d 0a20  sion algorithm. 
+00006ce0: 2020 2020 2020 2062 6c6f 636b 5f63 6170         block_cap
+00006cf0: 6163 6974 7920 3d20 6d61 785f 6275 6666  acity = max_buff
+00006d00: 6572 5f73 697a 6520 2f2f 2062 6c6f 636b  er_size // block
+00006d10: 5f73 697a 650a 2020 2020 2020 2020 6966  _size.        if
+00006d20: 2066 6f72 7761 7264 5f72 6174 696f 2069   forward_ratio i
+00006d30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00006d40: 2020 2020 626c 6f63 6b5f 666f 7277 6172      block_forwar
+00006d50: 6420 3d20 4e6f 6e65 0a20 2020 2020 2020  d = None.       
+00006d60: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00006d70: 2020 2062 6c6f 636b 5f66 6f72 7761 7264     block_forward
+00006d80: 203d 206d 6178 2869 6e74 2862 6c6f 636b   = max(int(block
+00006d90: 5f63 6170 6163 6974 7920 2a20 666f 7277  _capacity * forw
+00006da0: 6172 645f 7261 7469 6f29 2c20 3129 0a20  ard_ratio), 1). 
+00006db0: 2020 2020 2020 2069 6620 7368 6172 655f         if share_
+00006dc0: 6361 6368 655f 6b65 7920 6973 206e 6f74  cache_key is not
+00006dd0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00006de0: 2020 2072 6561 6465 7220 3d20 5333 5368     reader = S3Sh
+00006df0: 6172 6543 6163 6865 5265 6164 6572 280a  areCacheReader(.
+00006e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e10: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
+00006e20: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
+00006e30: 2020 2020 2020 2020 2020 2020 2063 6163               cac
+00006e40: 6865 5f6b 6579 3d73 6861 7265 5f63 6163  he_key=share_cac
+00006e50: 6865 5f6b 6579 2c0a 2020 2020 2020 2020  he_key,.        
+00006e60: 2020 2020 2020 2020 7333 5f63 6c69 656e          s3_clien
+00006e70: 743d 636c 6965 6e74 2c0a 2020 2020 2020  t=client,.      
+00006e80: 2020 2020 2020 2020 2020 6d61 785f 7265            max_re
+00006e90: 7472 6965 733d 6d61 785f 7265 7472 6965  tries=max_retrie
+00006ea0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00006eb0: 2020 206d 6178 5f77 6f72 6b65 7273 3d6d     max_workers=m
+00006ec0: 6178 5f63 6f6e 6375 7272 656e 6379 2c0a  ax_concurrency,.
+00006ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ee0: 626c 6f63 6b5f 7369 7a65 3d62 6c6f 636b  block_size=block
+00006ef0: 5f73 697a 652c 0a20 2020 2020 2020 2020  _size,.         
+00006f00: 2020 2020 2020 2062 6c6f 636b 5f66 6f72         block_for
+00006f10: 7761 7264 3d62 6c6f 636b 5f66 6f72 7761  ward=block_forwa
+00006f20: 7264 290a 2020 2020 2020 2020 656c 7365  rd).        else
+00006f30: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00006f40: 6164 6572 203d 2053 3350 7265 6665 7463  ader = S3Prefetc
+00006f50: 6852 6561 6465 7228 0a20 2020 2020 2020  hReader(.       
+00006f60: 2020 2020 2020 2020 2062 7563 6b65 742c           bucket,
+00006f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006f80: 206b 6579 2c0a 2020 2020 2020 2020 2020   key,.          
+00006f90: 2020 2020 2020 7333 5f63 6c69 656e 743d        s3_client=
+00006fa0: 636c 6965 6e74 2c0a 2020 2020 2020 2020  client,.        
+00006fb0: 2020 2020 2020 2020 6d61 785f 7265 7472          max_retr
+00006fc0: 6965 733d 6d61 785f 7265 7472 6965 732c  ies=max_retries,
+00006fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006fe0: 206d 6178 5f77 6f72 6b65 7273 3d6d 6178   max_workers=max
+00006ff0: 5f63 6f6e 6375 7272 656e 6379 2c0a 2020  _concurrency,.  
+00007000: 2020 2020 2020 2020 2020 2020 2020 626c                bl
+00007010: 6f63 6b5f 6361 7061 6369 7479 3d62 6c6f  ock_capacity=blo
+00007020: 636b 5f63 6170 6163 6974 792c 0a20 2020  ck_capacity,.   
+00007030: 2020 2020 2020 2020 2020 2020 2062 6c6f               blo
+00007040: 636b 5f66 6f72 7761 7264 3d62 6c6f 636b  ck_forward=block
+00007050: 5f66 6f72 7761 7264 2c0a 2020 2020 2020  _forward,.      
+00007060: 2020 2020 2020 2020 2020 626c 6f63 6b5f            block_
+00007070: 7369 7a65 3d62 6c6f 636b 5f73 697a 6529  size=block_size)
+00007080: 0a20 2020 2020 2020 2069 6620 6275 6666  .        if buff
+00007090: 6572 6564 3a0a 2020 2020 2020 2020 2020  ered:.          
+000070a0: 2020 7265 6164 6572 203d 2069 6f2e 4275    reader = io.Bu
+000070b0: 6666 6572 6564 5265 6164 6572 2872 6561  fferedReader(rea
+000070c0: 6465 7229 2020 2320 7079 7479 7065 3a20  der)  # pytype: 
+000070d0: 6469 7361 626c 653d 7772 6f6e 672d 6172  disable=wrong-ar
+000070e0: 672d 7479 7065 730a 2020 2020 2020 2020  g-types.        
+000070f0: 7265 7475 726e 2072 6561 6465 720a 0a20  return reader.. 
+00007100: 2020 2069 6620 6c69 6d69 7465 645f 7365     if limited_se
+00007110: 656b 6162 6c65 3a0a 2020 2020 2020 2020  ekable:.        
+00007120: 7772 6974 6572 203d 2053 334c 696d 6974  writer = S3Limit
+00007130: 6564 5365 656b 6162 6c65 5772 6974 6572  edSeekableWriter
+00007140: 280a 2020 2020 2020 2020 2020 2020 6275  (.            bu
+00007150: 636b 6574 2c0a 2020 2020 2020 2020 2020  cket,.          
+00007160: 2020 6b65 792c 0a20 2020 2020 2020 2020    key,.         
+00007170: 2020 2073 335f 636c 6965 6e74 3d63 6c69     s3_client=cli
+00007180: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
+00007190: 206d 6178 5f77 6f72 6b65 7273 3d6d 6178   max_workers=max
+000071a0: 5f63 6f6e 6375 7272 656e 6379 2c0a 2020  _concurrency,.  
+000071b0: 2020 2020 2020 2020 2020 6d61 785f 6275            max_bu
+000071c0: 6666 6572 5f73 697a 653d 6d61 785f 6275  ffer_size=max_bu
+000071d0: 6666 6572 5f73 697a 652c 0a20 2020 2020  ffer_size,.     
+000071e0: 2020 2020 2020 2062 6c6f 636b 5f73 697a         block_siz
+000071f0: 653d 626c 6f63 6b5f 7369 7a65 290a 2020  e=block_size).  
+00007200: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00007210: 7772 6974 6572 203d 2053 3342 7566 6665  writer = S3Buffe
+00007220: 7265 6457 7269 7465 7228 0a20 2020 2020  redWriter(.     
+00007230: 2020 2020 2020 2062 7563 6b65 742c 0a20         bucket,. 
+00007240: 2020 2020 2020 2020 2020 206b 6579 2c0a             key,.
+00007250: 2020 2020 2020 2020 2020 2020 7333 5f63              s3_c
+00007260: 6c69 656e 743d 636c 6965 6e74 2c0a 2020  lient=client,.  
+00007270: 2020 2020 2020 2020 2020 6d61 785f 776f            max_wo
+00007280: 726b 6572 733d 6d61 785f 636f 6e63 7572  rkers=max_concur
+00007290: 7265 6e63 792c 0a20 2020 2020 2020 2020  rency,.         
+000072a0: 2020 206d 6178 5f62 7566 6665 725f 7369     max_buffer_si
+000072b0: 7a65 3d6d 6178 5f62 7566 6665 725f 7369  ze=max_buffer_si
+000072c0: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
+000072d0: 626c 6f63 6b5f 7369 7a65 3d62 6c6f 636b  block_size=block
+000072e0: 5f73 697a 6529 0a20 2020 2069 6620 6275  _size).    if bu
+000072f0: 6666 6572 6564 3a0a 2020 2020 2020 2020  ffered:.        
+00007300: 7772 6974 6572 203d 2069 6f2e 4275 6666  writer = io.Buff
+00007310: 6572 6564 5772 6974 6572 2877 7269 7465  eredWriter(write
+00007320: 7229 2020 2320 7079 7479 7065 3a20 6469  r)  # pytype: di
+00007330: 7361 626c 653d 7772 6f6e 672d 6172 672d  sable=wrong-arg-
+00007340: 7479 7065 730a 2020 2020 7265 7475 726e  types.    return
+00007350: 2077 7269 7465 720a 0a0a 405f 7333 5f62   writer...@_s3_b
+00007360: 696e 6172 795f 6d6f 6465 0a64 6566 2073  inary_mode.def s
+00007370: 335f 6d65 6d6f 7279 5f6f 7065 6e28 0a20  3_memory_open(. 
+00007380: 2020 2020 2020 2073 335f 7572 6c3a 2050         s3_url: P
+00007390: 6174 684c 696b 652c 206d 6f64 653a 2073  athLike, mode: s
+000073a0: 7472 2c0a 2020 2020 2020 2020 666f 6c6c  tr,.        foll
+000073b0: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+000073c0: 4661 6c73 6529 202d 3e20 5333 4d65 6d6f  False) -> S3Memo
+000073d0: 7279 4861 6e64 6c65 723a 0a20 2020 2027  ryHandler:.    '
+000073e0: 2727 4f70 656e 2061 206d 656d 6f72 792d  ''Open a memory-
+000073f0: 6361 6368 6520 6669 6c65 2072 6561 6465  cache file reade
+00007400: 7220 2f20 7772 6974 6572 2c20 666f 7220  r / writer, for 
+00007410: 6672 6571 7565 6e74 2072 616e 646f 6d20  frequent random 
+00007420: 7265 6164 202f 2077 7269 7465 0a0a 2020  read / write..  
+00007430: 2020 2e2e 206e 6f74 6520 3a3a 0a0a 2020    .. note ::..  
+00007440: 2020 2020 2020 5573 6572 2073 686f 756c        User shoul
+00007450: 6420 6d61 6b65 2073 7572 6520 7468 6174  d make sure that
+00007460: 2072 6561 6465 7220 2f20 7772 6974 6572   reader / writer
+00007470: 2061 7265 2063 6c6f 7365 6420 636f 7272   are closed corr
+00007480: 6563 746c 790a 0a20 2020 2020 2020 2053  ectly..        S
+00007490: 7570 706f 7274 7320 636f 6e74 6578 7420  upports context 
+000074a0: 6d61 6e61 6765 720a 0a20 2020 203a 7061  manager..    :pa
+000074b0: 7261 6d20 6d6f 6465 3a20 4d6f 6465 2074  ram mode: Mode t
+000074c0: 6f20 6f70 656e 2066 696c 652c 2063 6f75  o open file, cou
+000074d0: 6c64 2062 6520 6f6e 6520 6f66 2022 7262  ld be one of "rb
+000074e0: 222c 2022 7762 222c 2022 6162 222c 2022  ", "wb", "ab", "
+000074f0: 7262 2b22 2c20 2277 622b 2220 6f72 2022  rb+", "wb+" or "
+00007500: 6162 2b22 0a20 2020 203a 7265 7475 726e  ab+".    :return
+00007510: 733a 2041 6e20 6f70 656e 6564 2042 7566  s: An opened Buf
+00007520: 6665 7265 6452 6561 6465 7220 2f20 4275  feredReader / Bu
+00007530: 6666 6572 6564 5772 6974 6572 206f 626a  fferedWriter obj
+00007540: 6563 740a 2020 2020 2727 270a 2020 2020  ect.    '''.    
+00007550: 6966 206d 6f64 6520 6e6f 7420 696e 2028  if mode not in (
+00007560: 2772 6227 2c20 2777 6227 2c20 2761 6227  'rb', 'wb', 'ab'
+00007570: 2c20 2772 622b 272c 2027 7762 2b27 2c20  , 'rb+', 'wb+', 
+00007580: 2761 622b 2729 3a0a 2020 2020 2020 2020  'ab+'):.        
+00007590: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000075a0: 2827 756e 6163 6365 7074 6162 6c65 206d  ('unacceptable m
+000075b0: 6f64 653a 2025 7227 2025 206d 6f64 6529  ode: %r' % mode)
+000075c0: 0a20 2020 2073 335f 7572 6c20 3d20 5333  .    s3_url = S3
+000075d0: 5061 7468 2873 335f 7572 6c29 0a20 2020  Path(s3_url).   
+000075e0: 2069 6620 666f 6c6c 6f77 6c69 6e6b 733a   if followlinks:
+000075f0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00007600: 2020 2020 2020 2020 2020 7333 5f75 726c            s3_url
+00007610: 203d 2073 335f 7572 6c2e 7265 6164 6c69   = s3_url.readli
+00007620: 6e6b 2829 0a20 2020 2020 2020 2065 7863  nk().        exc
+00007630: 6570 7420 5333 4e6f 7441 4c69 6e6b 4572  ept S3NotALinkEr
+00007640: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+00007650: 2070 6173 730a 0a20 2020 2062 7563 6b65   pass..    bucke
+00007660: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+00007670: 335f 7572 6c28 7333 5f75 726c 2e70 6174  3_url(s3_url.pat
+00007680: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+00007690: 0a20 2020 2063 6f6e 6669 6720 3d20 626f  .    config = bo
+000076a0: 746f 636f 7265 2e63 6f6e 6669 672e 436f  tocore.config.Co
+000076b0: 6e66 6967 286d 6178 5f70 6f6f 6c5f 636f  nfig(max_pool_co
+000076c0: 6e6e 6563 7469 6f6e 733d 6d61 785f 706f  nnections=max_po
+000076d0: 6f6c 5f63 6f6e 6e65 6374 696f 6e73 290a  ol_connections).
+000076e0: 2020 2020 636c 6965 6e74 203d 2067 6574      client = get
+000076f0: 5f73 335f 636c 6965 6e74 280a 2020 2020  _s3_client(.    
+00007700: 2020 2020 636f 6e66 6967 3d63 6f6e 6669      config=confi
+00007710: 672c 0a20 2020 2020 2020 2063 6163 6865  g,.        cache
+00007720: 5f6b 6579 3d27 7333 5f66 696c 656c 696b  _key='s3_filelik
+00007730: 655f 636c 6965 6e74 272c 0a20 2020 2020  e_client',.     
+00007740: 2020 2070 726f 6669 6c65 5f6e 616d 653d     profile_name=
+00007750: 7333 5f75 726c 2e5f 7072 6f66 696c 655f  s3_url._profile_
+00007760: 6e61 6d65 290a 2020 2020 7265 7475 726e  name).    return
+00007770: 2053 334d 656d 6f72 7948 616e 646c 6572   S3MemoryHandler
+00007780: 2862 7563 6b65 742c 206b 6579 2c20 6d6f  (bucket, key, mo
+00007790: 6465 2c20 7333 5f63 6c69 656e 743d 636c  de, s3_client=cl
+000077a0: 6965 6e74 290a 0a0a 7333 5f6f 7065 6e20  ient)...s3_open 
+000077b0: 3d20 7333 5f62 7566 6665 7265 645f 6f70  = s3_buffered_op
+000077c0: 656e 0a0a 0a64 6566 2073 335f 646f 776e  en...def s3_down
+000077d0: 6c6f 6164 280a 2020 2020 2020 2020 7372  load(.        sr
+000077e0: 635f 7572 6c3a 2050 6174 684c 696b 652c  c_url: PathLike,
+000077f0: 0a20 2020 2020 2020 2064 7374 5f75 726c  .        dst_url
+00007800: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
+00007810: 2020 2020 666f 6c6c 6f77 6c69 6e6b 733a      followlinks:
+00007820: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00007830: 2020 2020 2020 2063 616c 6c62 6163 6b3a         callback:
+00007840: 204f 7074 696f 6e61 6c5b 4361 6c6c 6162   Optional[Callab
+00007850: 6c65 5b5b 696e 745d 2c20 4e6f 6e65 5d5d  le[[int], None]]
+00007860: 203d 204e 6f6e 6529 202d 3e20 4e6f 6e65   = None) -> None
+00007870: 3a0a 2020 2020 2727 270a 2020 2020 446f  :.    '''.    Do
+00007880: 776e 6c6f 6164 7320 6120 6669 6c65 2066  wnloads a file f
+00007890: 726f 6d20 7333 2074 6f20 6c6f 6361 6c20  rom s3 to local 
+000078a0: 6669 6c65 7379 7374 656d 2e0a 2020 2020  filesystem..    
+000078b0: 3a70 6172 616d 2073 7263 5f75 726c 3a20  :param src_url: 
+000078c0: 736f 7572 6365 2073 3320 7061 7468 0a20  source s3 path. 
+000078d0: 2020 203a 7061 7261 6d20 6473 745f 7572     :param dst_ur
+000078e0: 6c3a 2074 6172 6765 7420 6673 2070 6174  l: target fs pat
+000078f0: 680a 2020 2020 3a70 6172 616d 2063 616c  h.    :param cal
+00007900: 6c62 6163 6b3a 2043 616c 6c65 6420 7065  lback: Called pe
+00007910: 7269 6f64 6963 616c 6c79 2064 7572 696e  riodically durin
+00007920: 6720 636f 7079 2c20 616e 6420 7468 6520  g copy, and the 
+00007930: 696e 7075 7420 7061 7261 6d65 7465 7220  input parameter 
+00007940: 6973 2074 6865 2064 6174 6120 7369 7a65  is the data size
+00007950: 2028 696e 2062 7974 6573 2920 6f66 2063   (in bytes) of c
+00007960: 6f70 7920 7369 6e63 6520 7468 6520 6c61  opy since the la
+00007970: 7374 2063 616c 6c0a 2020 2020 2727 270a  st call.    '''.
+00007980: 2020 2020 6672 6f6d 206d 6567 6669 6c65      from megfile
+00007990: 2e66 7320 696d 706f 7274 2069 735f 6673  .fs import is_fs
+000079a0: 0a20 2020 2066 726f 6d20 6d65 6766 696c  .    from megfil
+000079b0: 652e 6673 5f70 6174 6820 696d 706f 7274  e.fs_path import
+000079c0: 2046 5350 6174 680a 0a20 2020 2073 7263   FSPath..    src
+000079d0: 5f75 726c 203d 2053 3350 6174 6828 7372  _url = S3Path(sr
+000079e0: 635f 7572 6c29 0a20 2020 2069 6620 666f  c_url).    if fo
+000079f0: 6c6c 6f77 6c69 6e6b 733a 0a20 2020 2020  llowlinks:.     
+00007a00: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00007a10: 2020 2020 7372 635f 7572 6c20 3d20 7372      src_url = sr
+00007a20: 635f 7572 6c2e 7265 6164 6c69 6e6b 2829  c_url.readlink()
+00007a30: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00007a40: 5333 4e6f 7441 4c69 6e6b 4572 726f 723a  S3NotALinkError:
+00007a50: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+00007a60: 730a 2020 2020 7372 635f 6275 636b 6574  s.    src_bucket
+00007a70: 2c20 7372 635f 6b65 7920 3d20 7061 7273  , src_key = pars
+00007a80: 655f 7333 5f75 726c 2873 7263 5f75 726c  e_s3_url(src_url
+00007a90: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00007aa0: 636f 6c29 0a20 2020 2069 6620 6e6f 7420  col).    if not 
+00007ab0: 7372 635f 6275 636b 6574 3a0a 2020 2020  src_bucket:.    
+00007ac0: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
+00007ad0: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
+00007ae0: 0a20 2020 2020 2020 2020 2020 2027 456d  .            'Em
+00007af0: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
+00007b00: 2025 7227 2025 2073 7263 5f75 726c 2e70   %r' % src_url.p
+00007b10: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00007b20: 6c29 0a0a 2020 2020 6966 206e 6f74 2073  l)..    if not s
+00007b30: 7263 5f75 726c 2e65 7869 7374 7328 293a  rc_url.exists():
+00007b40: 0a20 2020 2020 2020 2072 6169 7365 2053  .        raise S
+00007b50: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
+00007b60: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00007b70: 2746 696c 6520 6e6f 7420 666f 756e 643a  'File not found:
+00007b80: 2025 7227 2025 2073 7263 5f75 726c 2e70   %r' % src_url.p
+00007b90: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00007ba0: 6c29 0a0a 2020 2020 6966 206e 6f74 2073  l)..    if not s
+00007bb0: 7263 5f75 726c 2e69 735f 6669 6c65 2829  rc_url.is_file()
+00007bc0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00007bd0: 5333 4973 4144 6972 6563 746f 7279 4572  S3IsADirectoryEr
+00007be0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00007bf0: 2027 4973 2061 2064 6972 6563 746f 7279   'Is a directory
+00007c00: 3a20 2572 2720 2520 7372 635f 7572 6c2e  : %r' % src_url.
+00007c10: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+00007c20: 6f6c 290a 0a20 2020 2064 7374 5f75 726c  ol)..    dst_url
+00007c30: 203d 2066 7370 6174 6828 6473 745f 7572   = fspath(dst_ur
+00007c40: 6c29 0a20 2020 2069 6620 6e6f 7420 6973  l).    if not is
+00007c50: 5f66 7328 6473 745f 7572 6c29 3a0a 2020  _fs(dst_url):.  
+00007c60: 2020 2020 2020 7261 6973 6520 4f53 4572        raise OSEr
+00007c70: 726f 7228 6627 6473 745f 7572 6c20 6973  ror(f'dst_url is
+00007c80: 206e 6f74 2066 7320 7061 7468 3a20 7b64   not fs path: {d
+00007c90: 7374 5f75 726c 7d27 290a 2020 2020 6966  st_url}').    if
+00007ca0: 206e 6f74 2064 7374 5f75 726c 206f 7220   not dst_url or 
+00007cb0: 6473 745f 7572 6c2e 656e 6473 7769 7468  dst_url.endswith
+00007cc0: 2827 2f27 293a 0a20 2020 2020 2020 2072  ('/'):.        r
+00007cd0: 6169 7365 2053 3349 7341 4469 7265 6374  aise S3IsADirect
+00007ce0: 6f72 7945 7272 6f72 2827 4973 2061 2064  oryError('Is a d
+00007cf0: 6972 6563 746f 7279 3a20 2572 2720 2520  irectory: %r' % 
+00007d00: 6473 745f 7572 6c29 0a0a 2020 2020 6473  dst_url)..    ds
+00007d10: 745f 7061 7468 203d 2046 5350 6174 6828  t_path = FSPath(
+00007d20: 6473 745f 7572 6c29 0a20 2020 2064 7374  dst_url).    dst
+00007d30: 5f64 6972 6563 746f 7279 203d 206f 732e  _directory = os.
+00007d40: 7061 7468 2e64 6972 6e61 6d65 2864 7374  path.dirname(dst
+00007d50: 5f70 6174 682e 7061 7468 5f77 6974 686f  _path.path_witho
+00007d60: 7574 5f70 726f 746f 636f 6c29 0a20 2020  ut_protocol).   
+00007d70: 2069 6620 6473 745f 6469 7265 6374 6f72   if dst_director
+00007d80: 7920 213d 2027 273a 0a20 2020 2020 2020  y != '':.       
+00007d90: 206f 732e 6d61 6b65 6469 7273 2864 7374   os.makedirs(dst
+00007da0: 5f64 6972 6563 746f 7279 2c20 6578 6973  _directory, exis
+00007db0: 745f 6f6b 3d54 7275 6529 0a0a 2020 2020  t_ok=True)..    
+00007dc0: 636c 6965 6e74 203d 2067 6574 5f73 335f  client = get_s3_
+00007dd0: 636c 6965 6e74 2870 726f 6669 6c65 5f6e  client(profile_n
+00007de0: 616d 653d 7372 635f 7572 6c2e 5f70 726f  ame=src_url._pro
+00007df0: 6669 6c65 5f6e 616d 6529 0a20 2020 2074  file_name).    t
+00007e00: 7279 3a0a 2020 2020 2020 2020 636c 6965  ry:.        clie
+00007e10: 6e74 2e64 6f77 6e6c 6f61 645f 6669 6c65  nt.download_file
+00007e20: 280a 2020 2020 2020 2020 2020 2020 7372  (.            sr
+00007e30: 635f 6275 636b 6574 2c0a 2020 2020 2020  c_bucket,.      
+00007e40: 2020 2020 2020 7372 635f 6b65 792c 0a20        src_key,. 
+00007e50: 2020 2020 2020 2020 2020 2064 7374 5f70             dst_p
+00007e60: 6174 682e 7061 7468 5f77 6974 686f 7574  ath.path_without
+00007e70: 5f70 726f 746f 636f 6c2c 0a20 2020 2020  _protocol,.     
+00007e80: 2020 2020 2020 2043 616c 6c62 6163 6b3d         Callback=
+00007e90: 6361 6c6c 6261 636b 290a 2020 2020 6578  callback).    ex
+00007ea0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+00007eb0: 7320 6572 726f 723a 0a20 2020 2020 2020  s error:.       
+00007ec0: 2065 7272 6f72 203d 2074 7261 6e73 6c61   error = transla
+00007ed0: 7465 5f66 735f 6572 726f 7228 6572 726f  te_fs_error(erro
+00007ee0: 722c 2064 7374 5f75 726c 290a 2020 2020  r, dst_url).    
+00007ef0: 2020 2020 6572 726f 7220 3d20 7472 616e      error = tran
+00007f00: 736c 6174 655f 7333 5f65 7272 6f72 2865  slate_s3_error(e
+00007f10: 7272 6f72 2c20 7372 635f 7572 6c2e 7061  rror, src_url.pa
+00007f20: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+00007f30: 290a 2020 2020 2020 2020 7261 6973 6520  ).        raise 
+00007f40: 6572 726f 720a 0a20 2020 2073 7263 5f73  error..    src_s
+00007f50: 7461 7420 3d20 7372 635f 7572 6c2e 7374  tat = src_url.st
+00007f60: 6174 2829 0a20 2020 206f 732e 7574 696d  at().    os.utim
+00007f70: 6528 0a20 2020 2020 2020 2064 7374 5f70  e(.        dst_p
+00007f80: 6174 682e 7061 7468 5f77 6974 686f 7574  ath.path_without
+00007f90: 5f70 726f 746f 636f 6c2c 2028 7372 635f  _protocol, (src_
+00007fa0: 7374 6174 2e73 745f 6d74 696d 652c 2073  stat.st_mtime, s
+00007fb0: 7263 5f73 7461 742e 7374 5f6d 7469 6d65  rc_stat.st_mtime
+00007fc0: 2929 0a0a 0a64 6566 2073 335f 7570 6c6f  ))...def s3_uplo
+00007fd0: 6164 280a 2020 2020 2020 2020 7372 635f  ad(.        src_
+00007fe0: 7572 6c3a 2050 6174 684c 696b 652c 0a20  url: PathLike,. 
+00007ff0: 2020 2020 2020 2064 7374 5f75 726c 3a20         dst_url: 
+00008000: 5061 7468 4c69 6b65 2c0a 2020 2020 2020  PathLike,.      
+00008010: 2020 6361 6c6c 6261 636b 3a20 4f70 7469    callback: Opti
+00008020: 6f6e 616c 5b43 616c 6c61 626c 655b 5b69  onal[Callable[[i
+00008030: 6e74 5d2c 204e 6f6e 655d 5d20 3d20 4e6f  nt], None]] = No
+00008040: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+00008050: 6172 6773 2920 2d3e 204e 6f6e 653a 0a20  args) -> None:. 
+00008060: 2020 2027 2727 0a20 2020 2055 706c 6f61     '''.    Uploa
+00008070: 6473 2061 2066 696c 6520 6672 6f6d 206c  ds a file from l
+00008080: 6f63 616c 2066 696c 6573 7973 7465 6d20  ocal filesystem 
+00008090: 746f 2073 332e 0a20 2020 203a 7061 7261  to s3..    :para
+000080a0: 6d20 7372 635f 7572 6c3a 2073 6f75 7263  m src_url: sourc
+000080b0: 6520 6673 2070 6174 680a 2020 2020 3a70  e fs path.    :p
+000080c0: 6172 616d 2064 7374 5f75 726c 3a20 7461  aram dst_url: ta
+000080d0: 7267 6574 2073 3320 7061 7468 0a20 2020  rget s3 path.   
+000080e0: 203a 7061 7261 6d20 6361 6c6c 6261 636b   :param callback
+000080f0: 3a20 4361 6c6c 6564 2070 6572 696f 6469  : Called periodi
+00008100: 6361 6c6c 7920 6475 7269 6e67 2063 6f70  cally during cop
+00008110: 792c 2061 6e64 2074 6865 2069 6e70 7574  y, and the input
+00008120: 2070 6172 616d 6574 6572 2069 7320 7468   parameter is th
+00008130: 6520 6461 7461 2073 697a 6520 2869 6e20  e data size (in 
+00008140: 6279 7465 7329 206f 6620 636f 7079 2073  bytes) of copy s
+00008150: 696e 6365 2074 6865 206c 6173 7420 6361  ince the last ca
+00008160: 6c6c 0a20 2020 2027 2727 0a20 2020 2066  ll.    '''.    f
+00008170: 726f 6d20 6d65 6766 696c 652e 6673 2069  rom megfile.fs i
+00008180: 6d70 6f72 7420 6973 5f66 730a 2020 2020  mport is_fs.    
+00008190: 6672 6f6d 206d 6567 6669 6c65 2e66 735f  from megfile.fs_
+000081a0: 7061 7468 2069 6d70 6f72 7420 4653 5061  path import FSPa
+000081b0: 7468 0a0a 2020 2020 6966 206e 6f74 2069  th..    if not i
+000081c0: 735f 6673 2873 7263 5f75 726c 293a 0a20  s_fs(src_url):. 
+000081d0: 2020 2020 2020 2072 6169 7365 204f 5345         raise OSE
+000081e0: 7272 6f72 2866 2773 7263 5f75 726c 2069  rror(f'src_url i
+000081f0: 7320 6e6f 7420 6673 2070 6174 683a 207b  s not fs path: {
+00008200: 7372 635f 7572 6c7d 2729 0a20 2020 2073  src_url}').    s
+00008210: 7263 5f70 6174 6820 3d20 4653 5061 7468  rc_path = FSPath
+00008220: 2873 7263 5f75 726c 290a 0a20 2020 2064  (src_url)..    d
+00008230: 7374 5f62 7563 6b65 742c 2064 7374 5f6b  st_bucket, dst_k
+00008240: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
+00008250: 6c28 6473 745f 7572 6c29 0a20 2020 2069  l(dst_url).    i
+00008260: 6620 6e6f 7420 6473 745f 6275 636b 6574  f not dst_bucket
+00008270: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00008280: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+00008290: 4572 726f 7228 2745 6d70 7479 2062 7563  Error('Empty buc
+000082a0: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
+000082b0: 6473 745f 7572 6c29 0a20 2020 2069 6620  dst_url).    if 
+000082c0: 6e6f 7420 6473 745f 6b65 7920 6f72 2064  not dst_key or d
+000082d0: 7374 5f6b 6579 2e65 6e64 7377 6974 6828  st_key.endswith(
+000082e0: 272f 2729 3a0a 2020 2020 2020 2020 7261  '/'):.        ra
+000082f0: 6973 6520 5333 4973 4144 6972 6563 746f  ise S3IsADirecto
+00008300: 7279 4572 726f 7228 2749 7320 6120 6469  ryError('Is a di
+00008310: 7265 6374 6f72 793a 2025 7227 2025 2064  rectory: %r' % d
+00008320: 7374 5f75 726c 290a 0a20 2020 2063 6c69  st_url)..    cli
+00008330: 656e 7420 3d20 6765 745f 7333 5f63 6c69  ent = get_s3_cli
+00008340: 656e 7428 7072 6f66 696c 655f 6e61 6d65  ent(profile_name
+00008350: 3d53 3350 6174 6828 6473 745f 7572 6c29  =S3Path(dst_url)
+00008360: 2e5f 7072 6f66 696c 655f 6e61 6d65 290a  ._profile_name).
+00008370: 2020 2020 7769 7468 206f 7065 6e28 7372      with open(sr
+00008380: 635f 7061 7468 2e70 6174 685f 7769 7468  c_path.path_with
+00008390: 6f75 745f 7072 6f74 6f63 6f6c 2c20 2772  out_protocol, 'r
+000083a0: 6227 2920 6173 2073 7263 3a0a 2020 2020  b') as src:.    
+000083b0: 2020 2020 7769 7468 2072 6169 7365 5f73      with raise_s
+000083c0: 335f 6572 726f 7228 6473 745f 7572 6c29  3_error(dst_url)
+000083d0: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+000083e0: 6965 6e74 2e75 706c 6f61 645f 6669 6c65  ient.upload_file
+000083f0: 6f62 6a28 0a20 2020 2020 2020 2020 2020  obj(.           
+00008400: 2020 2020 2073 7263 2c20 4275 636b 6574       src, Bucket
+00008410: 3d64 7374 5f62 7563 6b65 742c 204b 6579  =dst_bucket, Key
+00008420: 3d64 7374 5f6b 6579 2c20 4361 6c6c 6261  =dst_key, Callba
+00008430: 636b 3d63 616c 6c62 6163 6b29 0a0a 0a64  ck=callback)...d
+00008440: 6566 2073 335f 6c6f 6164 5f63 6f6e 7465  ef s3_load_conte
+00008450: 6e74 280a 2020 2020 2020 2020 7333 5f75  nt(.        s3_u
+00008460: 726c 2c0a 2020 2020 2020 2020 7374 6172  rl,.        star
+00008470: 743a 204f 7074 696f 6e61 6c5b 696e 745d  t: Optional[int]
+00008480: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00008490: 2073 746f 703a 204f 7074 696f 6e61 6c5b   stop: Optional[
+000084a0: 696e 745d 203d 204e 6f6e 652c 0a20 2020  int] = None,.   
+000084b0: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
+000084c0: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
+000084d0: 2d3e 2062 7974 6573 3a0a 2020 2020 2727  -> bytes:.    ''
+000084e0: 270a 2020 2020 4765 7420 7370 6563 6966  '.    Get specif
+000084f0: 6965 6420 6669 6c65 2066 726f 6d20 5b73  ied file from [s
+00008500: 7461 7274 2c20 7374 6f70 2920 696e 2062  tart, stop) in b
+00008510: 7974 6573 0a0a 2020 2020 3a70 6172 616d  ytes..    :param
+00008520: 2073 335f 7572 6c3a 2053 7065 6369 6669   s3_url: Specifi
+00008530: 6564 2070 6174 680a 2020 2020 3a70 6172  ed path.    :par
+00008540: 616d 2073 7461 7274 3a20 7374 6172 7420  am start: start 
+00008550: 696e 6465 780a 2020 2020 3a70 6172 616d  index.    :param
+00008560: 2073 746f 703a 2073 746f 7020 696e 6465   stop: stop inde
+00008570: 780a 2020 2020 3a72 6574 7572 6e73 3a20  x.    :returns: 
+00008580: 6279 7465 7320 636f 6e74 656e 7420 696e  bytes content in
+00008590: 2072 616e 6765 205b 7374 6172 742c 2073   range [start, s
+000085a0: 746f 7029 0a20 2020 2027 2727 0a0a 2020  top).    '''..  
+000085b0: 2020 6465 6620 5f67 6574 5f6f 626a 6563    def _get_objec
+000085c0: 7428 636c 6965 6e74 2c20 6275 636b 6574  t(client, bucket
+000085d0: 2c20 6b65 792c 2072 616e 6765 5f73 7472  , key, range_str
+000085e0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+000085f0: 6e20 636c 6965 6e74 2e67 6574 5f6f 626a  n client.get_obj
+00008600: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
+00008610: 2042 7563 6b65 743d 6275 636b 6574 2c20   Bucket=bucket, 
+00008620: 4b65 793d 6b65 792c 2052 616e 6765 3d72  Key=key, Range=r
+00008630: 616e 6765 5f73 7472 295b 2742 6f64 7927  ange_str)['Body'
+00008640: 5d2e 7265 6164 2829 0a0a 2020 2020 7333  ].read()..    s3
+00008650: 5f75 726c 203d 2053 3350 6174 6828 7333  _url = S3Path(s3
+00008660: 5f75 726c 290a 2020 2020 6966 2066 6f6c  _url).    if fol
+00008670: 6c6f 776c 696e 6b73 3a0a 2020 2020 2020  lowlinks:.      
+00008680: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00008690: 2020 2073 335f 7572 6c20 3d20 7333 5f75     s3_url = s3_u
+000086a0: 726c 2e72 6561 646c 696e 6b28 290a 2020  rl.readlink().  
+000086b0: 2020 2020 2020 6578 6365 7074 2053 334e        except S3N
+000086c0: 6f74 414c 696e 6b45 7272 6f72 3a0a 2020  otALinkError:.  
+000086d0: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
+000086e0: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
+000086f0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
+00008700: 335f 7572 6c2e 7061 7468 5f77 6974 685f  3_url.path_with_
+00008710: 7072 6f74 6f63 6f6c 290a 2020 2020 6966  protocol).    if
+00008720: 206e 6f74 2062 7563 6b65 743a 0a20 2020   not bucket:.   
+00008730: 2020 2020 2072 6169 7365 2053 3342 7563       raise S3Buc
+00008740: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
+00008750: 2827 456d 7074 7920 6275 636b 6574 206e  ('Empty bucket n
+00008760: 616d 653a 2025 7227 2025 2073 335f 7572  ame: %r' % s3_ur
+00008770: 6c29 0a20 2020 2069 6620 6e6f 7420 6b65  l).    if not ke
+00008780: 7920 6f72 206b 6579 2e65 6e64 7377 6974  y or key.endswit
+00008790: 6828 272f 2729 3a0a 2020 2020 2020 2020  h('/'):.        
+000087a0: 7261 6973 6520 5333 4973 4144 6972 6563  raise S3IsADirec
+000087b0: 746f 7279 4572 726f 7228 2749 7320 6120  toryError('Is a 
+000087c0: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
+000087d0: 2073 335f 7572 6c29 0a0a 2020 2020 7374   s3_url)..    st
+000087e0: 6172 742c 2073 746f 7020 3d20 6765 745f  art, stop = get_
+000087f0: 636f 6e74 656e 745f 6f66 6673 6574 280a  content_offset(.
+00008800: 2020 2020 2020 2020 7374 6172 742c 2073          start, s
+00008810: 746f 702c 2073 335f 7572 6c2e 6765 7473  top, s3_url.gets
+00008820: 697a 6528 666f 6c6c 6f77 5f73 796d 6c69  ize(follow_symli
+00008830: 6e6b 733d 4661 6c73 6529 290a 2020 2020  nks=False)).    
+00008840: 6966 2073 7461 7274 203d 3d20 3020 616e  if start == 0 an
+00008850: 6420 7374 6f70 203d 3d20 303a 0a20 2020  d stop == 0:.   
+00008860: 2020 2020 2072 6574 7572 6e20 6227 270a       return b''.
+00008870: 2020 2020 7261 6e67 655f 7374 7220 3d20      range_str = 
+00008880: 2762 7974 6573 3d25 642d 2564 2720 2520  'bytes=%d-%d' % 
+00008890: 2873 7461 7274 2c20 7374 6f70 202d 2031  (start, stop - 1
+000088a0: 290a 0a20 2020 2063 6c69 656e 7420 3d20  )..    client = 
+000088b0: 6765 745f 7333 5f63 6c69 656e 7428 7072  get_s3_client(pr
+000088c0: 6f66 696c 655f 6e61 6d65 3d73 335f 7572  ofile_name=s3_ur
+000088d0: 6c2e 5f70 726f 6669 6c65 5f6e 616d 6529  l._profile_name)
+000088e0: 0a20 2020 2077 6974 6820 7261 6973 655f  .    with raise_
+000088f0: 7333 5f65 7272 6f72 2873 335f 7572 6c2e  s3_error(s3_url.
+00008900: 7061 7468 293a 0a20 2020 2020 2020 2072  path):.        r
+00008910: 6574 7572 6e20 7061 7463 685f 6d65 7468  eturn patch_meth
+00008920: 6f64 280a 2020 2020 2020 2020 2020 2020  od(.            
+00008930: 5f67 6574 5f6f 626a 6563 742c 0a20 2020  _get_object,.   
+00008940: 2020 2020 2020 2020 206d 6178 5f72 6574           max_ret
+00008950: 7269 6573 3d6d 6178 5f72 6574 7269 6573  ries=max_retries
+00008960: 2c0a 2020 2020 2020 2020 2020 2020 7368  ,.            sh
+00008970: 6f75 6c64 5f72 6574 7279 3d73 335f 7368  ould_retry=s3_sh
+00008980: 6f75 6c64 5f72 6574 7279 2c0a 2020 2020  ould_retry,.    
+00008990: 2020 2020 2928 636c 6965 6e74 2c20 6275      )(client, bu
+000089a0: 636b 6574 2c20 6b65 792c 2072 616e 6765  cket, key, range
+000089b0: 5f73 7472 290a 0a0a 6465 6620 7333 5f72  _str)...def s3_r
+000089c0: 6561 646c 696e 6b28 7061 7468 2920 2d3e  eadlink(path) ->
+000089d0: 2073 7472 3a0a 2020 2020 2727 270a 2020   str:.    '''.  
+000089e0: 2020 5265 7475 726e 2061 2073 7472 696e    Return a strin
+000089f0: 6720 7265 7072 6573 656e 7469 6e67 2074  g representing t
+00008a00: 6865 2070 6174 6820 746f 2077 6869 6368  he path to which
+00008a10: 2074 6865 2073 796d 626f 6c69 6320 6c69   the symbolic li
+00008a20: 6e6b 2070 6f69 6e74 732e 0a0a 2020 2020  nk points...    
+00008a30: 3a72 6574 7572 6e73 3a20 5265 7475 726e  :returns: Return
+00008a40: 2061 2073 7472 696e 6720 7265 7072 6573   a string repres
+00008a50: 656e 7469 6e67 2074 6865 2070 6174 6820  enting the path 
+00008a60: 746f 2077 6869 6368 2074 6865 2073 796d  to which the sym
+00008a70: 626f 6c69 6320 6c69 6e6b 2070 6f69 6e74  bolic link point
+00008a80: 732e 0a20 2020 203a 7261 6973 6573 3a20  s..    :raises: 
+00008a90: 5333 4e61 6d65 546f 6f4c 6f6e 6745 7272  S3NameTooLongErr
+00008aa0: 6f72 2c20 5333 4275 636b 6574 4e6f 7446  or, S3BucketNotF
+00008ab0: 6f75 6e64 4572 726f 722c 2053 3349 7341  oundError, S3IsA
+00008ac0: 4469 7265 6374 6f72 7945 7272 6f72 2c20  DirectoryError, 
+00008ad0: 5333 4e6f 7441 4c69 6e6b 4572 726f 720a  S3NotALinkError.
+00008ae0: 2020 2020 2727 270a 2020 2020 7265 7475      '''.    retu
+00008af0: 726e 2053 3350 6174 6828 7061 7468 292e  rn S3Path(path).
+00008b00: 7265 6164 6c69 6e6b 2829 2e70 6174 685f  readlink().path_
+00008b10: 7769 7468 5f70 726f 746f 636f 6c0a 0a0a  with_protocol...
+00008b20: 6465 6620 7333 5f72 656e 616d 6528 7372  def s3_rename(sr
+00008b30: 635f 7572 6c3a 2050 6174 684c 696b 652c  c_url: PathLike,
+00008b40: 2064 7374 5f75 726c 3a20 5061 7468 4c69   dst_url: PathLi
+00008b50: 6b65 293a 0a20 2020 2027 2727 0a20 2020  ke):.    '''.   
+00008b60: 204d 6f76 6520 7333 2066 696c 6520 7061   Move s3 file pa
+00008b70: 7468 2066 726f 6d20 7372 635f 7572 6c20  th from src_url 
+00008b80: 746f 2064 7374 5f75 726c 0a0a 2020 2020  to dst_url..    
+00008b90: 3a70 6172 616d 2064 7374 5f75 726c 3a20  :param dst_url: 
+00008ba0: 4769 7665 6e20 6465 7374 696e 6174 696f  Given destinatio
+00008bb0: 6e20 7061 7468 0a20 2020 2027 2727 0a20  n path.    '''. 
+00008bc0: 2020 2073 7263 5f70 6174 685f 696e 7320     src_path_ins 
+00008bd0: 3d20 5333 5061 7468 2873 7263 5f75 726c  = S3Path(src_url
+00008be0: 290a 2020 2020 6966 2073 7263 5f70 6174  ).    if src_pat
+00008bf0: 685f 696e 732e 6973 5f66 696c 6528 293a  h_ins.is_file():
+00008c00: 0a20 2020 2020 2020 2073 7263 5f70 6174  .        src_pat
+00008c10: 685f 696e 732e 636f 7079 2864 7374 5f75  h_ins.copy(dst_u
+00008c20: 726c 290a 2020 2020 656c 7365 3a0a 2020  rl).    else:.  
+00008c30: 2020 2020 2020 7372 635f 7061 7468 5f69        src_path_i
+00008c40: 6e73 2e73 796e 6328 6473 745f 7572 6c29  ns.sync(dst_url)
+00008c50: 0a20 2020 2073 7263 5f70 6174 685f 696e  .    src_path_in
+00008c60: 732e 7265 6d6f 7665 2829 0a0a 0a63 6c61  s.remove()...cla
+00008c70: 7373 2053 3343 6163 6865 7228 4669 6c65  ss S3Cacher(File
+00008c80: 4361 6368 6572 293a 0a20 2020 2063 6163  Cacher):.    cac
+00008c90: 6865 5f70 6174 6820 3d20 4e6f 6e65 0a0a  he_path = None..
+00008ca0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00008cb0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00008cc0: 6c66 2c20 7061 7468 3a20 7374 722c 2063  lf, path: str, c
+00008cd0: 6163 6865 5f70 6174 683a 204f 7074 696f  ache_path: Optio
+00008ce0: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+00008cf0: 206d 6f64 653a 2073 7472 203d 2027 7227   mode: str = 'r'
+00008d00: 293a 0a20 2020 2020 2020 2069 6620 6d6f  ):.        if mo
+00008d10: 6465 206e 6f74 2069 6e20 2827 7227 2c20  de not in ('r', 
+00008d20: 2777 272c 2027 6127 293a 0a20 2020 2020  'w', 'a'):.     
+00008d30: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00008d40: 7565 4572 726f 7228 2775 6e61 6363 6570  ueError('unaccep
+00008d50: 7461 626c 6520 6d6f 6465 3a20 2572 2720  table mode: %r' 
+00008d60: 2520 6d6f 6465 290a 2020 2020 2020 2020  % mode).        
+00008d70: 6966 206d 6f64 6520 696e 2028 2772 272c  if mode in ('r',
+00008d80: 2027 6127 293a 0a20 2020 2020 2020 2020   'a'):.         
+00008d90: 2020 2069 6620 6361 6368 655f 7061 7468     if cache_path
+00008da0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00008db0: 2020 2020 2020 2020 2020 6361 6368 655f            cache_
+00008dc0: 7061 7468 203d 2067 656e 6572 6174 655f  path = generate_
+00008dd0: 6361 6368 655f 7061 7468 2870 6174 6829  cache_path(path)
+00008de0: 0a20 2020 2020 2020 2020 2020 2073 335f  .            s3_
+00008df0: 646f 776e 6c6f 6164 2870 6174 682c 2063  download(path, c
+00008e00: 6163 6865 5f70 6174 6829 0a20 2020 2020  ache_path).     
+00008e10: 2020 2073 656c 662e 6e61 6d65 203d 2070     self.name = p
+00008e20: 6174 680a 2020 2020 2020 2020 7365 6c66  ath.        self
+00008e30: 2e6d 6f64 6520 3d20 6d6f 6465 0a20 2020  .mode = mode.   
+00008e40: 2020 2020 2073 656c 662e 6361 6368 655f       self.cache_
+00008e50: 7061 7468 203d 2063 6163 6865 5f70 6174  path = cache_pat
+00008e60: 680a 0a20 2020 2064 6566 205f 636c 6f73  h..    def _clos
+00008e70: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+00008e80: 2069 6620 7365 6c66 2e63 6163 6865 5f70   if self.cache_p
+00008e90: 6174 6820 6973 206e 6f74 204e 6f6e 6520  ath is not None 
+00008ea0: 616e 6420 5c0a 2020 2020 2020 2020 2020  and \.          
+00008eb0: 2020 6f73 2e70 6174 682e 6578 6973 7473    os.path.exists
+00008ec0: 2873 656c 662e 6361 6368 655f 7061 7468  (self.cache_path
+00008ed0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+00008ee0: 6620 7365 6c66 2e6d 6f64 6520 696e 2028  f self.mode in (
+00008ef0: 2777 272c 2027 6127 293a 0a20 2020 2020  'w', 'a'):.     
+00008f00: 2020 2020 2020 2020 2020 2073 335f 7570             s3_up
+00008f10: 6c6f 6164 2873 656c 662e 6361 6368 655f  load(self.cache_
+00008f20: 7061 7468 2c20 7365 6c66 2e6e 616d 6529  path, self.name)
+00008f30: 0a20 2020 2020 2020 2020 2020 206f 732e  .            os.
+00008f40: 756e 6c69 6e6b 2873 656c 662e 6361 6368  unlink(self.cach
+00008f50: 655f 7061 7468 290a 0a0a 6465 6620 7333  e_path)...def s3
+00008f60: 5f67 6c6f 6228 0a20 2020 2020 2020 2070  _glob(.        p
+00008f70: 6174 683a 2050 6174 684c 696b 652c 0a20  ath: PathLike,. 
+00008f80: 2020 2020 2020 2072 6563 7572 7369 7665         recursive
+00008f90: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+00008fa0: 2020 2020 2020 206d 6973 7369 6e67 5f6f         missing_o
+00008fb0: 6b3a 2062 6f6f 6c20 3d20 5472 7565 2c0a  k: bool = True,.
+00008fc0: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
+00008fd0: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
+00008fe0: 652c 0a29 202d 3e20 4c69 7374 5b73 7472  e,.) -> List[str
+00008ff0: 5d3a 0a20 2020 2027 2727 5265 7475 726e  ]:.    '''Return
+00009000: 2073 3320 7061 7468 206c 6973 7420 696e   s3 path list in
+00009010: 2061 7363 656e 6469 6e67 2061 6c70 6861   ascending alpha
+00009020: 6265 7469 6361 6c20 6f72 6465 722c 2069  betical order, i
+00009030: 6e20 7768 6963 6820 7061 7468 206d 6174  n which path mat
+00009040: 6368 6573 2067 6c6f 6220 7061 7474 6572  ches glob patter
+00009050: 6e0a 2020 2020 4e6f 7465 733a 204f 6e6c  n.    Notes: Onl
+00009060: 7920 676c 6f62 2069 6e20 6275 636b 6574  y glob in bucket
+00009070: 2e20 4966 2074 7279 696e 6720 746f 206d  . If trying to m
+00009080: 6174 6368 2062 7563 6b65 7420 7769 7468  atch bucket with
+00009090: 2077 696c 6463 6172 6420 6368 6172 6163   wildcard charac
+000090a0: 7465 7273 2c20 7261 6973 6520 556e 7375  ters, raise Unsu
+000090b0: 7070 6f72 7465 6445 7272 6f72 0a0a 2020  pportedError..  
+000090c0: 2020 3a70 6172 616d 2072 6563 7572 7369    :param recursi
+000090d0: 7665 3a20 4966 2046 616c 7365 2c20 602a  ve: If False, `*
+000090e0: 2a60 2077 696c 6c20 6e6f 7420 7365 6172  *` will not sear
+000090f0: 6368 2064 6972 6563 746f 7279 2072 6563  ch directory rec
+00009100: 7572 7369 7665 6c79 0a20 2020 203a 7061  ursively.    :pa
+00009110: 7261 6d20 6d69 7373 696e 675f 6f6b 3a20  ram missing_ok: 
+00009120: 4966 2046 616c 7365 2061 6e64 2074 6172  If False and tar
+00009130: 6765 7420 7061 7468 2064 6f65 736e 2774  get path doesn't
+00009140: 206d 6174 6368 2061 6e79 2066 696c 652c   match any file,
+00009150: 2072 6169 7365 2046 696c 654e 6f74 466f   raise FileNotFo
+00009160: 756e 6445 7272 6f72 0a20 2020 203a 7261  undError.    :ra
+00009170: 6973 6573 3a20 556e 7375 7070 6f72 7465  ises: Unsupporte
+00009180: 6445 7272 6f72 2c20 7768 656e 2062 7563  dError, when buc
+00009190: 6b65 7420 7061 7274 2063 6f6e 7461 696e  ket part contain
+000091a0: 7320 7769 6c64 6361 7264 2063 6861 7261  s wildcard chara
+000091b0: 6374 6572 730a 2020 2020 3a72 6574 7572  cters.    :retur
+000091c0: 6e73 3a20 4120 6c69 7374 2063 6f6e 7461  ns: A list conta
+000091d0: 696e 7320 7061 7468 7320 6d61 7463 6820  ins paths match 
+000091e0: 6073 335f 7061 7468 6e61 6d65 600a 2020  `s3_pathname`.  
+000091f0: 2020 2727 270a 2020 2020 7265 7475 726e    '''.    return
+00009200: 206c 6973 7428 0a20 2020 2020 2020 2073   list(.        s
+00009210: 335f 6967 6c6f 6228 0a20 2020 2020 2020  3_iglob(.       
+00009220: 2020 2020 2070 6174 683d 7061 7468 2c0a       path=path,.
+00009230: 2020 2020 2020 2020 2020 2020 7265 6375              recu
+00009240: 7273 6976 653d 7265 6375 7273 6976 652c  rsive=recursive,
+00009250: 0a20 2020 2020 2020 2020 2020 206d 6973  .            mis
+00009260: 7369 6e67 5f6f 6b3d 6d69 7373 696e 675f  sing_ok=missing_
+00009270: 6f6b 2c0a 2020 2020 2020 2020 2020 2020  ok,.            
+00009280: 666f 6c6c 6f77 6c69 6e6b 733d 666f 6c6c  followlinks=foll
+00009290: 6f77 6c69 6e6b 7329 290a 0a0a 6465 6620  owlinks))...def 
+000092a0: 7333 5f67 6c6f 625f 7374 6174 280a 2020  s3_glob_stat(.  
+000092b0: 2020 2020 2020 7061 7468 3a20 5061 7468        path: Path
+000092c0: 4c69 6b65 2c0a 2020 2020 2020 2020 7265  Like,.        re
+000092d0: 6375 7273 6976 653a 2062 6f6f 6c20 3d20  cursive: bool = 
+000092e0: 5472 7565 2c0a 2020 2020 2020 2020 6d69  True,.        mi
+000092f0: 7373 696e 675f 6f6b 3a20 626f 6f6c 203d  ssing_ok: bool =
+00009300: 2054 7275 652c 0a20 2020 2020 2020 2066   True,.        f
+00009310: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
+00009320: 203d 2046 616c 7365 2920 2d3e 2049 7465   = False) -> Ite
+00009330: 7261 746f 725b 4669 6c65 456e 7472 795d  rator[FileEntry]
+00009340: 3a0a 2020 2020 2727 2752 6574 7572 6e20  :.    '''Return 
+00009350: 6120 6765 6e65 7261 746f 7220 636f 6e74  a generator cont
+00009360: 6169 6e73 2074 7570 6c65 7320 6f66 2070  ains tuples of p
+00009370: 6174 6820 616e 6420 6669 6c65 2073 7461  ath and file sta
+00009380: 742c 2069 6e20 6173 6365 6e64 696e 6720  t, in ascending 
+00009390: 616c 7068 6162 6574 6963 616c 206f 7264  alphabetical ord
+000093a0: 6572 2c20 696e 2077 6869 6368 2070 6174  er, in which pat
+000093b0: 6820 6d61 7463 6865 7320 676c 6f62 2070  h matches glob p
+000093c0: 6174 7465 726e 0a20 2020 204e 6f74 6573  attern.    Notes
+000093d0: 3a20 4f6e 6c79 2067 6c6f 6220 696e 2062  : Only glob in b
+000093e0: 7563 6b65 742e 2049 6620 7472 7969 6e67  ucket. If trying
+000093f0: 2074 6f20 6d61 7463 6820 6275 636b 6574   to match bucket
+00009400: 2077 6974 6820 7769 6c64 6361 7264 2063   with wildcard c
+00009410: 6861 7261 6374 6572 732c 2072 6169 7365  haracters, raise
+00009420: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
+00009430: 720a 0a20 2020 203a 7061 7261 6d20 7265  r..    :param re
+00009440: 6375 7273 6976 653a 2049 6620 4661 6c73  cursive: If Fals
+00009450: 652c 2060 2a2a 6020 7769 6c6c 206e 6f74  e, `**` will not
+00009460: 2073 6561 7263 6820 6469 7265 6374 6f72   search director
+00009470: 7920 7265 6375 7273 6976 656c 790a 2020  y recursively.  
+00009480: 2020 3a70 6172 616d 206d 6973 7369 6e67    :param missing
+00009490: 5f6f 6b3a 2049 6620 4661 6c73 6520 616e  _ok: If False an
+000094a0: 6420 7461 7267 6574 2070 6174 6820 646f  d target path do
+000094b0: 6573 6e27 7420 6d61 7463 6820 616e 7920  esn't match any 
+000094c0: 6669 6c65 2c20 7261 6973 6520 4669 6c65  file, raise File
+000094d0: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
+000094e0: 2020 3a72 6169 7365 733a 2055 6e73 7570    :raises: Unsup
+000094f0: 706f 7274 6564 4572 726f 722c 2077 6865  portedError, whe
+00009500: 6e20 6275 636b 6574 2070 6172 7420 636f  n bucket part co
+00009510: 6e74 6169 6e73 2077 696c 6463 6172 6420  ntains wildcard 
+00009520: 6368 6172 6163 7465 7273 0a20 2020 203a  characters.    :
+00009530: 7265 7475 726e 733a 2041 2067 656e 6572  returns: A gener
+00009540: 6174 6f72 2063 6f6e 7461 696e 7320 7475  ator contains tu
+00009550: 706c 6573 206f 6620 7061 7468 2061 6e64  ples of path and
+00009560: 2066 696c 6520 7374 6174 2c20 696e 2077   file stat, in w
+00009570: 6869 6368 2070 6174 6873 206d 6174 6368  hich paths match
+00009580: 2060 7333 5f70 6174 686e 616d 6560 0a20   `s3_pathname`. 
+00009590: 2020 2027 2727 0a20 2020 2072 6574 7572     '''.    retur
+000095a0: 6e20 5333 5061 7468 2870 6174 6829 2e67  n S3Path(path).g
+000095b0: 6c6f 625f 7374 6174 280a 2020 2020 2020  lob_stat(.      
+000095c0: 2020 7061 7474 6572 6e3d 2222 2c0a 2020    pattern="",.  
+000095d0: 2020 2020 2020 7265 6375 7273 6976 653d        recursive=
+000095e0: 7265 6375 7273 6976 652c 0a20 2020 2020  recursive,.     
+000095f0: 2020 206d 6973 7369 6e67 5f6f 6b3d 6d69     missing_ok=mi
+00009600: 7373 696e 675f 6f6b 2c0a 2020 2020 2020  ssing_ok,.      
+00009610: 2020 666f 6c6c 6f77 6c69 6e6b 733d 666f    followlinks=fo
+00009620: 6c6c 6f77 6c69 6e6b 7329 0a0a 0a64 6566  llowlinks)...def
+00009630: 2073 335f 6967 6c6f 6228 0a20 2020 2020   s3_iglob(.     
+00009640: 2020 2070 6174 683a 2050 6174 684c 696b     path: PathLik
+00009650: 652c 0a20 2020 2020 2020 2072 6563 7572  e,.        recur
+00009660: 7369 7665 3a20 626f 6f6c 203d 2054 7275  sive: bool = Tru
+00009670: 652c 0a20 2020 2020 2020 206d 6973 7369  e,.        missi
+00009680: 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20 5472  ng_ok: bool = Tr
+00009690: 7565 2c0a 2020 2020 2020 2020 666f 6c6c  ue,.        foll
+000096a0: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+000096b0: 4661 6c73 652c 0a29 202d 3e20 4974 6572  False,.) -> Iter
+000096c0: 6174 6f72 5b73 7472 5d3a 0a20 2020 2027  ator[str]:.    '
+000096d0: 2727 5265 7475 726e 2073 3320 7061 7468  ''Return s3 path
+000096e0: 2069 7465 7261 746f 7220 696e 2061 7363   iterator in asc
+000096f0: 656e 6469 6e67 2061 6c70 6861 6265 7469  ending alphabeti
+00009700: 6361 6c20 6f72 6465 722c 2069 6e20 7768  cal order, in wh
+00009710: 6963 6820 7061 7468 206d 6174 6368 6573  ich path matches
+00009720: 2067 6c6f 6220 7061 7474 6572 6e0a 2020   glob pattern.  
+00009730: 2020 4e6f 7465 733a 204f 6e6c 7920 676c    Notes: Only gl
+00009740: 6f62 2069 6e20 6275 636b 6574 2e20 4966  ob in bucket. If
+00009750: 2074 7279 696e 6720 746f 206d 6174 6368   trying to match
+00009760: 2062 7563 6b65 7420 7769 7468 2077 696c   bucket with wil
+00009770: 6463 6172 6420 6368 6172 6163 7465 7273  dcard characters
+00009780: 2c20 7261 6973 6520 556e 7375 7070 6f72  , raise Unsuppor
+00009790: 7465 6445 7272 6f72 0a0a 2020 2020 3a70  tedError..    :p
+000097a0: 6172 616d 2072 6563 7572 7369 7665 3a20  aram recursive: 
+000097b0: 4966 2046 616c 7365 2c20 602a 2a60 2077  If False, `**` w
+000097c0: 696c 6c20 6e6f 7420 7365 6172 6368 2064  ill not search d
+000097d0: 6972 6563 746f 7279 2072 6563 7572 7369  irectory recursi
+000097e0: 7665 6c79 0a20 2020 203a 7061 7261 6d20  vely.    :param 
+000097f0: 6d69 7373 696e 675f 6f6b 3a20 4966 2046  missing_ok: If F
+00009800: 616c 7365 2061 6e64 2074 6172 6765 7420  alse and target 
+00009810: 7061 7468 2064 6f65 736e 2774 206d 6174  path doesn't mat
+00009820: 6368 2061 6e79 2066 696c 652c 2072 6169  ch any file, rai
+00009830: 7365 2046 696c 654e 6f74 466f 756e 6445  se FileNotFoundE
+00009840: 7272 6f72 0a20 2020 203a 7261 6973 6573  rror.    :raises
+00009850: 3a20 556e 7375 7070 6f72 7465 6445 7272  : UnsupportedErr
+00009860: 6f72 2c20 7768 656e 2062 7563 6b65 7420  or, when bucket 
+00009870: 7061 7274 2063 6f6e 7461 696e 7320 7769  part contains wi
+00009880: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
+00009890: 730a 2020 2020 3a72 6574 7572 6e73 3a20  s.    :returns: 
+000098a0: 416e 2069 7465 7261 746f 7220 636f 6e74  An iterator cont
+000098b0: 6169 6e73 2070 6174 6873 206d 6174 6368  ains paths match
+000098c0: 2060 7333 5f70 6174 686e 616d 6560 0a20   `s3_pathname`. 
+000098d0: 2020 2027 2727 0a20 2020 2066 6f72 2070     '''.    for p
+000098e0: 6174 685f 6f62 6a20 696e 2053 3350 6174  ath_obj in S3Pat
+000098f0: 6828 7061 7468 292e 6967 6c6f 6228 7061  h(path).iglob(pa
+00009900: 7474 6572 6e3d 2222 2c20 7265 6375 7273  ttern="", recurs
+00009910: 6976 653d 7265 6375 7273 6976 652c 0a20  ive=recursive,. 
+00009920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009940: 2020 2020 2020 6d69 7373 696e 675f 6f6b        missing_ok
+00009950: 3d6d 6973 7369 6e67 5f6f 6b2c 0a20 2020  =missing_ok,.   
+00009960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009980: 2020 2020 666f 6c6c 6f77 6c69 6e6b 733d      followlinks=
+00009990: 666f 6c6c 6f77 6c69 6e6b 7329 3a0a 2020  followlinks):.  
+000099a0: 2020 2020 2020 7969 656c 6420 7061 7468        yield path
+000099b0: 5f6f 626a 2e70 6174 685f 7769 7468 5f70  _obj.path_with_p
+000099c0: 726f 746f 636f 6c0a 0a0a 6465 6620 7333  rotocol...def s3
+000099d0: 5f6d 616b 6564 6972 7328 7061 7468 3a20  _makedirs(path: 
+000099e0: 5061 7468 4c69 6b65 2c20 6578 6973 745f  PathLike, exist_
+000099f0: 6f6b 3a20 626f 6f6c 203d 2046 616c 7365  ok: bool = False
+00009a00: 293a 0a20 2020 2027 2727 0a20 2020 2043  ):.    '''.    C
+00009a10: 7265 6174 6520 616e 2073 3320 6469 7265  reate an s3 dire
+00009a20: 6374 6f72 792e 0a20 2020 2050 7572 656c  ctory..    Purel
+00009a30: 7920 6372 6561 7469 6e67 2064 6972 6563  y creating direc
+00009a40: 746f 7279 2069 7320 696e 7661 6c69 6420  tory is invalid 
+00009a50: 6265 6361 7573 6520 6974 2773 2075 6e61  because it's una
+00009a60: 7661 696c 6162 6c65 206f 6e20 4f53 532e  vailable on OSS.
+00009a70: 0a20 2020 2054 6869 7320 6675 6e63 7469  .    This functi
+00009a80: 6f6e 2069 7320 746f 2074 6573 7420 7468  on is to test th
+00009a90: 6520 7461 7267 6574 2062 7563 6b65 7420  e target bucket 
+00009aa0: 6861 7665 2057 5249 5445 2061 6363 6573  have WRITE acces
+00009ab0: 732e 0a0a 2020 2020 3a70 6172 616d 2070  s...    :param p
+00009ac0: 6174 683a 2047 6976 656e 2070 6174 680a  ath: Given path.
+00009ad0: 2020 2020 3a70 6172 616d 2065 7869 7374      :param exist
+00009ae0: 5f6f 6b3a 2049 6620 4661 6c73 6520 616e  _ok: If False an
+00009af0: 6420 7461 7267 6574 2064 6972 6563 746f  d target directo
+00009b00: 7279 2065 7869 7374 732c 2072 6169 7365  ry exists, raise
+00009b10: 2053 3346 696c 6545 7869 7374 7345 7272   S3FileExistsErr
+00009b20: 6f72 0a20 2020 203a 7261 6973 6573 3a20  or.    :raises: 
+00009b30: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+00009b40: 4572 726f 722c 2053 3346 696c 6545 7869  Error, S3FileExi
+00009b50: 7374 7345 7272 6f72 0a20 2020 2027 2727  stsError.    '''
+00009b60: 0a20 2020 2072 6574 7572 6e20 5333 5061  .    return S3Pa
+00009b70: 7468 2870 6174 6829 2e6d 6b64 6972 2870  th(path).mkdir(p
+00009b80: 6172 656e 7473 3d54 7275 652c 2065 7869  arents=True, exi
+00009b90: 7374 5f6f 6b3d 6578 6973 745f 6f6b 290a  st_ok=exist_ok).
+00009ba0: 0a0a 6465 6620 5f67 726f 7570 5f73 7263  ..def _group_src
+00009bb0: 5f70 6174 6873 5f62 795f 626c 6f63 6b28  _paths_by_block(
+00009bc0: 0a20 2020 2020 2020 2073 7263 5f70 6174  .        src_pat
+00009bd0: 6873 3a20 4c69 7374 5b50 6174 684c 696b  hs: List[PathLik
+00009be0: 655d 2c20 626c 6f63 6b5f 7369 7a65 3a20  e], block_size: 
+00009bf0: 696e 7420 3d20 4445 4641 554c 545f 424c  int = DEFAULT_BL
+00009c00: 4f43 4b5f 5349 5a45 0a29 202d 3e20 4c69  OCK_SIZE.) -> Li
+00009c10: 7374 5b4c 6973 745b 5475 706c 655b 5061  st[List[Tuple[Pa
+00009c20: 7468 4c69 6b65 2c20 4f70 7469 6f6e 616c  thLike, Optional
+00009c30: 5b73 7472 5d5d 5d5d 3a0a 2020 2020 6772  [str]]]]:.    gr
+00009c40: 6f75 7073 203d 205b 5d0a 2020 2020 6375  oups = [].    cu
+00009c50: 7272 656e 745f 6772 6f75 702c 2063 7572  rrent_group, cur
+00009c60: 7265 6e74 5f67 726f 7570 5f73 697a 6520  rent_group_size 
+00009c70: 3d20 5b5d 2c20 300a 2020 2020 666f 7220  = [], 0.    for 
+00009c80: 7372 635f 7061 7468 2069 6e20 7372 635f  src_path in src_
+00009c90: 7061 7468 733a 0a20 2020 2020 2020 2063  paths:.        c
+00009ca0: 7572 7265 6e74 5f66 696c 655f 7369 7a65  urrent_file_size
+00009cb0: 203d 2053 3350 6174 6828 7372 635f 7061   = S3Path(src_pa
+00009cc0: 7468 292e 7374 6174 2829 2e73 697a 650a  th).stat().size.
+00009cd0: 2020 2020 2020 2020 6966 2063 7572 7265          if curre
+00009ce0: 6e74 5f66 696c 655f 7369 7a65 203d 3d20  nt_file_size == 
+00009cf0: 303a 0a20 2020 2020 2020 2020 2020 2063  0:.            c
+00009d00: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+00009d10: 2069 6620 6375 7272 656e 745f 6669 6c65   if current_file
+00009d20: 5f73 697a 6520 3e3d 2062 6c6f 636b 5f73  _size >= block_s
+00009d30: 697a 653a 0a20 2020 2020 2020 2020 2020  ize:.           
+00009d40: 2069 6620 6c65 6e28 6772 6f75 7073 2920   if len(groups) 
+00009d50: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00009d60: 2020 2020 2020 6966 2063 7572 7265 6e74        if current
+00009d70: 5f67 726f 7570 5f73 697a 6520 2b20 6375  _group_size + cu
+00009d80: 7272 656e 745f 6669 6c65 5f73 697a 6520  rrent_file_size 
+00009d90: 3e20 3220 2a20 626c 6f63 6b5f 7369 7a65  > 2 * block_size
+00009da0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009db0: 2020 2020 2020 6772 6f75 705f 6c61 636b        group_lack
+00009dc0: 5f73 697a 6520 3d20 626c 6f63 6b5f 7369  _size = block_si
+00009dd0: 7a65 202d 2063 7572 7265 6e74 5f67 726f  ze - current_gro
+00009de0: 7570 5f73 697a 650a 2020 2020 2020 2020  up_size.        
+00009df0: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+00009e00: 656e 745f 6772 6f75 702e 6170 7065 6e64  ent_group.append
+00009e10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00009e20: 2020 2020 2020 2020 2020 2873 7263 5f70            (src_p
+00009e30: 6174 682c 2066 2762 7974 6573 3d30 2d7b  ath, f'bytes=0-{
+00009e40: 6772 6f75 705f 6c61 636b 5f73 697a 652d  group_lack_size-
+00009e50: 317d 2729 290a 2020 2020 2020 2020 2020  1}')).          
+00009e60: 2020 2020 2020 2020 2020 6772 6f75 7073            groups
+00009e70: 2e65 7874 656e 6428 0a20 2020 2020 2020  .extend(.       
 00009e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ea0: 2020 6627 6279 7465 733d 7b67 726f 7570    f'bytes={group
-00009eb0: 5f6c 6163 6b5f 7369 7a65 7d2d 7b63 7572  _lack_size}-{cur
-00009ec0: 7265 6e74 5f66 696c 655f 7369 7a65 2d31  rent_file_size-1
-00009ed0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00009e90: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+00009ea0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00009eb0: 7572 7265 6e74 5f67 726f 7570 2c0a 2020  urrent_group,.  
+00009ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ed0: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
 00009ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ef0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00009ef0: 2020 2020 2020 2020 2020 2020 280a 2020              (.  
 00009f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f10: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
-00009f20: 2020 2020 2020 2020 2020 205d 290a 2020             ]).  
-00009f30: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00009f40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00009f50: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-00009f60: 6772 6f75 702e 6170 7065 6e64 2828 7372  group.append((sr
-00009f70: 635f 7061 7468 2c20 4e6f 6e65 2929 0a20  c_path, None)). 
-00009f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f90: 2020 2067 726f 7570 732e 6170 7065 6e64     groups.append
-00009fa0: 2863 7572 7265 6e74 5f67 726f 7570 290a  (current_group).
-00009fb0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00009fc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009fd0: 2020 6772 6f75 7073 5b2d 315d 2e65 7874    groups[-1].ext
-00009fe0: 656e 6428 6375 7272 656e 745f 6772 6f75  end(current_grou
-00009ff0: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
-0000a000: 2020 2067 726f 7570 732e 6170 7065 6e64     groups.append
-0000a010: 285b 2873 7263 5f70 6174 682c 204e 6f6e  ([(src_path, Non
-0000a020: 6529 5d29 0a20 2020 2020 2020 2020 2020  e)]).           
-0000a030: 2063 7572 7265 6e74 5f67 726f 7570 2c20   current_group, 
-0000a040: 6375 7272 656e 745f 6772 6f75 705f 7369  current_group_si
-0000a050: 7a65 203d 205b 5d2c 2030 0a20 2020 2020  ze = [], 0.     
-0000a060: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000a070: 2020 2020 2063 7572 7265 6e74 5f67 726f       current_gro
-0000a080: 7570 2e61 7070 656e 6428 2873 7263 5f70  up.append((src_p
-0000a090: 6174 682c 204e 6f6e 6529 290a 2020 2020  ath, None)).    
-0000a0a0: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-0000a0b0: 6772 6f75 705f 7369 7a65 202b 3d20 6375  group_size += cu
-0000a0c0: 7272 656e 745f 6669 6c65 5f73 697a 650a  rrent_file_size.
-0000a0d0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-0000a0e0: 7572 7265 6e74 5f67 726f 7570 5f73 697a  urrent_group_siz
-0000a0f0: 6520 3e3d 2062 6c6f 636b 5f73 697a 653a  e >= block_size:
-0000a100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a110: 2067 726f 7570 732e 6170 7065 6e64 2863   groups.append(c
-0000a120: 7572 7265 6e74 5f67 726f 7570 290a 2020  urrent_group).  
-0000a130: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-0000a140: 7272 656e 745f 6772 6f75 702c 2063 7572  rrent_group, cur
-0000a150: 7265 6e74 5f67 726f 7570 5f73 697a 6520  rent_group_size 
-0000a160: 3d20 5b5d 2c20 300a 2020 2020 6966 2063  = [], 0.    if c
-0000a170: 7572 7265 6e74 5f67 726f 7570 3a0a 2020  urrent_group:.  
-0000a180: 2020 2020 2020 6772 6f75 7073 2e61 7070        groups.app
-0000a190: 656e 6428 6375 7272 656e 745f 6772 6f75  end(current_grou
-0000a1a0: 7029 0a20 2020 2072 6574 7572 6e20 6772  p).    return gr
-0000a1b0: 6f75 7073 0a0a 0a64 6566 2073 335f 636f  oups...def s3_co
-0000a1c0: 6e63 6174 280a 2020 2020 2020 2020 7372  ncat(.        sr
-0000a1d0: 635f 7061 7468 733a 204c 6973 745b 5061  c_paths: List[Pa
-0000a1e0: 7468 4c69 6b65 5d2c 0a20 2020 2020 2020  thLike],.       
-0000a1f0: 2064 7374 5f70 6174 683a 2050 6174 684c   dst_path: PathL
-0000a200: 696b 652c 0a20 2020 2020 2020 2062 6c6f  ike,.        blo
-0000a210: 636b 5f73 697a 653a 2069 6e74 203d 2044  ck_size: int = D
-0000a220: 4546 4155 4c54 5f42 4c4f 434b 5f53 495a  EFAULT_BLOCK_SIZ
-0000a230: 452c 0a20 2020 2020 2020 206d 6178 5f77  E,.        max_w
-0000a240: 6f72 6b65 7273 3a20 696e 7420 3d20 474c  orkers: int = GL
-0000a250: 4f42 414c 5f4d 4158 5f57 4f52 4b45 5253  OBAL_MAX_WORKERS
-0000a260: 2920 2d3e 204e 6f6e 653a 0a20 2020 2027  ) -> None:.    '
-0000a270: 2727 436f 6e63 6174 656e 6174 6520 7333  ''Concatenate s3
-0000a280: 2066 696c 6573 2074 6f20 6f6e 6520 6669   files to one fi
-0000a290: 6c65 2e0a 0a20 2020 203a 7061 7261 6d20  le...    :param 
-0000a2a0: 7372 635f 7061 7468 733a 2047 6976 656e  src_paths: Given
-0000a2b0: 2073 6f75 7263 6520 7061 7468 730a 2020   source paths.  
-0000a2c0: 2020 3a70 6172 616d 2064 7374 5f70 6174    :param dst_pat
-0000a2d0: 683a 2047 6976 656e 2064 6573 7469 6e61  h: Given destina
-0000a2e0: 7469 6f6e 2070 6174 680a 2020 2020 2727  tion path.    ''
-0000a2f0: 270a 2020 2020 636c 6965 6e74 203d 2053  '.    client = S
-0000a300: 3350 6174 6828 6473 745f 7061 7468 292e  3Path(dst_path).
-0000a310: 5f63 6c69 656e 740a 2020 2020 7769 7468  _client.    with
-0000a320: 2072 6169 7365 5f73 335f 6572 726f 7228   raise_s3_error(
-0000a330: 6473 745f 7061 7468 293a 0a20 2020 2020  dst_path):.     
-0000a340: 2020 2069 6620 626c 6f63 6b5f 7369 7a65     if block_size
-0000a350: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-0000a360: 2020 2067 726f 7570 7320 3d20 5b5b 2873     groups = [[(s
-0000a370: 7263 5f70 6174 682c 204e 6f6e 6529 5d20  rc_path, None)] 
-0000a380: 666f 7220 7372 635f 7061 7468 2069 6e20  for src_path in 
-0000a390: 7372 635f 7061 7468 735d 0a20 2020 2020  src_paths].     
-0000a3a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000a3b0: 2020 2020 2067 726f 7570 7320 3d20 5f67       groups = _g
-0000a3c0: 726f 7570 5f73 7263 5f70 6174 6873 5f62  roup_src_paths_b
-0000a3d0: 795f 626c 6f63 6b28 7372 635f 7061 7468  y_block(src_path
-0000a3e0: 732c 2062 6c6f 636b 5f73 697a 653d 626c  s, block_size=bl
-0000a3f0: 6f63 6b5f 7369 7a65 290a 0a20 2020 2020  ock_size)..     
-0000a400: 2020 2077 6974 6820 4d75 6c74 6950 6172     with MultiPar
-0000a410: 7457 7269 7465 7228 636c 6965 6e74 2c20  tWriter(client, 
-0000a420: 6473 745f 7061 7468 2920 6173 2077 7269  dst_path) as wri
-0000a430: 7465 722c 2054 6872 6561 6450 6f6f 6c45  ter, ThreadPoolE
-0000a440: 7865 6375 746f 7228 0a20 2020 2020 2020  xecutor(.       
-0000a450: 2020 2020 2020 2020 206d 6178 5f77 6f72           max_wor
-0000a460: 6b65 7273 3d6d 6178 5f77 6f72 6b65 7273  kers=max_workers
-0000a470: 2920 6173 2065 7865 6375 746f 723a 0a20  ) as executor:. 
-0000a480: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-0000a490: 6e64 6578 2c20 6772 6f75 7020 696e 2065  ndex, group in e
-0000a4a0: 6e75 6d65 7261 7465 2867 726f 7570 732c  numerate(groups,
-0000a4b0: 2073 7461 7274 3d31 293a 0a20 2020 2020   start=1):.     
-0000a4c0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-0000a4d0: 6e28 6772 6f75 7029 203d 3d20 313a 0a20  n(group) == 1:. 
-0000a4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4f0: 2020 2065 7865 6375 746f 722e 7375 626d     executor.subm
-0000a500: 6974 280a 2020 2020 2020 2020 2020 2020  it(.            
-0000a510: 2020 2020 2020 2020 2020 2020 7772 6974              writ
-0000a520: 6572 2e75 706c 6f61 645f 7061 7274 5f63  er.upload_part_c
-0000a530: 6f70 792c 2069 6e64 6578 2c20 6772 6f75  opy, index, grou
-0000a540: 705b 305d 5b30 5d2c 0a20 2020 2020 2020  p[0][0],.       
-0000a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a560: 2067 726f 7570 5b30 5d5b 315d 290a 2020   group[0][1]).  
-0000a570: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000a580: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000a590: 2020 2020 2020 2020 6578 6563 7574 6f72          executor
-0000a5a0: 2e73 7562 6d69 7428 7772 6974 6572 2e75  .submit(writer.u
-0000a5b0: 706c 6f61 645f 7061 7274 5f62 795f 7061  pload_part_by_pa
-0000a5c0: 7468 732c 2069 6e64 6578 2c20 6772 6f75  ths, index, grou
-0000a5d0: 7029 0a0a 0a40 536d 6172 7450 6174 682e  p)...@SmartPath.
-0000a5e0: 7265 6769 7374 6572 0a63 6c61 7373 2053  register.class S
-0000a5f0: 3350 6174 6828 5552 4950 6174 6829 3a0a  3Path(URIPath):.
-0000a600: 0a20 2020 2070 726f 746f 636f 6c20 3d20  .    protocol = 
-0000a610: 2273 3322 0a0a 2020 2020 6465 6620 5f5f  "s3"..    def __
-0000a620: 696e 6974 5f5f 2873 656c 662c 2070 6174  init__(self, pat
-0000a630: 683a 2022 5061 7468 4c69 6b65 222c 202a  h: "PathLike", *
-0000a640: 6f74 6865 725f 7061 7468 733a 2022 5061  other_paths: "Pa
-0000a650: 7468 4c69 6b65 2229 3a0a 2020 2020 2020  thLike"):.      
-0000a660: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
-0000a670: 5f5f 2870 6174 682c 202a 6f74 6865 725f  __(path, *other_
-0000a680: 7061 7468 7329 0a20 2020 2020 2020 2070  paths).        p
-0000a690: 726f 746f 636f 6c20 3d20 6765 745f 7572  rotocol = get_ur
-0000a6a0: 6c5f 7363 6865 6d65 2873 656c 662e 7061  l_scheme(self.pa
-0000a6b0: 7468 290a 2020 2020 2020 2020 7365 6c66  th).        self
-0000a6c0: 2e5f 7072 6f74 6f63 6f6c 5f77 6974 685f  ._protocol_with_
-0000a6d0: 7072 6f66 696c 6520 3d20 7365 6c66 2e70  profile = self.p
-0000a6e0: 726f 746f 636f 6c0a 2020 2020 2020 2020  rotocol.        
-0000a6f0: 7365 6c66 2e5f 7072 6f66 696c 655f 6e61  self._profile_na
-0000a700: 6d65 203d 204e 6f6e 650a 2020 2020 2020  me = None.      
-0000a710: 2020 6966 2070 726f 746f 636f 6c2e 7374    if protocol.st
-0000a720: 6172 7473 7769 7468 2827 7333 2b27 293a  artswith('s3+'):
-0000a730: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000a740: 662e 5f70 726f 746f 636f 6c5f 7769 7468  f._protocol_with
-0000a750: 5f70 726f 6669 6c65 203d 2070 726f 746f  _profile = proto
-0000a760: 636f 6c0a 2020 2020 2020 2020 2020 2020  col.            
-0000a770: 7365 6c66 2e5f 7072 6f66 696c 655f 6e61  self._profile_na
-0000a780: 6d65 203d 2070 726f 746f 636f 6c5b 333a  me = protocol[3:
-0000a790: 5d0a 2020 2020 2020 2020 2020 2020 7365  ].            se
-0000a7a0: 6c66 2e5f 7333 5f70 6174 6820 3d20 6622  lf._s3_path = f"
-0000a7b0: 7333 3a2f 2f7b 7365 6c66 2e70 6174 685b  s3://{self.path[
-0000a7c0: 6c65 6e28 7072 6f74 6f63 6f6c 292b 333a  len(protocol)+3:
-0000a7d0: 5d7d 220a 2020 2020 2020 2020 656c 6966  ]}".        elif
-0000a7e0: 206e 6f74 2070 726f 746f 636f 6c3a 0a20   not protocol:. 
-0000a7f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000a800: 5f73 335f 7061 7468 203d 2066 2273 333a  _s3_path = f"s3:
-0000a810: 2f2f 7b73 656c 662e 7061 7468 2e6c 7374  //{self.path.lst
-0000a820: 7269 7028 272f 2729 7d22 0a20 2020 2020  rip('/')}".     
-0000a830: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000a840: 2020 2020 2073 656c 662e 5f73 335f 7061       self._s3_pa
-0000a850: 7468 203d 2073 656c 662e 7061 7468 0a0a  th = self.path..
-0000a860: 2020 2020 4063 6163 6865 6470 726f 7065      @cachedprope
-0000a870: 7274 790a 2020 2020 6465 6620 7061 7468  rty.    def path
-0000a880: 5f77 6974 685f 7072 6f74 6f63 6f6c 2873  _with_protocol(s
-0000a890: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
-0000a8a0: 2020 2020 2027 2727 5265 7475 726e 2070       '''Return p
-0000a8b0: 6174 6820 7769 7468 2070 726f 746f 636f  ath with protoco
-0000a8c0: 6c2c 206c 696b 6520 6669 6c65 3a2f 2f2f  l, like file:///
-0000a8d0: 726f 6f74 2c20 7333 3a2f 2f62 7563 6b65  root, s3://bucke
-0000a8e0: 742f 6b65 7927 2727 0a20 2020 2020 2020  t/key'''.       
-0000a8f0: 2070 6174 6820 3d20 7365 6c66 2e70 6174   path = self.pat
-0000a900: 680a 2020 2020 2020 2020 7072 6f74 6f63  h.        protoc
-0000a910: 6f6c 5f70 7265 6669 7820 3d20 7365 6c66  ol_prefix = self
-0000a920: 2e5f 7072 6f74 6f63 6f6c 5f77 6974 685f  ._protocol_with_
-0000a930: 7072 6f66 696c 6520 2b20 223a 2f2f 220a  profile + "://".
-0000a940: 2020 2020 2020 2020 6966 2070 6174 682e          if path.
-0000a950: 7374 6172 7473 7769 7468 2870 726f 746f  startswith(proto
-0000a960: 636f 6c5f 7072 6566 6978 293a 0a20 2020  col_prefix):.   
-0000a970: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000a980: 7061 7468 0a20 2020 2020 2020 2072 6574  path.        ret
-0000a990: 7572 6e20 7072 6f74 6f63 6f6c 5f70 7265  urn protocol_pre
-0000a9a0: 6669 7820 2b20 7061 7468 2e6c 7374 7269  fix + path.lstri
-0000a9b0: 7028 272f 2729 0a0a 2020 2020 4063 6163  p('/')..    @cac
-0000a9c0: 6865 6470 726f 7065 7274 790a 2020 2020  hedproperty.    
-0000a9d0: 6465 6620 7061 7468 5f77 6974 686f 7574  def path_without
-0000a9e0: 5f70 726f 746f 636f 6c28 7365 6c66 2920  _protocol(self) 
-0000a9f0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-0000aa00: 2727 2752 6574 7572 6e20 7061 7468 2077  '''Return path w
-0000aa10: 6974 686f 7574 2070 726f 746f 636f 6c2c  ithout protocol,
-0000aa20: 2065 7861 6d70 6c65 3a20 6966 2070 6174   example: if pat
-0000aa30: 6820 6973 2073 333a 2f2f 6275 636b 6574  h is s3://bucket
-0000aa40: 2f6b 6579 2c20 7265 7475 726e 2062 7563  /key, return buc
-0000aa50: 6b65 742f 6b65 7927 2727 0a20 2020 2020  ket/key'''.     
-0000aa60: 2020 2070 6174 6820 3d20 7365 6c66 2e70     path = self.p
-0000aa70: 6174 680a 2020 2020 2020 2020 7072 6f74  ath.        prot
-0000aa80: 6f63 6f6c 5f70 7265 6669 7820 3d20 7365  ocol_prefix = se
-0000aa90: 6c66 2e5f 7072 6f74 6f63 6f6c 5f77 6974  lf._protocol_wit
-0000aaa0: 685f 7072 6f66 696c 6520 2b20 223a 2f2f  h_profile + "://
-0000aab0: 220a 2020 2020 2020 2020 6966 2070 6174  ".        if pat
-0000aac0: 682e 7374 6172 7473 7769 7468 2870 726f  h.startswith(pro
-0000aad0: 746f 636f 6c5f 7072 6566 6978 293a 0a20  tocol_prefix):. 
-0000aae0: 2020 2020 2020 2020 2020 2070 6174 6820             path 
-0000aaf0: 3d20 7061 7468 5b6c 656e 2870 726f 746f  = path[len(proto
-0000ab00: 636f 6c5f 7072 6566 6978 293a 5d0a 2020  col_prefix):].  
-0000ab10: 2020 2020 2020 7265 7475 726e 2070 6174        return pat
-0000ab20: 680a 0a20 2020 2040 6361 6368 6564 7072  h..    @cachedpr
-0000ab30: 6f70 6572 7479 0a20 2020 2064 6566 205f  operty.    def _
-0000ab40: 636c 6965 6e74 2873 656c 6629 3a0a 2020  client(self):.  
-0000ab50: 2020 2020 2020 7265 7475 726e 2067 6574        return get
-0000ab60: 5f73 335f 636c 6965 6e74 2870 726f 6669  _s3_client(profi
-0000ab70: 6c65 5f6e 616d 653d 7365 6c66 2e5f 7072  le_name=self._pr
-0000ab80: 6f66 696c 655f 6e61 6d65 290a 0a20 2020  ofile_name)..   
-0000ab90: 2064 6566 205f 7333 5f67 6574 5f6d 6574   def _s3_get_met
-0000aba0: 6164 6174 6128 7365 6c66 2920 2d3e 2064  adata(self) -> d
-0000abb0: 6963 743a 0a20 2020 2020 2020 2027 2727  ict:.        '''
-0000abc0: 0a20 2020 2020 2020 2047 6574 206f 626a  .        Get obj
-0000abd0: 6563 7420 6d65 7461 6461 7461 0a0a 2020  ect metadata..  
-0000abe0: 2020 2020 2020 3a70 6172 616d 2070 6174        :param pat
-0000abf0: 683a 204f 626a 6563 7420 7061 7468 0a20  h: Object path. 
-0000ac00: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0000ac10: 204f 626a 6563 7420 6d65 7461 6461 7461   Object metadata
-0000ac20: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000ac30: 2020 2020 2062 7563 6b65 742c 206b 6579       bucket, key
-0000ac40: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
-0000ac50: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-0000ac60: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
-0000ac70: 2069 6620 6e6f 7420 6275 636b 6574 3a0a   if not bucket:.
-0000ac80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000ac90: 726e 207b 7d0a 2020 2020 2020 2020 6966  rn {}.        if
-0000aca0: 206e 6f74 206b 6579 206f 7220 6b65 792e   not key or key.
-0000acb0: 656e 6473 7769 7468 2827 2f27 293a 0a20  endswith('/'):. 
-0000acc0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000acd0: 6e20 7b7d 0a20 2020 2020 2020 2074 7279  n {}.        try
-0000ace0: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
-0000acf0: 7468 2072 6169 7365 5f73 335f 6572 726f  th raise_s3_erro
-0000ad00: 7228 7365 6c66 2e70 6174 685f 7769 7468  r(self.path_with
-0000ad10: 5f70 726f 746f 636f 6c29 3a0a 2020 2020  _protocol):.    
-0000ad20: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-0000ad30: 203d 2073 656c 662e 5f63 6c69 656e 742e   = self._client.
-0000ad40: 6865 6164 5f6f 626a 6563 7428 4275 636b  head_object(Buck
-0000ad50: 6574 3d62 7563 6b65 742c 204b 6579 3d6b  et=bucket, Key=k
-0000ad60: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-0000ad70: 7265 7475 726e 2064 6963 7428 0a20 2020  return dict(.   
-0000ad80: 2020 2020 2020 2020 2020 2020 2028 6b65               (ke
-0000ad90: 792e 6c6f 7765 7228 292c 2076 616c 7565  y.lower(), value
-0000ada0: 2920 666f 7220 6b65 792c 2076 616c 7565  ) for key, value
-0000adb0: 2069 6e20 7265 7370 5b27 4d65 7461 6461   in resp['Metada
-0000adc0: 7461 275d 2e69 7465 6d73 2829 290a 2020  ta'].items()).  
-0000add0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-0000ade0: 6570 7469 6f6e 2061 7320 6572 726f 723a  eption as error:
-0000adf0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000ae00: 6973 696e 7374 616e 6365 2865 7272 6f72  isinstance(error
-0000ae10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ae20: 2020 2020 2020 2020 2020 2020 2853 3355              (S3U
-0000ae30: 6e6b 6e6f 776e 4572 726f 722c 2053 3343  nknownError, S3C
-0000ae40: 6f6e 6669 6745 7272 6f72 2c20 5333 5065  onfigError, S3Pe
-0000ae50: 726d 6973 7369 6f6e 4572 726f 7229 293a  rmissionError)):
-0000ae60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ae70: 2072 6169 7365 2065 7272 6f72 0a20 2020   raise error.   
-0000ae80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000ae90: 7b7d 0a0a 2020 2020 6465 6620 6163 6365  {}..    def acce
-0000aea0: 7373 280a 2020 2020 2020 2020 2020 2020  ss(.            
-0000aeb0: 7365 6c66 2c20 6d6f 6465 3a20 4163 6365  self, mode: Acce
-0000aec0: 7373 203d 2041 6363 6573 732e 5245 4144  ss = Access.READ
-0000aed0: 2c0a 2020 2020 2020 2020 2020 2020 666f  ,.            fo
-0000aee0: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
-0000aef0: 3d20 4661 6c73 6529 202d 3e20 626f 6f6c  = False) -> bool
-0000af00: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
-0000af10: 2020 2020 2020 5465 7374 2069 6620 7061        Test if pa
-0000af20: 7468 2068 6173 2061 6363 6573 7320 7065  th has access pe
-0000af30: 726d 6973 7369 6f6e 2064 6573 6372 6962  rmission describ
-0000af40: 6564 2062 7920 6d6f 6465 0a20 2020 2020  ed by mode.     
-0000af50: 2020 2055 7369 6e67 2068 6561 645f 6275     Using head_bu
-0000af60: 636b 6574 2829 2c20 6e6f 7720 5245 4144  cket(), now READ
-0000af70: 2f57 5249 5445 2061 7265 2073 616d 652e  /WRITE are same.
-0000af80: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-0000af90: 206d 6f64 653a 2061 6363 6573 7320 6d6f   mode: access mo
-0000afa0: 6465 0a20 2020 2020 2020 203a 7265 7475  de.        :retu
-0000afb0: 726e 733a 2062 6f6f 6c2c 2069 6620 7468  rns: bool, if th
-0000afc0: 6520 6275 636b 6574 206f 6620 7333 5f75  e bucket of s3_u
-0000afd0: 726c 2068 6173 2072 6561 642f 7772 6974  rl has read/writ
-0000afe0: 6520 6163 6365 7373 2e0a 2020 2020 2020  e access..      
-0000aff0: 2020 2727 270a 2020 2020 2020 2020 7333    '''.        s3
-0000b000: 5f75 726c 203d 2073 656c 662e 7061 7468  _url = self.path
-0000b010: 5f77 6974 685f 7072 6f74 6f63 6f6c 0a20  _with_protocol. 
-0000b020: 2020 2020 2020 2069 6620 666f 6c6c 6f77         if follow
-0000b030: 6c69 6e6b 733a 0a20 2020 2020 2020 2020  links:.         
-0000b040: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000b050: 2020 2020 2020 2020 7333 5f75 726c 203d          s3_url =
-0000b060: 2073 656c 662e 7265 6164 6c69 6e6b 2829   self.readlink()
-0000b070: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-0000b080: 636f 6c0a 2020 2020 2020 2020 2020 2020  col.            
-0000b090: 6578 6365 7074 2053 334e 6f74 414c 696e  except S3NotALin
-0000b0a0: 6b45 7272 6f72 3a0a 2020 2020 2020 2020  kError:.        
-0000b0b0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-0000b0c0: 2020 2020 2062 7563 6b65 742c 205f 203d       bucket, _ =
-0000b0d0: 2070 6172 7365 5f73 335f 7572 6c28 7333   parse_s3_url(s3
-0000b0e0: 5f75 726c 2920 2023 206f 6e6c 7920 6368  _url)  # only ch
-0000b0f0: 6563 6b20 6275 636b 6574 2061 6363 6573  eck bucket acces
-0000b100: 7369 6269 6c69 7479 0a20 2020 2020 2020  sibility.       
-0000b110: 2069 6620 6e6f 7420 6275 636b 6574 3a0a   if not bucket:.
-0000b120: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000b130: 6520 4578 6365 7074 696f 6e28 224e 6f20  e Exception("No 
-0000b140: 6176 6169 6c61 626c 6520 6275 636b 6574  available bucket
-0000b150: 2229 0a20 2020 2020 2020 2069 6620 6e6f  ").        if no
-0000b160: 7420 6973 696e 7374 616e 6365 286d 6f64  t isinstance(mod
-0000b170: 652c 2041 6363 6573 7329 3a0a 2020 2020  e, Access):.    
-0000b180: 2020 2020 2020 2020 7261 6973 6520 5479          raise Ty
-0000b190: 7065 4572 726f 7228 0a20 2020 2020 2020  peError(.       
-0000b1a0: 2020 2020 2020 2020 2027 556e 7375 7070           'Unsupp
-0000b1b0: 6f72 7465 6420 6d6f 6465 3a20 7b7d 202d  orted mode: {} -
-0000b1c0: 2d20 4d6f 6465 2073 686f 756c 6420 7573  - Mode should us
-0000b1d0: 6520 6f6e 6520 6f66 2074 6865 2065 6e75  e one of the enu
-0000b1e0: 6d73 2062 656c 6f6e 6769 6e67 2074 6f3a  ms belonging to:
-0000b1f0: 2020 7b7d 270a 2020 2020 2020 2020 2020    {}'.          
-0000b200: 2020 2020 2020 2e66 6f72 6d61 7428 6d6f        .format(mo
-0000b210: 6465 2c20 272c 2027 2e6a 6f69 6e28 5b73  de, ', '.join([s
-0000b220: 7472 2861 2920 666f 7220 6120 696e 2041  tr(a) for a in A
-0000b230: 6363 6573 735d 2929 290a 2020 2020 2020  ccess]))).      
-0000b240: 2020 6966 206d 6f64 6520 6e6f 7420 696e    if mode not in
-0000b250: 2028 4163 6365 7373 2e52 4541 442c 2041   (Access.READ, A
-0000b260: 6363 6573 732e 5752 4954 4529 3a0a 2020  ccess.WRITE):.  
-0000b270: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000b280: 5479 7065 4572 726f 7228 2755 6e73 7570  TypeError('Unsup
-0000b290: 706f 7274 6564 206d 6f64 653a 207b 7d27  ported mode: {}'
-0000b2a0: 2e66 6f72 6d61 7428 6d6f 6465 2929 0a20  .format(mode)). 
-0000b2b0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0000b2c0: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
-0000b2d0: 6965 6e74 2e68 6561 645f 6275 636b 6574  ient.head_bucket
-0000b2e0: 2842 7563 6b65 743d 6275 636b 6574 290a  (Bucket=bucket).
-0000b2f0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-0000b300: 7863 6570 7469 6f6e 2061 7320 6572 726f  xception as erro
-0000b310: 723a 0a20 2020 2020 2020 2020 2020 2065  r:.            e
-0000b320: 7272 6f72 203d 2074 7261 6e73 6c61 7465  rror = translate
-0000b330: 5f73 335f 6572 726f 7228 6572 726f 722c  _s3_error(error,
-0000b340: 2073 335f 7572 6c29 0a20 2020 2020 2020   s3_url).       
-0000b350: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0000b360: 6365 2865 7272 6f72 2c20 2853 3350 6572  ce(error, (S3Per
-0000b370: 6d69 7373 696f 6e45 7272 6f72 2c20 5333  missionError, S3
-0000b380: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-0000b390: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3b0: 2020 2020 2053 3342 7563 6b65 744e 6f74       S3BucketNot
-0000b3c0: 466f 756e 6445 7272 6f72 2929 3a0a 2020  FoundError)):.  
-0000b3d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000b3e0: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
-0000b3f0: 2020 2020 2020 2072 6169 7365 2065 7272         raise err
-0000b400: 6f72 0a20 2020 2020 2020 2072 6574 7572  or.        retur
-0000b410: 6e20 5472 7565 0a0a 2020 2020 6465 6620  n True..    def 
-0000b420: 6578 6973 7473 2873 656c 662c 2066 6f6c  exists(self, fol
-0000b430: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-0000b440: 2046 616c 7365 2920 2d3e 2062 6f6f 6c3a   False) -> bool:
-0000b450: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000b460: 2020 2020 2054 6573 7420 6966 2073 335f       Test if s3_
-0000b470: 7572 6c20 6578 6973 7473 0a0a 2020 2020  url exists..    
-0000b480: 2020 2020 4966 2074 6865 2062 7563 6b65      If the bucke
-0000b490: 7420 6f66 2073 335f 7572 6c20 6172 6520  t of s3_url are 
-0000b4a0: 6e6f 7420 7065 726d 6974 7465 6420 746f  not permitted to
-0000b4b0: 2072 6561 642c 2072 6574 7572 6e20 4661   read, return Fa
-0000b4c0: 6c73 650a 0a20 2020 2020 2020 203a 7265  lse..        :re
-0000b4d0: 7475 726e 733a 2054 7275 6520 6966 2073  turns: True if s
-0000b4e0: 335f 7572 6c20 6569 7873 7473 2c20 656c  3_url eixsts, el
-0000b4f0: 7365 2046 616c 7365 0a20 2020 2020 2020  se False.       
-0000b500: 2027 2727 0a20 2020 2020 2020 2062 7563   '''.        buc
-0000b510: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
-0000b520: 5f73 335f 7572 6c28 7365 6c66 2e70 6174  _s3_url(self.pat
-0000b530: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000b540: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0000b550: 6275 636b 6574 3a20 2023 2073 333a 2f2f  bucket:  # s3://
-0000b560: 203d 3e20 5472 7565 2c20 7333 3a2f 2f2f   => True, s3:///
-0000b570: 6b65 7920 3d3e 2046 616c 7365 0a20 2020  key => False.   
-0000b580: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000b590: 6e6f 7420 6b65 790a 0a20 2020 2020 2020  not key..       
-0000b5a0: 2072 6574 7572 6e20 7365 6c66 2e69 735f   return self.is_
-0000b5b0: 6469 7228 2920 6f72 2073 656c 662e 6973  dir() or self.is
-0000b5c0: 5f66 696c 6528 666f 6c6c 6f77 6c69 6e6b  _file(followlink
-0000b5d0: 7329 0a0a 2020 2020 6465 6620 6765 746d  s)..    def getm
-0000b5e0: 7469 6d65 2873 656c 662c 2066 6f6c 6c6f  time(self, follo
-0000b5f0: 775f 7379 6d6c 696e 6b73 3a20 626f 6f6c  w_symlinks: bool
-0000b600: 203d 2046 616c 7365 2920 2d3e 2066 6c6f   = False) -> flo
-0000b610: 6174 3a0a 2020 2020 2020 2020 2727 270a  at:.        '''.
-0000b620: 2020 2020 2020 2020 4765 7420 6c61 7374          Get last
-0000b630: 2d6d 6f64 6966 6965 6420 7469 6d65 206f  -modified time o
-0000b640: 6620 7468 6520 6669 6c65 206f 6e20 7468  f the file on th
-0000b650: 6520 6769 7665 6e20 7333 5f75 726c 2070  e given s3_url p
-0000b660: 6174 6820 2869 6e20 556e 6978 2074 696d  ath (in Unix tim
-0000b670: 6573 7461 6d70 2066 6f72 6d61 7429 2e0a  estamp format)..
-0000b680: 2020 2020 2020 2020 4966 2074 6865 2070          If the p
-0000b690: 6174 6820 6973 2061 6e20 6578 6973 7465  ath is an existe
-0000b6a0: 6e74 2064 6972 6563 746f 7279 2c20 7265  nt directory, re
-0000b6b0: 7475 726e 2074 6865 206c 6174 6573 7420  turn the latest 
-0000b6c0: 6d6f 6469 6669 6564 2074 696d 6520 6f66  modified time of
-0000b6d0: 2061 6c6c 2066 696c 6520 696e 2069 742e   all file in it.
-0000b6e0: 2054 6865 206d 7469 6d65 206f 6620 656d   The mtime of em
-0000b6f0: 7074 7920 6469 7265 6374 6f72 7920 6973  pty directory is
-0000b700: 2031 3937 302d 3031 2d30 3120 3030 3a30   1970-01-01 00:0
-0000b710: 303a 3030 0a0a 2020 2020 2020 2020 4966  0:00..        If
-0000b720: 2073 335f 7572 6c20 6973 206e 6f74 2061   s3_url is not a
-0000b730: 6e20 6578 6973 7465 6e74 2070 6174 682c  n existent path,
-0000b740: 2077 6869 6368 206d 6561 6e73 2073 335f   which means s3_
-0000b750: 6578 6973 7428 7333 5f75 726c 2920 7265  exist(s3_url) re
-0000b760: 7475 726e 7320 4661 6c73 652c 2074 6865  turns False, the
-0000b770: 6e20 7261 6973 6520 5333 4669 6c65 4e6f  n raise S3FileNo
-0000b780: 7446 6f75 6e64 4572 726f 720a 0a20 2020  tFoundError..   
-0000b790: 2020 2020 203a 7265 7475 726e 733a 204c       :returns: L
-0000b7a0: 6173 742d 6d6f 6469 6669 6564 2074 696d  ast-modified tim
-0000b7b0: 650a 2020 2020 2020 2020 3a72 6169 7365  e.        :raise
-0000b7c0: 733a 2053 3346 696c 654e 6f74 466f 756e  s: S3FileNotFoun
-0000b7d0: 6445 7272 6f72 2c20 556e 7375 7070 6f72  dError, Unsuppor
-0000b7e0: 7465 6445 7272 6f72 0a20 2020 2020 2020  tedError.       
-0000b7f0: 2027 2727 0a20 2020 2020 2020 2072 6574   '''.        ret
-0000b800: 7572 6e20 7365 6c66 2e73 7461 7428 666f  urn self.stat(fo
-0000b810: 6c6c 6f77 5f73 796d 6c69 6e6b 733d 666f  llow_symlinks=fo
-0000b820: 6c6c 6f77 5f73 796d 6c69 6e6b 7329 2e6d  llow_symlinks).m
-0000b830: 7469 6d65 0a0a 2020 2020 6465 6620 6765  time..    def ge
-0000b840: 7473 697a 6528 7365 6c66 2c20 666f 6c6c  tsize(self, foll
-0000b850: 6f77 5f73 796d 6c69 6e6b 733a 2062 6f6f  ow_symlinks: boo
-0000b860: 6c20 3d20 4661 6c73 6529 202d 3e20 696e  l = False) -> in
-0000b870: 743a 0a20 2020 2020 2020 2027 2727 0a20  t:.        '''. 
-0000b880: 2020 2020 2020 2047 6574 2066 696c 6520         Get file 
-0000b890: 7369 7a65 206f 6e20 7468 6520 6769 7665  size on the give
-0000b8a0: 6e20 7333 5f75 726c 2070 6174 6820 2869  n s3_url path (i
-0000b8b0: 6e20 6279 7465 7329 2e0a 2020 2020 2020  n bytes)..      
-0000b8c0: 2020 4966 2074 6865 2070 6174 6820 696e    If the path in
-0000b8d0: 2061 2064 6972 6563 746f 7279 2c20 7265   a directory, re
-0000b8e0: 7475 726e 2074 6865 2073 756d 206f 6620  turn the sum of 
-0000b8f0: 616c 6c20 6669 6c65 2073 697a 6520 696e  all file size in
-0000b900: 2069 742c 2069 6e63 6c75 6469 6e67 2066   it, including f
-0000b910: 696c 6520 696e 2073 7562 6469 7265 6374  ile in subdirect
-0000b920: 6f72 6965 7320 2869 6620 6578 6973 7429  ories (if exist)
-0000b930: 2e0a 2020 2020 2020 2020 5468 6520 7265  ..        The re
-0000b940: 7375 6c74 2065 7863 6c75 6465 7320 7468  sult excludes th
-0000b950: 6520 7369 7a65 206f 6620 6469 7265 6374  e size of direct
-0000b960: 6f72 7920 6974 7365 6c66 2e20 496e 206f  ory itself. In o
-0000b970: 7468 6572 2077 6f72 6473 2c20 7265 7475  ther words, retu
-0000b980: 726e 2030 2042 7974 6520 6f6e 2061 6e20  rn 0 Byte on an 
-0000b990: 656d 7074 7920 6469 7265 6374 6f72 7920  empty directory 
-0000b9a0: 7061 7468 2e0a 0a20 2020 2020 2020 2049  path...        I
-0000b9b0: 6620 7333 5f75 726c 2069 7320 6e6f 7420  f s3_url is not 
-0000b9c0: 616e 2065 7869 7374 656e 7420 7061 7468  an existent path
-0000b9d0: 2c20 7768 6963 6820 6d65 616e 7320 7333  , which means s3
-0000b9e0: 5f65 7869 7374 2873 335f 7572 6c29 2072  _exist(s3_url) r
-0000b9f0: 6574 7572 6e73 2046 616c 7365 2c20 7468  eturns False, th
-0000ba00: 656e 2072 6169 7365 2053 3346 696c 654e  en raise S3FileN
-0000ba10: 6f74 466f 756e 6445 7272 6f72 0a0a 2020  otFoundError..  
-0000ba20: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000ba30: 4669 6c65 2073 697a 650a 2020 2020 2020  File size.      
-0000ba40: 2020 3a72 6169 7365 733a 2053 3346 696c    :raises: S3Fil
-0000ba50: 654e 6f74 466f 756e 6445 7272 6f72 2c20  eNotFoundError, 
-0000ba60: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
-0000ba70: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000ba80: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0000ba90: 2e73 7461 7428 666f 6c6c 6f77 5f73 796d  .stat(follow_sym
-0000baa0: 6c69 6e6b 733d 666f 6c6c 6f77 5f73 796d  links=follow_sym
-0000bab0: 6c69 6e6b 7329 2e73 697a 650a 0a20 2020  links).size..   
-0000bac0: 2064 6566 2067 6c6f 6228 0a20 2020 2020   def glob(.     
-0000bad0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0000bae0: 2020 2020 2020 2020 2070 6174 7465 726e           pattern
-0000baf0: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-0000bb00: 6375 7273 6976 653a 2062 6f6f 6c20 3d20  cursive: bool = 
-0000bb10: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-0000bb20: 2020 6d69 7373 696e 675f 6f6b 3a20 626f    missing_ok: bo
-0000bb30: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
-0000bb40: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
-0000bb50: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
-0000bb60: 2c0a 2020 2020 2920 2d3e 204c 6973 745b  ,.    ) -> List[
-0000bb70: 2753 3350 6174 6827 5d3a 0a20 2020 2020  'S3Path']:.     
-0000bb80: 2020 2027 2727 5265 7475 726e 2073 3320     '''Return s3 
-0000bb90: 7061 7468 206c 6973 7420 696e 2061 7363  path list in asc
-0000bba0: 656e 6469 6e67 2061 6c70 6861 6265 7469  ending alphabeti
-0000bbb0: 6361 6c20 6f72 6465 722c 2069 6e20 7768  cal order, in wh
-0000bbc0: 6963 6820 7061 7468 206d 6174 6368 6573  ich path matches
-0000bbd0: 2067 6c6f 6220 7061 7474 6572 6e0a 2020   glob pattern.  
-0000bbe0: 2020 2020 2020 4e6f 7465 733a 204f 6e6c        Notes: Onl
-0000bbf0: 7920 676c 6f62 2069 6e20 6275 636b 6574  y glob in bucket
-0000bc00: 2e20 4966 2074 7279 696e 6720 746f 206d  . If trying to m
-0000bc10: 6174 6368 2062 7563 6b65 7420 7769 7468  atch bucket with
-0000bc20: 2077 696c 6463 6172 6420 6368 6172 6163   wildcard charac
-0000bc30: 7465 7273 2c20 7261 6973 6520 556e 7375  ters, raise Unsu
-0000bc40: 7070 6f72 7465 6445 7272 6f72 0a0a 2020  pportedError..  
-0000bc50: 2020 2020 2020 3a70 6172 616d 2070 6174        :param pat
-0000bc60: 7465 726e 3a20 476c 6f62 2074 6865 2067  tern: Glob the g
-0000bc70: 6976 656e 2072 656c 6174 6976 6520 7061  iven relative pa
-0000bc80: 7474 6572 6e20 696e 2074 6865 2064 6972  ttern in the dir
-0000bc90: 6563 746f 7279 2072 6570 7265 7365 6e74  ectory represent
-0000bca0: 6564 2062 7920 7468 6973 2070 6174 680a  ed by this path.
-0000bcb0: 2020 2020 2020 2020 3a70 6172 616d 2072          :param r
-0000bcc0: 6563 7572 7369 7665 3a20 4966 2046 616c  ecursive: If Fal
-0000bcd0: 7365 2c20 602a 2a60 2077 696c 6c20 6e6f  se, `**` will no
-0000bce0: 7420 7365 6172 6368 2064 6972 6563 746f  t search directo
-0000bcf0: 7279 2072 6563 7572 7369 7665 6c79 0a20  ry recursively. 
-0000bd00: 2020 2020 2020 203a 7061 7261 6d20 6d69         :param mi
-0000bd10: 7373 696e 675f 6f6b 3a20 4966 2046 616c  ssing_ok: If Fal
-0000bd20: 7365 2061 6e64 2074 6172 6765 7420 7061  se and target pa
-0000bd30: 7468 2064 6f65 736e 2774 206d 6174 6368  th doesn't match
-0000bd40: 2061 6e79 2066 696c 652c 2072 6169 7365   any file, raise
-0000bd50: 2046 696c 654e 6f74 466f 756e 6445 7272   FileNotFoundErr
-0000bd60: 6f72 0a20 2020 2020 2020 203a 7261 6973  or.        :rais
-0000bd70: 6573 3a20 556e 7375 7070 6f72 7465 6445  es: UnsupportedE
-0000bd80: 7272 6f72 2c20 7768 656e 2062 7563 6b65  rror, when bucke
-0000bd90: 7420 7061 7274 2063 6f6e 7461 696e 7320  t part contains 
-0000bda0: 7769 6c64 6361 7264 2063 6861 7261 6374  wildcard charact
-0000bdb0: 6572 730a 2020 2020 2020 2020 3a72 6574  ers.        :ret
-0000bdc0: 7572 6e73 3a20 4120 6c69 7374 2063 6f6e  urns: A list con
-0000bdd0: 7461 696e 7320 7061 7468 7320 6d61 7463  tains paths matc
-0000bde0: 6820 6073 335f 7061 7468 6e61 6d65 600a  h `s3_pathname`.
-0000bdf0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000be00: 2020 2020 7265 7475 726e 206c 6973 7428      return list(
-0000be10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000be20: 662e 6967 6c6f 6228 0a20 2020 2020 2020  f.iglob(.       
-0000be30: 2020 2020 2020 2020 2070 6174 7465 726e           pattern
-0000be40: 3d70 6174 7465 726e 2c0a 2020 2020 2020  =pattern,.      
-0000be50: 2020 2020 2020 2020 2020 7265 6375 7273            recurs
-0000be60: 6976 653d 7265 6375 7273 6976 652c 0a20  ive=recursive,. 
-0000be70: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000be80: 6973 7369 6e67 5f6f 6b3d 6d69 7373 696e  issing_ok=missin
-0000be90: 675f 6f6b 2c0a 2020 2020 2020 2020 2020  g_ok,.          
-0000bea0: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
-0000beb0: 733d 666f 6c6c 6f77 6c69 6e6b 7329 290a  s=followlinks)).
-0000bec0: 0a20 2020 2064 6566 2067 6c6f 625f 7374  .    def glob_st
-0000bed0: 6174 280a 2020 2020 2020 2020 2020 2020  at(.            
-0000bee0: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
-0000bef0: 2020 7061 7474 6572 6e2c 0a20 2020 2020    pattern,.     
-0000bf00: 2020 2020 2020 2072 6563 7572 7369 7665         recursive
-0000bf10: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
-0000bf20: 2020 2020 2020 2020 2020 206d 6973 7369             missi
-0000bf30: 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20 5472  ng_ok: bool = Tr
-0000bf40: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-0000bf50: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-0000bf60: 6c20 3d20 4661 6c73 6529 202d 3e20 4974  l = False) -> It
-0000bf70: 6572 6174 6f72 5b46 696c 6545 6e74 7279  erator[FileEntry
-0000bf80: 5d3a 0a20 2020 2020 2020 2027 2727 5265  ]:.        '''Re
-0000bf90: 7475 726e 2061 2067 656e 6572 6174 6f72  turn a generator
-0000bfa0: 2063 6f6e 7461 696e 7320 7475 706c 6573   contains tuples
-0000bfb0: 206f 6620 7061 7468 2061 6e64 2066 696c   of path and fil
-0000bfc0: 6520 7374 6174 2c20 696e 2061 7363 656e  e stat, in ascen
-0000bfd0: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
-0000bfe0: 6c20 6f72 6465 722c 2069 6e20 7768 6963  l order, in whic
-0000bff0: 6820 7061 7468 206d 6174 6368 6573 2067  h path matches g
-0000c000: 6c6f 6220 7061 7474 6572 6e0a 2020 2020  lob pattern.    
-0000c010: 2020 2020 4e6f 7465 733a 204f 6e6c 7920      Notes: Only 
-0000c020: 676c 6f62 2069 6e20 6275 636b 6574 2e20  glob in bucket. 
-0000c030: 4966 2074 7279 696e 6720 746f 206d 6174  If trying to mat
-0000c040: 6368 2062 7563 6b65 7420 7769 7468 2077  ch bucket with w
-0000c050: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
-0000c060: 7273 2c20 7261 6973 6520 556e 7375 7070  rs, raise Unsupp
-0000c070: 6f72 7465 6445 7272 6f72 0a0a 2020 2020  ortedError..    
-0000c080: 2020 2020 3a70 6172 616d 2070 6174 7465      :param patte
-0000c090: 726e 3a20 476c 6f62 2074 6865 2067 6976  rn: Glob the giv
-0000c0a0: 656e 2072 656c 6174 6976 6520 7061 7474  en relative patt
-0000c0b0: 6572 6e20 696e 2074 6865 2064 6972 6563  ern in the direc
-0000c0c0: 746f 7279 2072 6570 7265 7365 6e74 6564  tory represented
-0000c0d0: 2062 7920 7468 6973 2070 6174 680a 2020   by this path.  
-0000c0e0: 2020 2020 2020 3a70 6172 616d 2072 6563        :param rec
-0000c0f0: 7572 7369 7665 3a20 4966 2046 616c 7365  ursive: If False
-0000c100: 2c20 602a 2a60 2077 696c 6c20 6e6f 7420  , `**` will not 
-0000c110: 7365 6172 6368 2064 6972 6563 746f 7279  search directory
-0000c120: 2072 6563 7572 7369 7665 6c79 0a20 2020   recursively.   
-0000c130: 2020 2020 203a 7061 7261 6d20 6d69 7373       :param miss
-0000c140: 696e 675f 6f6b 3a20 4966 2046 616c 7365  ing_ok: If False
-0000c150: 2061 6e64 2074 6172 6765 7420 7061 7468   and target path
-0000c160: 2064 6f65 736e 2774 206d 6174 6368 2061   doesn't match a
-0000c170: 6e79 2066 696c 652c 2072 6169 7365 2046  ny file, raise F
-0000c180: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-0000c190: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
-0000c1a0: 3a20 556e 7375 7070 6f72 7465 6445 7272  : UnsupportedErr
-0000c1b0: 6f72 2c20 7768 656e 2062 7563 6b65 7420  or, when bucket 
-0000c1c0: 7061 7274 2063 6f6e 7461 696e 7320 7769  part contains wi
-0000c1d0: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
-0000c1e0: 730a 2020 2020 2020 2020 3a72 6574 7572  s.        :retur
-0000c1f0: 6e73 3a20 4120 6765 6e65 7261 746f 7220  ns: A generator 
-0000c200: 636f 6e74 6169 6e73 2074 7570 6c65 7320  contains tuples 
-0000c210: 6f66 2070 6174 6820 616e 6420 6669 6c65  of path and file
-0000c220: 2073 7461 742c 2069 6e20 7768 6963 6820   stat, in which 
-0000c230: 7061 7468 7320 6d61 7463 6820 6073 335f  paths match `s3_
-0000c240: 7061 7468 6e61 6d65 600a 2020 2020 2020  pathname`.      
-0000c250: 2020 2727 270a 2020 2020 2020 2020 676c    '''.        gl
-0000c260: 6f62 5f70 6174 6820 3d20 7365 6c66 2e5f  ob_path = self._
-0000c270: 7333 5f70 6174 680a 2020 2020 2020 2020  s3_path.        
-0000c280: 6966 2070 6174 7465 726e 3a0a 2020 2020  if pattern:.    
-0000c290: 2020 2020 2020 2020 676c 6f62 5f70 6174          glob_pat
-0000c2a0: 6820 3d20 7365 6c66 2e6a 6f69 6e70 6174  h = self.joinpat
-0000c2b0: 6828 7061 7474 6572 6e29 2e5f 7333 5f70  h(pattern)._s3_p
-0000c2c0: 6174 6820 2023 2070 7974 7970 653a 2064  ath  # pytype: d
-0000c2d0: 6973 6162 6c65 3d61 7474 7269 6275 7465  isable=attribute
-0000c2e0: 2d65 7272 6f72 0a20 2020 2020 2020 2073  -error.        s
-0000c2f0: 335f 7061 7468 6e61 6d65 203d 2066 7370  3_pathname = fsp
-0000c300: 6174 6828 676c 6f62 5f70 6174 6829 0a0a  ath(glob_path)..
-0000c310: 2020 2020 2020 2020 6465 6620 6372 6561          def crea
-0000c320: 7465 5f67 656e 6572 6174 6f72 2829 3a0a  te_generator():.
-0000c330: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000c340: 6772 6f75 705f 7333 5f70 6174 686e 616d  group_s3_pathnam
-0000c350: 655f 3120 696e 205f 6772 6f75 705f 7333  e_1 in _group_s3
-0000c360: 7061 7468 5f62 795f 6275 636b 6574 280a  path_by_bucket(.
-0000c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c380: 2020 2020 7333 5f70 6174 686e 616d 652c      s3_pathname,
-0000c390: 2073 656c 662e 5f70 726f 6669 6c65 5f6e   self._profile_n
-0000c3a0: 616d 6529 3a0a 2020 2020 2020 2020 2020  ame):.          
-0000c3b0: 2020 2020 2020 666f 7220 6772 6f75 705f        for group_
-0000c3c0: 7333 5f70 6174 686e 616d 655f 3220 696e  s3_pathname_2 in
-0000c3d0: 205f 6772 6f75 705f 7333 7061 7468 5f62   _group_s3path_b
-0000c3e0: 795f 7072 6566 6978 280a 2020 2020 2020  y_prefix(.      
-0000c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c400: 2020 6772 6f75 705f 7333 5f70 6174 686e    group_s3_pathn
-0000c410: 616d 655f 3129 3a0a 2020 2020 2020 2020  ame_1):.        
-0000c420: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000c430: 6669 6c65 5f65 6e74 7279 2069 6e20 5f73  file_entry in _s
-0000c440: 335f 676c 6f62 5f73 7461 745f 7369 6e67  3_glob_stat_sing
-0000c450: 6c65 5f70 6174 6828 0a20 2020 2020 2020  le_path(.       
-0000c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c470: 2020 2020 2067 726f 7570 5f73 335f 7061       group_s3_pa
-0000c480: 7468 6e61 6d65 5f32 2c20 7265 6375 7273  thname_2, recurs
-0000c490: 6976 652c 206d 6973 7369 6e67 5f6f 6b2c  ive, missing_ok,
-0000c4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c4b0: 2020 2020 2020 2020 2020 2020 2066 6f6c               fol
-0000c4c0: 6c6f 776c 696e 6b73 3d66 6f6c 6c6f 776c  lowlinks=followl
-0000c4d0: 696e 6b73 2c0a 2020 2020 2020 2020 2020  inks,.          
-0000c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4f0: 2020 7072 6f66 696c 655f 6e61 6d65 3d73    profile_name=s
-0000c500: 656c 662e 5f70 726f 6669 6c65 5f6e 616d  elf._profile_nam
-0000c510: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0000c520: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0000c530: 656c 662e 5f70 726f 6669 6c65 5f6e 616d  elf._profile_nam
-0000c540: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000c550: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000c560: 696c 655f 656e 7472 7920 3d20 6669 6c65  ile_entry = file
-0000c570: 5f65 6e74 7279 2e5f 7265 706c 6163 6528  _entry._replace(
-0000c580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f20: 2020 7372 635f 7061 7468 2c0a 2020 2020    src_path,.    
+00009f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f50: 6627 6279 7465 733d 7b67 726f 7570 5f6c  f'bytes={group_l
+00009f60: 6163 6b5f 7369 7a65 7d2d 7b63 7572 7265  ack_size}-{curre
+00009f70: 6e74 5f66 696c 655f 7369 7a65 2d31 7d27  nt_file_size-1}'
+00009f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009fa0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00009fb0: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+00009fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009fd0: 2020 2020 2020 2020 205d 290a 2020 2020           ]).    
+00009fe0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00009ff0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a000: 2020 2020 2020 6375 7272 656e 745f 6772        current_gr
+0000a010: 6f75 702e 6170 7065 6e64 2828 7372 635f  oup.append((src_
+0000a020: 7061 7468 2c20 4e6f 6e65 2929 0a20 2020  path, None)).   
+0000a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a040: 2067 726f 7570 732e 6170 7065 6e64 2863   groups.append(c
+0000a050: 7572 7265 6e74 5f67 726f 7570 290a 2020  urrent_group).  
+0000a060: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a080: 6772 6f75 7073 5b2d 315d 2e65 7874 656e  groups[-1].exten
+0000a090: 6428 6375 7272 656e 745f 6772 6f75 7029  d(current_group)
+0000a0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a0b0: 2067 726f 7570 732e 6170 7065 6e64 285b   groups.append([
+0000a0c0: 2873 7263 5f70 6174 682c 204e 6f6e 6529  (src_path, None)
+0000a0d0: 5d29 0a20 2020 2020 2020 2020 2020 2063  ]).            c
+0000a0e0: 7572 7265 6e74 5f67 726f 7570 2c20 6375  urrent_group, cu
+0000a0f0: 7272 656e 745f 6772 6f75 705f 7369 7a65  rrent_group_size
+0000a100: 203d 205b 5d2c 2030 0a20 2020 2020 2020   = [], 0.       
+0000a110: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000a120: 2020 2063 7572 7265 6e74 5f67 726f 7570     current_group
+0000a130: 2e61 7070 656e 6428 2873 7263 5f70 6174  .append((src_pat
+0000a140: 682c 204e 6f6e 6529 290a 2020 2020 2020  h, None)).      
+0000a150: 2020 2020 2020 6375 7272 656e 745f 6772        current_gr
+0000a160: 6f75 705f 7369 7a65 202b 3d20 6375 7272  oup_size += curr
+0000a170: 656e 745f 6669 6c65 5f73 697a 650a 2020  ent_file_size.  
+0000a180: 2020 2020 2020 2020 2020 6966 2063 7572            if cur
+0000a190: 7265 6e74 5f67 726f 7570 5f73 697a 6520  rent_group_size 
+0000a1a0: 3e3d 2062 6c6f 636b 5f73 697a 653a 0a20  >= block_size:. 
+0000a1b0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0000a1c0: 726f 7570 732e 6170 7065 6e64 2863 7572  roups.append(cur
+0000a1d0: 7265 6e74 5f67 726f 7570 290a 2020 2020  rent_group).    
+0000a1e0: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+0000a1f0: 656e 745f 6772 6f75 702c 2063 7572 7265  ent_group, curre
+0000a200: 6e74 5f67 726f 7570 5f73 697a 6520 3d20  nt_group_size = 
+0000a210: 5b5d 2c20 300a 2020 2020 6966 2063 7572  [], 0.    if cur
+0000a220: 7265 6e74 5f67 726f 7570 3a0a 2020 2020  rent_group:.    
+0000a230: 2020 2020 6772 6f75 7073 2e61 7070 656e      groups.appen
+0000a240: 6428 6375 7272 656e 745f 6772 6f75 7029  d(current_group)
+0000a250: 0a20 2020 2072 6574 7572 6e20 6772 6f75  .    return grou
+0000a260: 7073 0a0a 0a64 6566 2073 335f 636f 6e63  ps...def s3_conc
+0000a270: 6174 280a 2020 2020 2020 2020 7372 635f  at(.        src_
+0000a280: 7061 7468 733a 204c 6973 745b 5061 7468  paths: List[Path
+0000a290: 4c69 6b65 5d2c 0a20 2020 2020 2020 2064  Like],.        d
+0000a2a0: 7374 5f70 6174 683a 2050 6174 684c 696b  st_path: PathLik
+0000a2b0: 652c 0a20 2020 2020 2020 2062 6c6f 636b  e,.        block
+0000a2c0: 5f73 697a 653a 2069 6e74 203d 2044 4546  _size: int = DEF
+0000a2d0: 4155 4c54 5f42 4c4f 434b 5f53 495a 452c  AULT_BLOCK_SIZE,
+0000a2e0: 0a20 2020 2020 2020 206d 6178 5f77 6f72  .        max_wor
+0000a2f0: 6b65 7273 3a20 696e 7420 3d20 474c 4f42  kers: int = GLOB
+0000a300: 414c 5f4d 4158 5f57 4f52 4b45 5253 2920  AL_MAX_WORKERS) 
+0000a310: 2d3e 204e 6f6e 653a 0a20 2020 2027 2727  -> None:.    '''
+0000a320: 436f 6e63 6174 656e 6174 6520 7333 2066  Concatenate s3 f
+0000a330: 696c 6573 2074 6f20 6f6e 6520 6669 6c65  iles to one file
+0000a340: 2e0a 0a20 2020 203a 7061 7261 6d20 7372  ...    :param sr
+0000a350: 635f 7061 7468 733a 2047 6976 656e 2073  c_paths: Given s
+0000a360: 6f75 7263 6520 7061 7468 730a 2020 2020  ource paths.    
+0000a370: 3a70 6172 616d 2064 7374 5f70 6174 683a  :param dst_path:
+0000a380: 2047 6976 656e 2064 6573 7469 6e61 7469   Given destinati
+0000a390: 6f6e 2070 6174 680a 2020 2020 2727 270a  on path.    '''.
+0000a3a0: 2020 2020 636c 6965 6e74 203d 2053 3350      client = S3P
+0000a3b0: 6174 6828 6473 745f 7061 7468 292e 5f63  ath(dst_path)._c
+0000a3c0: 6c69 656e 740a 2020 2020 7769 7468 2072  lient.    with r
+0000a3d0: 6169 7365 5f73 335f 6572 726f 7228 6473  aise_s3_error(ds
+0000a3e0: 745f 7061 7468 293a 0a20 2020 2020 2020  t_path):.       
+0000a3f0: 2069 6620 626c 6f63 6b5f 7369 7a65 203d   if block_size =
+0000a400: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+0000a410: 2067 726f 7570 7320 3d20 5b5b 2873 7263   groups = [[(src
+0000a420: 5f70 6174 682c 204e 6f6e 6529 5d20 666f  _path, None)] fo
+0000a430: 7220 7372 635f 7061 7468 2069 6e20 7372  r src_path in sr
+0000a440: 635f 7061 7468 735d 0a20 2020 2020 2020  c_paths].       
+0000a450: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000a460: 2020 2067 726f 7570 7320 3d20 5f67 726f     groups = _gro
+0000a470: 7570 5f73 7263 5f70 6174 6873 5f62 795f  up_src_paths_by_
+0000a480: 626c 6f63 6b28 7372 635f 7061 7468 732c  block(src_paths,
+0000a490: 2062 6c6f 636b 5f73 697a 653d 626c 6f63   block_size=bloc
+0000a4a0: 6b5f 7369 7a65 290a 0a20 2020 2020 2020  k_size)..       
+0000a4b0: 2077 6974 6820 4d75 6c74 6950 6172 7457   with MultiPartW
+0000a4c0: 7269 7465 7228 636c 6965 6e74 2c20 6473  riter(client, ds
+0000a4d0: 745f 7061 7468 2920 6173 2077 7269 7465  t_path) as write
+0000a4e0: 722c 2054 6872 6561 6450 6f6f 6c45 7865  r, ThreadPoolExe
+0000a4f0: 6375 746f 7228 0a20 2020 2020 2020 2020  cutor(.         
+0000a500: 2020 2020 2020 206d 6178 5f77 6f72 6b65         max_worke
+0000a510: 7273 3d6d 6178 5f77 6f72 6b65 7273 2920  rs=max_workers) 
+0000a520: 6173 2065 7865 6375 746f 723a 0a20 2020  as executor:.   
+0000a530: 2020 2020 2020 2020 2066 6f72 2069 6e64           for ind
+0000a540: 6578 2c20 6772 6f75 7020 696e 2065 6e75  ex, group in enu
+0000a550: 6d65 7261 7465 2867 726f 7570 732c 2073  merate(groups, s
+0000a560: 7461 7274 3d31 293a 0a20 2020 2020 2020  tart=1):.       
+0000a570: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0000a580: 6772 6f75 7029 203d 3d20 313a 0a20 2020  group) == 1:.   
+0000a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5a0: 2065 7865 6375 746f 722e 7375 626d 6974   executor.submit
+0000a5b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000a5c0: 2020 2020 2020 2020 2020 7772 6974 6572            writer
+0000a5d0: 2e75 706c 6f61 645f 7061 7274 5f63 6f70  .upload_part_cop
+0000a5e0: 792c 2069 6e64 6578 2c20 6772 6f75 705b  y, index, group[
+0000a5f0: 305d 5b30 5d2c 0a20 2020 2020 2020 2020  0][0],.         
+0000a600: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0000a610: 726f 7570 5b30 5d5b 315d 290a 2020 2020  roup[0][1]).    
+0000a620: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000a630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a640: 2020 2020 2020 6578 6563 7574 6f72 2e73        executor.s
+0000a650: 7562 6d69 7428 7772 6974 6572 2e75 706c  ubmit(writer.upl
+0000a660: 6f61 645f 7061 7274 5f62 795f 7061 7468  oad_part_by_path
+0000a670: 732c 2069 6e64 6578 2c20 6772 6f75 7029  s, index, group)
+0000a680: 0a0a 0a40 536d 6172 7450 6174 682e 7265  ...@SmartPath.re
+0000a690: 6769 7374 6572 0a63 6c61 7373 2053 3350  gister.class S3P
+0000a6a0: 6174 6828 5552 4950 6174 6829 3a0a 0a20  ath(URIPath):.. 
+0000a6b0: 2020 2070 726f 746f 636f 6c20 3d20 2273     protocol = "s
+0000a6c0: 3322 0a0a 2020 2020 6465 6620 5f5f 696e  3"..    def __in
+0000a6d0: 6974 5f5f 2873 656c 662c 2070 6174 683a  it__(self, path:
+0000a6e0: 2022 5061 7468 4c69 6b65 222c 202a 6f74   "PathLike", *ot
+0000a6f0: 6865 725f 7061 7468 733a 2022 5061 7468  her_paths: "Path
+0000a700: 4c69 6b65 2229 3a0a 2020 2020 2020 2020  Like"):.        
+0000a710: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+0000a720: 2870 6174 682c 202a 6f74 6865 725f 7061  (path, *other_pa
+0000a730: 7468 7329 0a20 2020 2020 2020 2070 726f  ths).        pro
+0000a740: 746f 636f 6c20 3d20 6765 745f 7572 6c5f  tocol = get_url_
+0000a750: 7363 6865 6d65 2873 656c 662e 7061 7468  scheme(self.path
+0000a760: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+0000a770: 7072 6f74 6f63 6f6c 5f77 6974 685f 7072  protocol_with_pr
+0000a780: 6f66 696c 6520 3d20 7365 6c66 2e70 726f  ofile = self.pro
+0000a790: 746f 636f 6c0a 2020 2020 2020 2020 7365  tocol.        se
+0000a7a0: 6c66 2e5f 7072 6f66 696c 655f 6e61 6d65  lf._profile_name
+0000a7b0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0000a7c0: 6966 2070 726f 746f 636f 6c2e 7374 6172  if protocol.star
+0000a7d0: 7473 7769 7468 2827 7333 2b27 293a 0a20  tswith('s3+'):. 
+0000a7e0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000a7f0: 5f70 726f 746f 636f 6c5f 7769 7468 5f70  _protocol_with_p
+0000a800: 726f 6669 6c65 203d 2070 726f 746f 636f  rofile = protoco
+0000a810: 6c0a 2020 2020 2020 2020 2020 2020 7365  l.            se
+0000a820: 6c66 2e5f 7072 6f66 696c 655f 6e61 6d65  lf._profile_name
+0000a830: 203d 2070 726f 746f 636f 6c5b 333a 5d0a   = protocol[3:].
+0000a840: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000a850: 2e5f 7333 5f70 6174 6820 3d20 6622 7333  ._s3_path = f"s3
+0000a860: 3a2f 2f7b 7365 6c66 2e70 6174 685b 6c65  ://{self.path[le
+0000a870: 6e28 7072 6f74 6f63 6f6c 292b 333a 5d7d  n(protocol)+3:]}
+0000a880: 220a 2020 2020 2020 2020 656c 6966 206e  ".        elif n
+0000a890: 6f74 2070 726f 746f 636f 6c3a 0a20 2020  ot protocol:.   
+0000a8a0: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
+0000a8b0: 335f 7061 7468 203d 2066 2273 333a 2f2f  3_path = f"s3://
+0000a8c0: 7b73 656c 662e 7061 7468 2e6c 7374 7269  {self.path.lstri
+0000a8d0: 7028 272f 2729 7d22 0a20 2020 2020 2020  p('/')}".       
+0000a8e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000a8f0: 2020 2073 656c 662e 5f73 335f 7061 7468     self._s3_path
+0000a900: 203d 2073 656c 662e 7061 7468 0a0a 2020   = self.path..  
+0000a910: 2020 4063 6163 6865 6470 726f 7065 7274    @cachedpropert
+0000a920: 790a 2020 2020 6465 6620 7061 7468 5f77  y.    def path_w
+0000a930: 6974 685f 7072 6f74 6f63 6f6c 2873 656c  ith_protocol(sel
+0000a940: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
+0000a950: 2020 2027 2727 5265 7475 726e 2070 6174     '''Return pat
+0000a960: 6820 7769 7468 2070 726f 746f 636f 6c2c  h with protocol,
+0000a970: 206c 696b 6520 6669 6c65 3a2f 2f2f 726f   like file:///ro
+0000a980: 6f74 2c20 7333 3a2f 2f62 7563 6b65 742f  ot, s3://bucket/
+0000a990: 6b65 7927 2727 0a20 2020 2020 2020 2070  key'''.        p
+0000a9a0: 6174 6820 3d20 7365 6c66 2e70 6174 680a  ath = self.path.
+0000a9b0: 2020 2020 2020 2020 7072 6f74 6f63 6f6c          protocol
+0000a9c0: 5f70 7265 6669 7820 3d20 7365 6c66 2e5f  _prefix = self._
+0000a9d0: 7072 6f74 6f63 6f6c 5f77 6974 685f 7072  protocol_with_pr
+0000a9e0: 6f66 696c 6520 2b20 223a 2f2f 220a 2020  ofile + "://".  
+0000a9f0: 2020 2020 2020 6966 2070 6174 682e 7374        if path.st
+0000aa00: 6172 7473 7769 7468 2870 726f 746f 636f  artswith(protoco
+0000aa10: 6c5f 7072 6566 6978 293a 0a20 2020 2020  l_prefix):.     
+0000aa20: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
+0000aa30: 7468 0a20 2020 2020 2020 2072 6574 7572  th.        retur
+0000aa40: 6e20 7072 6f74 6f63 6f6c 5f70 7265 6669  n protocol_prefi
+0000aa50: 7820 2b20 7061 7468 2e6c 7374 7269 7028  x + path.lstrip(
+0000aa60: 272f 2729 0a0a 2020 2020 4063 6163 6865  '/')..    @cache
+0000aa70: 6470 726f 7065 7274 790a 2020 2020 6465  dproperty.    de
+0000aa80: 6620 7061 7468 5f77 6974 686f 7574 5f70  f path_without_p
+0000aa90: 726f 746f 636f 6c28 7365 6c66 2920 2d3e  rotocol(self) ->
+0000aaa0: 2073 7472 3a0a 2020 2020 2020 2020 2727   str:.        ''
+0000aab0: 2752 6574 7572 6e20 7061 7468 2077 6974  'Return path wit
+0000aac0: 686f 7574 2070 726f 746f 636f 6c2c 2065  hout protocol, e
+0000aad0: 7861 6d70 6c65 3a20 6966 2070 6174 6820  xample: if path 
+0000aae0: 6973 2073 333a 2f2f 6275 636b 6574 2f6b  is s3://bucket/k
+0000aaf0: 6579 2c20 7265 7475 726e 2062 7563 6b65  ey, return bucke
+0000ab00: 742f 6b65 7927 2727 0a20 2020 2020 2020  t/key'''.       
+0000ab10: 2070 6174 6820 3d20 7365 6c66 2e70 6174   path = self.pat
+0000ab20: 680a 2020 2020 2020 2020 7072 6f74 6f63  h.        protoc
+0000ab30: 6f6c 5f70 7265 6669 7820 3d20 7365 6c66  ol_prefix = self
+0000ab40: 2e5f 7072 6f74 6f63 6f6c 5f77 6974 685f  ._protocol_with_
+0000ab50: 7072 6f66 696c 6520 2b20 223a 2f2f 220a  profile + "://".
+0000ab60: 2020 2020 2020 2020 6966 2070 6174 682e          if path.
+0000ab70: 7374 6172 7473 7769 7468 2870 726f 746f  startswith(proto
+0000ab80: 636f 6c5f 7072 6566 6978 293a 0a20 2020  col_prefix):.   
+0000ab90: 2020 2020 2020 2020 2070 6174 6820 3d20           path = 
+0000aba0: 7061 7468 5b6c 656e 2870 726f 746f 636f  path[len(protoco
+0000abb0: 6c5f 7072 6566 6978 293a 5d0a 2020 2020  l_prefix):].    
+0000abc0: 2020 2020 7265 7475 726e 2070 6174 680a      return path.
+0000abd0: 0a20 2020 2040 6361 6368 6564 7072 6f70  .    @cachedprop
+0000abe0: 6572 7479 0a20 2020 2064 6566 205f 636c  erty.    def _cl
+0000abf0: 6965 6e74 2873 656c 6629 3a0a 2020 2020  ient(self):.    
+0000ac00: 2020 2020 7265 7475 726e 2067 6574 5f73      return get_s
+0000ac10: 335f 636c 6965 6e74 2870 726f 6669 6c65  3_client(profile
+0000ac20: 5f6e 616d 653d 7365 6c66 2e5f 7072 6f66  _name=self._prof
+0000ac30: 696c 655f 6e61 6d65 290a 0a20 2020 2064  ile_name)..    d
+0000ac40: 6566 205f 7333 5f67 6574 5f6d 6574 6164  ef _s3_get_metad
+0000ac50: 6174 6128 7365 6c66 2920 2d3e 2064 6963  ata(self) -> dic
+0000ac60: 743a 0a20 2020 2020 2020 2027 2727 0a20  t:.        '''. 
+0000ac70: 2020 2020 2020 2047 6574 206f 626a 6563         Get objec
+0000ac80: 7420 6d65 7461 6461 7461 0a0a 2020 2020  t metadata..    
+0000ac90: 2020 2020 3a70 6172 616d 2070 6174 683a      :param path:
+0000aca0: 204f 626a 6563 7420 7061 7468 0a20 2020   Object path.   
+0000acb0: 2020 2020 203a 7265 7475 726e 733a 204f       :returns: O
+0000acc0: 626a 6563 7420 6d65 7461 6461 7461 0a20  bject metadata. 
+0000acd0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000ace0: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
+0000acf0: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
+0000ad00: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+0000ad10: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
+0000ad20: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
+0000ad30: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000ad40: 207b 7d0a 2020 2020 2020 2020 6966 206e   {}.        if n
+0000ad50: 6f74 206b 6579 206f 7220 6b65 792e 656e  ot key or key.en
+0000ad60: 6473 7769 7468 2827 2f27 293a 0a20 2020  dswith('/'):.   
+0000ad70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000ad80: 7b7d 0a20 2020 2020 2020 2074 7279 3a0a  {}.        try:.
+0000ad90: 2020 2020 2020 2020 2020 2020 7769 7468              with
+0000ada0: 2072 6169 7365 5f73 335f 6572 726f 7228   raise_s3_error(
+0000adb0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+0000adc0: 726f 746f 636f 6c29 3a0a 2020 2020 2020  rotocol):.      
+0000add0: 2020 2020 2020 2020 2020 7265 7370 203d            resp =
+0000ade0: 2073 656c 662e 5f63 6c69 656e 742e 6865   self._client.he
+0000adf0: 6164 5f6f 626a 6563 7428 4275 636b 6574  ad_object(Bucket
+0000ae00: 3d62 7563 6b65 742c 204b 6579 3d6b 6579  =bucket, Key=key
+0000ae10: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0000ae20: 7475 726e 2064 6963 7428 0a20 2020 2020  turn dict(.     
+0000ae30: 2020 2020 2020 2020 2020 2028 6b65 792e             (key.
+0000ae40: 6c6f 7765 7228 292c 2076 616c 7565 2920  lower(), value) 
+0000ae50: 666f 7220 6b65 792c 2076 616c 7565 2069  for key, value i
+0000ae60: 6e20 7265 7370 5b27 4d65 7461 6461 7461  n resp['Metadata
+0000ae70: 275d 2e69 7465 6d73 2829 290a 2020 2020  '].items()).    
+0000ae80: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0000ae90: 7469 6f6e 2061 7320 6572 726f 723a 0a20  tion as error:. 
+0000aea0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0000aeb0: 696e 7374 616e 6365 2865 7272 6f72 2c0a  instance(error,.
+0000aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aed0: 2020 2020 2020 2020 2020 2853 3355 6e6b            (S3Unk
+0000aee0: 6e6f 776e 4572 726f 722c 2053 3343 6f6e  nownError, S3Con
+0000aef0: 6669 6745 7272 6f72 2c20 5333 5065 726d  figError, S3Perm
+0000af00: 6973 7369 6f6e 4572 726f 7229 293a 0a20  issionError)):. 
+0000af10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000af20: 6169 7365 2065 7272 6f72 0a20 2020 2020  aise error.     
+0000af30: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
+0000af40: 0a0a 2020 2020 6465 6620 6163 6365 7373  ..    def access
+0000af50: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+0000af60: 6c66 2c20 6d6f 6465 3a20 4163 6365 7373  lf, mode: Access
+0000af70: 203d 2041 6363 6573 732e 5245 4144 2c0a   = Access.READ,.
+0000af80: 2020 2020 2020 2020 2020 2020 666f 6c6c              foll
+0000af90: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+0000afa0: 4661 6c73 6529 202d 3e20 626f 6f6c 3a0a  False) -> bool:.
+0000afb0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000afc0: 2020 2020 5465 7374 2069 6620 7061 7468      Test if path
+0000afd0: 2068 6173 2061 6363 6573 7320 7065 726d   has access perm
+0000afe0: 6973 7369 6f6e 2064 6573 6372 6962 6564  ission described
+0000aff0: 2062 7920 6d6f 6465 0a20 2020 2020 2020   by mode.       
+0000b000: 2055 7369 6e67 2068 6561 645f 6275 636b   Using head_buck
+0000b010: 6574 2829 2c20 6e6f 7720 5245 4144 2f57  et(), now READ/W
+0000b020: 5249 5445 2061 7265 2073 616d 652e 0a0a  RITE are same...
+0000b030: 2020 2020 2020 2020 3a70 6172 616d 206d          :param m
+0000b040: 6f64 653a 2061 6363 6573 7320 6d6f 6465  ode: access mode
+0000b050: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0000b060: 733a 2062 6f6f 6c2c 2069 6620 7468 6520  s: bool, if the 
+0000b070: 6275 636b 6574 206f 6620 7333 5f75 726c  bucket of s3_url
+0000b080: 2068 6173 2072 6561 642f 7772 6974 6520   has read/write 
+0000b090: 6163 6365 7373 2e0a 2020 2020 2020 2020  access..        
+0000b0a0: 2727 270a 2020 2020 2020 2020 7333 5f75  '''.        s3_u
+0000b0b0: 726c 203d 2073 656c 662e 7061 7468 5f77  rl = self.path_w
+0000b0c0: 6974 685f 7072 6f74 6f63 6f6c 0a20 2020  ith_protocol.   
+0000b0d0: 2020 2020 2069 6620 666f 6c6c 6f77 6c69       if followli
+0000b0e0: 6e6b 733a 0a20 2020 2020 2020 2020 2020  nks:.           
+0000b0f0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000b100: 2020 2020 2020 7333 5f75 726c 203d 2073        s3_url = s
+0000b110: 656c 662e 7265 6164 6c69 6e6b 2829 2e70  elf.readlink().p
+0000b120: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+0000b130: 6c0a 2020 2020 2020 2020 2020 2020 6578  l.            ex
+0000b140: 6365 7074 2053 334e 6f74 414c 696e 6b45  cept S3NotALinkE
+0000b150: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+0000b160: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
+0000b170: 2020 2062 7563 6b65 742c 205f 203d 2070     bucket, _ = p
+0000b180: 6172 7365 5f73 335f 7572 6c28 7333 5f75  arse_s3_url(s3_u
+0000b190: 726c 2920 2023 206f 6e6c 7920 6368 6563  rl)  # only chec
+0000b1a0: 6b20 6275 636b 6574 2061 6363 6573 7369  k bucket accessi
+0000b1b0: 6269 6c69 7479 0a20 2020 2020 2020 2069  bility.        i
+0000b1c0: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
+0000b1d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000b1e0: 4578 6365 7074 696f 6e28 224e 6f20 6176  Exception("No av
+0000b1f0: 6169 6c61 626c 6520 6275 636b 6574 2229  ailable bucket")
+0000b200: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0000b210: 6973 696e 7374 616e 6365 286d 6f64 652c  isinstance(mode,
+0000b220: 2041 6363 6573 7329 3a0a 2020 2020 2020   Access):.      
+0000b230: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
+0000b240: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0000b250: 2020 2020 2020 2027 556e 7375 7070 6f72         'Unsuppor
+0000b260: 7465 6420 6d6f 6465 3a20 7b7d 202d 2d20  ted mode: {} -- 
+0000b270: 4d6f 6465 2073 686f 756c 6420 7573 6520  Mode should use 
+0000b280: 6f6e 6520 6f66 2074 6865 2065 6e75 6d73  one of the enums
+0000b290: 2062 656c 6f6e 6769 6e67 2074 6f3a 2020   belonging to:  
+0000b2a0: 7b7d 270a 2020 2020 2020 2020 2020 2020  {}'.            
+0000b2b0: 2020 2020 2e66 6f72 6d61 7428 6d6f 6465      .format(mode
+0000b2c0: 2c20 272c 2027 2e6a 6f69 6e28 5b73 7472  , ', '.join([str
+0000b2d0: 2861 2920 666f 7220 6120 696e 2041 6363  (a) for a in Acc
+0000b2e0: 6573 735d 2929 290a 2020 2020 2020 2020  ess]))).        
+0000b2f0: 6966 206d 6f64 6520 6e6f 7420 696e 2028  if mode not in (
+0000b300: 4163 6365 7373 2e52 4541 442c 2041 6363  Access.READ, Acc
+0000b310: 6573 732e 5752 4954 4529 3a0a 2020 2020  ess.WRITE):.    
+0000b320: 2020 2020 2020 2020 7261 6973 6520 5479          raise Ty
+0000b330: 7065 4572 726f 7228 2755 6e73 7570 706f  peError('Unsuppo
+0000b340: 7274 6564 206d 6f64 653a 207b 7d27 2e66  rted mode: {}'.f
+0000b350: 6f72 6d61 7428 6d6f 6465 2929 0a20 2020  ormat(mode)).   
+0000b360: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000b370: 2020 2020 2020 7365 6c66 2e5f 636c 6965        self._clie
+0000b380: 6e74 2e68 6561 645f 6275 636b 6574 2842  nt.head_bucket(B
+0000b390: 7563 6b65 743d 6275 636b 6574 290a 2020  ucket=bucket).  
+0000b3a0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+0000b3b0: 6570 7469 6f6e 2061 7320 6572 726f 723a  eption as error:
+0000b3c0: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
+0000b3d0: 6f72 203d 2074 7261 6e73 6c61 7465 5f73  or = translate_s
+0000b3e0: 335f 6572 726f 7228 6572 726f 722c 2073  3_error(error, s
+0000b3f0: 335f 7572 6c29 0a20 2020 2020 2020 2020  3_url).         
+0000b400: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000b410: 2865 7272 6f72 2c20 2853 3350 6572 6d69  (error, (S3Permi
+0000b420: 7373 696f 6e45 7272 6f72 2c20 5333 4669  ssionError, S3Fi
+0000b430: 6c65 4e6f 7446 6f75 6e64 4572 726f 722c  leNotFoundError,
+0000b440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b460: 2020 2053 3342 7563 6b65 744e 6f74 466f     S3BucketNotFo
+0000b470: 756e 6445 7272 6f72 2929 3a0a 2020 2020  undError)):.    
+0000b480: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000b490: 726e 2046 616c 7365 0a20 2020 2020 2020  rn False.       
+0000b4a0: 2020 2020 2072 6169 7365 2065 7272 6f72       raise error
+0000b4b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000b4c0: 5472 7565 0a0a 2020 2020 6465 6620 6578  True..    def ex
+0000b4d0: 6973 7473 2873 656c 662c 2066 6f6c 6c6f  ists(self, follo
+0000b4e0: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
+0000b4f0: 616c 7365 2920 2d3e 2062 6f6f 6c3a 0a20  alse) -> bool:. 
+0000b500: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000b510: 2020 2054 6573 7420 6966 2073 335f 7572     Test if s3_ur
+0000b520: 6c20 6578 6973 7473 0a0a 2020 2020 2020  l exists..      
+0000b530: 2020 4966 2074 6865 2062 7563 6b65 7420    If the bucket 
+0000b540: 6f66 2073 335f 7572 6c20 6172 6520 6e6f  of s3_url are no
+0000b550: 7420 7065 726d 6974 7465 6420 746f 2072  t permitted to r
+0000b560: 6561 642c 2072 6574 7572 6e20 4661 6c73  ead, return Fals
+0000b570: 650a 0a20 2020 2020 2020 203a 7265 7475  e..        :retu
+0000b580: 726e 733a 2054 7275 6520 6966 2073 335f  rns: True if s3_
+0000b590: 7572 6c20 6569 7873 7473 2c20 656c 7365  url eixsts, else
+0000b5a0: 2046 616c 7365 0a20 2020 2020 2020 2027   False.        '
+0000b5b0: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
+0000b5c0: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+0000b5d0: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
+0000b5e0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+0000b5f0: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
+0000b600: 636b 6574 3a20 2023 2073 333a 2f2f 203d  cket:  # s3:// =
+0000b610: 3e20 5472 7565 2c20 7333 3a2f 2f2f 6b65  > True, s3:///ke
+0000b620: 7920 3d3e 2046 616c 7365 0a20 2020 2020  y => False.     
+0000b630: 2020 2020 2020 2072 6574 7572 6e20 6e6f         return no
+0000b640: 7420 6b65 790a 0a20 2020 2020 2020 2072  t key..        r
+0000b650: 6574 7572 6e20 7365 6c66 2e69 735f 6469  eturn self.is_di
+0000b660: 7228 2920 6f72 2073 656c 662e 6973 5f66  r() or self.is_f
+0000b670: 696c 6528 666f 6c6c 6f77 6c69 6e6b 7329  ile(followlinks)
+0000b680: 0a0a 2020 2020 6465 6620 6765 746d 7469  ..    def getmti
+0000b690: 6d65 2873 656c 662c 2066 6f6c 6c6f 775f  me(self, follow_
+0000b6a0: 7379 6d6c 696e 6b73 3a20 626f 6f6c 203d  symlinks: bool =
+0000b6b0: 2046 616c 7365 2920 2d3e 2066 6c6f 6174   False) -> float
+0000b6c0: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
+0000b6d0: 2020 2020 2020 4765 7420 6c61 7374 2d6d        Get last-m
+0000b6e0: 6f64 6966 6965 6420 7469 6d65 206f 6620  odified time of 
+0000b6f0: 7468 6520 6669 6c65 206f 6e20 7468 6520  the file on the 
+0000b700: 6769 7665 6e20 7333 5f75 726c 2070 6174  given s3_url pat
+0000b710: 6820 2869 6e20 556e 6978 2074 696d 6573  h (in Unix times
+0000b720: 7461 6d70 2066 6f72 6d61 7429 2e0a 2020  tamp format)..  
+0000b730: 2020 2020 2020 4966 2074 6865 2070 6174        If the pat
+0000b740: 6820 6973 2061 6e20 6578 6973 7465 6e74  h is an existent
+0000b750: 2064 6972 6563 746f 7279 2c20 7265 7475   directory, retu
+0000b760: 726e 2074 6865 206c 6174 6573 7420 6d6f  rn the latest mo
+0000b770: 6469 6669 6564 2074 696d 6520 6f66 2061  dified time of a
+0000b780: 6c6c 2066 696c 6520 696e 2069 742e 2054  ll file in it. T
+0000b790: 6865 206d 7469 6d65 206f 6620 656d 7074  he mtime of empt
+0000b7a0: 7920 6469 7265 6374 6f72 7920 6973 2031  y directory is 1
+0000b7b0: 3937 302d 3031 2d30 3120 3030 3a30 303a  970-01-01 00:00:
+0000b7c0: 3030 0a0a 2020 2020 2020 2020 4966 2073  00..        If s
+0000b7d0: 335f 7572 6c20 6973 206e 6f74 2061 6e20  3_url is not an 
+0000b7e0: 6578 6973 7465 6e74 2070 6174 682c 2077  existent path, w
+0000b7f0: 6869 6368 206d 6561 6e73 2073 335f 6578  hich means s3_ex
+0000b800: 6973 7428 7333 5f75 726c 2920 7265 7475  ist(s3_url) retu
+0000b810: 726e 7320 4661 6c73 652c 2074 6865 6e20  rns False, then 
+0000b820: 7261 6973 6520 5333 4669 6c65 4e6f 7446  raise S3FileNotF
+0000b830: 6f75 6e64 4572 726f 720a 0a20 2020 2020  oundError..     
+0000b840: 2020 203a 7265 7475 726e 733a 204c 6173     :returns: Las
+0000b850: 742d 6d6f 6469 6669 6564 2074 696d 650a  t-modified time.
+0000b860: 2020 2020 2020 2020 3a72 6169 7365 733a          :raises:
+0000b870: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
+0000b880: 7272 6f72 2c20 556e 7375 7070 6f72 7465  rror, Unsupporte
+0000b890: 6445 7272 6f72 0a20 2020 2020 2020 2027  dError.        '
+0000b8a0: 2727 0a20 2020 2020 2020 2072 6574 7572  ''.        retur
+0000b8b0: 6e20 7365 6c66 2e73 7461 7428 666f 6c6c  n self.stat(foll
+0000b8c0: 6f77 5f73 796d 6c69 6e6b 733d 666f 6c6c  ow_symlinks=foll
+0000b8d0: 6f77 5f73 796d 6c69 6e6b 7329 2e6d 7469  ow_symlinks).mti
+0000b8e0: 6d65 0a0a 2020 2020 6465 6620 6765 7473  me..    def gets
+0000b8f0: 697a 6528 7365 6c66 2c20 666f 6c6c 6f77  ize(self, follow
+0000b900: 5f73 796d 6c69 6e6b 733a 2062 6f6f 6c20  _symlinks: bool 
+0000b910: 3d20 4661 6c73 6529 202d 3e20 696e 743a  = False) -> int:
+0000b920: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000b930: 2020 2020 2047 6574 2066 696c 6520 7369       Get file si
+0000b940: 7a65 206f 6e20 7468 6520 6769 7665 6e20  ze on the given 
+0000b950: 7333 5f75 726c 2070 6174 6820 2869 6e20  s3_url path (in 
+0000b960: 6279 7465 7329 2e0a 2020 2020 2020 2020  bytes)..        
+0000b970: 4966 2074 6865 2070 6174 6820 696e 2061  If the path in a
+0000b980: 2064 6972 6563 746f 7279 2c20 7265 7475   directory, retu
+0000b990: 726e 2074 6865 2073 756d 206f 6620 616c  rn the sum of al
+0000b9a0: 6c20 6669 6c65 2073 697a 6520 696e 2069  l file size in i
+0000b9b0: 742c 2069 6e63 6c75 6469 6e67 2066 696c  t, including fil
+0000b9c0: 6520 696e 2073 7562 6469 7265 6374 6f72  e in subdirector
+0000b9d0: 6965 7320 2869 6620 6578 6973 7429 2e0a  ies (if exist)..
+0000b9e0: 2020 2020 2020 2020 5468 6520 7265 7375          The resu
+0000b9f0: 6c74 2065 7863 6c75 6465 7320 7468 6520  lt excludes the 
+0000ba00: 7369 7a65 206f 6620 6469 7265 6374 6f72  size of director
+0000ba10: 7920 6974 7365 6c66 2e20 496e 206f 7468  y itself. In oth
+0000ba20: 6572 2077 6f72 6473 2c20 7265 7475 726e  er words, return
+0000ba30: 2030 2042 7974 6520 6f6e 2061 6e20 656d   0 Byte on an em
+0000ba40: 7074 7920 6469 7265 6374 6f72 7920 7061  pty directory pa
+0000ba50: 7468 2e0a 0a20 2020 2020 2020 2049 6620  th...        If 
+0000ba60: 7333 5f75 726c 2069 7320 6e6f 7420 616e  s3_url is not an
+0000ba70: 2065 7869 7374 656e 7420 7061 7468 2c20   existent path, 
+0000ba80: 7768 6963 6820 6d65 616e 7320 7333 5f65  which means s3_e
+0000ba90: 7869 7374 2873 335f 7572 6c29 2072 6574  xist(s3_url) ret
+0000baa0: 7572 6e73 2046 616c 7365 2c20 7468 656e  urns False, then
+0000bab0: 2072 6169 7365 2053 3346 696c 654e 6f74   raise S3FileNot
+0000bac0: 466f 756e 6445 7272 6f72 0a0a 2020 2020  FoundError..    
+0000bad0: 2020 2020 3a72 6574 7572 6e73 3a20 4669      :returns: Fi
+0000bae0: 6c65 2073 697a 650a 2020 2020 2020 2020  le size.        
+0000baf0: 3a72 6169 7365 733a 2053 3346 696c 654e  :raises: S3FileN
+0000bb00: 6f74 466f 756e 6445 7272 6f72 2c20 556e  otFoundError, Un
+0000bb10: 7375 7070 6f72 7465 6445 7272 6f72 0a20  supportedError. 
+0000bb20: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000bb30: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
+0000bb40: 7461 7428 666f 6c6c 6f77 5f73 796d 6c69  tat(follow_symli
+0000bb50: 6e6b 733d 666f 6c6c 6f77 5f73 796d 6c69  nks=follow_symli
+0000bb60: 6e6b 7329 2e73 697a 650a 0a20 2020 2064  nks).size..    d
+0000bb70: 6566 2067 6c6f 6228 0a20 2020 2020 2020  ef glob(.       
+0000bb80: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000bb90: 2020 2020 2020 2070 6174 7465 726e 2c0a         pattern,.
+0000bba0: 2020 2020 2020 2020 2020 2020 7265 6375              recu
+0000bbb0: 7273 6976 653a 2062 6f6f 6c20 3d20 5472  rsive: bool = Tr
+0000bbc0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0000bbd0: 6d69 7373 696e 675f 6f6b 3a20 626f 6f6c  missing_ok: bool
+0000bbe0: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
+0000bbf0: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
+0000bc00: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+0000bc10: 2020 2020 2920 2d3e 204c 6973 745b 2753      ) -> List['S
+0000bc20: 3350 6174 6827 5d3a 0a20 2020 2020 2020  3Path']:.       
+0000bc30: 2027 2727 5265 7475 726e 2073 3320 7061   '''Return s3 pa
+0000bc40: 7468 206c 6973 7420 696e 2061 7363 656e  th list in ascen
+0000bc50: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
+0000bc60: 6c20 6f72 6465 722c 2069 6e20 7768 6963  l order, in whic
+0000bc70: 6820 7061 7468 206d 6174 6368 6573 2067  h path matches g
+0000bc80: 6c6f 6220 7061 7474 6572 6e0a 2020 2020  lob pattern.    
+0000bc90: 2020 2020 4e6f 7465 733a 204f 6e6c 7920      Notes: Only 
+0000bca0: 676c 6f62 2069 6e20 6275 636b 6574 2e20  glob in bucket. 
+0000bcb0: 4966 2074 7279 696e 6720 746f 206d 6174  If trying to mat
+0000bcc0: 6368 2062 7563 6b65 7420 7769 7468 2077  ch bucket with w
+0000bcd0: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
+0000bce0: 7273 2c20 7261 6973 6520 556e 7375 7070  rs, raise Unsupp
+0000bcf0: 6f72 7465 6445 7272 6f72 0a0a 2020 2020  ortedError..    
+0000bd00: 2020 2020 3a70 6172 616d 2070 6174 7465      :param patte
+0000bd10: 726e 3a20 476c 6f62 2074 6865 2067 6976  rn: Glob the giv
+0000bd20: 656e 2072 656c 6174 6976 6520 7061 7474  en relative patt
+0000bd30: 6572 6e20 696e 2074 6865 2064 6972 6563  ern in the direc
+0000bd40: 746f 7279 2072 6570 7265 7365 6e74 6564  tory represented
+0000bd50: 2062 7920 7468 6973 2070 6174 680a 2020   by this path.  
+0000bd60: 2020 2020 2020 3a70 6172 616d 2072 6563        :param rec
+0000bd70: 7572 7369 7665 3a20 4966 2046 616c 7365  ursive: If False
+0000bd80: 2c20 602a 2a60 2077 696c 6c20 6e6f 7420  , `**` will not 
+0000bd90: 7365 6172 6368 2064 6972 6563 746f 7279  search directory
+0000bda0: 2072 6563 7572 7369 7665 6c79 0a20 2020   recursively.   
+0000bdb0: 2020 2020 203a 7061 7261 6d20 6d69 7373       :param miss
+0000bdc0: 696e 675f 6f6b 3a20 4966 2046 616c 7365  ing_ok: If False
+0000bdd0: 2061 6e64 2074 6172 6765 7420 7061 7468   and target path
+0000bde0: 2064 6f65 736e 2774 206d 6174 6368 2061   doesn't match a
+0000bdf0: 6e79 2066 696c 652c 2072 6169 7365 2046  ny file, raise F
+0000be00: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+0000be10: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
+0000be20: 3a20 556e 7375 7070 6f72 7465 6445 7272  : UnsupportedErr
+0000be30: 6f72 2c20 7768 656e 2062 7563 6b65 7420  or, when bucket 
+0000be40: 7061 7274 2063 6f6e 7461 696e 7320 7769  part contains wi
+0000be50: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
+0000be60: 730a 2020 2020 2020 2020 3a72 6574 7572  s.        :retur
+0000be70: 6e73 3a20 4120 6c69 7374 2063 6f6e 7461  ns: A list conta
+0000be80: 696e 7320 7061 7468 7320 6d61 7463 6820  ins paths match 
+0000be90: 6073 335f 7061 7468 6e61 6d65 600a 2020  `s3_pathname`.  
+0000bea0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0000beb0: 2020 7265 7475 726e 206c 6973 7428 0a20    return list(. 
+0000bec0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000bed0: 6967 6c6f 6228 0a20 2020 2020 2020 2020  iglob(.         
+0000bee0: 2020 2020 2020 2070 6174 7465 726e 3d70         pattern=p
+0000bef0: 6174 7465 726e 2c0a 2020 2020 2020 2020  attern,.        
+0000bf00: 2020 2020 2020 2020 7265 6375 7273 6976          recursiv
+0000bf10: 653d 7265 6375 7273 6976 652c 0a20 2020  e=recursive,.   
+0000bf20: 2020 2020 2020 2020 2020 2020 206d 6973               mis
+0000bf30: 7369 6e67 5f6f 6b3d 6d69 7373 696e 675f  sing_ok=missing_
+0000bf40: 6f6b 2c0a 2020 2020 2020 2020 2020 2020  ok,.            
+0000bf50: 2020 2020 666f 6c6c 6f77 6c69 6e6b 733d      followlinks=
+0000bf60: 666f 6c6c 6f77 6c69 6e6b 7329 290a 0a20  followlinks)).. 
+0000bf70: 2020 2064 6566 2067 6c6f 625f 7374 6174     def glob_stat
+0000bf80: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+0000bf90: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+0000bfa0: 7061 7474 6572 6e2c 0a20 2020 2020 2020  pattern,.       
+0000bfb0: 2020 2020 2072 6563 7572 7369 7665 3a20       recursive: 
+0000bfc0: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
+0000bfd0: 2020 2020 2020 2020 206d 6973 7369 6e67           missing
+0000bfe0: 5f6f 6b3a 2062 6f6f 6c20 3d20 5472 7565  _ok: bool = True
+0000bff0: 2c0a 2020 2020 2020 2020 2020 2020 666f  ,.            fo
+0000c000: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
+0000c010: 3d20 4661 6c73 6529 202d 3e20 4974 6572  = False) -> Iter
+0000c020: 6174 6f72 5b46 696c 6545 6e74 7279 5d3a  ator[FileEntry]:
+0000c030: 0a20 2020 2020 2020 2027 2727 5265 7475  .        '''Retu
+0000c040: 726e 2061 2067 656e 6572 6174 6f72 2063  rn a generator c
+0000c050: 6f6e 7461 696e 7320 7475 706c 6573 206f  ontains tuples o
+0000c060: 6620 7061 7468 2061 6e64 2066 696c 6520  f path and file 
+0000c070: 7374 6174 2c20 696e 2061 7363 656e 6469  stat, in ascendi
+0000c080: 6e67 2061 6c70 6861 6265 7469 6361 6c20  ng alphabetical 
+0000c090: 6f72 6465 722c 2069 6e20 7768 6963 6820  order, in which 
+0000c0a0: 7061 7468 206d 6174 6368 6573 2067 6c6f  path matches glo
+0000c0b0: 6220 7061 7474 6572 6e0a 2020 2020 2020  b pattern.      
+0000c0c0: 2020 4e6f 7465 733a 204f 6e6c 7920 676c    Notes: Only gl
+0000c0d0: 6f62 2069 6e20 6275 636b 6574 2e20 4966  ob in bucket. If
+0000c0e0: 2074 7279 696e 6720 746f 206d 6174 6368   trying to match
+0000c0f0: 2062 7563 6b65 7420 7769 7468 2077 696c   bucket with wil
+0000c100: 6463 6172 6420 6368 6172 6163 7465 7273  dcard characters
+0000c110: 2c20 7261 6973 6520 556e 7375 7070 6f72  , raise Unsuppor
+0000c120: 7465 6445 7272 6f72 0a0a 2020 2020 2020  tedError..      
+0000c130: 2020 3a70 6172 616d 2070 6174 7465 726e    :param pattern
+0000c140: 3a20 476c 6f62 2074 6865 2067 6976 656e  : Glob the given
+0000c150: 2072 656c 6174 6976 6520 7061 7474 6572   relative patter
+0000c160: 6e20 696e 2074 6865 2064 6972 6563 746f  n in the directo
+0000c170: 7279 2072 6570 7265 7365 6e74 6564 2062  ry represented b
+0000c180: 7920 7468 6973 2070 6174 680a 2020 2020  y this path.    
+0000c190: 2020 2020 3a70 6172 616d 2072 6563 7572      :param recur
+0000c1a0: 7369 7665 3a20 4966 2046 616c 7365 2c20  sive: If False, 
+0000c1b0: 602a 2a60 2077 696c 6c20 6e6f 7420 7365  `**` will not se
+0000c1c0: 6172 6368 2064 6972 6563 746f 7279 2072  arch directory r
+0000c1d0: 6563 7572 7369 7665 6c79 0a20 2020 2020  ecursively.     
+0000c1e0: 2020 203a 7061 7261 6d20 6d69 7373 696e     :param missin
+0000c1f0: 675f 6f6b 3a20 4966 2046 616c 7365 2061  g_ok: If False a
+0000c200: 6e64 2074 6172 6765 7420 7061 7468 2064  nd target path d
+0000c210: 6f65 736e 2774 206d 6174 6368 2061 6e79  oesn't match any
+0000c220: 2066 696c 652c 2072 6169 7365 2046 696c   file, raise Fil
+0000c230: 654e 6f74 466f 756e 6445 7272 6f72 0a20  eNotFoundError. 
+0000c240: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
+0000c250: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
+0000c260: 2c20 7768 656e 2062 7563 6b65 7420 7061  , when bucket pa
+0000c270: 7274 2063 6f6e 7461 696e 7320 7769 6c64  rt contains wild
+0000c280: 6361 7264 2063 6861 7261 6374 6572 730a  card characters.
+0000c290: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+0000c2a0: 3a20 4120 6765 6e65 7261 746f 7220 636f  : A generator co
+0000c2b0: 6e74 6169 6e73 2074 7570 6c65 7320 6f66  ntains tuples of
+0000c2c0: 2070 6174 6820 616e 6420 6669 6c65 2073   path and file s
+0000c2d0: 7461 742c 2069 6e20 7768 6963 6820 7061  tat, in which pa
+0000c2e0: 7468 7320 6d61 7463 6820 6073 335f 7061  ths match `s3_pa
+0000c2f0: 7468 6e61 6d65 600a 2020 2020 2020 2020  thname`.        
+0000c300: 2727 270a 2020 2020 2020 2020 676c 6f62  '''.        glob
+0000c310: 5f70 6174 6820 3d20 7365 6c66 2e5f 7333  _path = self._s3
+0000c320: 5f70 6174 680a 2020 2020 2020 2020 6966  _path.        if
+0000c330: 2070 6174 7465 726e 3a0a 2020 2020 2020   pattern:.      
+0000c340: 2020 2020 2020 676c 6f62 5f70 6174 6820        glob_path 
+0000c350: 3d20 7365 6c66 2e6a 6f69 6e70 6174 6828  = self.joinpath(
+0000c360: 7061 7474 6572 6e29 2e5f 7333 5f70 6174  pattern)._s3_pat
+0000c370: 6820 2023 2070 7974 7970 653a 2064 6973  h  # pytype: dis
+0000c380: 6162 6c65 3d61 7474 7269 6275 7465 2d65  able=attribute-e
+0000c390: 7272 6f72 0a20 2020 2020 2020 2073 335f  rror.        s3_
+0000c3a0: 7061 7468 6e61 6d65 203d 2066 7370 6174  pathname = fspat
+0000c3b0: 6828 676c 6f62 5f70 6174 6829 0a0a 2020  h(glob_path)..  
+0000c3c0: 2020 2020 2020 6465 6620 6372 6561 7465        def create
+0000c3d0: 5f67 656e 6572 6174 6f72 2829 3a0a 2020  _generator():.  
+0000c3e0: 2020 2020 2020 2020 2020 666f 7220 6772            for gr
+0000c3f0: 6f75 705f 7333 5f70 6174 686e 616d 655f  oup_s3_pathname_
+0000c400: 3120 696e 205f 6772 6f75 705f 7333 7061  1 in _group_s3pa
+0000c410: 7468 5f62 795f 6275 636b 6574 280a 2020  th_by_bucket(.  
+0000c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c430: 2020 7333 5f70 6174 686e 616d 652c 2073    s3_pathname, s
+0000c440: 656c 662e 5f70 726f 6669 6c65 5f6e 616d  elf._profile_nam
+0000c450: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0000c460: 2020 2020 666f 7220 6772 6f75 705f 7333      for group_s3
+0000c470: 5f70 6174 686e 616d 655f 3220 696e 205f  _pathname_2 in _
+0000c480: 6772 6f75 705f 7333 7061 7468 5f62 795f  group_s3path_by_
+0000c490: 7072 6566 6978 280a 2020 2020 2020 2020  prefix(.        
+0000c4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4b0: 6772 6f75 705f 7333 5f70 6174 686e 616d  group_s3_pathnam
+0000c4c0: 655f 3129 3a0a 2020 2020 2020 2020 2020  e_1):.          
+0000c4d0: 2020 2020 2020 2020 2020 666f 7220 6669            for fi
+0000c4e0: 6c65 5f65 6e74 7279 2069 6e20 5f73 335f  le_entry in _s3_
+0000c4f0: 676c 6f62 5f73 7461 745f 7369 6e67 6c65  glob_stat_single
+0000c500: 5f70 6174 6828 0a20 2020 2020 2020 2020  _path(.         
+0000c510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c520: 2020 2067 726f 7570 5f73 335f 7061 7468     group_s3_path
+0000c530: 6e61 6d65 5f32 2c20 7265 6375 7273 6976  name_2, recursiv
+0000c540: 652c 206d 6973 7369 6e67 5f6f 6b2c 0a20  e, missing_ok,. 
+0000c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c560: 2020 2020 2020 2020 2020 2066 6f6c 6c6f             follo
+0000c570: 776c 696e 6b73 3d66 6f6c 6c6f 776c 696e  wlinks=followlin
+0000c580: 6b73 2c0a 2020 2020 2020 2020 2020 2020  ks,.            
 0000c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5a0: 2070 6174 683d 0a20 2020 2020 2020 2020   path=.         
-0000c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5c0: 2020 2020 2020 2066 227b 7365 6c66 2e5f         f"{self._
-0000c5d0: 7072 6f74 6f63 6f6c 5f77 6974 685f 7072  protocol_with_pr
-0000c5e0: 6f66 696c 657d 3a2f 2f7b 6669 6c65 5f65  ofile}://{file_e
-0000c5f0: 6e74 7279 2e70 6174 685b 353a 5d7d 220a  ntry.path[5:]}".
-0000c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c610: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c630: 2020 2020 2020 7969 656c 6420 6669 6c65        yield file
-0000c640: 5f65 6e74 7279 0a0a 2020 2020 2020 2020  _entry..        
-0000c650: 7265 7475 726e 205f 6372 6561 7465 5f6d  return _create_m
-0000c660: 6973 7369 6e67 5f6f 6b5f 6765 6e65 7261  issing_ok_genera
-0000c670: 746f 7228 0a20 2020 2020 2020 2020 2020  tor(.           
-0000c680: 2063 7265 6174 655f 6765 6e65 7261 746f   create_generato
-0000c690: 7228 292c 206d 6973 7369 6e67 5f6f 6b2c  r(), missing_ok,
-0000c6a0: 0a20 2020 2020 2020 2020 2020 2053 3346  .            S3F
-0000c6b0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-0000c6c0: 2827 4e6f 206d 6174 6368 2066 696c 653a  ('No match file:
-0000c6d0: 2025 7227 2025 2073 335f 7061 7468 6e61   %r' % s3_pathna
-0000c6e0: 6d65 2929 0a0a 2020 2020 6465 6620 6967  me))..    def ig
-0000c6f0: 6c6f 6228 0a20 2020 2020 2020 2020 2020  lob(.           
-0000c700: 2073 656c 662c 0a20 2020 2020 2020 2020   self,.         
-0000c710: 2020 2070 6174 7465 726e 2c0a 2020 2020     pattern,.    
-0000c720: 2020 2020 2020 2020 7265 6375 7273 6976          recursiv
-0000c730: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
-0000c740: 2020 2020 2020 2020 2020 2020 6d69 7373              miss
-0000c750: 696e 675f 6f6b 3a20 626f 6f6c 203d 2054  ing_ok: bool = T
-0000c760: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-0000c770: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
-0000c780: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-0000c790: 2920 2d3e 2049 7465 7261 746f 725b 2753  ) -> Iterator['S
-0000c7a0: 3350 6174 6827 5d3a 0a20 2020 2020 2020  3Path']:.       
-0000c7b0: 2027 2727 5265 7475 726e 2073 3320 7061   '''Return s3 pa
-0000c7c0: 7468 2069 7465 7261 746f 7220 696e 2061  th iterator in a
-0000c7d0: 7363 656e 6469 6e67 2061 6c70 6861 6265  scending alphabe
-0000c7e0: 7469 6361 6c20 6f72 6465 722c 2069 6e20  tical order, in 
-0000c7f0: 7768 6963 6820 7061 7468 206d 6174 6368  which path match
-0000c800: 6573 2067 6c6f 6220 7061 7474 6572 6e0a  es glob pattern.
-0000c810: 2020 2020 2020 2020 4e6f 7465 733a 204f          Notes: O
-0000c820: 6e6c 7920 676c 6f62 2069 6e20 6275 636b  nly glob in buck
-0000c830: 6574 2e20 4966 2074 7279 696e 6720 746f  et. If trying to
-0000c840: 206d 6174 6368 2062 7563 6b65 7420 7769   match bucket wi
-0000c850: 7468 2077 696c 6463 6172 6420 6368 6172  th wildcard char
-0000c860: 6163 7465 7273 2c20 7261 6973 6520 556e  acters, raise Un
-0000c870: 7375 7070 6f72 7465 6445 7272 6f72 0a0a  supportedError..
-0000c880: 2020 2020 2020 2020 3a70 6172 616d 2070          :param p
-0000c890: 6174 7465 726e 3a20 476c 6f62 2074 6865  attern: Glob the
-0000c8a0: 2067 6976 656e 2072 656c 6174 6976 6520   given relative 
-0000c8b0: 7061 7474 6572 6e20 696e 2074 6865 2064  pattern in the d
-0000c8c0: 6972 6563 746f 7279 2072 6570 7265 7365  irectory represe
-0000c8d0: 6e74 6564 2062 7920 7468 6973 2070 6174  nted by this pat
-0000c8e0: 680a 2020 2020 2020 2020 3a70 6172 616d  h.        :param
-0000c8f0: 2072 6563 7572 7369 7665 3a20 4966 2046   recursive: If F
-0000c900: 616c 7365 2c20 602a 2a60 2077 696c 6c20  alse, `**` will 
-0000c910: 6e6f 7420 7365 6172 6368 2064 6972 6563  not search direc
-0000c920: 746f 7279 2072 6563 7572 7369 7665 6c79  tory recursively
-0000c930: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000c940: 6d69 7373 696e 675f 6f6b 3a20 4966 2046  missing_ok: If F
-0000c950: 616c 7365 2061 6e64 2074 6172 6765 7420  alse and target 
-0000c960: 7061 7468 2064 6f65 736e 2774 206d 6174  path doesn't mat
-0000c970: 6368 2061 6e79 2066 696c 652c 2072 6169  ch any file, rai
-0000c980: 7365 2046 696c 654e 6f74 466f 756e 6445  se FileNotFoundE
-0000c990: 7272 6f72 0a20 2020 2020 2020 203a 7261  rror.        :ra
-0000c9a0: 6973 6573 3a20 556e 7375 7070 6f72 7465  ises: Unsupporte
-0000c9b0: 6445 7272 6f72 2c20 7768 656e 2062 7563  dError, when buc
-0000c9c0: 6b65 7420 7061 7274 2063 6f6e 7461 696e  ket part contain
-0000c9d0: 7320 7769 6c64 6361 7264 2063 6861 7261  s wildcard chara
-0000c9e0: 6374 6572 730a 2020 2020 2020 2020 3a72  cters.        :r
-0000c9f0: 6574 7572 6e73 3a20 416e 2069 7465 7261  eturns: An itera
-0000ca00: 746f 7220 636f 6e74 6169 6e73 2070 6174  tor contains pat
-0000ca10: 6873 206d 6174 6368 2060 7333 5f70 6174  hs match `s3_pat
-0000ca20: 686e 616d 6560 0a20 2020 2020 2020 2027  hname`.        '
-0000ca30: 2727 0a20 2020 2020 2020 2066 6f72 2066  ''.        for f
-0000ca40: 696c 655f 656e 7472 7920 696e 2073 656c  ile_entry in sel
-0000ca50: 662e 676c 6f62 5f73 7461 7428 7061 7474  f.glob_stat(patt
-0000ca60: 6572 6e3d 7061 7474 6572 6e2c 2072 6563  ern=pattern, rec
-0000ca70: 7572 7369 7665 3d72 6563 7572 7369 7665  ursive=recursive
-0000ca80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000caa0: 2020 2020 2020 2020 2020 206d 6973 7369             missi
-0000cab0: 6e67 5f6f 6b3d 6d69 7373 696e 675f 6f6b  ng_ok=missing_ok
-0000cac0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cae0: 2020 2020 2020 2020 2020 2066 6f6c 6c6f             follo
-0000caf0: 776c 696e 6b73 3d66 6f6c 6c6f 776c 696e  wlinks=followlin
-0000cb00: 6b73 293a 0a20 2020 2020 2020 2020 2020  ks):.           
-0000cb10: 2079 6965 6c64 2073 656c 662e 6672 6f6d   yield self.from
-0000cb20: 5f70 6174 6828 6669 6c65 5f65 6e74 7279  _path(file_entry
-0000cb30: 2e70 6174 6829 0a0a 2020 2020 6465 6620  .path)..    def 
-0000cb40: 6973 5f64 6972 2873 656c 662c 2066 6f6c  is_dir(self, fol
-0000cb50: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-0000cb60: 2046 616c 7365 2920 2d3e 2062 6f6f 6c3a   False) -> bool:
-0000cb70: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000cb80: 2020 2020 2054 6573 7420 6966 2061 6e20       Test if an 
-0000cb90: 7333 2075 726c 2069 7320 6469 7265 6374  s3 url is direct
-0000cba0: 6f72 790a 2020 2020 2020 2020 5370 6563  ory.        Spec
-0000cbb0: 6966 6963 2070 726f 6365 6475 7265 7320  ific procedures 
-0000cbc0: 6172 6520 6173 2066 6f6c 6c6f 7773 3a0a  are as follows:.
-0000cbd0: 2020 2020 2020 2020 4966 2074 6865 7265          If there
-0000cbe0: 2065 7869 7374 7320 6120 7375 6666 6978   exists a suffix
-0000cbf0: 2c20 6f66 2077 6869 6368 2060 606f 732e  , of which ``os.
-0000cc00: 7061 7468 2e6a 6f69 6e28 7333 5f75 726c  path.join(s3_url
-0000cc10: 2c20 7375 6666 6978 2960 6020 6973 2061  , suffix)`` is a
-0000cc20: 2066 696c 650a 2020 2020 2020 2020 4966   file.        If
-0000cc30: 2074 6865 2075 726c 2069 7320 656d 7074   the url is empt
-0000cc40: 7920 6275 636b 6574 206f 7220 7333 3a2f  y bucket or s3:/
-0000cc50: 2f0a 0a20 2020 2020 2020 203a 7061 7261  /..        :para
-0000cc60: 6d20 666f 6c6c 6f77 6c69 6e6b 733a 2077  m followlinks: w
-0000cc70: 6865 7468 6572 2066 6f6c 6c6f 776c 696e  hether followlin
-0000cc80: 6b73 2069 7320 5472 7565 206f 7220 4661  ks is True or Fa
-0000cc90: 6c73 652c 2072 6573 756c 7420 6973 2074  lse, result is t
-0000cca0: 6865 2073 616d 652e 2042 6563 6175 7365  he same. Because
-0000ccb0: 2073 3320 7379 6d6c 696e 6b20 6e6f 7420   s3 symlink not 
-0000ccc0: 7375 7070 6f72 7420 6469 722e 0a20 2020  support dir..   
-0000ccd0: 2020 2020 203a 7265 7475 726e 733a 2054       :returns: T
-0000cce0: 7275 6520 6966 2070 6174 6820 6973 2073  rue if path is s
-0000ccf0: 3320 6469 7265 6374 6f72 792c 2065 6c73  3 directory, els
-0000cd00: 6520 4661 6c73 650a 2020 2020 2020 2020  e False.        
-0000cd10: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
-0000cd20: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
-0000cd30: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
-0000cd40: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-0000cd50: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
-0000cd60: 7563 6b65 743a 2020 2320 7333 3a2f 2f20  ucket:  # s3:// 
-0000cd70: 3d3e 2054 7275 652c 2073 333a 2f2f 2f6b  => True, s3:///k
-0000cd80: 6579 203d 3e20 4661 6c73 650a 2020 2020  ey => False.    
-0000cd90: 2020 2020 2020 2020 7265 7475 726e 206e          return n
-0000cda0: 6f74 206b 6579 0a20 2020 2020 2020 2070  ot key.        p
-0000cdb0: 7265 6669 7820 3d20 5f62 6563 6f6d 655f  refix = _become_
-0000cdc0: 7072 6566 6978 286b 6579 290a 2020 2020  prefix(key).    
-0000cdd0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000cde0: 2020 2020 2072 6573 7020 3d20 7365 6c66       resp = self
-0000cdf0: 2e5f 636c 6965 6e74 2e6c 6973 745f 6f62  ._client.list_ob
-0000ce00: 6a65 6374 735f 7632 280a 2020 2020 2020  jects_v2(.      
-0000ce10: 2020 2020 2020 2020 2020 4275 636b 6574            Bucket
-0000ce20: 3d62 7563 6b65 742c 2050 7265 6669 783d  =bucket, Prefix=
-0000ce30: 7072 6566 6978 2c20 4465 6c69 6d69 7465  prefix, Delimite
-0000ce40: 723d 272f 272c 204d 6178 4b65 7973 3d31  r='/', MaxKeys=1
-0000ce50: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-0000ce60: 2045 7863 6570 7469 6f6e 2061 7320 6572   Exception as er
-0000ce70: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0000ce80: 2065 7272 6f72 203d 2074 7261 6e73 6c61   error = transla
-0000ce90: 7465 5f73 335f 6572 726f 7228 6572 726f  te_s3_error(erro
-0000cea0: 722c 2073 656c 662e 7061 7468 5f77 6974  r, self.path_wit
-0000ceb0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
-0000cec0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0000ced0: 7461 6e63 6528 6572 726f 722c 0a20 2020  tance(error,.   
-0000cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cef0: 2020 2020 2020 2028 5333 556e 6b6e 6f77         (S3Unknow
-0000cf00: 6e45 7272 6f72 2c20 5333 436f 6e66 6967  nError, S3Config
-0000cf10: 4572 726f 722c 2053 3350 6572 6d69 7373  Error, S3Permiss
-0000cf20: 696f 6e45 7272 6f72 2929 3a0a 2020 2020  ionError)):.    
-0000cf30: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000cf40: 6520 6572 726f 720a 2020 2020 2020 2020  e error.        
-0000cf50: 2020 2020 7265 7475 726e 2046 616c 7365      return False
-0000cf60: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-0000cf70: 206b 6579 3a20 2023 2062 7563 6b65 7420   key:  # bucket 
-0000cf80: 6973 2061 6363 6573 7369 626c 650a 2020  is accessible.  
-0000cf90: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000cfa0: 2054 7275 650a 0a20 2020 2020 2020 2069   True..        i
-0000cfb0: 6620 274b 6579 436f 756e 7427 2069 6e20  f 'KeyCount' in 
-0000cfc0: 7265 7370 3a0a 2020 2020 2020 2020 2020  resp:.          
-0000cfd0: 2020 7265 7475 726e 2072 6573 705b 274b    return resp['K
-0000cfe0: 6579 436f 756e 7427 5d20 3e20 300a 0a20  eyCount'] > 0.. 
-0000cff0: 2020 2020 2020 2072 6574 7572 6e20 6c65         return le
-0000d000: 6e28 7265 7370 2e67 6574 2827 436f 6e74  n(resp.get('Cont
-0000d010: 656e 7473 272c 205b 5d29 2920 3e20 3020  ents', [])) > 0 
-0000d020: 6f72 205c 0a20 2020 2020 2020 2020 2020  or \.           
-0000d030: 206c 656e 2872 6573 702e 6765 7428 2743   len(resp.get('C
-0000d040: 6f6d 6d6f 6e50 7265 6669 7865 7327 2c20  ommonPrefixes', 
-0000d050: 5b5d 2929 203e 2030 0a0a 2020 2020 6465  [])) > 0..    de
-0000d060: 6620 6973 5f66 696c 6528 7365 6c66 2c20  f is_file(self, 
-0000d070: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-0000d080: 6c20 3d20 4661 6c73 6529 202d 3e20 626f  l = False) -> bo
-0000d090: 6f6c 3a0a 2020 2020 2020 2020 2727 270a  ol:.        '''.
-0000d0a0: 2020 2020 2020 2020 5465 7374 2069 6620          Test if 
-0000d0b0: 616e 2073 335f 7572 6c20 6973 2066 696c  an s3_url is fil
-0000d0c0: 650a 0a20 2020 2020 2020 203a 7265 7475  e..        :retu
-0000d0d0: 726e 733a 2054 7275 6520 6966 2070 6174  rns: True if pat
-0000d0e0: 6820 6973 2073 3320 6669 6c65 2c20 656c  h is s3 file, el
-0000d0f0: 7365 2046 616c 7365 0a20 2020 2020 2020  se False.       
-0000d100: 2027 2727 0a20 2020 2020 2020 2073 335f   '''.        s3_
-0000d110: 7572 6c20 3d20 7365 6c66 2e70 6174 685f  url = self.path_
-0000d120: 7769 7468 5f70 726f 746f 636f 6c0a 2020  with_protocol.  
-0000d130: 2020 2020 2020 6966 2066 6f6c 6c6f 776c        if followl
-0000d140: 696e 6b73 3a0a 2020 2020 2020 2020 2020  inks:.          
-0000d150: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000d160: 2020 2020 2020 2073 335f 7572 6c20 3d20         s3_url = 
-0000d170: 7365 6c66 2e72 6561 646c 696e 6b28 292e  self.readlink().
-0000d180: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000d190: 6f6c 0a20 2020 2020 2020 2020 2020 2065  ol.            e
-0000d1a0: 7863 6570 7420 5333 4e6f 7441 4c69 6e6b  xcept S3NotALink
-0000d1b0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0000d1c0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-0000d1d0: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-0000d1e0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-0000d1f0: 335f 7572 6c29 0a20 2020 2020 2020 2069  3_url).        i
-0000d200: 6620 6e6f 7420 6275 636b 6574 206f 7220  f not bucket or 
-0000d210: 6e6f 7420 6b65 7920 6f72 206b 6579 2e65  not key or key.e
-0000d220: 6e64 7377 6974 6828 272f 2729 3a0a 2020  ndswith('/'):.  
-0000d230: 2020 2020 2020 2020 2020 2320 7333 3a2f            # s3:/
-0000d240: 2f2c 2073 333a 2f2f 2f6b 6579 2c20 7333  /, s3:///key, s3
-0000d250: 3a2f 2f62 7563 6b65 742c 2073 333a 2f2f  ://bucket, s3://
-0000d260: 6275 636b 6574 2f70 7265 6669 782f 0a20  bucket/prefix/. 
-0000d270: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000d280: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
-0000d290: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000d2a0: 2073 656c 662e 5f63 6c69 656e 742e 6865   self._client.he
-0000d2b0: 6164 5f6f 626a 6563 7428 4275 636b 6574  ad_object(Bucket
-0000d2c0: 3d62 7563 6b65 742c 204b 6579 3d6b 6579  =bucket, Key=key
-0000d2d0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-0000d2e0: 2045 7863 6570 7469 6f6e 2061 7320 6572   Exception as er
-0000d2f0: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0000d300: 2065 7272 6f72 203d 2074 7261 6e73 6c61   error = transla
-0000d310: 7465 5f73 335f 6572 726f 7228 6572 726f  te_s3_error(erro
-0000d320: 722c 2073 335f 7572 6c29 0a20 2020 2020  r, s3_url).     
-0000d330: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0000d340: 616e 6365 2865 7272 6f72 2c0a 2020 2020  ance(error,.    
-0000d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d360: 2020 2020 2020 2853 3355 6e6b 6e6f 776e        (S3Unknown
-0000d370: 4572 726f 722c 2053 3343 6f6e 6669 6745  Error, S3ConfigE
-0000d380: 7272 6f72 2c20 5333 5065 726d 6973 7369  rror, S3Permissi
-0000d390: 6f6e 4572 726f 7229 293a 0a20 2020 2020  onError)):.     
-0000d3a0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000d3b0: 2065 7272 6f72 0a20 2020 2020 2020 2020   error.         
-0000d3c0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-0000d3d0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-0000d3e0: 7275 650a 0a20 2020 2064 6566 206c 6973  rue..    def lis
-0000d3f0: 7464 6972 2873 656c 662c 2066 6f6c 6c6f  tdir(self, follo
-0000d400: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
-0000d410: 616c 7365 2920 2d3e 204c 6973 745b 7374  alse) -> List[st
-0000d420: 725d 3a0a 2020 2020 2020 2020 2727 270a  r]:.        '''.
-0000d430: 2020 2020 2020 2020 4765 7420 616c 6c20          Get all 
-0000d440: 636f 6e74 656e 7473 206f 6620 6769 7665  contents of give
-0000d450: 6e20 7333 5f75 726c 2e20 5468 6520 7265  n s3_url. The re
-0000d460: 7375 6c74 2069 7320 696e 2061 6373 656e  sult is in acsen
-0000d470: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
-0000d480: 6c20 6f72 6465 722e 0a0a 2020 2020 2020  l order...      
-0000d490: 2020 3a72 6574 7572 6e73 3a20 416c 6c20    :returns: All 
-0000d4a0: 636f 6e74 656e 7473 2068 6176 6520 7072  contents have pr
-0000d4b0: 6566 6978 206f 6620 7333 5f75 726c 2069  efix of s3_url i
-0000d4c0: 6e20 6163 7365 6e64 696e 6720 616c 7068  n acsending alph
-0000d4d0: 6162 6574 6963 616c 206f 7264 6572 0a20  abetical order. 
-0000d4e0: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
-0000d4f0: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
-0000d500: 726f 722c 2053 334e 6f74 4144 6972 6563  ror, S3NotADirec
-0000d510: 746f 7279 4572 726f 720a 2020 2020 2020  toryError.      
-0000d520: 2020 2727 270a 2020 2020 2020 2020 656e    '''.        en
-0000d530: 7472 6965 7320 3d20 6c69 7374 2873 656c  tries = list(sel
-0000d540: 662e 7363 616e 6469 7228 666f 6c6c 6f77  f.scandir(follow
-0000d550: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
-0000d560: 7329 290a 2020 2020 2020 2020 7265 7475  s)).        retu
-0000d570: 726e 2073 6f72 7465 6428 5b65 6e74 7279  rn sorted([entry
-0000d580: 2e6e 616d 6520 666f 7220 656e 7472 7920  .name for entry 
-0000d590: 696e 2065 6e74 7269 6573 5d29 0a0a 2020  in entries])..  
-0000d5a0: 2020 6465 6620 6974 6572 6469 7228 7365    def iterdir(se
-0000d5b0: 6c66 2c20 666f 6c6c 6f77 6c69 6e6b 733a  lf, followlinks:
-0000d5c0: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
-0000d5d0: 3e20 4974 6572 6174 6f72 5b27 5333 5061  > Iterator['S3Pa
-0000d5e0: 7468 275d 3a0a 2020 2020 2020 2020 2727  th']:.        ''
-0000d5f0: 270a 2020 2020 2020 2020 4765 7420 616c  '.        Get al
-0000d600: 6c20 636f 6e74 656e 7473 206f 6620 6769  l contents of gi
-0000d610: 7665 6e20 7333 5f75 726c 2e20 5468 6520  ven s3_url. The 
-0000d620: 7265 7375 6c74 2069 7320 696e 2061 6373  result is in acs
-0000d630: 656e 6469 6e67 2061 6c70 6861 6265 7469  ending alphabeti
-0000d640: 6361 6c20 6f72 6465 722e 0a0a 2020 2020  cal order...    
-0000d650: 2020 2020 3a72 6574 7572 6e73 3a20 416c      :returns: Al
-0000d660: 6c20 636f 6e74 656e 7473 2068 6176 6520  l contents have 
-0000d670: 7072 6566 6978 206f 6620 7333 5f75 726c  prefix of s3_url
-0000d680: 2069 6e20 6163 7365 6e64 696e 6720 616c   in acsending al
-0000d690: 7068 6162 6574 6963 616c 206f 7264 6572  phabetical order
-0000d6a0: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
-0000d6b0: 3a20 5333 4669 6c65 4e6f 7446 6f75 6e64  : S3FileNotFound
-0000d6c0: 4572 726f 722c 2053 334e 6f74 4144 6972  Error, S3NotADir
-0000d6d0: 6563 746f 7279 4572 726f 720a 2020 2020  ectoryError.    
-0000d6e0: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000d6f0: 666f 7220 7061 7468 2069 6e20 7365 6c66  for path in self
-0000d700: 2e6c 6973 7464 6972 2866 6f6c 6c6f 776c  .listdir(followl
-0000d710: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
-0000d720: 293a 0a20 2020 2020 2020 2020 2020 2079  ):.            y
-0000d730: 6965 6c64 2073 656c 662e 6a6f 696e 7061  ield self.joinpa
-0000d740: 7468 2870 6174 6829 2020 2320 7479 7065  th(path)  # type
-0000d750: 3a20 6967 6e6f 7265 0a0a 2020 2020 6465  : ignore..    de
-0000d760: 6620 6c6f 6164 2873 656c 662c 2066 6f6c  f load(self, fol
-0000d770: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-0000d780: 2046 616c 7365 2920 2d3e 2042 696e 6172   False) -> Binar
-0000d790: 7949 4f3a 0a20 2020 2020 2020 2027 2727  yIO:.        '''
-0000d7a0: 5265 6164 2061 6c6c 2063 6f6e 7465 6e74  Read all content
-0000d7b0: 2069 6e20 6269 6e61 7279 206f 6e20 7370   in binary on sp
-0000d7c0: 6563 6966 6965 6420 7061 7468 2061 6e64  ecified path and
-0000d7d0: 2077 7269 7465 2069 6e74 6f20 6d65 6d6f   write into memo
-0000d7e0: 7279 0a0a 2020 2020 2020 2020 5573 6572  ry..        User
-0000d7f0: 2073 686f 756c 6420 636c 6f73 6520 7468   should close th
-0000d800: 6520 4269 6e61 7279 494f 206d 616e 7561  e BinaryIO manua
-0000d810: 6c6c 790a 0a20 2020 2020 2020 203a 7265  lly..        :re
-0000d820: 7475 726e 733a 2042 696e 6172 7949 4f0a  turns: BinaryIO.
-0000d830: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000d840: 2020 2020 7333 5f75 726c 203d 2073 656c      s3_url = sel
-0000d850: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000d860: 6f63 6f6c 0a20 2020 2020 2020 2069 6620  ocol.        if 
-0000d870: 666f 6c6c 6f77 6c69 6e6b 733a 0a20 2020  followlinks:.   
-0000d880: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0000d890: 2020 2020 2020 2020 2020 2020 2020 7333                s3
-0000d8a0: 5f75 726c 203d 2073 656c 662e 7265 6164  _url = self.read
-0000d8b0: 6c69 6e6b 2829 2e70 6174 685f 7769 7468  link().path_with
-0000d8c0: 5f70 726f 746f 636f 6c0a 2020 2020 2020  _protocol.      
-0000d8d0: 2020 2020 2020 6578 6365 7074 2053 334e        except S3N
-0000d8e0: 6f74 414c 696e 6b45 7272 6f72 3a0a 2020  otALinkError:.  
-0000d8f0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0000d900: 7373 0a20 2020 2020 2020 2062 7563 6b65  ss.        bucke
-0000d910: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
-0000d920: 335f 7572 6c28 7333 5f75 726c 290a 2020  3_url(s3_url).  
-0000d930: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
-0000d940: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
-0000d950: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
-0000d960: 6f74 466f 756e 6445 7272 6f72 2827 456d  otFoundError('Em
-0000d970: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
-0000d980: 2025 7227 2025 2073 335f 7572 6c29 0a20   %r' % s3_url). 
-0000d990: 2020 2020 2020 2069 6620 6e6f 7420 6b65         if not ke
-0000d9a0: 7920 6f72 206b 6579 2e65 6e64 7377 6974  y or key.endswit
-0000d9b0: 6828 272f 2729 3a0a 2020 2020 2020 2020  h('/'):.        
-0000d9c0: 2020 2020 7261 6973 6520 5333 4973 4144      raise S3IsAD
-0000d9d0: 6972 6563 746f 7279 4572 726f 7228 2749  irectoryError('I
-0000d9e0: 7320 6120 6469 7265 6374 6f72 793a 2025  s a directory: %
-0000d9f0: 7227 2025 2073 335f 7572 6c29 0a0a 2020  r' % s3_url)..  
-0000da00: 2020 2020 2020 6275 6666 6572 203d 2069        buffer = i
-0000da10: 6f2e 4279 7465 7349 4f28 290a 2020 2020  o.BytesIO().    
-0000da20: 2020 2020 7769 7468 2072 6169 7365 5f73      with raise_s
-0000da30: 335f 6572 726f 7228 7333 5f75 726c 293a  3_error(s3_url):
-0000da40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000da50: 662e 5f63 6c69 656e 742e 646f 776e 6c6f  f._client.downlo
-0000da60: 6164 5f66 696c 656f 626a 2862 7563 6b65  ad_fileobj(bucke
-0000da70: 742c 206b 6579 2c20 6275 6666 6572 290a  t, key, buffer).
-0000da80: 2020 2020 2020 2020 6275 6666 6572 2e73          buffer.s
-0000da90: 6565 6b28 3029 0a20 2020 2020 2020 2072  eek(0).        r
-0000daa0: 6574 7572 6e20 6275 6666 6572 0a0a 2020  eturn buffer..  
-0000dab0: 2020 6465 6620 6861 7362 7563 6b65 7428    def hasbucket(
-0000dac0: 7365 6c66 2920 2d3e 2062 6f6f 6c3a 0a20  self) -> bool:. 
-0000dad0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000dae0: 2020 2054 6573 7420 6966 2074 6865 2062     Test if the b
-0000daf0: 7563 6b65 7420 6f66 2073 335f 7572 6c20  ucket of s3_url 
-0000db00: 6578 6973 7473 0a0a 2020 2020 2020 2020  exists..        
-0000db10: 3a72 6574 7572 6e73 3a20 5472 7565 2069  :returns: True i
-0000db20: 6620 6275 636b 6574 206f 6620 7333 5f75  f bucket of s3_u
-0000db30: 726c 2065 6978 7374 732c 2065 6c73 6520  rl eixsts, else 
-0000db40: 4661 6c73 650a 2020 2020 2020 2020 2727  False.        ''
-0000db50: 270a 2020 2020 2020 2020 6275 636b 6574  '.        bucket
-0000db60: 2c20 5f20 3d20 7061 7273 655f 7333 5f75  , _ = parse_s3_u
-0000db70: 726c 2873 656c 662e 7061 7468 5f77 6974  rl(self.path_wit
-0000db80: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
-0000db90: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
-0000dba0: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
-0000dbb0: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
-0000dbc0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000dbd0: 2020 2020 2020 7365 6c66 2e5f 636c 6965        self._clie
-0000dbe0: 6e74 2e68 6561 645f 6275 636b 6574 2842  nt.head_bucket(B
-0000dbf0: 7563 6b65 743d 6275 636b 6574 290a 2020  ucket=bucket).  
-0000dc00: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-0000dc10: 6570 7469 6f6e 2061 7320 6572 726f 723a  eption as error:
-0000dc20: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
-0000dc30: 6f72 203d 2074 7261 6e73 6c61 7465 5f73  or = translate_s
-0000dc40: 335f 6572 726f 7228 6572 726f 722c 2073  3_error(error, s
-0000dc50: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-0000dc60: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
-0000dc70: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0000dc80: 6528 6572 726f 722c 0a20 2020 2020 2020  e(error,.       
-0000dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dca0: 2020 2028 5333 556e 6b6e 6f77 6e45 7272     (S3UnknownErr
-0000dcb0: 6f72 2c20 5333 436f 6e66 6967 4572 726f  or, S3ConfigErro
-0000dcc0: 722c 2053 3350 6572 6d69 7373 696f 6e45  r, S3PermissionE
-0000dcd0: 7272 6f72 2929 3a0a 2020 2020 2020 2020  rror)):.        
-0000dce0: 2020 2020 2020 2020 7261 6973 6520 6572          raise er
-0000dcf0: 726f 720a 2020 2020 2020 2020 2020 2020  ror.            
-0000dd00: 6966 2069 7369 6e73 7461 6e63 6528 6572  if isinstance(er
-0000dd10: 726f 722c 2053 3346 696c 654e 6f74 466f  ror, S3FileNotFo
-0000dd20: 756e 6445 7272 6f72 293a 0a20 2020 2020  undError):.     
-0000dd30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000dd40: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
-0000dd50: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
-0000dd60: 2020 6465 6620 6d6b 6469 7228 7365 6c66    def mkdir(self
-0000dd70: 2c20 6d6f 6465 3d30 6f37 3737 2c20 7061  , mode=0o777, pa
-0000dd80: 7265 6e74 733a 2062 6f6f 6c20 3d20 4661  rents: bool = Fa
-0000dd90: 6c73 652c 2065 7869 7374 5f6f 6b3a 2062  lse, exist_ok: b
-0000dda0: 6f6f 6c20 3d20 4661 6c73 6529 3a0a 2020  ool = False):.  
-0000ddb0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-0000ddc0: 2020 4372 6561 7465 2061 6e20 7333 2064    Create an s3 d
-0000ddd0: 6972 6563 746f 7279 2e0a 2020 2020 2020  irectory..      
-0000dde0: 2020 5075 7265 6c79 2063 7265 6174 696e    Purely creatin
-0000ddf0: 6720 6469 7265 6374 6f72 7920 6973 2069  g directory is i
-0000de00: 6e76 616c 6964 2062 6563 6175 7365 2069  nvalid because i
-0000de10: 7427 7320 756e 6176 6169 6c61 626c 6520  t's unavailable 
-0000de20: 6f6e 204f 5353 2e0a 2020 2020 2020 2020  on OSS..        
-0000de30: 5468 6973 2066 756e 6374 696f 6e20 6973  This function is
-0000de40: 2074 6f20 7465 7374 2074 6865 2074 6172   to test the tar
-0000de50: 6765 7420 6275 636b 6574 2068 6176 6520  get bucket have 
-0000de60: 5752 4954 4520 6163 6365 7373 2e0a 0a20  WRITE access... 
-0000de70: 2020 2020 2020 203a 7061 7261 6d20 6d6f         :param mo
-0000de80: 6465 3a20 6d6f 6465 2069 7320 6967 6e6f  de: mode is igno
-0000de90: 7265 642c 206f 6e6c 7920 6265 2063 6f6d  red, only be com
-0000dea0: 7061 7469 626c 6520 7769 7468 2070 6174  patible with pat
-0000deb0: 686c 6962 2e50 6174 680a 2020 2020 2020  hlib.Path.      
-0000dec0: 2020 3a70 6172 616d 2070 6172 656e 7473    :param parents
-0000ded0: 3a20 7061 7265 6e74 7320 6973 2069 676e  : parents is ign
-0000dee0: 6f72 6564 2c20 6f6e 6c79 2062 6520 636f  ored, only be co
-0000def0: 6d70 6174 6962 6c65 2077 6974 6820 7061  mpatible with pa
-0000df00: 7468 6c69 622e 5061 7468 0a20 2020 2020  thlib.Path.     
-0000df10: 2020 203a 7061 7261 6d20 6578 6973 745f     :param exist_
-0000df20: 6f6b 3a20 4966 2046 616c 7365 2061 6e64  ok: If False and
-0000df30: 2074 6172 6765 7420 6469 7265 6374 6f72   target director
-0000df40: 7920 6578 6973 7473 2c20 7261 6973 6520  y exists, raise 
-0000df50: 5333 4669 6c65 4578 6973 7473 4572 726f  S3FileExistsErro
-0000df60: 720a 2020 2020 2020 2020 3a72 6169 7365  r.        :raise
-0000df70: 733a 2053 3342 7563 6b65 744e 6f74 466f  s: S3BucketNotFo
-0000df80: 756e 6445 7272 6f72 2c20 5333 4669 6c65  undError, S3File
-0000df90: 4578 6973 7473 4572 726f 720a 2020 2020  ExistsError.    
-0000dfa0: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000dfb0: 6275 636b 6574 2c20 5f20 3d20 7061 7273  bucket, _ = pars
-0000dfc0: 655f 7333 5f75 726c 2873 656c 662e 7061  e_s3_url(self.pa
-0000dfd0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-0000dfe0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0000dff0: 2062 7563 6b65 743a 0a20 2020 2020 2020   bucket:.       
-0000e000: 2020 2020 2072 6169 7365 2053 3342 7563       raise S3Buc
-0000e010: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
-0000e020: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000e030: 2020 2745 6d70 7479 2062 7563 6b65 7420    'Empty bucket 
-0000e040: 6e61 6d65 3a20 2572 2720 2520 7365 6c66  name: %r' % self
-0000e050: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-0000e060: 636f 6c29 0a20 2020 2020 2020 2069 6620  col).        if 
-0000e070: 6e6f 7420 7365 6c66 2e68 6173 6275 636b  not self.hasbuck
-0000e080: 6574 2829 3a0a 2020 2020 2020 2020 2020  et():.          
-0000e090: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
-0000e0a0: 4e6f 7446 6f75 6e64 4572 726f 7228 0a20  NotFoundError(. 
-0000e0b0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000e0c0: 4e6f 2073 7563 6820 6275 636b 6574 3a20  No such bucket: 
-0000e0d0: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
-0000e0e0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
-0000e0f0: 2020 2020 2020 2069 6620 6578 6973 745f         if exist_
-0000e100: 6f6b 3a0a 2020 2020 2020 2020 2020 2020  ok:.            
-0000e110: 6966 2073 656c 662e 6973 5f66 696c 6528  if self.is_file(
-0000e120: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000e130: 2020 2072 6169 7365 2053 3346 696c 6545     raise S3FileE
-0000e140: 7869 7374 7345 7272 6f72 280a 2020 2020  xistsError(.    
-0000e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e160: 2746 696c 6520 6578 6973 7473 3a20 2572  'File exists: %r
-0000e170: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
-0000e180: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-0000e190: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-0000e1a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000e1b0: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
-0000e1c0: 2020 2020 2020 7261 6973 6520 5333 4669        raise S3Fi
-0000e1d0: 6c65 4578 6973 7473 4572 726f 7228 2746  leExistsError('F
-0000e1e0: 696c 6520 6578 6973 7473 3a20 2572 2720  ile exists: %r' 
-0000e1f0: 2520 7365 6c66 2e70 6174 685f 7769 7468  % self.path_with
-0000e200: 5f70 726f 746f 636f 6c29 0a0a 2020 2020  _protocol)..    
-0000e210: 6465 6620 6d6f 7665 2873 656c 662c 2064  def move(self, d
-0000e220: 7374 5f75 726c 3a20 5061 7468 4c69 6b65  st_url: PathLike
-0000e230: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0000e240: 2020 2027 2727 0a20 2020 2020 2020 204d     '''.        M
-0000e250: 6f76 6520 6669 6c65 2f64 6972 6563 746f  ove file/directo
-0000e260: 7279 2070 6174 6820 6672 6f6d 2073 7263  ry path from src
-0000e270: 5f75 726c 2074 6f20 6473 745f 7572 6c0a  _url to dst_url.
-0000e280: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000e290: 6473 745f 7572 6c3a 2047 6976 656e 2064  dst_url: Given d
-0000e2a0: 6573 7469 6e61 7469 6f6e 2070 6174 680a  estination path.
-0000e2b0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000e2c0: 2020 2020 666f 7220 7372 635f 6669 6c65      for src_file
-0000e2d0: 5f70 6174 682c 2064 7374 5f66 696c 655f  _path, dst_file_
-0000e2e0: 7061 7468 2069 6e20 5f73 335f 7363 616e  path in _s3_scan
-0000e2f0: 5f70 6169 7273 280a 2020 2020 2020 2020  _pairs(.        
-0000e300: 2020 2020 2020 2020 7365 6c66 2e70 6174          self.pat
-0000e310: 685f 7769 7468 5f70 726f 746f 636f 6c2c  h_with_protocol,
-0000e320: 2064 7374 5f75 726c 293a 0a20 2020 2020   dst_url):.     
-0000e330: 2020 2020 2020 2053 3350 6174 6828 7372         S3Path(sr
-0000e340: 635f 6669 6c65 5f70 6174 6829 2e72 656e  c_file_path).ren
-0000e350: 616d 6528 6473 745f 6669 6c65 5f70 6174  ame(dst_file_pat
-0000e360: 6829 0a0a 2020 2020 6465 6620 7265 6d6f  h)..    def remo
-0000e370: 7665 2873 656c 662c 206d 6973 7369 6e67  ve(self, missing
-0000e380: 5f6f 6b3a 2062 6f6f 6c20 3d20 4661 6c73  _ok: bool = Fals
-0000e390: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-0000e3a0: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000e3b0: 5265 6d6f 7665 2074 6865 2066 696c 6520  Remove the file 
-0000e3c0: 6f72 2064 6972 6563 746f 7279 206f 6e20  or directory on 
-0000e3d0: 7333 2c20 6073 333a 2f2f 6020 616e 6420  s3, `s3://` and 
-0000e3e0: 6073 333a 2f2f 6275 636b 6574 6020 6172  `s3://bucket` ar
-0000e3f0: 6520 6e6f 7420 7065 726d 6974 7465 6420  e not permitted 
-0000e400: 746f 2072 656d 6f76 650a 0a20 2020 2020  to remove..     
-0000e410: 2020 203a 7061 7261 6d20 6d69 7373 696e     :param missin
-0000e420: 675f 6f6b 3a20 6966 2046 616c 7365 2061  g_ok: if False a
-0000e430: 6e64 2074 6172 6765 7420 6669 6c65 2f64  nd target file/d
-0000e440: 6972 6563 746f 7279 206e 6f74 2065 7869  irectory not exi
-0000e450: 7374 732c 2072 6169 7365 2053 3346 696c  sts, raise S3Fil
-0000e460: 654e 6f74 466f 756e 6445 7272 6f72 0a20  eNotFoundError. 
-0000e470: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
-0000e480: 5333 5065 726d 6973 7369 6f6e 4572 726f  S3PermissionErro
-0000e490: 722c 2053 3346 696c 654e 6f74 466f 756e  r, S3FileNotFoun
-0000e4a0: 6445 7272 6f72 2c20 556e 7375 7070 6f72  dError, Unsuppor
-0000e4b0: 7465 6445 7272 6f72 0a20 2020 2020 2020  tedError.       
-0000e4c0: 2027 2727 0a20 2020 2020 2020 2062 7563   '''.        buc
-0000e4d0: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
-0000e4e0: 5f73 335f 7572 6c28 7365 6c66 2e70 6174  _s3_url(self.pat
-0000e4f0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000e500: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0000e510: 6275 636b 6574 3a0a 2020 2020 2020 2020  bucket:.        
-0000e520: 2020 2020 6966 206e 6f74 206b 6579 3a0a      if not key:.
-0000e530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e540: 7261 6973 6520 556e 7375 7070 6f72 7465  raise Unsupporte
-0000e550: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
-0000e560: 2020 2020 2020 2020 2020 2020 2752 656d              'Rem
-0000e570: 6f76 6520 7768 6f6c 6520 7333 272c 2073  ove whole s3', s
-0000e580: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-0000e590: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
-0000e5a0: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
-0000e5b0: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
-0000e5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e5d0: 2027 456d 7074 7920 6275 636b 6574 206e   'Empty bucket n
-0000e5e0: 616d 653a 2025 7227 2025 2073 656c 662e  ame: %r' % self.
-0000e5f0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000e600: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
-0000e610: 6f74 206b 6579 3a0a 2020 2020 2020 2020  ot key:.        
-0000e620: 2020 2020 7261 6973 6520 556e 7375 7070      raise Unsupp
-0000e630: 6f72 7465 6445 7272 6f72 2827 5265 6d6f  ortedError('Remo
-0000e640: 7665 2062 7563 6b65 7427 2c20 7365 6c66  ve bucket', self
-0000e650: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-0000e660: 636f 6c29 0a20 2020 2020 2020 2069 6620  col).        if 
-0000e670: 6e6f 7420 7365 6c66 2e65 7869 7374 7328  not self.exists(
-0000e680: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-0000e690: 6620 6d69 7373 696e 675f 6f6b 3a0a 2020  f missing_ok:.  
-0000e6a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000e6b0: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
-0000e6c0: 2072 6169 7365 2053 3346 696c 654e 6f74   raise S3FileNot
-0000e6d0: 466f 756e 6445 7272 6f72 280a 2020 2020  FoundError(.    
-0000e6e0: 2020 2020 2020 2020 2020 2020 274e 6f20              'No 
-0000e6f0: 7375 6368 2066 696c 6520 6f72 2064 6972  such file or dir
-0000e700: 6563 746f 7279 3a20 2572 2720 2520 7365  ectory: %r' % se
-0000e710: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000e720: 746f 636f 6c29 0a0a 2020 2020 2020 2020  tocol)..        
-0000e730: 636c 6965 6e74 203d 2073 656c 662e 5f63  client = self._c
-0000e740: 6c69 656e 740a 2020 2020 2020 2020 7769  lient.        wi
-0000e750: 7468 2072 6169 7365 5f73 335f 6572 726f  th raise_s3_erro
-0000e760: 7228 7365 6c66 2e70 6174 685f 7769 7468  r(self.path_with
-0000e770: 5f70 726f 746f 636f 6c29 3a0a 2020 2020  _protocol):.    
-0000e780: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000e790: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
-0000e7a0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0000e7b0: 742e 6465 6c65 7465 5f6f 626a 6563 7428  t.delete_object(
-0000e7c0: 4275 636b 6574 3d62 7563 6b65 742c 204b  Bucket=bucket, K
-0000e7d0: 6579 3d6b 6579 290a 2020 2020 2020 2020  ey=key).        
-0000e7e0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-0000e7f0: 2020 2020 2020 2020 2020 2070 7265 6669             prefi
-0000e800: 7820 3d20 5f62 6563 6f6d 655f 7072 6566  x = _become_pref
-0000e810: 6978 286b 6579 290a 2020 2020 2020 2020  ix(key).        
-0000e820: 2020 2020 746f 7461 6c5f 636f 756e 742c      total_count,
-0000e830: 2065 7272 6f72 5f63 6f75 6e74 203d 2030   error_count = 0
-0000e840: 2c20 300a 2020 2020 2020 2020 2020 2020  , 0.            
-0000e850: 666f 7220 7265 7370 2069 6e20 5f6c 6973  for resp in _lis
-0000e860: 745f 6f62 6a65 6374 735f 7265 6375 7273  t_objects_recurs
-0000e870: 6976 6528 636c 6965 6e74 2c20 6275 636b  ive(client, buck
-0000e880: 6574 2c20 7072 6566 6978 293a 0a20 2020  et, prefix):.   
-0000e890: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000e8a0: 2743 6f6e 7465 6e74 7327 2069 6e20 7265  'Contents' in re
-0000e8b0: 7370 3a0a 2020 2020 2020 2020 2020 2020  sp:.            
-0000e8c0: 2020 2020 2020 2020 6b65 7973 203d 205b          keys = [
-0000e8d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e8e0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0000e8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e900: 2020 2020 2020 2027 4b65 7927 3a20 636f         'Key': co
-0000e910: 6e74 656e 745b 274b 6579 275d 0a20 2020  ntent['Key'].   
-0000e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e930: 2020 2020 207d 2066 6f72 2063 6f6e 7465       } for conte
-0000e940: 6e74 2069 6e20 7265 7370 5b27 436f 6e74  nt in resp['Cont
-0000e950: 656e 7473 275d 0a20 2020 2020 2020 2020  ents'].         
-0000e960: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
-0000e970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e980: 2074 6f74 616c 5f63 6f75 6e74 202b 3d20   total_count += 
-0000e990: 6c65 6e28 6b65 7973 290a 2020 2020 2020  len(keys).      
-0000e9a0: 2020 2020 2020 2020 2020 2020 2020 6572                er
-0000e9b0: 726f 7273 203d 205b 5d0a 2020 2020 2020  rors = [].      
-0000e9c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000e9d0: 7472 6965 7320 3d20 320a 2020 2020 2020  tries = 2.      
-0000e9e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000e9f0: 7472 795f 696e 7465 7276 616c 203d 206d  try_interval = m
-0000ea00: 696e 2830 2e31 202a 2032 2a2a 7265 7472  in(0.1 * 2**retr
-0000ea10: 6965 732c 2033 3029 0a20 2020 2020 2020  ies, 30).       
-0000ea20: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0000ea30: 2069 2069 6e20 7261 6e67 6528 7265 7472   i in range(retr
-0000ea40: 6965 7329 3a0a 2020 2020 2020 2020 2020  ies):.          
-0000ea50: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000ea60: 646f 633a 2068 7474 7073 3a2f 2f62 6f74  doc: https://bot
-0000ea70: 6f33 2e61 6d61 7a6f 6e61 7773 2e63 6f6d  o3.amazonaws.com
-0000ea80: 2f76 312f 646f 6375 6d65 6e74 6174 696f  /v1/documentatio
-0000ea90: 6e2f 6170 692f 6c61 7465 7374 2f72 6566  n/api/latest/ref
-0000eaa0: 6572 656e 6365 2f73 6572 7669 6365 732f  erence/services/
-0000eab0: 7333 2e68 746d 6c23 5333 2e43 6c69 656e  s3.html#S3.Clien
-0000eac0: 742e 6465 6c65 7465 5f6f 626a 6563 7473  t.delete_objects
-0000ead0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eae0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0000eaf0: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-0000eb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb10: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
-0000eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb30: 7265 7370 6f6e 7365 203d 2063 6c69 656e  response = clien
-0000eb40: 742e 6465 6c65 7465 5f6f 626a 6563 7473  t.delete_objects
-0000eb50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000eb60: 2020 2020 2020 2020 2020 2020 2020 4275                Bu
-0000eb70: 636b 6574 3d62 7563 6b65 742c 2044 656c  cket=bucket, Del
-0000eb80: 6574 653d 7b27 4f62 6a65 6374 7327 3a20  ete={'Objects': 
-0000eb90: 6b65 7973 7d29 0a20 2020 2020 2020 2020  keys}).         
-0000eba0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-0000ebb0: 6579 7320 3d20 5b5d 0a20 2020 2020 2020  eys = [].       
-0000ebc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebd0: 2066 6f72 2065 7272 6f72 5f69 6e66 6f20   for error_info 
-0000ebe0: 696e 2072 6573 706f 6e73 652e 6765 7428  in response.get(
-0000ebf0: 2745 7272 6f72 7327 2c20 5b5d 293a 0a20  'Errors', []):. 
+0000c5a0: 7072 6f66 696c 655f 6e61 6d65 3d73 656c  profile_name=sel
+0000c5b0: 662e 5f70 726f 6669 6c65 5f6e 616d 6529  f._profile_name)
+0000c5c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c5d0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0000c5e0: 662e 5f70 726f 6669 6c65 5f6e 616d 653a  f._profile_name:
+0000c5f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c600: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+0000c610: 655f 656e 7472 7920 3d20 6669 6c65 5f65  e_entry = file_e
+0000c620: 6e74 7279 2e5f 7265 706c 6163 6528 0a20  ntry._replace(. 
+0000c630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c640: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000c650: 6174 683d 0a20 2020 2020 2020 2020 2020  ath=.           
+0000c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c670: 2020 2020 2066 227b 7365 6c66 2e5f 7072       f"{self._pr
+0000c680: 6f74 6f63 6f6c 5f77 6974 685f 7072 6f66  otocol_with_prof
+0000c690: 696c 657d 3a2f 2f7b 6669 6c65 5f65 6e74  ile}://{file_ent
+0000c6a0: 7279 2e70 6174 685b 353a 5d7d 220a 2020  ry.path[5:]}".  
+0000c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6e0: 2020 2020 7969 656c 6420 6669 6c65 5f65      yield file_e
+0000c6f0: 6e74 7279 0a0a 2020 2020 2020 2020 7265  ntry..        re
+0000c700: 7475 726e 205f 6372 6561 7465 5f6d 6973  turn _create_mis
+0000c710: 7369 6e67 5f6f 6b5f 6765 6e65 7261 746f  sing_ok_generato
+0000c720: 7228 0a20 2020 2020 2020 2020 2020 2063  r(.            c
+0000c730: 7265 6174 655f 6765 6e65 7261 746f 7228  reate_generator(
+0000c740: 292c 206d 6973 7369 6e67 5f6f 6b2c 0a20  ), missing_ok,. 
+0000c750: 2020 2020 2020 2020 2020 2053 3346 696c             S3Fil
+0000c760: 654e 6f74 466f 756e 6445 7272 6f72 2827  eNotFoundError('
+0000c770: 4e6f 206d 6174 6368 2066 696c 653a 2025  No match file: %
+0000c780: 7227 2025 2073 335f 7061 7468 6e61 6d65  r' % s3_pathname
+0000c790: 2929 0a0a 2020 2020 6465 6620 6967 6c6f  ))..    def iglo
+0000c7a0: 6228 0a20 2020 2020 2020 2020 2020 2073  b(.            s
+0000c7b0: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
+0000c7c0: 2070 6174 7465 726e 2c0a 2020 2020 2020   pattern,.      
+0000c7d0: 2020 2020 2020 7265 6375 7273 6976 653a        recursive:
+0000c7e0: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
+0000c7f0: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
+0000c800: 675f 6f6b 3a20 626f 6f6c 203d 2054 7275  g_ok: bool = Tru
+0000c810: 652c 0a20 2020 2020 2020 2020 2020 2066  e,.            f
+0000c820: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
+0000c830: 203d 2046 616c 7365 2c0a 2020 2020 2920   = False,.    ) 
+0000c840: 2d3e 2049 7465 7261 746f 725b 2753 3350  -> Iterator['S3P
+0000c850: 6174 6827 5d3a 0a20 2020 2020 2020 2027  ath']:.        '
+0000c860: 2727 5265 7475 726e 2073 3320 7061 7468  ''Return s3 path
+0000c870: 2069 7465 7261 746f 7220 696e 2061 7363   iterator in asc
+0000c880: 656e 6469 6e67 2061 6c70 6861 6265 7469  ending alphabeti
+0000c890: 6361 6c20 6f72 6465 722c 2069 6e20 7768  cal order, in wh
+0000c8a0: 6963 6820 7061 7468 206d 6174 6368 6573  ich path matches
+0000c8b0: 2067 6c6f 6220 7061 7474 6572 6e0a 2020   glob pattern.  
+0000c8c0: 2020 2020 2020 4e6f 7465 733a 204f 6e6c        Notes: Onl
+0000c8d0: 7920 676c 6f62 2069 6e20 6275 636b 6574  y glob in bucket
+0000c8e0: 2e20 4966 2074 7279 696e 6720 746f 206d  . If trying to m
+0000c8f0: 6174 6368 2062 7563 6b65 7420 7769 7468  atch bucket with
+0000c900: 2077 696c 6463 6172 6420 6368 6172 6163   wildcard charac
+0000c910: 7465 7273 2c20 7261 6973 6520 556e 7375  ters, raise Unsu
+0000c920: 7070 6f72 7465 6445 7272 6f72 0a0a 2020  pportedError..  
+0000c930: 2020 2020 2020 3a70 6172 616d 2070 6174        :param pat
+0000c940: 7465 726e 3a20 476c 6f62 2074 6865 2067  tern: Glob the g
+0000c950: 6976 656e 2072 656c 6174 6976 6520 7061  iven relative pa
+0000c960: 7474 6572 6e20 696e 2074 6865 2064 6972  ttern in the dir
+0000c970: 6563 746f 7279 2072 6570 7265 7365 6e74  ectory represent
+0000c980: 6564 2062 7920 7468 6973 2070 6174 680a  ed by this path.
+0000c990: 2020 2020 2020 2020 3a70 6172 616d 2072          :param r
+0000c9a0: 6563 7572 7369 7665 3a20 4966 2046 616c  ecursive: If Fal
+0000c9b0: 7365 2c20 602a 2a60 2077 696c 6c20 6e6f  se, `**` will no
+0000c9c0: 7420 7365 6172 6368 2064 6972 6563 746f  t search directo
+0000c9d0: 7279 2072 6563 7572 7369 7665 6c79 0a20  ry recursively. 
+0000c9e0: 2020 2020 2020 203a 7061 7261 6d20 6d69         :param mi
+0000c9f0: 7373 696e 675f 6f6b 3a20 4966 2046 616c  ssing_ok: If Fal
+0000ca00: 7365 2061 6e64 2074 6172 6765 7420 7061  se and target pa
+0000ca10: 7468 2064 6f65 736e 2774 206d 6174 6368  th doesn't match
+0000ca20: 2061 6e79 2066 696c 652c 2072 6169 7365   any file, raise
+0000ca30: 2046 696c 654e 6f74 466f 756e 6445 7272   FileNotFoundErr
+0000ca40: 6f72 0a20 2020 2020 2020 203a 7261 6973  or.        :rais
+0000ca50: 6573 3a20 556e 7375 7070 6f72 7465 6445  es: UnsupportedE
+0000ca60: 7272 6f72 2c20 7768 656e 2062 7563 6b65  rror, when bucke
+0000ca70: 7420 7061 7274 2063 6f6e 7461 696e 7320  t part contains 
+0000ca80: 7769 6c64 6361 7264 2063 6861 7261 6374  wildcard charact
+0000ca90: 6572 730a 2020 2020 2020 2020 3a72 6574  ers.        :ret
+0000caa0: 7572 6e73 3a20 416e 2069 7465 7261 746f  urns: An iterato
+0000cab0: 7220 636f 6e74 6169 6e73 2070 6174 6873  r contains paths
+0000cac0: 206d 6174 6368 2060 7333 5f70 6174 686e   match `s3_pathn
+0000cad0: 616d 6560 0a20 2020 2020 2020 2027 2727  ame`.        '''
+0000cae0: 0a20 2020 2020 2020 2066 6f72 2066 696c  .        for fil
+0000caf0: 655f 656e 7472 7920 696e 2073 656c 662e  e_entry in self.
+0000cb00: 676c 6f62 5f73 7461 7428 7061 7474 6572  glob_stat(patter
+0000cb10: 6e3d 7061 7474 6572 6e2c 2072 6563 7572  n=pattern, recur
+0000cb20: 7369 7665 3d72 6563 7572 7369 7665 2c0a  sive=recursive,.
+0000cb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb50: 2020 2020 2020 2020 206d 6973 7369 6e67           missing
+0000cb60: 5f6f 6b3d 6d69 7373 696e 675f 6f6b 2c0a  _ok=missing_ok,.
+0000cb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb90: 2020 2020 2020 2020 2066 6f6c 6c6f 776c           followl
+0000cba0: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
+0000cbb0: 293a 0a20 2020 2020 2020 2020 2020 2079  ):.            y
+0000cbc0: 6965 6c64 2073 656c 662e 6672 6f6d 5f70  ield self.from_p
+0000cbd0: 6174 6828 6669 6c65 5f65 6e74 7279 2e70  ath(file_entry.p
+0000cbe0: 6174 6829 0a0a 2020 2020 6465 6620 6973  ath)..    def is
+0000cbf0: 5f64 6972 2873 656c 662c 2066 6f6c 6c6f  _dir(self, follo
+0000cc00: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
+0000cc10: 616c 7365 2920 2d3e 2062 6f6f 6c3a 0a20  alse) -> bool:. 
+0000cc20: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000cc30: 2020 2054 6573 7420 6966 2061 6e20 7333     Test if an s3
+0000cc40: 2075 726c 2069 7320 6469 7265 6374 6f72   url is director
+0000cc50: 790a 2020 2020 2020 2020 5370 6563 6966  y.        Specif
+0000cc60: 6963 2070 726f 6365 6475 7265 7320 6172  ic procedures ar
+0000cc70: 6520 6173 2066 6f6c 6c6f 7773 3a0a 2020  e as follows:.  
+0000cc80: 2020 2020 2020 4966 2074 6865 7265 2065        If there e
+0000cc90: 7869 7374 7320 6120 7375 6666 6978 2c20  xists a suffix, 
+0000cca0: 6f66 2077 6869 6368 2060 606f 732e 7061  of which ``os.pa
+0000ccb0: 7468 2e6a 6f69 6e28 7333 5f75 726c 2c20  th.join(s3_url, 
+0000ccc0: 7375 6666 6978 2960 6020 6973 2061 2066  suffix)`` is a f
+0000ccd0: 696c 650a 2020 2020 2020 2020 4966 2074  ile.        If t
+0000cce0: 6865 2075 726c 2069 7320 656d 7074 7920  he url is empty 
+0000ccf0: 6275 636b 6574 206f 7220 7333 3a2f 2f0a  bucket or s3://.
+0000cd00: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000cd10: 666f 6c6c 6f77 6c69 6e6b 733a 2077 6865  followlinks: whe
+0000cd20: 7468 6572 2066 6f6c 6c6f 776c 696e 6b73  ther followlinks
+0000cd30: 2069 7320 5472 7565 206f 7220 4661 6c73   is True or Fals
+0000cd40: 652c 2072 6573 756c 7420 6973 2074 6865  e, result is the
+0000cd50: 2073 616d 652e 2042 6563 6175 7365 2073   same. Because s
+0000cd60: 3320 7379 6d6c 696e 6b20 6e6f 7420 7375  3 symlink not su
+0000cd70: 7070 6f72 7420 6469 722e 0a20 2020 2020  pport dir..     
+0000cd80: 2020 203a 7265 7475 726e 733a 2054 7275     :returns: Tru
+0000cd90: 6520 6966 2070 6174 6820 6973 2073 3320  e if path is s3 
+0000cda0: 6469 7265 6374 6f72 792c 2065 6c73 6520  directory, else 
+0000cdb0: 4661 6c73 650a 2020 2020 2020 2020 2727  False.        ''
+0000cdc0: 270a 2020 2020 2020 2020 6275 636b 6574  '.        bucket
+0000cdd0: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
+0000cde0: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
+0000cdf0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+0000ce00: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
+0000ce10: 6b65 743a 2020 2320 7333 3a2f 2f20 3d3e  ket:  # s3:// =>
+0000ce20: 2054 7275 652c 2073 333a 2f2f 2f6b 6579   True, s3:///key
+0000ce30: 203d 3e20 4661 6c73 650a 2020 2020 2020   => False.      
+0000ce40: 2020 2020 2020 7265 7475 726e 206e 6f74        return not
+0000ce50: 206b 6579 0a20 2020 2020 2020 2070 7265   key.        pre
+0000ce60: 6669 7820 3d20 5f62 6563 6f6d 655f 7072  fix = _become_pr
+0000ce70: 6566 6978 286b 6579 290a 2020 2020 2020  efix(key).      
+0000ce80: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000ce90: 2020 2072 6573 7020 3d20 7365 6c66 2e5f     resp = self._
+0000cea0: 636c 6965 6e74 2e6c 6973 745f 6f62 6a65  client.list_obje
+0000ceb0: 6374 735f 7632 280a 2020 2020 2020 2020  cts_v2(.        
+0000cec0: 2020 2020 2020 2020 4275 636b 6574 3d62          Bucket=b
+0000ced0: 7563 6b65 742c 2050 7265 6669 783d 7072  ucket, Prefix=pr
+0000cee0: 6566 6978 2c20 4465 6c69 6d69 7465 723d  efix, Delimiter=
+0000cef0: 272f 272c 204d 6178 4b65 7973 3d31 290a  '/', MaxKeys=1).
+0000cf00: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0000cf10: 7863 6570 7469 6f6e 2061 7320 6572 726f  xception as erro
+0000cf20: 723a 0a20 2020 2020 2020 2020 2020 2065  r:.            e
+0000cf30: 7272 6f72 203d 2074 7261 6e73 6c61 7465  rror = translate
+0000cf40: 5f73 335f 6572 726f 7228 6572 726f 722c  _s3_error(error,
+0000cf50: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
+0000cf60: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+0000cf70: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+0000cf80: 6e63 6528 6572 726f 722c 0a20 2020 2020  nce(error,.     
+0000cf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cfa0: 2020 2020 2028 5333 556e 6b6e 6f77 6e45       (S3UnknownE
+0000cfb0: 7272 6f72 2c20 5333 436f 6e66 6967 4572  rror, S3ConfigEr
+0000cfc0: 726f 722c 2053 3350 6572 6d69 7373 696f  ror, S3Permissio
+0000cfd0: 6e45 7272 6f72 2929 3a0a 2020 2020 2020  nError)):.      
+0000cfe0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000cff0: 6572 726f 720a 2020 2020 2020 2020 2020  error.          
+0000d000: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+0000d010: 2020 2020 2020 2020 6966 206e 6f74 206b          if not k
+0000d020: 6579 3a20 2023 2062 7563 6b65 7420 6973  ey:  # bucket is
+0000d030: 2061 6363 6573 7369 626c 650a 2020 2020   accessible.    
+0000d040: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+0000d050: 7275 650a 0a20 2020 2020 2020 2069 6620  rue..        if 
+0000d060: 274b 6579 436f 756e 7427 2069 6e20 7265  'KeyCount' in re
+0000d070: 7370 3a0a 2020 2020 2020 2020 2020 2020  sp:.            
+0000d080: 7265 7475 726e 2072 6573 705b 274b 6579  return resp['Key
+0000d090: 436f 756e 7427 5d20 3e20 300a 0a20 2020  Count'] > 0..   
+0000d0a0: 2020 2020 2072 6574 7572 6e20 6c65 6e28       return len(
+0000d0b0: 7265 7370 2e67 6574 2827 436f 6e74 656e  resp.get('Conten
+0000d0c0: 7473 272c 205b 5d29 2920 3e20 3020 6f72  ts', [])) > 0 or
+0000d0d0: 205c 0a20 2020 2020 2020 2020 2020 206c   \.            l
+0000d0e0: 656e 2872 6573 702e 6765 7428 2743 6f6d  en(resp.get('Com
+0000d0f0: 6d6f 6e50 7265 6669 7865 7327 2c20 5b5d  monPrefixes', []
+0000d100: 2929 203e 2030 0a0a 2020 2020 6465 6620  )) > 0..    def 
+0000d110: 6973 5f66 696c 6528 7365 6c66 2c20 666f  is_file(self, fo
+0000d120: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
+0000d130: 3d20 4661 6c73 6529 202d 3e20 626f 6f6c  = False) -> bool
+0000d140: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
+0000d150: 2020 2020 2020 5465 7374 2069 6620 616e        Test if an
+0000d160: 2073 335f 7572 6c20 6973 2066 696c 650a   s3_url is file.
+0000d170: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0000d180: 733a 2054 7275 6520 6966 2070 6174 6820  s: True if path 
+0000d190: 6973 2073 3320 6669 6c65 2c20 656c 7365  is s3 file, else
+0000d1a0: 2046 616c 7365 0a20 2020 2020 2020 2027   False.        '
+0000d1b0: 2727 0a20 2020 2020 2020 2073 335f 7572  ''.        s3_ur
+0000d1c0: 6c20 3d20 7365 6c66 2e70 6174 685f 7769  l = self.path_wi
+0000d1d0: 7468 5f70 726f 746f 636f 6c0a 2020 2020  th_protocol.    
+0000d1e0: 2020 2020 6966 2066 6f6c 6c6f 776c 696e      if followlin
+0000d1f0: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
+0000d200: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000d210: 2020 2020 2073 335f 7572 6c20 3d20 7365       s3_url = se
+0000d220: 6c66 2e72 6561 646c 696e 6b28 292e 7061  lf.readlink().pa
+0000d230: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000d240: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0000d250: 6570 7420 5333 4e6f 7441 4c69 6e6b 4572  ept S3NotALinkEr
+0000d260: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0000d270: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
+0000d280: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
+0000d290: 7061 7273 655f 7333 5f75 726c 2873 335f  parse_s3_url(s3_
+0000d2a0: 7572 6c29 0a20 2020 2020 2020 2069 6620  url).        if 
+0000d2b0: 6e6f 7420 6275 636b 6574 206f 7220 6e6f  not bucket or no
+0000d2c0: 7420 6b65 7920 6f72 206b 6579 2e65 6e64  t key or key.end
+0000d2d0: 7377 6974 6828 272f 2729 3a0a 2020 2020  swith('/'):.    
+0000d2e0: 2020 2020 2020 2020 2320 7333 3a2f 2f2c          # s3://,
+0000d2f0: 2073 333a 2f2f 2f6b 6579 2c20 7333 3a2f   s3:///key, s3:/
+0000d300: 2f62 7563 6b65 742c 2073 333a 2f2f 6275  /bucket, s3://bu
+0000d310: 636b 6574 2f70 7265 6669 782f 0a20 2020  cket/prefix/.   
+0000d320: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000d330: 4661 6c73 650a 2020 2020 2020 2020 7472  False.        tr
+0000d340: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+0000d350: 656c 662e 5f63 6c69 656e 742e 6865 6164  elf._client.head
+0000d360: 5f6f 626a 6563 7428 4275 636b 6574 3d62  _object(Bucket=b
+0000d370: 7563 6b65 742c 204b 6579 3d6b 6579 290a  ucket, Key=key).
+0000d380: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0000d390: 7863 6570 7469 6f6e 2061 7320 6572 726f  xception as erro
+0000d3a0: 723a 0a20 2020 2020 2020 2020 2020 2065  r:.            e
+0000d3b0: 7272 6f72 203d 2074 7261 6e73 6c61 7465  rror = translate
+0000d3c0: 5f73 335f 6572 726f 7228 6572 726f 722c  _s3_error(error,
+0000d3d0: 2073 335f 7572 6c29 0a20 2020 2020 2020   s3_url).       
+0000d3e0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0000d3f0: 6365 2865 7272 6f72 2c0a 2020 2020 2020  ce(error,.      
+0000d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d410: 2020 2020 2853 3355 6e6b 6e6f 776e 4572      (S3UnknownEr
+0000d420: 726f 722c 2053 3343 6f6e 6669 6745 7272  ror, S3ConfigErr
+0000d430: 6f72 2c20 5333 5065 726d 6973 7369 6f6e  or, S3Permission
+0000d440: 4572 726f 7229 293a 0a20 2020 2020 2020  Error)):.       
+0000d450: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
+0000d460: 7272 6f72 0a20 2020 2020 2020 2020 2020  rror.           
+0000d470: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
+0000d480: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+0000d490: 650a 0a20 2020 2064 6566 206c 6973 7464  e..    def listd
+0000d4a0: 6972 2873 656c 662c 2066 6f6c 6c6f 776c  ir(self, followl
+0000d4b0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+0000d4c0: 7365 2920 2d3e 204c 6973 745b 7374 725d  se) -> List[str]
+0000d4d0: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
+0000d4e0: 2020 2020 2020 4765 7420 616c 6c20 636f        Get all co
+0000d4f0: 6e74 656e 7473 206f 6620 6769 7665 6e20  ntents of given 
+0000d500: 7333 5f75 726c 2e20 5468 6520 7265 7375  s3_url. The resu
+0000d510: 6c74 2069 7320 696e 2061 6373 656e 6469  lt is in acsendi
+0000d520: 6e67 2061 6c70 6861 6265 7469 6361 6c20  ng alphabetical 
+0000d530: 6f72 6465 722e 0a0a 2020 2020 2020 2020  order...        
+0000d540: 3a72 6574 7572 6e73 3a20 416c 6c20 636f  :returns: All co
+0000d550: 6e74 656e 7473 2068 6176 6520 7072 6566  ntents have pref
+0000d560: 6978 206f 6620 7333 5f75 726c 2069 6e20  ix of s3_url in 
+0000d570: 6163 7365 6e64 696e 6720 616c 7068 6162  acsending alphab
+0000d580: 6574 6963 616c 206f 7264 6572 0a20 2020  etical order.   
+0000d590: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
+0000d5a0: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+0000d5b0: 722c 2053 334e 6f74 4144 6972 6563 746f  r, S3NotADirecto
+0000d5c0: 7279 4572 726f 720a 2020 2020 2020 2020  ryError.        
+0000d5d0: 2727 270a 2020 2020 2020 2020 656e 7472  '''.        entr
+0000d5e0: 6965 7320 3d20 6c69 7374 2873 656c 662e  ies = list(self.
+0000d5f0: 7363 616e 6469 7228 666f 6c6c 6f77 6c69  scandir(followli
+0000d600: 6e6b 733d 666f 6c6c 6f77 6c69 6e6b 7329  nks=followlinks)
+0000d610: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0000d620: 2073 6f72 7465 6428 5b65 6e74 7279 2e6e   sorted([entry.n
+0000d630: 616d 6520 666f 7220 656e 7472 7920 696e  ame for entry in
+0000d640: 2065 6e74 7269 6573 5d29 0a0a 2020 2020   entries])..    
+0000d650: 6465 6620 6974 6572 6469 7228 7365 6c66  def iterdir(self
+0000d660: 2c20 666f 6c6c 6f77 6c69 6e6b 733a 2062  , followlinks: b
+0000d670: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
+0000d680: 4974 6572 6174 6f72 5b27 5333 5061 7468  Iterator['S3Path
+0000d690: 275d 3a0a 2020 2020 2020 2020 2727 270a  ']:.        '''.
+0000d6a0: 2020 2020 2020 2020 4765 7420 616c 6c20          Get all 
+0000d6b0: 636f 6e74 656e 7473 206f 6620 6769 7665  contents of give
+0000d6c0: 6e20 7333 5f75 726c 2e20 5468 6520 7265  n s3_url. The re
+0000d6d0: 7375 6c74 2069 7320 696e 2061 6373 656e  sult is in acsen
+0000d6e0: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
+0000d6f0: 6c20 6f72 6465 722e 0a0a 2020 2020 2020  l order...      
+0000d700: 2020 3a72 6574 7572 6e73 3a20 416c 6c20    :returns: All 
+0000d710: 636f 6e74 656e 7473 2068 6176 6520 7072  contents have pr
+0000d720: 6566 6978 206f 6620 7333 5f75 726c 2069  efix of s3_url i
+0000d730: 6e20 6163 7365 6e64 696e 6720 616c 7068  n acsending alph
+0000d740: 6162 6574 6963 616c 206f 7264 6572 0a20  abetical order. 
+0000d750: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
+0000d760: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
+0000d770: 726f 722c 2053 334e 6f74 4144 6972 6563  ror, S3NotADirec
+0000d780: 746f 7279 4572 726f 720a 2020 2020 2020  toryError.      
+0000d790: 2020 2727 270a 2020 2020 2020 2020 666f    '''.        fo
+0000d7a0: 7220 7061 7468 2069 6e20 7365 6c66 2e6c  r path in self.l
+0000d7b0: 6973 7464 6972 2866 6f6c 6c6f 776c 696e  istdir(followlin
+0000d7c0: 6b73 3d66 6f6c 6c6f 776c 696e 6b73 293a  ks=followlinks):
+0000d7d0: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
+0000d7e0: 6c64 2073 656c 662e 6a6f 696e 7061 7468  ld self.joinpath
+0000d7f0: 2870 6174 6829 2020 2320 7479 7065 3a20  (path)  # type: 
+0000d800: 6967 6e6f 7265 0a0a 2020 2020 6465 6620  ignore..    def 
+0000d810: 6c6f 6164 2873 656c 662c 2066 6f6c 6c6f  load(self, follo
+0000d820: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
+0000d830: 616c 7365 2920 2d3e 2042 696e 6172 7949  alse) -> BinaryI
+0000d840: 4f3a 0a20 2020 2020 2020 2027 2727 5265  O:.        '''Re
+0000d850: 6164 2061 6c6c 2063 6f6e 7465 6e74 2069  ad all content i
+0000d860: 6e20 6269 6e61 7279 206f 6e20 7370 6563  n binary on spec
+0000d870: 6966 6965 6420 7061 7468 2061 6e64 2077  ified path and w
+0000d880: 7269 7465 2069 6e74 6f20 6d65 6d6f 7279  rite into memory
+0000d890: 0a0a 2020 2020 2020 2020 5573 6572 2073  ..        User s
+0000d8a0: 686f 756c 6420 636c 6f73 6520 7468 6520  hould close the 
+0000d8b0: 4269 6e61 7279 494f 206d 616e 7561 6c6c  BinaryIO manuall
+0000d8c0: 790a 0a20 2020 2020 2020 203a 7265 7475  y..        :retu
+0000d8d0: 726e 733a 2042 696e 6172 7949 4f0a 2020  rns: BinaryIO.  
+0000d8e0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0000d8f0: 2020 7333 5f75 726c 203d 2073 656c 662e    s3_url = self.
+0000d900: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+0000d910: 6f6c 0a20 2020 2020 2020 2069 6620 666f  ol.        if fo
+0000d920: 6c6c 6f77 6c69 6e6b 733a 0a20 2020 2020  llowlinks:.     
+0000d930: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000d940: 2020 2020 2020 2020 2020 2020 7333 5f75              s3_u
+0000d950: 726c 203d 2073 656c 662e 7265 6164 6c69  rl = self.readli
+0000d960: 6e6b 2829 2e70 6174 685f 7769 7468 5f70  nk().path_with_p
+0000d970: 726f 746f 636f 6c0a 2020 2020 2020 2020  rotocol.        
+0000d980: 2020 2020 6578 6365 7074 2053 334e 6f74      except S3Not
+0000d990: 414c 696e 6b45 7272 6f72 3a0a 2020 2020  ALinkError:.    
+0000d9a0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0000d9b0: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
+0000d9c0: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
+0000d9d0: 7572 6c28 7333 5f75 726c 290a 2020 2020  url(s3_url).    
+0000d9e0: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
+0000d9f0: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+0000da00: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
+0000da10: 466f 756e 6445 7272 6f72 2827 456d 7074  FoundError('Empt
+0000da20: 7920 6275 636b 6574 206e 616d 653a 2025  y bucket name: %
+0000da30: 7227 2025 2073 335f 7572 6c29 0a20 2020  r' % s3_url).   
+0000da40: 2020 2020 2069 6620 6e6f 7420 6b65 7920       if not key 
+0000da50: 6f72 206b 6579 2e65 6e64 7377 6974 6828  or key.endswith(
+0000da60: 272f 2729 3a0a 2020 2020 2020 2020 2020  '/'):.          
+0000da70: 2020 7261 6973 6520 5333 4973 4144 6972    raise S3IsADir
+0000da80: 6563 746f 7279 4572 726f 7228 2749 7320  ectoryError('Is 
+0000da90: 6120 6469 7265 6374 6f72 793a 2025 7227  a directory: %r'
+0000daa0: 2025 2073 335f 7572 6c29 0a0a 2020 2020   % s3_url)..    
+0000dab0: 2020 2020 6275 6666 6572 203d 2069 6f2e      buffer = io.
+0000dac0: 4279 7465 7349 4f28 290a 2020 2020 2020  BytesIO().      
+0000dad0: 2020 7769 7468 2072 6169 7365 5f73 335f    with raise_s3_
+0000dae0: 6572 726f 7228 7333 5f75 726c 293a 0a20  error(s3_url):. 
+0000daf0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000db00: 5f63 6c69 656e 742e 646f 776e 6c6f 6164  _client.download
+0000db10: 5f66 696c 656f 626a 2862 7563 6b65 742c  _fileobj(bucket,
+0000db20: 206b 6579 2c20 6275 6666 6572 290a 2020   key, buffer).  
+0000db30: 2020 2020 2020 6275 6666 6572 2e73 6565        buffer.see
+0000db40: 6b28 3029 0a20 2020 2020 2020 2072 6574  k(0).        ret
+0000db50: 7572 6e20 6275 6666 6572 0a0a 2020 2020  urn buffer..    
+0000db60: 6465 6620 6861 7362 7563 6b65 7428 7365  def hasbucket(se
+0000db70: 6c66 2920 2d3e 2062 6f6f 6c3a 0a20 2020  lf) -> bool:.   
+0000db80: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
+0000db90: 2054 6573 7420 6966 2074 6865 2062 7563   Test if the buc
+0000dba0: 6b65 7420 6f66 2073 335f 7572 6c20 6578  ket of s3_url ex
+0000dbb0: 6973 7473 0a0a 2020 2020 2020 2020 3a72  ists..        :r
+0000dbc0: 6574 7572 6e73 3a20 5472 7565 2069 6620  eturns: True if 
+0000dbd0: 6275 636b 6574 206f 6620 7333 5f75 726c  bucket of s3_url
+0000dbe0: 2065 6978 7374 732c 2065 6c73 6520 4661   eixsts, else Fa
+0000dbf0: 6c73 650a 2020 2020 2020 2020 2727 270a  lse.        '''.
+0000dc00: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
+0000dc10: 5f20 3d20 7061 7273 655f 7333 5f75 726c  _ = parse_s3_url
+0000dc20: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+0000dc30: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+0000dc40: 2020 6966 206e 6f74 2062 7563 6b65 743a    if not bucket:
+0000dc50: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000dc60: 7572 6e20 4661 6c73 650a 0a20 2020 2020  urn False..     
+0000dc70: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000dc80: 2020 2020 7365 6c66 2e5f 636c 6965 6e74      self._client
+0000dc90: 2e68 6561 645f 6275 636b 6574 2842 7563  .head_bucket(Buc
+0000dca0: 6b65 743d 6275 636b 6574 290a 2020 2020  ket=bucket).    
+0000dcb0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0000dcc0: 7469 6f6e 2061 7320 6572 726f 723a 0a20  tion as error:. 
+0000dcd0: 2020 2020 2020 2020 2020 2065 7272 6f72             error
+0000dce0: 203d 2074 7261 6e73 6c61 7465 5f73 335f   = translate_s3_
+0000dcf0: 6572 726f 7228 6572 726f 722c 2073 656c  error(error, sel
+0000dd00: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+0000dd10: 6f63 6f6c 290a 2020 2020 2020 2020 2020  ocol).          
+0000dd20: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000dd30: 6572 726f 722c 0a20 2020 2020 2020 2020  error,.         
+0000dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd50: 2028 5333 556e 6b6e 6f77 6e45 7272 6f72   (S3UnknownError
+0000dd60: 2c20 5333 436f 6e66 6967 4572 726f 722c  , S3ConfigError,
+0000dd70: 2053 3350 6572 6d69 7373 696f 6e45 7272   S3PermissionErr
+0000dd80: 6f72 2929 3a0a 2020 2020 2020 2020 2020  or)):.          
+0000dd90: 2020 2020 2020 7261 6973 6520 6572 726f        raise erro
+0000dda0: 720a 2020 2020 2020 2020 2020 2020 6966  r.            if
+0000ddb0: 2069 7369 6e73 7461 6e63 6528 6572 726f   isinstance(erro
+0000ddc0: 722c 2053 3346 696c 654e 6f74 466f 756e  r, S3FileNotFoun
+0000ddd0: 6445 7272 6f72 293a 0a20 2020 2020 2020  dError):.       
+0000dde0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000ddf0: 4661 6c73 650a 0a20 2020 2020 2020 2072  False..        r
+0000de00: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
+0000de10: 6465 6620 6d6b 6469 7228 7365 6c66 2c20  def mkdir(self, 
+0000de20: 6d6f 6465 3d30 6f37 3737 2c20 7061 7265  mode=0o777, pare
+0000de30: 6e74 733a 2062 6f6f 6c20 3d20 4661 6c73  nts: bool = Fals
+0000de40: 652c 2065 7869 7374 5f6f 6b3a 2062 6f6f  e, exist_ok: boo
+0000de50: 6c20 3d20 4661 6c73 6529 3a0a 2020 2020  l = False):.    
+0000de60: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+0000de70: 4372 6561 7465 2061 6e20 7333 2064 6972  Create an s3 dir
+0000de80: 6563 746f 7279 2e0a 2020 2020 2020 2020  ectory..        
+0000de90: 5075 7265 6c79 2063 7265 6174 696e 6720  Purely creating 
+0000dea0: 6469 7265 6374 6f72 7920 6973 2069 6e76  directory is inv
+0000deb0: 616c 6964 2062 6563 6175 7365 2069 7427  alid because it'
+0000dec0: 7320 756e 6176 6169 6c61 626c 6520 6f6e  s unavailable on
+0000ded0: 204f 5353 2e0a 2020 2020 2020 2020 5468   OSS..        Th
+0000dee0: 6973 2066 756e 6374 696f 6e20 6973 2074  is function is t
+0000def0: 6f20 7465 7374 2074 6865 2074 6172 6765  o test the targe
+0000df00: 7420 6275 636b 6574 2068 6176 6520 5752  t bucket have WR
+0000df10: 4954 4520 6163 6365 7373 2e0a 0a20 2020  ITE access...   
+0000df20: 2020 2020 203a 7061 7261 6d20 6d6f 6465       :param mode
+0000df30: 3a20 6d6f 6465 2069 7320 6967 6e6f 7265  : mode is ignore
+0000df40: 642c 206f 6e6c 7920 6265 2063 6f6d 7061  d, only be compa
+0000df50: 7469 626c 6520 7769 7468 2070 6174 686c  tible with pathl
+0000df60: 6962 2e50 6174 680a 2020 2020 2020 2020  ib.Path.        
+0000df70: 3a70 6172 616d 2070 6172 656e 7473 3a20  :param parents: 
+0000df80: 7061 7265 6e74 7320 6973 2069 676e 6f72  parents is ignor
+0000df90: 6564 2c20 6f6e 6c79 2062 6520 636f 6d70  ed, only be comp
+0000dfa0: 6174 6962 6c65 2077 6974 6820 7061 7468  atible with path
+0000dfb0: 6c69 622e 5061 7468 0a20 2020 2020 2020  lib.Path.       
+0000dfc0: 203a 7061 7261 6d20 6578 6973 745f 6f6b   :param exist_ok
+0000dfd0: 3a20 4966 2046 616c 7365 2061 6e64 2074  : If False and t
+0000dfe0: 6172 6765 7420 6469 7265 6374 6f72 7920  arget directory 
+0000dff0: 6578 6973 7473 2c20 7261 6973 6520 5333  exists, raise S3
+0000e000: 4669 6c65 4578 6973 7473 4572 726f 720a  FileExistsError.
+0000e010: 2020 2020 2020 2020 3a72 6169 7365 733a          :raises:
+0000e020: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
+0000e030: 6445 7272 6f72 2c20 5333 4669 6c65 4578  dError, S3FileEx
+0000e040: 6973 7473 4572 726f 720a 2020 2020 2020  istsError.      
+0000e050: 2020 2727 270a 2020 2020 2020 2020 6275    '''.        bu
+0000e060: 636b 6574 2c20 5f20 3d20 7061 7273 655f  cket, _ = parse_
+0000e070: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
+0000e080: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+0000e090: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
+0000e0a0: 7563 6b65 743a 0a20 2020 2020 2020 2020  ucket:.         
+0000e0b0: 2020 2072 6169 7365 2053 3342 7563 6b65     raise S3Bucke
+0000e0c0: 744e 6f74 466f 756e 6445 7272 6f72 280a  tNotFoundError(.
+0000e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0e0: 2745 6d70 7479 2062 7563 6b65 7420 6e61  'Empty bucket na
+0000e0f0: 6d65 3a20 2572 2720 2520 7365 6c66 2e70  me: %r' % self.p
+0000e100: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+0000e110: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+0000e120: 7420 7365 6c66 2e68 6173 6275 636b 6574  t self.hasbucket
+0000e130: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0000e140: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
+0000e150: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
+0000e160: 2020 2020 2020 2020 2020 2020 2027 4e6f               'No
+0000e170: 2073 7563 6820 6275 636b 6574 3a20 2572   such bucket: %r
+0000e180: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
+0000e190: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+0000e1a0: 2020 2020 2069 6620 6578 6973 745f 6f6b       if exist_ok
+0000e1b0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0000e1c0: 2073 656c 662e 6973 5f66 696c 6528 293a   self.is_file():
+0000e1d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e1e0: 2072 6169 7365 2053 3346 696c 6545 7869   raise S3FileExi
+0000e1f0: 7374 7345 7272 6f72 280a 2020 2020 2020  stsError(.      
+0000e200: 2020 2020 2020 2020 2020 2020 2020 2746                'F
+0000e210: 696c 6520 6578 6973 7473 3a20 2572 2720  ile exists: %r' 
+0000e220: 2520 7365 6c66 2e70 6174 685f 7769 7468  % self.path_with
+0000e230: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
+0000e240: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+0000e250: 2020 2020 2020 6966 2073 656c 662e 6578        if self.ex
+0000e260: 6973 7473 2829 3a0a 2020 2020 2020 2020  ists():.        
+0000e270: 2020 2020 7261 6973 6520 5333 4669 6c65      raise S3File
+0000e280: 4578 6973 7473 4572 726f 7228 2746 696c  ExistsError('Fil
+0000e290: 6520 6578 6973 7473 3a20 2572 2720 2520  e exists: %r' % 
+0000e2a0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+0000e2b0: 726f 746f 636f 6c29 0a0a 2020 2020 6465  rotocol)..    de
+0000e2c0: 6620 6d6f 7665 2873 656c 662c 2064 7374  f move(self, dst
+0000e2d0: 5f75 726c 3a20 5061 7468 4c69 6b65 2920  _url: PathLike) 
+0000e2e0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0000e2f0: 2027 2727 0a20 2020 2020 2020 204d 6f76   '''.        Mov
+0000e300: 6520 6669 6c65 2f64 6972 6563 746f 7279  e file/directory
+0000e310: 2070 6174 6820 6672 6f6d 2073 7263 5f75   path from src_u
+0000e320: 726c 2074 6f20 6473 745f 7572 6c0a 0a20  rl to dst_url.. 
+0000e330: 2020 2020 2020 203a 7061 7261 6d20 6473         :param ds
+0000e340: 745f 7572 6c3a 2047 6976 656e 2064 6573  t_url: Given des
+0000e350: 7469 6e61 7469 6f6e 2070 6174 680a 2020  tination path.  
+0000e360: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0000e370: 2020 666f 7220 7372 635f 6669 6c65 5f70    for src_file_p
+0000e380: 6174 682c 2064 7374 5f66 696c 655f 7061  ath, dst_file_pa
+0000e390: 7468 2069 6e20 5f73 335f 7363 616e 5f70  th in _s3_scan_p
+0000e3a0: 6169 7273 280a 2020 2020 2020 2020 2020  airs(.          
+0000e3b0: 2020 2020 2020 7365 6c66 2e70 6174 685f        self.path_
+0000e3c0: 7769 7468 5f70 726f 746f 636f 6c2c 2064  with_protocol, d
+0000e3d0: 7374 5f75 726c 293a 0a20 2020 2020 2020  st_url):.       
+0000e3e0: 2020 2020 2053 3350 6174 6828 7372 635f       S3Path(src_
+0000e3f0: 6669 6c65 5f70 6174 6829 2e72 656e 616d  file_path).renam
+0000e400: 6528 6473 745f 6669 6c65 5f70 6174 6829  e(dst_file_path)
+0000e410: 0a0a 2020 2020 6465 6620 7265 6d6f 7665  ..    def remove
+0000e420: 2873 656c 662c 206d 6973 7369 6e67 5f6f  (self, missing_o
+0000e430: 6b3a 2062 6f6f 6c20 3d20 4661 6c73 6529  k: bool = False)
+0000e440: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0000e450: 2020 2727 270a 2020 2020 2020 2020 5265    '''.        Re
+0000e460: 6d6f 7665 2074 6865 2066 696c 6520 6f72  move the file or
+0000e470: 2064 6972 6563 746f 7279 206f 6e20 7333   directory on s3
+0000e480: 2c20 6073 333a 2f2f 6020 616e 6420 6073  , `s3://` and `s
+0000e490: 333a 2f2f 6275 636b 6574 6020 6172 6520  3://bucket` are 
+0000e4a0: 6e6f 7420 7065 726d 6974 7465 6420 746f  not permitted to
+0000e4b0: 2072 656d 6f76 650a 0a20 2020 2020 2020   remove..       
+0000e4c0: 203a 7061 7261 6d20 6d69 7373 696e 675f   :param missing_
+0000e4d0: 6f6b 3a20 6966 2046 616c 7365 2061 6e64  ok: if False and
+0000e4e0: 2074 6172 6765 7420 6669 6c65 2f64 6972   target file/dir
+0000e4f0: 6563 746f 7279 206e 6f74 2065 7869 7374  ectory not exist
+0000e500: 732c 2072 6169 7365 2053 3346 696c 654e  s, raise S3FileN
+0000e510: 6f74 466f 756e 6445 7272 6f72 0a20 2020  otFoundError.   
+0000e520: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
+0000e530: 5065 726d 6973 7369 6f6e 4572 726f 722c  PermissionError,
+0000e540: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
+0000e550: 7272 6f72 2c20 556e 7375 7070 6f72 7465  rror, Unsupporte
+0000e560: 6445 7272 6f72 0a20 2020 2020 2020 2027  dError.        '
+0000e570: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
+0000e580: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+0000e590: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
+0000e5a0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+0000e5b0: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
+0000e5c0: 636b 6574 3a0a 2020 2020 2020 2020 2020  cket:.          
+0000e5d0: 2020 6966 206e 6f74 206b 6579 3a0a 2020    if not key:.  
+0000e5e0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000e5f0: 6973 6520 556e 7375 7070 6f72 7465 6445  ise UnsupportedE
+0000e600: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000e610: 2020 2020 2020 2020 2020 2752 656d 6f76            'Remov
+0000e620: 6520 7768 6f6c 6520 7333 272c 2073 656c  e whole s3', sel
+0000e630: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+0000e640: 6f63 6f6c 290a 2020 2020 2020 2020 2020  ocol).          
+0000e650: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
+0000e660: 4e6f 7446 6f75 6e64 4572 726f 7228 0a20  NotFoundError(. 
+0000e670: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000e680: 456d 7074 7920 6275 636b 6574 206e 616d  Empty bucket nam
+0000e690: 653a 2025 7227 2025 2073 656c 662e 7061  e: %r' % self.pa
+0000e6a0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000e6b0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+0000e6c0: 206b 6579 3a0a 2020 2020 2020 2020 2020   key:.          
+0000e6d0: 2020 7261 6973 6520 556e 7375 7070 6f72    raise Unsuppor
+0000e6e0: 7465 6445 7272 6f72 2827 5265 6d6f 7665  tedError('Remove
+0000e6f0: 2062 7563 6b65 7427 2c20 7365 6c66 2e70   bucket', self.p
+0000e700: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+0000e710: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+0000e720: 7420 7365 6c66 2e65 7869 7374 7328 293a  t self.exists():
+0000e730: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000e740: 6d69 7373 696e 675f 6f6b 3a0a 2020 2020  missing_ok:.    
+0000e750: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000e760: 726e 0a20 2020 2020 2020 2020 2020 2072  rn.            r
+0000e770: 6169 7365 2053 3346 696c 654e 6f74 466f  aise S3FileNotFo
+0000e780: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
+0000e790: 2020 2020 2020 2020 2020 274e 6f20 7375            'No su
+0000e7a0: 6368 2066 696c 6520 6f72 2064 6972 6563  ch file or direc
+0000e7b0: 746f 7279 3a20 2572 2720 2520 7365 6c66  tory: %r' % self
+0000e7c0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+0000e7d0: 636f 6c29 0a0a 2020 2020 2020 2020 636c  col)..        cl
+0000e7e0: 6965 6e74 203d 2073 656c 662e 5f63 6c69  ient = self._cli
+0000e7f0: 656e 740a 2020 2020 2020 2020 7769 7468  ent.        with
+0000e800: 2072 6169 7365 5f73 335f 6572 726f 7228   raise_s3_error(
+0000e810: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+0000e820: 726f 746f 636f 6c29 3a0a 2020 2020 2020  rotocol):.      
+0000e830: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
+0000e840: 5f66 696c 6528 293a 0a20 2020 2020 2020  _file():.       
+0000e850: 2020 2020 2020 2020 2063 6c69 656e 742e           client.
+0000e860: 6465 6c65 7465 5f6f 626a 6563 7428 4275  delete_object(Bu
+0000e870: 636b 6574 3d62 7563 6b65 742c 204b 6579  cket=bucket, Key
+0000e880: 3d6b 6579 290a 2020 2020 2020 2020 2020  =key).          
+0000e890: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0000e8a0: 2020 2020 2020 2020 2070 7265 6669 7820           prefix 
+0000e8b0: 3d20 5f62 6563 6f6d 655f 7072 6566 6978  = _become_prefix
+0000e8c0: 286b 6579 290a 2020 2020 2020 2020 2020  (key).          
+0000e8d0: 2020 746f 7461 6c5f 636f 756e 742c 2065    total_count, e
+0000e8e0: 7272 6f72 5f63 6f75 6e74 203d 2030 2c20  rror_count = 0, 
+0000e8f0: 300a 2020 2020 2020 2020 2020 2020 666f  0.            fo
+0000e900: 7220 7265 7370 2069 6e20 5f6c 6973 745f  r resp in _list_
+0000e910: 6f62 6a65 6374 735f 7265 6375 7273 6976  objects_recursiv
+0000e920: 6528 636c 6965 6e74 2c20 6275 636b 6574  e(client, bucket
+0000e930: 2c20 7072 6566 6978 293a 0a20 2020 2020  , prefix):.     
+0000e940: 2020 2020 2020 2020 2020 2069 6620 2743             if 'C
+0000e950: 6f6e 7465 6e74 7327 2069 6e20 7265 7370  ontents' in resp
+0000e960: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e970: 2020 2020 2020 6b65 7973 203d 205b 0a20        keys = [. 
+0000e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e990: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0000e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9b0: 2020 2020 2027 4b65 7927 3a20 636f 6e74       'Key': cont
+0000e9c0: 656e 745b 274b 6579 275d 0a20 2020 2020  ent['Key'].     
+0000e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9e0: 2020 207d 2066 6f72 2063 6f6e 7465 6e74     } for content
+0000e9f0: 2069 6e20 7265 7370 5b27 436f 6e74 656e   in resp['Conten
+0000ea00: 7473 275d 0a20 2020 2020 2020 2020 2020  ts'].           
+0000ea10: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
+0000ea20: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000ea30: 6f74 616c 5f63 6f75 6e74 202b 3d20 6c65  otal_count += le
+0000ea40: 6e28 6b65 7973 290a 2020 2020 2020 2020  n(keys).        
+0000ea50: 2020 2020 2020 2020 2020 2020 6572 726f              erro
+0000ea60: 7273 203d 205b 5d0a 2020 2020 2020 2020  rs = [].        
+0000ea70: 2020 2020 2020 2020 2020 2020 7265 7472              retr
+0000ea80: 6965 7320 3d20 320a 2020 2020 2020 2020  ies = 2.        
+0000ea90: 2020 2020 2020 2020 2020 2020 7265 7472              retr
+0000eaa0: 795f 696e 7465 7276 616c 203d 206d 696e  y_interval = min
+0000eab0: 2830 2e31 202a 2032 2a2a 7265 7472 6965  (0.1 * 2**retrie
+0000eac0: 732c 2033 3029 0a20 2020 2020 2020 2020  s, 30).         
+0000ead0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0000eae0: 2069 6e20 7261 6e67 6528 7265 7472 6965   in range(retrie
+0000eaf0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0000eb00: 2020 2020 2020 2020 2020 2020 2320 646f              # do
+0000eb10: 633a 2068 7474 7073 3a2f 2f62 6f74 6f33  c: https://boto3
+0000eb20: 2e61 6d61 7a6f 6e61 7773 2e63 6f6d 2f76  .amazonaws.com/v
+0000eb30: 312f 646f 6375 6d65 6e74 6174 696f 6e2f  1/documentation/
+0000eb40: 6170 692f 6c61 7465 7374 2f72 6566 6572  api/latest/refer
+0000eb50: 656e 6365 2f73 6572 7669 6365 732f 7333  ence/services/s3
+0000eb60: 2e68 746d 6c23 5333 2e43 6c69 656e 742e  .html#S3.Client.
+0000eb70: 6465 6c65 7465 5f6f 626a 6563 7473 0a20  delete_objects. 
+0000eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb90: 2020 2020 2020 2069 6620 6e6f 7420 6b65         if not ke
+0000eba0: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+0000ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebc0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
+0000ebd0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000ebe0: 7370 6f6e 7365 203d 2063 6c69 656e 742e  sponse = client.
+0000ebf0: 6465 6c65 7465 5f6f 626a 6563 7473 280a  delete_objects(.
 0000ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec10: 2020 2020 2020 2020 2020 2069 6620 7333             if s3
-0000ec20: 5f65 7272 6f72 5f63 6f64 655f 7368 6f75  _error_code_shou
-0000ec30: 6c64 5f72 6574 7279 280a 2020 2020 2020  ld_retry(.      
-0000ec40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec50: 2020 2020 2020 2020 2020 2020 2020 6572                er
-0000ec60: 726f 725f 696e 666f 2e67 6574 2827 436f  ror_info.get('Co
-0000ec70: 6465 2729 293a 0a20 2020 2020 2020 2020  de')):.         
-0000ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec90: 2020 2020 2020 2065 7272 6f72 5f6c 6f67         error_log
-0000eca0: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+0000ec10: 2020 2020 2020 2020 2020 2020 4275 636b              Buck
+0000ec20: 6574 3d62 7563 6b65 742c 2044 656c 6574  et=bucket, Delet
+0000ec30: 653d 7b27 4f62 6a65 6374 7327 3a20 6b65  e={'Objects': ke
+0000ec40: 7973 7d29 0a20 2020 2020 2020 2020 2020  ys}).           
+0000ec50: 2020 2020 2020 2020 2020 2020 206b 6579               key
+0000ec60: 7320 3d20 5b5d 0a20 2020 2020 2020 2020  s = [].         
+0000ec70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000ec80: 6f72 2065 7272 6f72 5f69 6e66 6f20 696e  or error_info in
+0000ec90: 2072 6573 706f 6e73 652e 6765 7428 2745   response.get('E
+0000eca0: 7272 6f72 7327 2c20 5b5d 293a 0a20 2020  rrors', []):.   
 0000ecb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ecd0: 2022 7265 7472 7920 2573 2074 696d 6573   "retry %s times
-0000ece0: 2c20 7265 6d6f 7669 6e67 2066 696c 653a  , removing file:
-0000ecf0: 2025 732c 2077 6974 6820 6572 726f 7220   %s, with error 
-0000ed00: 2573 3a20 2573 220a 2020 2020 2020 2020  %s: %s".        
-0000ed10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed20: 2020 2020 2020 2020 2020 2020 2520 280a              % (.
+0000ecc0: 2020 2020 2020 2020 2069 6620 7333 5f65           if s3_e
+0000ecd0: 7272 6f72 5f63 6f64 655f 7368 6f75 6c64  rror_code_should
+0000ece0: 5f72 6574 7279 280a 2020 2020 2020 2020  _retry(.        
+0000ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed00: 2020 2020 2020 2020 2020 2020 6572 726f              erro
+0000ed10: 725f 696e 666f 2e67 6574 2827 436f 6465  r_info.get('Code
+0000ed20: 2729 293a 0a20 2020 2020 2020 2020 2020  ')):.           
 0000ed30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed50: 2020 2020 2020 2020 6920 2b20 312c 2065          i + 1, e
-0000ed60: 7272 6f72 5f69 6e66 6f5b 274b 6579 275d  rror_info['Key']
-0000ed70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed90: 2020 2020 2020 2020 2020 6572 726f 725f            error_
-0000eda0: 696e 666f 5b27 436f 6465 275d 2c0a 2020  info['Code'],.  
-0000edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed40: 2020 2020 2065 7272 6f72 5f6c 6f67 6765       error_logge
+0000ed50: 722e 7761 726e 696e 6728 0a20 2020 2020  r.warning(.     
+0000ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000ed80: 7265 7472 7920 2573 2074 696d 6573 2c20  retry %s times, 
+0000ed90: 7265 6d6f 7669 6e67 2066 696c 653a 2025  removing file: %
+0000eda0: 732c 2077 6974 6820 6572 726f 7220 2573  s, with error %s
+0000edb0: 3a20 2573 220a 2020 2020 2020 2020 2020  : %s".          
 0000edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000edd0: 2020 2020 2020 6572 726f 725f 696e 666f        error_info
-0000ede0: 5b27 4d65 7373 6167 6527 5d29 290a 2020  ['Message'])).  
+0000edd0: 2020 2020 2020 2020 2020 2520 280a 2020            % (.  
+0000ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000edf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee00: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-0000ee10: 7973 2e61 7070 656e 6428 7b27 4b65 7927  ys.append({'Key'
-0000ee20: 3a20 6572 726f 725f 696e 666f 5b27 4b65  : error_info['Ke
-0000ee30: 7927 5d7d 290a 2020 2020 2020 2020 2020  y']}).          
-0000ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000ee00: 2020 2020 2020 6920 2b20 312c 2065 7272        i + 1, err
+0000ee10: 6f72 5f69 6e66 6f5b 274b 6579 275d 2c0a  or_info['Key'],.
+0000ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee40: 2020 2020 2020 2020 6572 726f 725f 696e          error_in
+0000ee50: 666f 5b27 436f 6465 275d 2c0a 2020 2020  fo['Code'],.    
 0000ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee70: 2020 2020 2020 2020 6572 726f 7273 2e61          errors.a
-0000ee80: 7070 656e 6428 6572 726f 725f 696e 666f  ppend(error_info
-0000ee90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000eea0: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
-0000eeb0: 6c65 6570 2872 6574 7279 5f69 6e74 6572  leep(retry_inter
-0000eec0: 7661 6c29 0a20 2020 2020 2020 2020 2020  val).           
-0000eed0: 2020 2020 2020 2020 2066 6f72 2065 7272           for err
-0000eee0: 6f72 5f69 6e66 6f20 696e 2065 7272 6f72  or_info in error
-0000eef0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000ef00: 2020 2020 2020 2020 2020 2065 7272 6f72             error
-0000ef10: 5f6c 6f67 6765 722e 6572 726f 7228 0a20  _logger.error(. 
-0000ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef30: 2020 2020 2020 2020 2020 2022 6661 696c             "fail
-0000ef40: 6564 2072 656d 6f76 6520 6669 6c65 3a20  ed remove file: 
-0000ef50: 2573 2c20 7769 7468 2065 7272 6f72 2025  %s, with error %
-0000ef60: 733a 2025 7322 2025 2028 0a20 2020 2020  s: %s" % (.     
-0000ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef80: 2020 2020 2020 2020 2020 2065 7272 6f72             error
-0000ef90: 5f69 6e66 6f5b 274b 6579 275d 2c20 6572  _info['Key'], er
-0000efa0: 726f 725f 696e 666f 5b27 436f 6465 275d  ror_info['Code']
-0000efb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efd0: 2020 6572 726f 725f 696e 666f 5b27 4d65    error_info['Me
-0000efe0: 7373 6167 6527 5d29 290a 2020 2020 2020  ssage'])).      
-0000eff0: 2020 2020 2020 2020 2020 2020 2020 6572                er
-0000f000: 726f 725f 636f 756e 7420 2b3d 206c 656e  ror_count += len
-0000f010: 2865 7272 6f72 7329 0a20 2020 2020 2020  (errors).       
-0000f020: 2020 2020 2069 6620 6572 726f 725f 636f       if error_co
-0000f030: 756e 7420 3e20 303a 0a20 2020 2020 2020  unt > 0:.       
-0000f040: 2020 2020 2020 2020 2065 7272 6f72 5f6d           error_m
-0000f050: 7367 203d 2022 6661 696c 6564 2072 656d  sg = "failed rem
-0000f060: 6f76 6520 7061 7468 3a20 2573 2c20 746f  ove path: %s, to
-0000f070: 7461 6c20 6669 6c65 2063 6f75 6e74 3a20  tal file count: 
-0000f080: 2573 2c20 6661 696c 6564 2063 6f75 6e74  %s, failed count
-0000f090: 3a20 2573 2220 2520 280a 2020 2020 2020  : %s" % (.      
-0000f0a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000f0b0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000f0c0: 746f 636f 6c2c 2074 6f74 616c 5f63 6f75  tocol, total_cou
-0000f0d0: 6e74 2c20 6572 726f 725f 636f 756e 7429  nt, error_count)
-0000f0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f0f0: 2072 6169 7365 2053 3355 6e6b 6e6f 776e   raise S3Unknown
-0000f100: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0000f110: 2020 2020 2020 2020 2020 2045 7863 6570             Excep
-0000f120: 7469 6f6e 2865 7272 6f72 5f6d 7367 292c  tion(error_msg),
-0000f130: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-0000f140: 7072 6f74 6f63 6f6c 290a 0a20 2020 2064  protocol)..    d
-0000f150: 6566 2072 656e 616d 6528 7365 6c66 2c20  ef rename(self, 
-0000f160: 6473 745f 7061 7468 3a20 5061 7468 4c69  dst_path: PathLi
-0000f170: 6b65 2920 2d3e 2027 5333 5061 7468 273a  ke) -> 'S3Path':
-0000f180: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000f190: 2020 2020 204d 6f76 6520 7333 2066 696c       Move s3 fil
-0000f1a0: 6520 7061 7468 2066 726f 6d20 7372 635f  e path from src_
-0000f1b0: 7572 6c20 746f 2064 7374 5f75 726c 0a0a  url to dst_url..
-0000f1c0: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
-0000f1d0: 7374 5f70 6174 683a 2047 6976 656e 2064  st_path: Given d
-0000f1e0: 6573 7469 6e61 7469 6f6e 2070 6174 680a  estination path.
-0000f1f0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000f200: 2020 2020 7333 5f72 656e 616d 6528 7365      s3_rename(se
-0000f210: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000f220: 746f 636f 6c2c 2064 7374 5f70 6174 6829  tocol, dst_path)
-0000f230: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000f240: 7365 6c66 2e66 726f 6d5f 7061 7468 2864  self.from_path(d
-0000f250: 7374 5f70 6174 6829 0a0a 2020 2020 6465  st_path)..    de
-0000f260: 6620 7363 616e 2873 656c 662c 206d 6973  f scan(self, mis
-0000f270: 7369 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20  sing_ok: bool = 
-0000f280: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-0000f290: 2020 2066 6f6c 6c6f 776c 696e 6b73 3a20     followlinks: 
-0000f2a0: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
-0000f2b0: 2049 7465 7261 746f 725b 7374 725d 3a0a   Iterator[str]:.
-0000f2c0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000f2d0: 2020 2020 4974 6572 6174 6976 656c 7920      Iteratively 
-0000f2e0: 7472 6176 6572 7365 206f 6e6c 7920 6669  traverse only fi
-0000f2f0: 6c65 7320 696e 2067 6976 656e 2073 3320  les in given s3 
-0000f300: 6469 7265 6374 6f72 792c 2069 6e20 616c  directory, in al
-0000f310: 7068 6162 6574 6963 616c 206f 7264 6572  phabetical order
-0000f320: 2e0a 2020 2020 2020 2020 4576 6572 7920  ..        Every 
-0000f330: 6974 6572 6174 696f 6e20 6f6e 2067 656e  iteration on gen
-0000f340: 6572 6174 6f72 2079 6965 6c64 7320 6120  erator yields a 
-0000f350: 7061 7468 2073 7472 696e 672e 0a0a 2020  path string...  
-0000f360: 2020 2020 2020 4966 2073 335f 7572 6c20        If s3_url 
-0000f370: 6973 2061 2066 696c 6520 7061 7468 2c20  is a file path, 
-0000f380: 7969 656c 6473 2074 6865 2066 696c 6520  yields the file 
-0000f390: 6f6e 6c79 0a20 2020 2020 2020 2049 6620  only.        If 
-0000f3a0: 7333 5f75 726c 2069 7320 6120 6e6f 6e2d  s3_url is a non-
-0000f3b0: 6578 6973 7465 6e74 2070 6174 682c 2072  existent path, r
-0000f3c0: 6574 7572 6e20 616e 2065 6d70 7479 2067  eturn an empty g
-0000f3d0: 656e 6572 6174 6f72 0a20 2020 2020 2020  enerator.       
-0000f3e0: 2049 6620 7333 5f75 726c 2069 7320 6120   If s3_url is a 
-0000f3f0: 6275 636b 6574 2070 6174 682c 2072 6574  bucket path, ret
-0000f400: 7572 6e20 616c 6c20 6669 6c65 2070 6174  urn all file pat
-0000f410: 6873 2069 6e20 7468 6520 6275 636b 6574  hs in the bucket
-0000f420: 0a20 2020 2020 2020 2049 6620 7333 5f75  .        If s3_u
-0000f430: 726c 2069 7320 616e 2065 6d70 7479 2062  rl is an empty b
-0000f440: 7563 6b65 742c 2072 6574 7572 6e20 616e  ucket, return an
-0000f450: 2065 6d70 7479 2067 656e 6572 6174 6f72   empty generator
-0000f460: 0a20 2020 2020 2020 2049 6620 7333 5f75  .        If s3_u
-0000f470: 726c 2064 6f65 736e 2774 2063 6f6e 7461  rl doesn't conta
-0000f480: 696e 2061 6e79 2062 7563 6b65 742c 2077  in any bucket, w
-0000f490: 6869 6368 2069 7320 7333 5f75 726c 203d  hich is s3_url =
-0000f4a0: 3d20 2773 333a 2f2f 272c 2072 6169 7365  = 's3://', raise
-0000f4b0: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
-0000f4c0: 722e 2077 616c 6b28 2920 6f6e 2063 6f6d  r. walk() on com
-0000f4d0: 706c 6574 6520 7333 2069 7320 6e6f 7420  plete s3 is not 
-0000f4e0: 7375 7070 6f72 7465 6420 696e 206d 6567  supported in meg
-0000f4f0: 6669 6c65 0a0a 2020 2020 2020 2020 3a70  file..        :p
-0000f500: 6172 616d 206d 6973 7369 6e67 5f6f 6b3a  aram missing_ok:
-0000f510: 2049 6620 4661 6c73 6520 616e 6420 7468   If False and th
-0000f520: 6572 6527 7320 6e6f 2066 696c 6520 696e  ere's no file in
-0000f530: 2074 6865 2064 6972 6563 746f 7279 2c20   the directory, 
-0000f540: 7261 6973 6520 4669 6c65 4e6f 7446 6f75  raise FileNotFou
-0000f550: 6e64 4572 726f 720a 2020 2020 2020 2020  ndError.        
-0000f560: 3a72 6169 7365 733a 2055 6e73 7570 706f  :raises: Unsuppo
-0000f570: 7274 6564 4572 726f 720a 2020 2020 2020  rtedError.      
-0000f580: 2020 3a72 6574 7572 6e73 3a20 4120 6669    :returns: A fi
-0000f590: 6c65 2070 6174 6820 6765 6e65 7261 746f  le path generato
-0000f5a0: 720a 2020 2020 2020 2020 2727 270a 2020  r.        '''.  
-0000f5b0: 2020 2020 2020 7363 616e 5f73 7461 745f        scan_stat_
-0000f5c0: 6974 6572 203d 2073 656c 662e 7363 616e  iter = self.scan
-0000f5d0: 5f73 7461 7428 0a20 2020 2020 2020 2020  _stat(.         
-0000f5e0: 2020 206d 6973 7369 6e67 5f6f 6b3d 6d69     missing_ok=mi
-0000f5f0: 7373 696e 675f 6f6b 2c20 666f 6c6c 6f77  ssing_ok, follow
-0000f600: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
-0000f610: 7329 0a0a 2020 2020 2020 2020 6465 6620  s)..        def 
-0000f620: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
-0000f630: 2829 202d 3e20 4974 6572 6174 6f72 5b73  () -> Iterator[s
-0000f640: 7472 5d3a 0a20 2020 2020 2020 2020 2020  tr]:.           
-0000f650: 2066 6f72 2066 696c 655f 656e 7472 7920   for file_entry 
-0000f660: 696e 2073 6361 6e5f 7374 6174 5f69 7465  in scan_stat_ite
-0000f670: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000f680: 2020 2079 6965 6c64 2066 696c 655f 656e     yield file_en
-0000f690: 7472 792e 7061 7468 0a0a 2020 2020 2020  try.path..      
-0000f6a0: 2020 7265 7475 726e 2063 7265 6174 655f    return create_
-0000f6b0: 6765 6e65 7261 746f 7228 290a 0a20 2020  generator()..   
-0000f6c0: 2064 6566 2073 6361 6e5f 7374 6174 2873   def scan_stat(s
-0000f6d0: 656c 662c 206d 6973 7369 6e67 5f6f 6b3a  elf, missing_ok:
-0000f6e0: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
-0000f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f700: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-0000f710: 6c20 3d20 4661 6c73 6529 202d 3e20 4974  l = False) -> It
-0000f720: 6572 6174 6f72 5b46 696c 6545 6e74 7279  erator[FileEntry
-0000f730: 5d3a 0a20 2020 2020 2020 2027 2727 0a20  ]:.        '''. 
-0000f740: 2020 2020 2020 2049 7465 7261 7469 7665         Iterative
-0000f750: 6c79 2074 7261 7665 7273 6520 6f6e 6c79  ly traverse only
-0000f760: 2066 696c 6573 2069 6e20 6769 7665 6e20   files in given 
-0000f770: 6469 7265 6374 6f72 792c 2069 6e20 616c  directory, in al
-0000f780: 7068 6162 6574 6963 616c 206f 7264 6572  phabetical order
-0000f790: 2e0a 2020 2020 2020 2020 4576 6572 7920  ..        Every 
-0000f7a0: 6974 6572 6174 696f 6e20 6f6e 2067 656e  iteration on gen
-0000f7b0: 6572 6174 6f72 2079 6965 6c64 7320 6120  erator yields a 
-0000f7c0: 7475 706c 6520 6f66 2070 6174 6820 7374  tuple of path st
-0000f7d0: 7269 6e67 2061 6e64 2066 696c 6520 7374  ring and file st
-0000f7e0: 6174 0a0a 2020 2020 2020 2020 3a70 6172  at..        :par
-0000f7f0: 616d 206d 6973 7369 6e67 5f6f 6b3a 2049  am missing_ok: I
-0000f800: 6620 4661 6c73 6520 616e 6420 7468 6572  f False and ther
-0000f810: 6527 7320 6e6f 2066 696c 6520 696e 2074  e's no file in t
-0000f820: 6865 2064 6972 6563 746f 7279 2c20 7261  he directory, ra
-0000f830: 6973 6520 4669 6c65 4e6f 7446 6f75 6e64  ise FileNotFound
-0000f840: 4572 726f 720a 2020 2020 2020 2020 3a72  Error.        :r
-0000f850: 6169 7365 733a 2055 6e73 7570 706f 7274  aises: Unsupport
-0000f860: 6564 4572 726f 720a 2020 2020 2020 2020  edError.        
-0000f870: 3a72 6574 7572 6e73 3a20 4120 6669 6c65  :returns: A file
-0000f880: 2070 6174 6820 6765 6e65 7261 746f 720a   path generator.
-0000f890: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000f8a0: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-0000f8b0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-0000f8c0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-0000f8d0: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
-0000f8e0: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
-0000f8f0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000f900: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
-0000f910: 7228 2753 6361 6e20 7768 6f6c 6520 7333  r('Scan whole s3
-0000f920: 272c 2073 656c 662e 7061 7468 5f77 6974  ', self.path_wit
-0000f930: 685f 7072 6f74 6f63 6f6c 290a 0a20 2020  h_protocol)..   
-0000f940: 2020 2020 2064 6566 2063 7265 6174 655f       def create_
-0000f950: 6765 6e65 7261 746f 7228 2920 2d3e 2049  generator() -> I
-0000f960: 7465 7261 746f 725b 4669 6c65 456e 7472  terator[FileEntr
-0000f970: 795d 3a0a 2020 2020 2020 2020 2020 2020  y]:.            
-0000f980: 6966 206e 6f74 2073 656c 662e 6973 5f64  if not self.is_d
-0000f990: 6972 2829 3a0a 2020 2020 2020 2020 2020  ir():.          
-0000f9a0: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
-0000f9b0: 5f66 696c 6528 293a 0a20 2020 2020 2020  _file():.       
-0000f9c0: 2020 2020 2020 2020 2020 2020 2023 204f               # O
-0000f9d0: 6e20 7333 2c20 6669 6c65 2061 6e64 2064  n s3, file and d
-0000f9e0: 6972 6563 746f 7279 206d 6179 2062 6520  irectory may be 
-0000f9f0: 6f66 2073 616d 6520 6e61 6d65 2061 6e64  of same name and
-0000fa00: 206c 6576 656c 2c20 736f 206e 6565 6420   level, so need 
-0000fa10: 746f 2074 6573 7420 7468 6520 7061 7468  to test the path
-0000fa20: 2069 7320 6669 6c65 206f 7220 6469 7265   is file or dire
-0000fa30: 6374 6f72 790a 2020 2020 2020 2020 2020  ctory.          
-0000fa40: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-0000fa50: 4669 6c65 456e 7472 7928 0a20 2020 2020  FileEntry(.     
-0000fa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa70: 2020 2073 656c 662e 6e61 6d65 2c20 6673     self.name, fs
-0000fa80: 7061 7468 2873 656c 662e 7061 7468 5f77  path(self.path_w
-0000fa90: 6974 685f 7072 6f74 6f63 6f6c 292c 0a20  ith_protocol),. 
-0000faa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fab0: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
-0000fac0: 2866 6f6c 6c6f 775f 7379 6d6c 696e 6b73  (follow_symlinks
-0000fad0: 3d66 6f6c 6c6f 776c 696e 6b73 2929 0a20  =followlinks)). 
-0000fae0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000faf0: 6574 7572 6e0a 0a20 2020 2020 2020 2020  eturn..         
-0000fb00: 2020 2069 6620 6e6f 7420 6b65 792e 656e     if not key.en
-0000fb10: 6473 7769 7468 2827 2f27 2920 616e 6420  dswith('/') and 
-0000fb20: 7365 6c66 2e69 735f 6669 6c65 2829 3a0a  self.is_file():.
-0000fb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb40: 7969 656c 6420 4669 6c65 456e 7472 7928  yield FileEntry(
-0000fb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fb60: 2020 2020 2073 656c 662e 6e61 6d65 2c20       self.name, 
-0000fb70: 6673 7061 7468 2873 656c 662e 7061 7468  fspath(self.path
-0000fb80: 5f77 6974 685f 7072 6f74 6f63 6f6c 292c  _with_protocol),
-0000fb90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fba0: 2020 2020 2073 656c 662e 7374 6174 2866       self.stat(f
-0000fbb0: 6f6c 6c6f 775f 7379 6d6c 696e 6b73 3d66  ollow_symlinks=f
-0000fbc0: 6f6c 6c6f 776c 696e 6b73 2929 0a0a 2020  ollowlinks))..  
-0000fbd0: 2020 2020 2020 2020 2020 7072 6566 6978            prefix
-0000fbe0: 203d 205f 6265 636f 6d65 5f70 7265 6669   = _become_prefi
-0000fbf0: 7828 6b65 7929 0a20 2020 2020 2020 2020  x(key).         
-0000fc00: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
-0000fc10: 2e5f 636c 6965 6e74 0a20 2020 2020 2020  ._client.       
-0000fc20: 2020 2020 2077 6974 6820 7261 6973 655f       with raise_
-0000fc30: 7333 5f65 7272 6f72 2873 656c 662e 7061  s3_error(self.pa
-0000fc40: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-0000fc50: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000fc60: 2020 2066 6f72 2072 6573 7020 696e 205f     for resp in _
-0000fc70: 6c69 7374 5f6f 626a 6563 7473 5f72 6563  list_objects_rec
-0000fc80: 7572 7369 7665 2863 6c69 656e 742c 2062  ursive(client, b
-0000fc90: 7563 6b65 742c 2070 7265 6669 7829 3a0a  ucket, prefix):.
-0000fca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fcb0: 2020 2020 666f 7220 636f 6e74 656e 7420      for content 
-0000fcc0: 696e 2072 6573 702e 6765 7428 2743 6f6e  in resp.get('Con
-0000fcd0: 7465 6e74 7327 2c20 5b5d 293a 0a20 2020  tents', []):.   
-0000fce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fcf0: 2020 2020 2066 756c 6c5f 7061 7468 203d       full_path =
-0000fd00: 2073 335f 7061 7468 5f6a 6f69 6e28 0a20   s3_path_join(. 
-0000fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd20: 2020 2020 2020 2020 2020 2066 277b 7365             f'{se
-0000fd30: 6c66 2e5f 7072 6f74 6f63 6f6c 5f77 6974  lf._protocol_wit
-0000fd40: 685f 7072 6f66 696c 657d 3a2f 2f27 2c20  h_profile}://', 
-0000fd50: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
-0000fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd70: 2020 2020 636f 6e74 656e 745b 274b 6579      content['Key
-0000fd80: 275d 290a 2020 2020 2020 2020 2020 2020  ']).            
-0000fd90: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-0000fda0: 6420 4669 6c65 456e 7472 7928 0a20 2020  d FileEntry(.   
-0000fdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fdc0: 2020 2020 2020 2020 2053 3350 6174 6828           S3Path(
-0000fdd0: 6675 6c6c 5f70 6174 6829 2e6e 616d 652c  full_path).name,
-0000fde0: 2066 756c 6c5f 7061 7468 2c0a 2020 2020   full_path,.    
-0000fdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe00: 2020 2020 2020 2020 5f6d 616b 655f 7374          _make_st
-0000fe10: 6174 2863 6f6e 7465 6e74 2929 0a0a 2020  at(content))..  
-0000fe20: 2020 2020 2020 7265 7475 726e 205f 6372        return _cr
-0000fe30: 6561 7465 5f6d 6973 7369 6e67 5f6f 6b5f  eate_missing_ok_
-0000fe40: 6765 6e65 7261 746f 7228 0a20 2020 2020  generator(.     
-0000fe50: 2020 2020 2020 2063 7265 6174 655f 6765         create_ge
-0000fe60: 6e65 7261 746f 7228 292c 206d 6973 7369  nerator(), missi
-0000fe70: 6e67 5f6f 6b2c 0a20 2020 2020 2020 2020  ng_ok,.         
-0000fe80: 2020 2053 3346 696c 654e 6f74 466f 756e     S3FileNotFoun
-0000fe90: 6445 7272 6f72 2827 4e6f 206d 6174 6368  dError('No match
-0000fea0: 2066 696c 653a 2025 7227 2025 2073 656c   file: %r' % sel
-0000feb0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000fec0: 6f63 6f6c 2929 0a0a 2020 2020 6465 6620  ocol))..    def 
-0000fed0: 7363 616e 6469 7228 7365 6c66 2c20 666f  scandir(self, fo
-0000fee0: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
-0000fef0: 3d20 4661 6c73 6529 202d 3e20 4974 6572  = False) -> Iter
-0000ff00: 6174 6f72 5b46 696c 6545 6e74 7279 5d3a  ator[FileEntry]:
-0000ff10: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000ff20: 2020 2020 2047 6574 2061 6c6c 2063 6f6e       Get all con
-0000ff30: 7465 6e74 7320 6f66 2067 6976 656e 2073  tents of given s
-0000ff40: 335f 7572 6c2c 2074 6865 206f 7264 6572  3_url, the order
-0000ff50: 206f 6620 7265 7375 6c74 2069 7320 6e6f   of result is no
-0000ff60: 7420 6775 6172 616e 7465 6564 2e0a 0a20  t guaranteed... 
-0000ff70: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0000ff80: 2041 6c6c 2063 6f6e 7465 6e74 7320 6861   All contents ha
-0000ff90: 7665 2070 7265 6669 7820 6f66 2073 335f  ve prefix of s3_
-0000ffa0: 7572 6c0a 2020 2020 2020 2020 3a72 6169  url.        :rai
-0000ffb0: 7365 733a 2053 3346 696c 654e 6f74 466f  ses: S3FileNotFo
-0000ffc0: 756e 6445 7272 6f72 2c20 5333 4e6f 7441  undError, S3NotA
-0000ffd0: 4469 7265 6374 6f72 7945 7272 6f72 0a20  DirectoryError. 
-0000ffe0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000fff0: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
-00010000: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
-00010010: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-00010020: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
-00010030: 6620 6e6f 7420 6275 636b 6574 2061 6e64  f not bucket and
-00010040: 206b 6579 3a0a 2020 2020 2020 2020 2020   key:.          
-00010050: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
-00010060: 4e6f 7446 6f75 6e64 4572 726f 7228 0a20  NotFoundError(. 
-00010070: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00010080: 456d 7074 7920 6275 636b 6574 206e 616d  Empty bucket nam
-00010090: 653a 2025 7227 2025 2073 656c 662e 7061  e: %r' % self.pa
-000100a0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-000100b0: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-000100c0: 6c66 2e69 735f 6669 6c65 2829 3a0a 2020  lf.is_file():.  
-000100d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000100e0: 5333 4e6f 7441 4469 7265 6374 6f72 7945  S3NotADirectoryE
-000100f0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00010100: 2020 2020 2020 274e 6f74 2061 2064 6972        'Not a dir
-00010110: 6563 746f 7279 3a20 2572 2720 2520 7365  ectory: %r' % se
-00010120: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-00010130: 746f 636f 6c29 0a20 2020 2020 2020 2065  tocol).        e
-00010140: 6c69 6620 6e6f 7420 7365 6c66 2e69 735f  lif not self.is_
-00010150: 6469 7228 293a 0a20 2020 2020 2020 2020  dir():.         
-00010160: 2020 2072 6169 7365 2053 3346 696c 654e     raise S3FileN
-00010170: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
-00010180: 2020 2020 2020 2020 2020 2020 2020 274e                'N
-00010190: 6f20 7375 6368 2064 6972 6563 746f 7279  o such directory
-000101a0: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
-000101b0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-000101c0: 0a20 2020 2020 2020 2070 7265 6669 7820  .        prefix 
-000101d0: 3d20 5f62 6563 6f6d 655f 7072 6566 6978  = _become_prefix
-000101e0: 286b 6579 290a 2020 2020 2020 2020 636c  (key).        cl
-000101f0: 6965 6e74 203d 2073 656c 662e 5f63 6c69  ient = self._cli
-00010200: 656e 740a 0a20 2020 2020 2020 2023 2049  ent..        # I
-00010210: 6e20 6f72 6465 7220 746f 2064 6f20 6368  n order to do ch
-00010220: 6563 6b20 6f6e 2063 7265 6174 696f 6e2c  eck on creation,
-00010230: 0a20 2020 2020 2020 2023 2077 6520 6e65  .        # we ne
-00010240: 6564 2074 6f20 7772 6170 2074 6865 2069  ed to wrap the i
-00010250: 7465 7261 746f 7220 696e 2061 6e6f 7468  terator in anoth
-00010260: 6572 2066 756e 6374 696f 6e0a 2020 2020  er function.    
-00010270: 2020 2020 6465 6620 6372 6561 7465 5f67      def create_g
-00010280: 656e 6572 6174 6f72 2829 202d 3e20 4974  enerator() -> It
-00010290: 6572 6174 6f72 5b46 696c 6545 6e74 7279  erator[FileEntry
-000102a0: 5d3a 0a20 2020 2020 2020 2020 2020 2077  ]:.            w
-000102b0: 6974 6820 7261 6973 655f 7333 5f65 7272  ith raise_s3_err
-000102c0: 6f72 2873 656c 662e 7061 7468 5f77 6974  or(self.path_wit
-000102d0: 685f 7072 6f74 6f63 6f6c 293a 0a0a 2020  h_protocol):..  
-000102e0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-000102f0: 6620 6765 6e65 7261 7465 5f73 335f 7061  f generate_s3_pa
-00010300: 7468 280a 2020 2020 2020 2020 2020 2020  th(.            
-00010310: 2020 2020 2020 2020 2020 2020 7072 6f74              prot
-00010320: 6f63 6f6c 3a20 7374 722c 2062 7563 6b65  ocol: str, bucke
-00010330: 743a 2073 7472 2c20 6b65 793a 2073 7472  t: str, key: str
-00010340: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-00010350: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00010360: 7475 726e 2022 2573 3a2f 2f25 732f 2573  turn "%s://%s/%s
-00010370: 2220 2520 2870 726f 746f 636f 6c2c 2062  " % (protocol, b
-00010380: 7563 6b65 742c 206b 6579 290a 0a20 2020  ucket, key)..   
-00010390: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000103a0: 6e6f 7420 6275 636b 6574 2061 6e64 206e  not bucket and n
-000103b0: 6f74 206b 6579 3a20 2023 206c 6973 7420  ot key:  # list 
-000103c0: 6275 636b 6574 730a 2020 2020 2020 2020  buckets.        
-000103d0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-000103e0: 6f6e 7365 203d 2063 6c69 656e 742e 6c69  onse = client.li
-000103f0: 7374 5f62 7563 6b65 7473 2829 0a20 2020  st_buckets().   
-00010400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010410: 2066 6f72 2063 6f6e 7465 6e74 2069 6e20   for content in 
-00010420: 7265 7370 6f6e 7365 5b27 4275 636b 6574  response['Bucket
-00010430: 7327 5d3a 0a20 2020 2020 2020 2020 2020  s']:.           
-00010440: 2020 2020 2020 2020 2020 2020 2079 6965               yie
-00010450: 6c64 2046 696c 6545 6e74 7279 280a 2020  ld FileEntry(.  
-00010460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010470: 2020 2020 2020 2020 2020 636f 6e74 656e            conten
-00010480: 745b 274e 616d 6527 5d2c 2066 2273 333a  t['Name'], f"s3:
-00010490: 2f2f 7b63 6f6e 7465 6e74 5b27 4e61 6d65  //{content['Name
-000104a0: 275d 7d22 2c0a 2020 2020 2020 2020 2020  ']}",.          
-000104b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104c0: 2020 5374 6174 5265 7375 6c74 280a 2020    StatResult(.  
-000104d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104e0: 2020 2020 2020 2020 2020 2020 2020 6374                ct
-000104f0: 696d 653d 636f 6e74 656e 745b 2743 7265  ime=content['Cre
-00010500: 6174 696f 6e44 6174 6527 5d2e 7469 6d65  ationDate'].time
-00010510: 7374 616d 7028 292c 0a20 2020 2020 2020  stamp(),.       
-00010520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010530: 2020 2020 2020 2020 2069 7364 6972 3d54           isdir=T
-00010540: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00010550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010560: 2020 2020 2065 7874 7261 3d63 6f6e 7465       extra=conte
-00010570: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+0000ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee80: 2020 2020 6572 726f 725f 696e 666f 5b27      error_info['
+0000ee90: 4d65 7373 6167 6527 5d29 290a 2020 2020  Message'])).    
+0000eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eeb0: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+0000eec0: 2e61 7070 656e 6428 7b27 4b65 7927 3a20  .append({'Key': 
+0000eed0: 6572 726f 725f 696e 666f 5b27 4b65 7927  error_info['Key'
+0000eee0: 5d7d 290a 2020 2020 2020 2020 2020 2020  ]}).            
+0000eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef20: 2020 2020 2020 6572 726f 7273 2e61 7070        errors.app
+0000ef30: 656e 6428 6572 726f 725f 696e 666f 290a  end(error_info).
+0000ef40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef50: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
+0000ef60: 6570 2872 6574 7279 5f69 6e74 6572 7661  ep(retry_interva
+0000ef70: 6c29 0a20 2020 2020 2020 2020 2020 2020  l).             
+0000ef80: 2020 2020 2020 2066 6f72 2065 7272 6f72         for error
+0000ef90: 5f69 6e66 6f20 696e 2065 7272 6f72 733a  _info in errors:
+0000efa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000efb0: 2020 2020 2020 2020 2065 7272 6f72 5f6c           error_l
+0000efc0: 6f67 6765 722e 6572 726f 7228 0a20 2020  ogger.error(.   
+0000efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000efe0: 2020 2020 2020 2020 2022 6661 696c 6564           "failed
+0000eff0: 2072 656d 6f76 6520 6669 6c65 3a20 2573   remove file: %s
+0000f000: 2c20 7769 7468 2065 7272 6f72 2025 733a  , with error %s:
+0000f010: 2025 7322 2025 2028 0a20 2020 2020 2020   %s" % (.       
+0000f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f030: 2020 2020 2020 2020 2065 7272 6f72 5f69           error_i
+0000f040: 6e66 6f5b 274b 6579 275d 2c20 6572 726f  nfo['Key'], erro
+0000f050: 725f 696e 666f 5b27 436f 6465 275d 2c0a  r_info['Code'],.
+0000f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f080: 6572 726f 725f 696e 666f 5b27 4d65 7373  error_info['Mess
+0000f090: 6167 6527 5d29 290a 2020 2020 2020 2020  age'])).        
+0000f0a0: 2020 2020 2020 2020 2020 2020 6572 726f              erro
+0000f0b0: 725f 636f 756e 7420 2b3d 206c 656e 2865  r_count += len(e
+0000f0c0: 7272 6f72 7329 0a20 2020 2020 2020 2020  rrors).         
+0000f0d0: 2020 2069 6620 6572 726f 725f 636f 756e     if error_coun
+0000f0e0: 7420 3e20 303a 0a20 2020 2020 2020 2020  t > 0:.         
+0000f0f0: 2020 2020 2020 2065 7272 6f72 5f6d 7367         error_msg
+0000f100: 203d 2022 6661 696c 6564 2072 656d 6f76   = "failed remov
+0000f110: 6520 7061 7468 3a20 2573 2c20 746f 7461  e path: %s, tota
+0000f120: 6c20 6669 6c65 2063 6f75 6e74 3a20 2573  l file count: %s
+0000f130: 2c20 6661 696c 6564 2063 6f75 6e74 3a20  , failed count: 
+0000f140: 2573 2220 2520 280a 2020 2020 2020 2020  %s" % (.        
+0000f150: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000f160: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+0000f170: 636f 6c2c 2074 6f74 616c 5f63 6f75 6e74  col, total_count
+0000f180: 2c20 6572 726f 725f 636f 756e 7429 0a20  , error_count). 
+0000f190: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000f1a0: 6169 7365 2053 3355 6e6b 6e6f 776e 4572  aise S3UnknownEr
+0000f1b0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+0000f1c0: 2020 2020 2020 2020 2045 7863 6570 7469           Excepti
+0000f1d0: 6f6e 2865 7272 6f72 5f6d 7367 292c 2073  on(error_msg), s
+0000f1e0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+0000f1f0: 6f74 6f63 6f6c 290a 0a20 2020 2064 6566  otocol)..    def
+0000f200: 2072 656e 616d 6528 7365 6c66 2c20 6473   rename(self, ds
+0000f210: 745f 7061 7468 3a20 5061 7468 4c69 6b65  t_path: PathLike
+0000f220: 2920 2d3e 2027 5333 5061 7468 273a 0a20  ) -> 'S3Path':. 
+0000f230: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000f240: 2020 204d 6f76 6520 7333 2066 696c 6520     Move s3 file 
+0000f250: 7061 7468 2066 726f 6d20 7372 635f 7572  path from src_ur
+0000f260: 6c20 746f 2064 7374 5f75 726c 0a0a 2020  l to dst_url..  
+0000f270: 2020 2020 2020 3a70 6172 616d 2064 7374        :param dst
+0000f280: 5f70 6174 683a 2047 6976 656e 2064 6573  _path: Given des
+0000f290: 7469 6e61 7469 6f6e 2070 6174 680a 2020  tination path.  
+0000f2a0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0000f2b0: 2020 7333 5f72 656e 616d 6528 7365 6c66    s3_rename(self
+0000f2c0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+0000f2d0: 636f 6c2c 2064 7374 5f70 6174 6829 0a20  col, dst_path). 
+0000f2e0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000f2f0: 6c66 2e66 726f 6d5f 7061 7468 2864 7374  lf.from_path(dst
+0000f300: 5f70 6174 6829 0a0a 2020 2020 6465 6620  _path)..    def 
+0000f310: 7363 616e 2873 656c 662c 206d 6973 7369  scan(self, missi
+0000f320: 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20 5472  ng_ok: bool = Tr
+0000f330: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0000f340: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
+0000f350: 6f6c 203d 2046 616c 7365 2920 2d3e 2049  ol = False) -> I
+0000f360: 7465 7261 746f 725b 7374 725d 3a0a 2020  terator[str]:.  
+0000f370: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0000f380: 2020 4974 6572 6174 6976 656c 7920 7472    Iteratively tr
+0000f390: 6176 6572 7365 206f 6e6c 7920 6669 6c65  averse only file
+0000f3a0: 7320 696e 2067 6976 656e 2073 3320 6469  s in given s3 di
+0000f3b0: 7265 6374 6f72 792c 2069 6e20 616c 7068  rectory, in alph
+0000f3c0: 6162 6574 6963 616c 206f 7264 6572 2e0a  abetical order..
+0000f3d0: 2020 2020 2020 2020 4576 6572 7920 6974          Every it
+0000f3e0: 6572 6174 696f 6e20 6f6e 2067 656e 6572  eration on gener
+0000f3f0: 6174 6f72 2079 6965 6c64 7320 6120 7061  ator yields a pa
+0000f400: 7468 2073 7472 696e 672e 0a0a 2020 2020  th string...    
+0000f410: 2020 2020 4966 2073 335f 7572 6c20 6973      If s3_url is
+0000f420: 2061 2066 696c 6520 7061 7468 2c20 7969   a file path, yi
+0000f430: 656c 6473 2074 6865 2066 696c 6520 6f6e  elds the file on
+0000f440: 6c79 0a20 2020 2020 2020 2049 6620 7333  ly.        If s3
+0000f450: 5f75 726c 2069 7320 6120 6e6f 6e2d 6578  _url is a non-ex
+0000f460: 6973 7465 6e74 2070 6174 682c 2072 6574  istent path, ret
+0000f470: 7572 6e20 616e 2065 6d70 7479 2067 656e  urn an empty gen
+0000f480: 6572 6174 6f72 0a20 2020 2020 2020 2049  erator.        I
+0000f490: 6620 7333 5f75 726c 2069 7320 6120 6275  f s3_url is a bu
+0000f4a0: 636b 6574 2070 6174 682c 2072 6574 7572  cket path, retur
+0000f4b0: 6e20 616c 6c20 6669 6c65 2070 6174 6873  n all file paths
+0000f4c0: 2069 6e20 7468 6520 6275 636b 6574 0a20   in the bucket. 
+0000f4d0: 2020 2020 2020 2049 6620 7333 5f75 726c         If s3_url
+0000f4e0: 2069 7320 616e 2065 6d70 7479 2062 7563   is an empty buc
+0000f4f0: 6b65 742c 2072 6574 7572 6e20 616e 2065  ket, return an e
+0000f500: 6d70 7479 2067 656e 6572 6174 6f72 0a20  mpty generator. 
+0000f510: 2020 2020 2020 2049 6620 7333 5f75 726c         If s3_url
+0000f520: 2064 6f65 736e 2774 2063 6f6e 7461 696e   doesn't contain
+0000f530: 2061 6e79 2062 7563 6b65 742c 2077 6869   any bucket, whi
+0000f540: 6368 2069 7320 7333 5f75 726c 203d 3d20  ch is s3_url == 
+0000f550: 2773 333a 2f2f 272c 2072 6169 7365 2055  's3://', raise U
+0000f560: 6e73 7570 706f 7274 6564 4572 726f 722e  nsupportedError.
+0000f570: 2077 616c 6b28 2920 6f6e 2063 6f6d 706c   walk() on compl
+0000f580: 6574 6520 7333 2069 7320 6e6f 7420 7375  ete s3 is not su
+0000f590: 7070 6f72 7465 6420 696e 206d 6567 6669  pported in megfi
+0000f5a0: 6c65 0a0a 2020 2020 2020 2020 3a70 6172  le..        :par
+0000f5b0: 616d 206d 6973 7369 6e67 5f6f 6b3a 2049  am missing_ok: I
+0000f5c0: 6620 4661 6c73 6520 616e 6420 7468 6572  f False and ther
+0000f5d0: 6527 7320 6e6f 2066 696c 6520 696e 2074  e's no file in t
+0000f5e0: 6865 2064 6972 6563 746f 7279 2c20 7261  he directory, ra
+0000f5f0: 6973 6520 4669 6c65 4e6f 7446 6f75 6e64  ise FileNotFound
+0000f600: 4572 726f 720a 2020 2020 2020 2020 3a72  Error.        :r
+0000f610: 6169 7365 733a 2055 6e73 7570 706f 7274  aises: Unsupport
+0000f620: 6564 4572 726f 720a 2020 2020 2020 2020  edError.        
+0000f630: 3a72 6574 7572 6e73 3a20 4120 6669 6c65  :returns: A file
+0000f640: 2070 6174 6820 6765 6e65 7261 746f 720a   path generator.
+0000f650: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000f660: 2020 2020 7363 616e 5f73 7461 745f 6974      scan_stat_it
+0000f670: 6572 203d 2073 656c 662e 7363 616e 5f73  er = self.scan_s
+0000f680: 7461 7428 0a20 2020 2020 2020 2020 2020  tat(.           
+0000f690: 206d 6973 7369 6e67 5f6f 6b3d 6d69 7373   missing_ok=miss
+0000f6a0: 696e 675f 6f6b 2c20 666f 6c6c 6f77 6c69  ing_ok, followli
+0000f6b0: 6e6b 733d 666f 6c6c 6f77 6c69 6e6b 7329  nks=followlinks)
+0000f6c0: 0a0a 2020 2020 2020 2020 6465 6620 6372  ..        def cr
+0000f6d0: 6561 7465 5f67 656e 6572 6174 6f72 2829  eate_generator()
+0000f6e0: 202d 3e20 4974 6572 6174 6f72 5b73 7472   -> Iterator[str
+0000f6f0: 5d3a 0a20 2020 2020 2020 2020 2020 2066  ]:.            f
+0000f700: 6f72 2066 696c 655f 656e 7472 7920 696e  or file_entry in
+0000f710: 2073 6361 6e5f 7374 6174 5f69 7465 723a   scan_stat_iter:
+0000f720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f730: 2079 6965 6c64 2066 696c 655f 656e 7472   yield file_entr
+0000f740: 792e 7061 7468 0a0a 2020 2020 2020 2020  y.path..        
+0000f750: 7265 7475 726e 2063 7265 6174 655f 6765  return create_ge
+0000f760: 6e65 7261 746f 7228 290a 0a20 2020 2064  nerator()..    d
+0000f770: 6566 2073 6361 6e5f 7374 6174 2873 656c  ef scan_stat(sel
+0000f780: 662c 206d 6973 7369 6e67 5f6f 6b3a 2062  f, missing_ok: b
+0000f790: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
+0000f7a0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0000f7b0: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
+0000f7c0: 3d20 4661 6c73 6529 202d 3e20 4974 6572  = False) -> Iter
+0000f7d0: 6174 6f72 5b46 696c 6545 6e74 7279 5d3a  ator[FileEntry]:
+0000f7e0: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000f7f0: 2020 2020 2049 7465 7261 7469 7665 6c79       Iteratively
+0000f800: 2074 7261 7665 7273 6520 6f6e 6c79 2066   traverse only f
+0000f810: 696c 6573 2069 6e20 6769 7665 6e20 6469  iles in given di
+0000f820: 7265 6374 6f72 792c 2069 6e20 616c 7068  rectory, in alph
+0000f830: 6162 6574 6963 616c 206f 7264 6572 2e0a  abetical order..
+0000f840: 2020 2020 2020 2020 4576 6572 7920 6974          Every it
+0000f850: 6572 6174 696f 6e20 6f6e 2067 656e 6572  eration on gener
+0000f860: 6174 6f72 2079 6965 6c64 7320 6120 7475  ator yields a tu
+0000f870: 706c 6520 6f66 2070 6174 6820 7374 7269  ple of path stri
+0000f880: 6e67 2061 6e64 2066 696c 6520 7374 6174  ng and file stat
+0000f890: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0000f8a0: 206d 6973 7369 6e67 5f6f 6b3a 2049 6620   missing_ok: If 
+0000f8b0: 4661 6c73 6520 616e 6420 7468 6572 6527  False and there'
+0000f8c0: 7320 6e6f 2066 696c 6520 696e 2074 6865  s no file in the
+0000f8d0: 2064 6972 6563 746f 7279 2c20 7261 6973   directory, rais
+0000f8e0: 6520 4669 6c65 4e6f 7446 6f75 6e64 4572  e FileNotFoundEr
+0000f8f0: 726f 720a 2020 2020 2020 2020 3a72 6169  ror.        :rai
+0000f900: 7365 733a 2055 6e73 7570 706f 7274 6564  ses: Unsupported
+0000f910: 4572 726f 720a 2020 2020 2020 2020 3a72  Error.        :r
+0000f920: 6574 7572 6e73 3a20 4120 6669 6c65 2070  eturns: A file p
+0000f930: 6174 6820 6765 6e65 7261 746f 720a 2020  ath generator.  
+0000f940: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0000f950: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
+0000f960: 7061 7273 655f 7333 5f75 726c 2873 656c  parse_s3_url(sel
+0000f970: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+0000f980: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
+0000f990: 206e 6f74 2062 7563 6b65 743a 0a20 2020   not bucket:.   
+0000f9a0: 2020 2020 2020 2020 2072 6169 7365 2055           raise U
+0000f9b0: 6e73 7570 706f 7274 6564 4572 726f 7228  nsupportedError(
+0000f9c0: 2753 6361 6e20 7768 6f6c 6520 7333 272c  'Scan whole s3',
+0000f9d0: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
+0000f9e0: 7072 6f74 6f63 6f6c 290a 0a20 2020 2020  protocol)..     
+0000f9f0: 2020 2064 6566 2063 7265 6174 655f 6765     def create_ge
+0000fa00: 6e65 7261 746f 7228 2920 2d3e 2049 7465  nerator() -> Ite
+0000fa10: 7261 746f 725b 4669 6c65 456e 7472 795d  rator[FileEntry]
+0000fa20: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0000fa30: 206e 6f74 2073 656c 662e 6973 5f64 6972   not self.is_dir
+0000fa40: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0000fa50: 2020 2020 6966 2073 656c 662e 6973 5f66      if self.is_f
+0000fa60: 696c 6528 293a 0a20 2020 2020 2020 2020  ile():.         
+0000fa70: 2020 2020 2020 2020 2020 2023 204f 6e20             # On 
+0000fa80: 7333 2c20 6669 6c65 2061 6e64 2064 6972  s3, file and dir
+0000fa90: 6563 746f 7279 206d 6179 2062 6520 6f66  ectory may be of
+0000faa0: 2073 616d 6520 6e61 6d65 2061 6e64 206c   same name and l
+0000fab0: 6576 656c 2c20 736f 206e 6565 6420 746f  evel, so need to
+0000fac0: 2074 6573 7420 7468 6520 7061 7468 2069   test the path i
+0000fad0: 7320 6669 6c65 206f 7220 6469 7265 6374  s file or direct
+0000fae0: 6f72 790a 2020 2020 2020 2020 2020 2020  ory.            
+0000faf0: 2020 2020 2020 2020 7969 656c 6420 4669          yield Fi
+0000fb00: 6c65 456e 7472 7928 0a20 2020 2020 2020  leEntry(.       
+0000fb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb20: 2073 656c 662e 6e61 6d65 2c20 6673 7061   self.name, fspa
+0000fb30: 7468 2873 656c 662e 7061 7468 5f77 6974  th(self.path_wit
+0000fb40: 685f 7072 6f74 6f63 6f6c 292c 0a20 2020  h_protocol),.   
+0000fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb60: 2020 2020 2073 656c 662e 7374 6174 2866       self.stat(f
+0000fb70: 6f6c 6c6f 775f 7379 6d6c 696e 6b73 3d66  ollow_symlinks=f
+0000fb80: 6f6c 6c6f 776c 696e 6b73 2929 0a20 2020  ollowlinks)).   
+0000fb90: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0000fba0: 7572 6e0a 0a20 2020 2020 2020 2020 2020  urn..           
+0000fbb0: 2069 6620 6e6f 7420 6b65 792e 656e 6473   if not key.ends
+0000fbc0: 7769 7468 2827 2f27 2920 616e 6420 7365  with('/') and se
+0000fbd0: 6c66 2e69 735f 6669 6c65 2829 3a0a 2020  lf.is_file():.  
+0000fbe0: 2020 2020 2020 2020 2020 2020 2020 7969                yi
+0000fbf0: 656c 6420 4669 6c65 456e 7472 7928 0a20  eld FileEntry(. 
+0000fc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fc10: 2020 2073 656c 662e 6e61 6d65 2c20 6673     self.name, fs
+0000fc20: 7061 7468 2873 656c 662e 7061 7468 5f77  path(self.path_w
+0000fc30: 6974 685f 7072 6f74 6f63 6f6c 292c 0a20  ith_protocol),. 
+0000fc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fc50: 2020 2073 656c 662e 7374 6174 2866 6f6c     self.stat(fol
+0000fc60: 6c6f 775f 7379 6d6c 696e 6b73 3d66 6f6c  low_symlinks=fol
+0000fc70: 6c6f 776c 696e 6b73 2929 0a0a 2020 2020  lowlinks))..    
+0000fc80: 2020 2020 2020 2020 7072 6566 6978 203d          prefix =
+0000fc90: 205f 6265 636f 6d65 5f70 7265 6669 7828   _become_prefix(
+0000fca0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+0000fcb0: 2063 6c69 656e 7420 3d20 7365 6c66 2e5f   client = self._
+0000fcc0: 636c 6965 6e74 0a20 2020 2020 2020 2020  client.         
+0000fcd0: 2020 2077 6974 6820 7261 6973 655f 7333     with raise_s3
+0000fce0: 5f65 7272 6f72 2873 656c 662e 7061 7468  _error(self.path
+0000fcf0: 5f77 6974 685f 7072 6f74 6f63 6f6c 293a  _with_protocol):
+0000fd00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fd10: 2066 6f72 2072 6573 7020 696e 205f 6c69   for resp in _li
+0000fd20: 7374 5f6f 626a 6563 7473 5f72 6563 7572  st_objects_recur
+0000fd30: 7369 7665 2863 6c69 656e 742c 2062 7563  sive(client, buc
+0000fd40: 6b65 742c 2070 7265 6669 7829 3a0a 2020  ket, prefix):.  
+0000fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd60: 2020 666f 7220 636f 6e74 656e 7420 696e    for content in
+0000fd70: 2072 6573 702e 6765 7428 2743 6f6e 7465   resp.get('Conte
+0000fd80: 6e74 7327 2c20 5b5d 293a 0a20 2020 2020  nts', []):.     
+0000fd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fda0: 2020 2066 756c 6c5f 7061 7468 203d 2073     full_path = s
+0000fdb0: 335f 7061 7468 5f6a 6f69 6e28 0a20 2020  3_path_join(.   
+0000fdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fdd0: 2020 2020 2020 2020 2066 277b 7365 6c66           f'{self
+0000fde0: 2e5f 7072 6f74 6f63 6f6c 5f77 6974 685f  ._protocol_with_
+0000fdf0: 7072 6f66 696c 657d 3a2f 2f27 2c20 6275  profile}://', bu
+0000fe00: 636b 6574 2c0a 2020 2020 2020 2020 2020  cket,.          
+0000fe10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe20: 2020 636f 6e74 656e 745b 274b 6579 275d    content['Key']
+0000fe30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000fe40: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+0000fe50: 4669 6c65 456e 7472 7928 0a20 2020 2020  FileEntry(.     
+0000fe60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe70: 2020 2020 2020 2053 3350 6174 6828 6675         S3Path(fu
+0000fe80: 6c6c 5f70 6174 6829 2e6e 616d 652c 2066  ll_path).name, f
+0000fe90: 756c 6c5f 7061 7468 2c0a 2020 2020 2020  ull_path,.      
+0000fea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000feb0: 2020 2020 2020 5f6d 616b 655f 7374 6174        _make_stat
+0000fec0: 2863 6f6e 7465 6e74 2929 0a0a 2020 2020  (content))..    
+0000fed0: 2020 2020 7265 7475 726e 205f 6372 6561      return _crea
+0000fee0: 7465 5f6d 6973 7369 6e67 5f6f 6b5f 6765  te_missing_ok_ge
+0000fef0: 6e65 7261 746f 7228 0a20 2020 2020 2020  nerator(.       
+0000ff00: 2020 2020 2063 7265 6174 655f 6765 6e65       create_gene
+0000ff10: 7261 746f 7228 292c 206d 6973 7369 6e67  rator(), missing
+0000ff20: 5f6f 6b2c 0a20 2020 2020 2020 2020 2020  _ok,.           
+0000ff30: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
+0000ff40: 7272 6f72 2827 4e6f 206d 6174 6368 2066  rror('No match f
+0000ff50: 696c 653a 2025 7227 2025 2073 656c 662e  ile: %r' % self.
+0000ff60: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+0000ff70: 6f6c 2929 0a0a 2020 2020 6465 6620 7363  ol))..    def sc
+0000ff80: 616e 6469 7228 7365 6c66 2c20 666f 6c6c  andir(self, foll
+0000ff90: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+0000ffa0: 4661 6c73 6529 202d 3e20 4974 6572 6174  False) -> Iterat
+0000ffb0: 6f72 5b46 696c 6545 6e74 7279 5d3a 0a20  or[FileEntry]:. 
+0000ffc0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000ffd0: 2020 2047 6574 2061 6c6c 2063 6f6e 7465     Get all conte
+0000ffe0: 6e74 7320 6f66 2067 6976 656e 2073 335f  nts of given s3_
+0000fff0: 7572 6c2c 2074 6865 206f 7264 6572 206f  url, the order o
+00010000: 6620 7265 7375 6c74 2069 7320 6e6f 7420  f result is not 
+00010010: 6775 6172 616e 7465 6564 2e0a 0a20 2020  guaranteed...   
+00010020: 2020 2020 203a 7265 7475 726e 733a 2041       :returns: A
+00010030: 6c6c 2063 6f6e 7465 6e74 7320 6861 7665  ll contents have
+00010040: 2070 7265 6669 7820 6f66 2073 335f 7572   prefix of s3_ur
+00010050: 6c0a 2020 2020 2020 2020 3a72 6169 7365  l.        :raise
+00010060: 733a 2053 3346 696c 654e 6f74 466f 756e  s: S3FileNotFoun
+00010070: 6445 7272 6f72 2c20 5333 4e6f 7441 4469  dError, S3NotADi
+00010080: 7265 6374 6f72 7945 7272 6f72 0a20 2020  rectoryError.   
+00010090: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
+000100a0: 2062 7563 6b65 742c 206b 6579 203d 2070   bucket, key = p
+000100b0: 6172 7365 5f73 335f 7572 6c28 7365 6c66  arse_s3_url(self
+000100c0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+000100d0: 636f 6c29 0a20 2020 2020 2020 2069 6620  col).        if 
+000100e0: 6e6f 7420 6275 636b 6574 2061 6e64 206b  not bucket and k
+000100f0: 6579 3a0a 2020 2020 2020 2020 2020 2020  ey:.            
+00010100: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
+00010110: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
+00010120: 2020 2020 2020 2020 2020 2020 2027 456d               'Em
+00010130: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
+00010140: 2025 7227 2025 2073 656c 662e 7061 7468   %r' % self.path
+00010150: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+00010160: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00010170: 2e69 735f 6669 6c65 2829 3a0a 2020 2020  .is_file():.    
+00010180: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
+00010190: 4e6f 7441 4469 7265 6374 6f72 7945 7272  NotADirectoryErr
+000101a0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+000101b0: 2020 2020 274e 6f74 2061 2064 6972 6563      'Not a direc
+000101c0: 746f 7279 3a20 2572 2720 2520 7365 6c66  tory: %r' % self
+000101d0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+000101e0: 636f 6c29 0a20 2020 2020 2020 2065 6c69  col).        eli
+000101f0: 6620 6e6f 7420 7365 6c66 2e69 735f 6469  f not self.is_di
+00010200: 7228 293a 0a20 2020 2020 2020 2020 2020  r():.           
+00010210: 2072 6169 7365 2053 3346 696c 654e 6f74   raise S3FileNot
+00010220: 466f 756e 6445 7272 6f72 280a 2020 2020  FoundError(.    
+00010230: 2020 2020 2020 2020 2020 2020 274e 6f20              'No 
+00010240: 7375 6368 2064 6972 6563 746f 7279 3a20  such directory: 
+00010250: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
+00010260: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+00010270: 2020 2020 2020 2070 7265 6669 7820 3d20         prefix = 
+00010280: 5f62 6563 6f6d 655f 7072 6566 6978 286b  _become_prefix(k
+00010290: 6579 290a 2020 2020 2020 2020 636c 6965  ey).        clie
+000102a0: 6e74 203d 2073 656c 662e 5f63 6c69 656e  nt = self._clien
+000102b0: 740a 0a20 2020 2020 2020 2023 2049 6e20  t..        # In 
+000102c0: 6f72 6465 7220 746f 2064 6f20 6368 6563  order to do chec
+000102d0: 6b20 6f6e 2063 7265 6174 696f 6e2c 0a20  k on creation,. 
+000102e0: 2020 2020 2020 2023 2077 6520 6e65 6564         # we need
+000102f0: 2074 6f20 7772 6170 2074 6865 2069 7465   to wrap the ite
+00010300: 7261 746f 7220 696e 2061 6e6f 7468 6572  rator in another
+00010310: 2066 756e 6374 696f 6e0a 2020 2020 2020   function.      
+00010320: 2020 6465 6620 6372 6561 7465 5f67 656e    def create_gen
+00010330: 6572 6174 6f72 2829 202d 3e20 4974 6572  erator() -> Iter
+00010340: 6174 6f72 5b46 696c 6545 6e74 7279 5d3a  ator[FileEntry]:
+00010350: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+00010360: 6820 7261 6973 655f 7333 5f65 7272 6f72  h raise_s3_error
+00010370: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+00010380: 7072 6f74 6f63 6f6c 293a 0a0a 2020 2020  protocol):..    
+00010390: 2020 2020 2020 2020 2020 2020 6465 6620              def 
+000103a0: 6765 6e65 7261 7465 5f73 335f 7061 7468  generate_s3_path
+000103b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000103c0: 2020 2020 2020 2020 2020 7072 6f74 6f63            protoc
+000103d0: 6f6c 3a20 7374 722c 2062 7563 6b65 743a  ol: str, bucket:
+000103e0: 2073 7472 2c20 6b65 793a 2073 7472 2920   str, key: str) 
+000103f0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+00010400: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00010410: 726e 2022 2573 3a2f 2f25 732f 2573 2220  rn "%s://%s/%s" 
+00010420: 2520 2870 726f 746f 636f 6c2c 2062 7563  % (protocol, buc
+00010430: 6b65 742c 206b 6579 290a 0a20 2020 2020  ket, key)..     
+00010440: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00010450: 7420 6275 636b 6574 2061 6e64 206e 6f74  t bucket and not
+00010460: 206b 6579 3a20 2023 206c 6973 7420 6275   key:  # list bu
+00010470: 636b 6574 730a 2020 2020 2020 2020 2020  ckets.          
+00010480: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+00010490: 7365 203d 2063 6c69 656e 742e 6c69 7374  se = client.list
+000104a0: 5f62 7563 6b65 7473 2829 0a20 2020 2020  _buckets().     
+000104b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000104c0: 6f72 2063 6f6e 7465 6e74 2069 6e20 7265  or content in re
+000104d0: 7370 6f6e 7365 5b27 4275 636b 6574 7327  sponse['Buckets'
+000104e0: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+000104f0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+00010500: 2046 696c 6545 6e74 7279 280a 2020 2020   FileEntry(.    
+00010510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010520: 2020 2020 2020 2020 636f 6e74 656e 745b          content[
+00010530: 274e 616d 6527 5d2c 2066 2273 333a 2f2f  'Name'], f"s3://
+00010540: 7b63 6f6e 7465 6e74 5b27 4e61 6d65 275d  {content['Name']
+00010550: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
+00010560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010570: 5374 6174 5265 7375 6c74 280a 2020 2020  StatResult(.    
 00010580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010590: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000105a0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-000105b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000105c0: 6f72 2072 6573 7020 696e 205f 6c69 7374  or resp in _list
-000105d0: 5f6f 626a 6563 7473 5f72 6563 7572 7369  _objects_recursi
-000105e0: 7665 2863 6c69 656e 742c 2062 7563 6b65  ve(client, bucke
-000105f0: 742c 2070 7265 6669 782c 0a20 2020 2020  t, prefix,.     
+00010590: 2020 2020 2020 2020 2020 2020 6374 696d              ctim
+000105a0: 653d 636f 6e74 656e 745b 2743 7265 6174  e=content['Creat
+000105b0: 696f 6e44 6174 6527 5d2e 7469 6d65 7374  ionDate'].timest
+000105c0: 616d 7028 292c 0a20 2020 2020 2020 2020  amp(),.         
+000105d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000105e0: 2020 2020 2020 2069 7364 6972 3d54 7275         isdir=Tru
+000105f0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
 00010600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010620: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00010630: 2f27 293a 0a20 2020 2020 2020 2020 2020  /'):.           
-00010640: 2020 2020 2020 2020 2066 6f72 2063 6f6d           for com
-00010650: 6d6f 6e5f 7072 6566 6978 2069 6e20 7265  mon_prefix in re
-00010660: 7370 2e67 6574 2827 436f 6d6d 6f6e 5072  sp.get('CommonPr
-00010670: 6566 6978 6573 272c 205b 5d29 3a0a 2020  efixes', []):.  
-00010680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010690: 2020 2020 2020 7969 656c 6420 4669 6c65        yield File
-000106a0: 456e 7472 7928 0a20 2020 2020 2020 2020  Entry(.         
+00010610: 2020 2065 7874 7261 3d63 6f6e 7465 6e74     extra=content
+00010620: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00010630: 2020 2020 2020 2020 2020 2020 2020 2929                ))
+00010640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010650: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00010660: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00010670: 2072 6573 7020 696e 205f 6c69 7374 5f6f   resp in _list_o
+00010680: 626a 6563 7473 5f72 6563 7572 7369 7665  bjects_recursive
+00010690: 2863 6c69 656e 742c 2062 7563 6b65 742c  (client, bucket,
+000106a0: 2070 7265 6669 782c 0a20 2020 2020 2020   prefix,.       
 000106b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106c0: 2020 2063 6f6d 6d6f 6e5f 7072 6566 6978     common_prefix
-000106d0: 5b27 5072 6566 6978 275d 5b6c 656e 2870  ['Prefix'][len(p
-000106e0: 7265 6669 7829 3a2d 315d 2c0a 2020 2020  refix):-1],.    
-000106f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010700: 2020 2020 2020 2020 6765 6e65 7261 7465          generate
-00010710: 5f73 335f 7061 7468 280a 2020 2020 2020  _s3_path(.      
-00010720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010730: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00010740: 7072 6f74 6f63 6f6c 5f77 6974 685f 7072  protocol_with_pr
-00010750: 6f66 696c 652c 2062 7563 6b65 742c 0a20  ofile, bucket,. 
+000106c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106d0: 2020 2020 2020 2020 2020 2020 2027 2f27               '/'
+000106e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000106f0: 2020 2020 2020 2066 6f72 2063 6f6d 6d6f         for commo
+00010700: 6e5f 7072 6566 6978 2069 6e20 7265 7370  n_prefix in resp
+00010710: 2e67 6574 2827 436f 6d6d 6f6e 5072 6566  .get('CommonPref
+00010720: 6978 6573 272c 205b 5d29 3a0a 2020 2020  ixes', []):.    
+00010730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010740: 2020 2020 7969 656c 6420 4669 6c65 456e      yield FileEn
+00010750: 7472 7928 0a20 2020 2020 2020 2020 2020  try(.           
 00010760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010770: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00010780: 6f6d 6d6f 6e5f 7072 6566 6978 5b27 5072  ommon_prefix['Pr
-00010790: 6566 6978 275d 292c 0a20 2020 2020 2020  efix']),.       
+00010770: 2063 6f6d 6d6f 6e5f 7072 6566 6978 5b27   common_prefix['
+00010780: 5072 6566 6978 275d 5b6c 656e 2870 7265  Prefix'][len(pre
+00010790: 6669 7829 3a2d 315d 2c0a 2020 2020 2020  fix):-1],.      
 000107a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107b0: 2020 2020 2053 7461 7452 6573 756c 7428       StatResult(
-000107c0: 6973 6469 723d 5472 7565 2c20 6578 7472  isdir=True, extr
-000107d0: 613d 636f 6d6d 6f6e 5f70 7265 6669 7829  a=common_prefix)
-000107e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000107f0: 2020 2020 2020 666f 7220 636f 6e74 656e        for conten
-00010800: 7420 696e 2072 6573 702e 6765 7428 2743  t in resp.get('C
-00010810: 6f6e 7465 6e74 7327 2c20 5b5d 293a 0a20  ontents', []):. 
-00010820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010830: 2020 2020 2020 2073 7263 5f75 726c 203d         src_url =
-00010840: 2067 656e 6572 6174 655f 7333 5f70 6174   generate_s3_pat
-00010850: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
-00010860: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00010870: 656c 662e 5f70 726f 746f 636f 6c5f 7769  elf._protocol_wi
-00010880: 7468 5f70 726f 6669 6c65 2c20 6275 636b  th_profile, buck
-00010890: 6574 2c20 636f 6e74 656e 745b 274b 6579  et, content['Key
-000108a0: 275d 290a 0a20 2020 2020 2020 2020 2020  '])..           
-000108b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000108c0: 666f 6c6c 6f77 6c69 6e6b 7320 616e 6420  followlinks and 
-000108d0: 5333 5061 7468 2873 7263 5f75 726c 292e  S3Path(src_url).
-000108e0: 6973 5f73 796d 6c69 6e6b 2829 3a0a 2020  is_symlink():.  
-000108f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010900: 2020 2020 2020 2020 2020 636f 6e74 656e            conten
-00010910: 745b 2769 736c 6e6b 275d 203d 2054 7275  t['islnk'] = Tru
-00010920: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
-00010930: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-00010940: 2046 696c 6545 6e74 7279 280a 2020 2020   FileEntry(.    
-00010950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010960: 2020 2020 2020 2020 636f 6e74 656e 745b          content[
-00010970: 274b 6579 275d 5b6c 656e 2870 7265 6669  'Key'][len(prefi
-00010980: 7829 3a5d 2c20 7372 635f 7572 6c2c 0a20  x):], src_url,. 
-00010990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000109a0: 2020 2020 2020 2020 2020 205f 6d61 6b65             _make
-000109b0: 5f73 7461 7428 636f 6e74 656e 7429 290a  _stat(content)).
-000109c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000109d0: 436f 6e74 6578 7449 7465 7261 746f 7228  ContextIterator(
-000109e0: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
-000109f0: 2829 290a 0a20 2020 2064 6566 205f 6765  ())..    def _ge
-00010a00: 7464 6972 7374 6174 2873 656c 6629 202d  tdirstat(self) -
-00010a10: 3e20 5374 6174 5265 7375 6c74 3a0a 2020  > StatResult:.  
-00010a20: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-00010a30: 2020 5265 7475 726e 2053 7461 7452 6573    Return StatRes
-00010a40: 756c 7420 6f66 2067 6976 656e 2073 335f  ult of given s3_
-00010a50: 7572 6c20 6469 7265 6374 6f72 792c 2069  url directory, i
-00010a60: 6e63 6c75 6469 6e67 3a20 0a0a 2020 2020  ncluding: ..    
-00010a70: 2020 2020 312e 2044 6972 6563 746f 7279      1. Directory
-00010a80: 2073 697a 653a 2074 6865 2073 756d 206f   size: the sum o
-00010a90: 6620 616c 6c20 6669 6c65 2073 697a 6520  f all file size 
-00010aa0: 696e 2069 742c 2069 6e63 6c75 6469 6e67  in it, including
-00010ab0: 2066 696c 6520 696e 2073 7562 6469 7265   file in subdire
-00010ac0: 6374 6f72 6965 7320 2869 6620 6578 6973  ctories (if exis
-00010ad0: 7429 2e0a 2020 2020 2020 2020 5468 6520  t)..        The 
-00010ae0: 7265 7375 6c74 2065 7863 6c75 6465 7320  result excludes 
-00010af0: 7468 6520 7369 7a65 206f 6620 6469 7265  the size of dire
-00010b00: 6374 6f72 7920 6974 7365 6c66 2e20 496e  ctory itself. In
-00010b10: 206f 7468 6572 2077 6f72 6473 2c20 7265   other words, re
-00010b20: 7475 726e 2030 2042 7974 6520 6f6e 2061  turn 0 Byte on a
-00010b30: 6e20 656d 7074 7920 6469 7265 6374 6f72  n empty director
-00010b40: 7920 7061 7468 0a20 2020 2020 2020 2032  y path.        2
-00010b50: 2e20 4c61 7374 2d6d 6f64 6966 6965 6420  . Last-modified 
-00010b60: 7469 6d65 206f 6620 6469 7265 6374 6f72  time of director
-00010b70: 793a 2072 6574 7572 6e20 7468 6520 6c61  y: return the la
-00010b80: 7465 7374 206d 6f64 6966 6965 6420 7469  test modified ti
-00010b90: 6d65 206f 6620 616c 6c20 6669 6c65 2069  me of all file i
-00010ba0: 6e20 6974 2e20 5468 6520 6d74 696d 6520  n it. The mtime 
-00010bb0: 6f66 2065 6d70 7479 2064 6972 6563 746f  of empty directo
-00010bc0: 7279 2069 7320 3139 3730 2d30 312d 3031  ry is 1970-01-01
-00010bd0: 2030 303a 3030 3a30 300a 0a20 2020 2020   00:00:00..     
-00010be0: 2020 203a 7265 7475 726e 733a 2041 6e20     :returns: An 
-00010bf0: 696e 7420 696e 6469 6361 7465 7320 7369  int indicates si
-00010c00: 7a65 2069 6e20 4279 7465 730a 2020 2020  ze in Bytes.    
-00010c10: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-00010c20: 6966 206e 6f74 2073 656c 662e 6973 5f64  if not self.is_d
-00010c30: 6972 2829 3a0a 2020 2020 2020 2020 2020  ir():.          
-00010c40: 2020 7261 6973 6520 5333 4669 6c65 4e6f    raise S3FileNo
-00010c50: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
-00010c60: 2020 2020 2020 2020 2020 2020 2027 4e6f               'No
-00010c70: 2073 7563 6820 6669 6c65 206f 7220 6469   such file or di
-00010c80: 7265 6374 6f72 793a 2025 7227 2025 2073  rectory: %r' % s
-00010c90: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-00010ca0: 6f74 6f63 6f6c 290a 0a20 2020 2020 2020  otocol)..       
-00010cb0: 2062 7563 6b65 742c 206b 6579 203d 2070   bucket, key = p
-00010cc0: 6172 7365 5f73 335f 7572 6c28 7365 6c66  arse_s3_url(self
-00010cd0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-00010ce0: 636f 6c29 0a20 2020 2020 2020 2070 7265  col).        pre
-00010cf0: 6669 7820 3d20 5f62 6563 6f6d 655f 7072  fix = _become_pr
-00010d00: 6566 6978 286b 6579 290a 2020 2020 2020  efix(key).      
-00010d10: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
-00010d20: 5f63 6c69 656e 740a 2020 2020 2020 2020  _client.        
-00010d30: 7369 7a65 203d 2030 0a20 2020 2020 2020  size = 0.       
-00010d40: 206d 7469 6d65 203d 2030 2e30 0a20 2020   mtime = 0.0.   
-00010d50: 2020 2020 2077 6974 6820 7261 6973 655f       with raise_
-00010d60: 7333 5f65 7272 6f72 2873 656c 662e 7061  s3_error(self.pa
-00010d70: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00010d80: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
-00010d90: 6f72 2072 6573 7020 696e 205f 6c69 7374  or resp in _list
-00010da0: 5f6f 626a 6563 7473 5f72 6563 7572 7369  _objects_recursi
-00010db0: 7665 2863 6c69 656e 742c 2062 7563 6b65  ve(client, bucke
-00010dc0: 742c 2070 7265 6669 7829 3a0a 2020 2020  t, prefix):.    
-00010dd0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00010de0: 636f 6e74 656e 7420 696e 2072 6573 702e  content in resp.
-00010df0: 6765 7428 2743 6f6e 7465 6e74 7327 2c20  get('Contents', 
-00010e00: 5b5d 293a 0a20 2020 2020 2020 2020 2020  []):.           
-00010e10: 2020 2020 2020 2020 2073 697a 6520 2b3d           size +=
-00010e20: 2063 6f6e 7465 6e74 5b27 5369 7a65 275d   content['Size']
-00010e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010e40: 2020 2020 206c 6173 745f 6d6f 6469 6669       last_modifi
-00010e50: 6564 203d 2063 6f6e 7465 6e74 5b27 4c61  ed = content['La
-00010e60: 7374 4d6f 6469 6669 6564 275d 2e74 696d  stModified'].tim
-00010e70: 6573 7461 6d70 2829 0a20 2020 2020 2020  estamp().       
-00010e80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00010e90: 6d74 696d 6520 3c20 6c61 7374 5f6d 6f64  mtime < last_mod
-00010ea0: 6966 6965 643a 0a20 2020 2020 2020 2020  ified:.         
-00010eb0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00010ec0: 7469 6d65 203d 206c 6173 745f 6d6f 6469  time = last_modi
-00010ed0: 6669 6564 0a0a 2020 2020 2020 2020 7265  fied..        re
-00010ee0: 7475 726e 2053 7461 7452 6573 756c 7428  turn StatResult(
-00010ef0: 7369 7a65 3d73 697a 652c 206d 7469 6d65  size=size, mtime
-00010f00: 3d6d 7469 6d65 2c20 6973 6469 723d 5472  =mtime, isdir=Tr
-00010f10: 7565 290a 0a20 2020 2064 6566 2073 7461  ue)..    def sta
-00010f20: 7428 7365 6c66 2c20 666f 6c6c 6f77 5f73  t(self, follow_s
-00010f30: 796d 6c69 6e6b 733d 5472 7565 2920 2d3e  ymlinks=True) ->
-00010f40: 2053 7461 7452 6573 756c 743a 0a20 2020   StatResult:.   
-00010f50: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-00010f60: 2047 6574 2053 7461 7452 6573 756c 7420   Get StatResult 
-00010f70: 6f66 2073 335f 7572 6c20 6669 6c65 2c20  of s3_url file, 
-00010f80: 696e 636c 7564 696e 6720 6669 6c65 2073  including file s
-00010f90: 697a 6520 616e 6420 6d74 696d 652c 2072  ize and mtime, r
-00010fa0: 6566 6572 7269 6e67 2074 6f20 7333 5f67  eferring to s3_g
-00010fb0: 6574 7369 7a65 2061 6e64 2073 335f 6765  etsize and s3_ge
-00010fc0: 746d 7469 6d65 0a0a 2020 2020 2020 2020  tmtime..        
-00010fd0: 4966 2073 335f 7572 6c20 6973 206e 6f74  If s3_url is not
-00010fe0: 2061 6e20 6578 6973 7465 6e74 2070 6174   an existent pat
-00010ff0: 682c 2077 6869 6368 206d 6561 6e73 2073  h, which means s
-00011000: 335f 6578 6973 7428 7333 5f75 726c 2920  3_exist(s3_url) 
-00011010: 7265 7475 726e 7320 4661 6c73 652c 2074  returns False, t
-00011020: 6865 6e20 7261 6973 6520 5333 4669 6c65  hen raise S3File
-00011030: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
-00011040: 2020 2020 2020 4966 2061 7474 656d 7074        If attempt
-00011050: 2074 6f20 6765 7420 5374 6174 5265 7375   to get StatResu
-00011060: 6c74 206f 6620 636f 6d70 6c65 7465 2073  lt of complete s
-00011070: 332c 2073 7563 6820 6173 2073 335f 6469  3, such as s3_di
-00011080: 725f 7572 6c20 3d3d 2027 7333 3a2f 2f27  r_url == 's3://'
-00011090: 2c20 7261 6973 6520 5333 4275 636b 6574  , raise S3Bucket
-000110a0: 4e6f 7446 6f75 6e64 4572 726f 720a 0a20  NotFoundError.. 
-000110b0: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-000110c0: 2053 7461 7452 6573 756c 740a 2020 2020   StatResult.    
-000110d0: 2020 2020 3a72 6169 7365 733a 2053 3346      :raises: S3F
-000110e0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-000110f0: 2c20 5333 4275 636b 6574 4e6f 7446 6f75  , S3BucketNotFou
-00011100: 6e64 4572 726f 720a 2020 2020 2020 2020  ndError.        
-00011110: 2727 270a 2020 2020 2020 2020 6973 6c6e  '''.        isln
-00011120: 6b20 3d20 4661 6c73 650a 2020 2020 2020  k = False.      
-00011130: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
-00011140: 7061 7273 655f 7333 5f75 726c 2873 656c  parse_s3_url(sel
-00011150: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-00011160: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
-00011170: 206e 6f74 2062 7563 6b65 743a 0a20 2020   not bucket:.   
-00011180: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
-00011190: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
-000111a0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-000111b0: 2020 2020 2020 2745 6d70 7479 2062 7563        'Empty buc
-000111c0: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
-000111d0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-000111e0: 726f 746f 636f 6c29 0a0a 2020 2020 2020  rotocol)..      
-000111f0: 2020 6966 206e 6f74 2073 656c 662e 6973    if not self.is
-00011200: 5f66 696c 6528 293a 0a20 2020 2020 2020  _file():.       
-00011210: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00011220: 2e5f 6765 7464 6972 7374 6174 2829 0a0a  ._getdirstat()..
-00011230: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-00011240: 2073 656c 662e 5f63 6c69 656e 740a 2020   self._client.  
-00011250: 2020 2020 2020 7769 7468 2072 6169 7365        with raise
-00011260: 5f73 335f 6572 726f 7228 7365 6c66 2e70  _s3_error(self.p
-00011270: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-00011280: 6c29 3a0a 2020 2020 2020 2020 2020 2020  l):.            
-00011290: 636f 6e74 656e 7420 3d20 636c 6965 6e74  content = client
-000112a0: 2e68 6561 645f 6f62 6a65 6374 2842 7563  .head_object(Buc
-000112b0: 6b65 743d 6275 636b 6574 2c20 4b65 793d  ket=bucket, Key=
-000112c0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
-000112d0: 2069 6620 274d 6574 6164 6174 6127 2069   if 'Metadata' i
-000112e0: 6e20 636f 6e74 656e 743a 0a20 2020 2020  n content:.     
-000112f0: 2020 2020 2020 2020 2020 206d 6574 6164             metad
-00011300: 6174 6120 3d20 6469 6374 280a 2020 2020  ata = dict(.    
-00011310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011320: 286b 6579 2e6c 6f77 6572 2829 2c20 7661  (key.lower(), va
-00011330: 6c75 6529 0a20 2020 2020 2020 2020 2020  lue).           
-00011340: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
-00011350: 2c20 7661 6c75 6520 696e 2063 6f6e 7465  , value in conte
-00011360: 6e74 5b27 4d65 7461 6461 7461 275d 2e69  nt['Metadata'].i
-00011370: 7465 6d73 2829 290a 2020 2020 2020 2020  tems()).        
-00011380: 2020 2020 2020 2020 6966 206d 6574 6164          if metad
-00011390: 6174 6120 616e 6420 2773 796d 6c69 6e6b  ata and 'symlink
-000113a0: 5f74 6f27 2069 6e20 6d65 7461 6461 7461  _to' in metadata
-000113b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000113c0: 2020 2020 2020 6973 6c6e 6b20 3d20 5472        islnk = Tr
-000113d0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-000113e0: 2020 2020 2020 2069 6620 6973 6c6e 6b20         if islnk 
-000113f0: 616e 6420 666f 6c6c 6f77 5f73 796d 6c69  and follow_symli
-00011400: 6e6b 733a 0a20 2020 2020 2020 2020 2020  nks:.           
-00011410: 2020 2020 2020 2020 2020 2020 2073 335f               s3_
-00011420: 7572 6c20 3d20 6d65 7461 6461 7461 5b27  url = metadata['
-00011430: 7379 6d6c 696e 6b5f 746f 275d 0a20 2020  symlink_to'].   
-00011440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011450: 2020 2020 2062 7563 6b65 742c 206b 6579       bucket, key
-00011460: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
-00011470: 7333 5f75 726c 290a 2020 2020 2020 2020  s3_url).        
-00011480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011490: 636f 6e74 656e 7420 3d20 636c 6965 6e74  content = client
-000114a0: 2e68 6561 645f 6f62 6a65 6374 2842 7563  .head_object(Buc
-000114b0: 6b65 743d 6275 636b 6574 2c20 4b65 793d  ket=bucket, Key=
-000114c0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
-000114d0: 2073 7461 745f 7265 636f 7264 203d 2053   stat_record = S
-000114e0: 7461 7452 6573 756c 7428 0a20 2020 2020  tatResult(.     
-000114f0: 2020 2020 2020 2020 2020 2069 736c 6e6b             islnk
-00011500: 3d69 736c 6e6b 2c0a 2020 2020 2020 2020  =islnk,.        
-00011510: 2020 2020 2020 2020 7369 7a65 3d63 6f6e          size=con
-00011520: 7465 6e74 5b27 436f 6e74 656e 744c 656e  tent['ContentLen
-00011530: 6774 6827 5d2c 0a20 2020 2020 2020 2020  gth'],.         
-00011540: 2020 2020 2020 206d 7469 6d65 3d63 6f6e         mtime=con
-00011550: 7465 6e74 5b27 4c61 7374 4d6f 6469 6669  tent['LastModifi
-00011560: 6564 275d 2e74 696d 6573 7461 6d70 2829  ed'].timestamp()
-00011570: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011580: 2020 6578 7472 613d 636f 6e74 656e 7429    extra=content)
-00011590: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000115a0: 7374 6174 5f72 6563 6f72 640a 0a20 2020  stat_record..   
-000115b0: 2064 6566 206c 7374 6174 2873 656c 6629   def lstat(self)
-000115c0: 202d 3e20 5374 6174 5265 7375 6c74 3a0a   -> StatResult:.
-000115d0: 2020 2020 2020 2020 2727 274c 696b 6520          '''Like 
-000115e0: 5061 7468 2e73 7461 7428 2920 6275 742c  Path.stat() but,
-000115f0: 2069 6620 7468 6520 7061 7468 2070 6f69   if the path poi
-00011600: 6e74 7320 746f 2061 2073 796d 626f 6c69  nts to a symboli
-00011610: 6320 6c69 6e6b 2c20 7265 7475 726e 2074  c link, return t
-00011620: 6865 2073 796d 626f 6c69 6320 6c69 6e6b  he symbolic link
-00011630: e280 9973 2069 6e66 6f72 6d61 7469 6f6e  ...s information
-00011640: 2072 6174 6865 7220 7468 616e 2069 7473   rather than its
-00011650: 2074 6172 6765 74e2 8099 732e 2727 270a   target...s.'''.
-00011660: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00011670: 656c 662e 7374 6174 2866 6f6c 6c6f 775f  elf.stat(follow_
-00011680: 7379 6d6c 696e 6b73 3d46 616c 7365 290a  symlinks=False).
-00011690: 0a20 2020 2064 6566 2075 6e6c 696e 6b28  .    def unlink(
-000116a0: 7365 6c66 2c20 6d69 7373 696e 675f 6f6b  self, missing_ok
-000116b0: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
-000116c0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-000116d0: 2027 2727 0a20 2020 2020 2020 2052 656d   '''.        Rem
-000116e0: 6f76 6520 7468 6520 6669 6c65 206f 6e20  ove the file on 
-000116f0: 7333 0a0a 2020 2020 2020 2020 3a70 6172  s3..        :par
-00011700: 616d 206d 6973 7369 6e67 5f6f 6b3a 2069  am missing_ok: i
-00011710: 6620 4661 6c73 6520 616e 6420 7461 7267  f False and targ
-00011720: 6574 2066 696c 6520 6e6f 7420 6578 6973  et file not exis
-00011730: 7473 2c20 7261 6973 6520 5333 4669 6c65  ts, raise S3File
-00011740: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
-00011750: 2020 2020 2020 3a72 6169 7365 733a 2053        :raises: S
-00011760: 3350 6572 6d69 7373 696f 6e45 7272 6f72  3PermissionError
-00011770: 2c20 5333 4669 6c65 4e6f 7446 6f75 6e64  , S3FileNotFound
-00011780: 4572 726f 722c 2053 3349 7341 4469 7265  Error, S3IsADire
-00011790: 6374 6f72 7945 7272 6f72 0a20 2020 2020  ctoryError.     
-000117a0: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
-000117b0: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-000117c0: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
-000117d0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-000117e0: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
-000117f0: 7420 6275 636b 6574 206f 7220 6e6f 7420  t bucket or not 
-00011800: 6b65 7920 6f72 206b 6579 2e65 6e64 7377  key or key.endsw
-00011810: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
-00011820: 2020 2020 2020 7261 6973 6520 5333 4973        raise S3Is
-00011830: 4144 6972 6563 746f 7279 4572 726f 7228  ADirectoryError(
-00011840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011850: 2027 4973 2061 2064 6972 6563 746f 7279   'Is a directory
-00011860: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
-00011870: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-00011880: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00011890: 7365 6c66 2e69 735f 6669 6c65 2829 3a0a  self.is_file():.
-000118a0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-000118b0: 6973 7369 6e67 5f6f 6b3a 0a20 2020 2020  issing_ok:.     
-000118c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000118d0: 6e0a 2020 2020 2020 2020 2020 2020 7261  n.            ra
-000118e0: 6973 6520 5333 4669 6c65 4e6f 7446 6f75  ise S3FileNotFou
-000118f0: 6e64 4572 726f 7228 0a20 2020 2020 2020  ndError(.       
-00011900: 2020 2020 2020 2020 2027 4e6f 2073 7563           'No suc
-00011910: 6820 6669 6c65 3a20 2572 2720 2520 7365  h file: %r' % se
-00011920: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-00011930: 746f 636f 6c29 0a0a 2020 2020 2020 2020  tocol)..        
-00011940: 7769 7468 2072 6169 7365 5f73 335f 6572  with raise_s3_er
-00011950: 726f 7228 7365 6c66 2e70 6174 685f 7769  ror(self.path_wi
-00011960: 7468 5f70 726f 746f 636f 6c29 3a0a 2020  th_protocol):.  
-00011970: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00011980: 636c 6965 6e74 2e64 656c 6574 655f 6f62  client.delete_ob
-00011990: 6a65 6374 2842 7563 6b65 743d 6275 636b  ject(Bucket=buck
-000119a0: 6574 2c20 4b65 793d 6b65 7929 0a0a 2020  et, Key=key)..  
-000119b0: 2020 6465 6620 7761 6c6b 2873 656c 662c    def walk(self,
-000119c0: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
-000119d0: 6f6c 203d 2046 616c 7365 0a20 2020 2020  ol = False.     
-000119e0: 2020 2020 2020 2029 202d 3e20 4974 6572         ) -> Iter
-000119f0: 6174 6f72 5b54 7570 6c65 5b73 7472 2c20  ator[Tuple[str, 
-00011a00: 4c69 7374 5b73 7472 5d2c 204c 6973 745b  List[str], List[
-00011a10: 7374 725d 5d5d 3a0a 2020 2020 2020 2020  str]]]:.        
-00011a20: 2727 270a 2020 2020 2020 2020 4974 6572  '''.        Iter
-00011a30: 6174 6976 656c 7920 7472 6176 6572 7365  atively traverse
-00011a40: 2074 6865 2067 6976 656e 2073 3320 6469   the given s3 di
-00011a50: 7265 6374 6f72 792c 2069 6e20 746f 702d  rectory, in top-
-00011a60: 626f 7474 6f6d 206f 7264 6572 2e20 496e  bottom order. In
-00011a70: 206f 7468 6572 2077 6f72 6473 2c20 6669   other words, fi
-00011a80: 7273 746c 7920 7472 6176 6572 7365 2070  rstly traverse p
-00011a90: 6172 656e 7420 6469 7265 6374 6f72 792c  arent directory,
-00011aa0: 2069 6620 7375 6264 6972 6563 746f 7269   if subdirectori
-00011ab0: 6573 2065 7869 7374 2c20 7472 6176 6572  es exist, traver
-00011ac0: 7365 2074 6865 2073 7562 6469 7265 6374  se the subdirect
-00011ad0: 6f72 6965 7320 696e 2061 6c70 6861 6265  ories in alphabe
-00011ae0: 7469 6361 6c20 6f72 6465 722e 0a20 2020  tical order..   
-00011af0: 2020 2020 2045 7665 7279 2069 7465 7261       Every itera
-00011b00: 7469 6f6e 206f 6e20 6765 6e65 7261 746f  tion on generato
-00011b10: 7220 7969 656c 6473 2061 2033 2d74 7570  r yields a 3-tup
-00011b20: 6c65 3a20 2872 6f6f 742c 2064 6972 732c  le: (root, dirs,
-00011b30: 2066 696c 6573 290a 0a20 2020 2020 2020   files)..       
-00011b40: 202d 2072 6f6f 743a 2043 7572 7265 6e74   - root: Current
-00011b50: 2073 3320 7061 7468 3b0a 2020 2020 2020   s3 path;.      
-00011b60: 2020 2d20 6469 7273 3a20 4e61 6d65 206c    - dirs: Name l
-00011b70: 6973 7420 6f66 2073 7562 6469 7265 6374  ist of subdirect
-00011b80: 6f72 6965 7320 696e 2063 7572 7265 6e74  ories in current
-00011b90: 2064 6972 6563 746f 7279 2e20 5468 6520   directory. The 
-00011ba0: 6c69 7374 2069 7320 736f 7274 6564 2062  list is sorted b
-00011bb0: 7920 6e61 6d65 2069 6e20 6173 6365 6e64  y name in ascend
-00011bc0: 696e 6720 616c 7068 6162 6574 6963 616c  ing alphabetical
-00011bd0: 206f 7264 6572 3b0a 2020 2020 2020 2020   order;.        
-00011be0: 2d20 6669 6c65 733a 204e 616d 6520 6c69  - files: Name li
-00011bf0: 7374 206f 6620 6669 6c65 7320 696e 2063  st of files in c
-00011c00: 7572 7265 6e74 2064 6972 6563 746f 7279  urrent directory
-00011c10: 2e20 5468 6520 6c69 7374 2069 7320 736f  . The list is so
-00011c20: 7274 6564 2062 7920 6e61 6d65 2069 6e20  rted by name in 
-00011c30: 6173 6365 6e64 696e 6720 616c 7068 6162  ascending alphab
-00011c40: 6574 6963 616c 206f 7264 6572 3b0a 0a20  etical order;.. 
-00011c50: 2020 2020 2020 2049 6620 7333 5f75 726c         If s3_url
-00011c60: 2069 7320 6120 6669 6c65 2070 6174 682c   is a file path,
-00011c70: 2072 6574 7572 6e20 616e 2065 6d70 7479   return an empty
-00011c80: 2067 656e 6572 6174 6f72 0a20 2020 2020   generator.     
-00011c90: 2020 2049 6620 7333 5f75 726c 2069 7320     If s3_url is 
-00011ca0: 6120 6e6f 6e2d 6578 6973 7465 6e74 2070  a non-existent p
-00011cb0: 6174 682c 2072 6574 7572 6e20 616e 2065  ath, return an e
-00011cc0: 6d70 7479 2067 656e 6572 6174 6f72 0a20  mpty generator. 
-00011cd0: 2020 2020 2020 2049 6620 7333 5f75 726c         If s3_url
-00011ce0: 2069 7320 6120 6275 636b 6574 2070 6174   is a bucket pat
-00011cf0: 682c 2062 7563 6b65 7420 7769 6c6c 2062  h, bucket will b
-00011d00: 6520 7468 6520 746f 7020 6469 7265 6374  e the top direct
-00011d10: 6f72 792c 2061 6e64 2077 696c 6c20 6265  ory, and will be
-00011d20: 2072 6574 7572 6e65 6420 6174 2066 6972   returned at fir
-00011d30: 7374 2069 7465 7261 7469 6f6e 206f 6620  st iteration of 
-00011d40: 6765 6e65 7261 746f 720a 2020 2020 2020  generator.      
-00011d50: 2020 4966 2073 335f 7572 6c20 6973 2061    If s3_url is a
-00011d60: 6e20 656d 7074 7920 6275 636b 6574 2c20  n empty bucket, 
-00011d70: 6f6e 6c79 2079 6965 6c64 206f 6e65 2033  only yield one 3
-00011d80: 2d74 7570 6c65 2028 6e6f 7465 733a 2073  -tuple (notes: s
-00011d90: 3320 646f 6573 6e27 7420 6861 7665 2065  3 doesn't have e
-00011da0: 6d70 7479 2064 6972 6563 746f 7279 290a  mpty directory).
-00011db0: 2020 2020 2020 2020 4966 2073 335f 7572          If s3_ur
-00011dc0: 6c20 646f 6573 6e27 7420 636f 6e74 6169  l doesn't contai
-00011dd0: 6e20 616e 7920 6275 636b 6574 2c20 7768  n any bucket, wh
-00011de0: 6963 6820 6973 2073 335f 7572 6c20 3d3d  ich is s3_url ==
-00011df0: 2027 7333 3a2f 2f27 2c20 7261 6973 6520   's3://', raise 
-00011e00: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
-00011e10: 2e20 7761 6c6b 2829 206f 6e20 636f 6d70  . walk() on comp
-00011e20: 6c65 7465 2073 3320 6973 206e 6f74 2073  lete s3 is not s
-00011e30: 7570 706f 7274 6564 2069 6e20 6d65 6766  upported in megf
-00011e40: 696c 650a 0a20 2020 2020 2020 203a 7061  ile..        :pa
-00011e50: 7261 6d20 666f 6c6c 6f77 6c69 6e6b 733a  ram followlinks:
-00011e60: 2077 6865 7468 6572 2066 6f6c 6c6f 776c   whether followl
-00011e70: 696e 6b73 2069 7320 5472 7565 206f 7220  inks is True or 
-00011e80: 4661 6c73 652c 2072 6573 756c 7420 6973  False, result is
-00011e90: 2074 6865 2073 616d 652e 2042 6563 6175   the same. Becau
-00011ea0: 7365 2073 3320 7379 6d6c 696e 6b20 6e6f  se s3 symlink no
-00011eb0: 7420 7375 7070 6f72 7420 6469 722e 0a20  t support dir.. 
-00011ec0: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
-00011ed0: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
-00011ee0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00011ef0: 733a 2041 2033 2d74 7570 6c65 2067 656e  s: A 3-tuple gen
-00011f00: 6572 6174 6f72 0a20 2020 2020 2020 2027  erator.        '
-00011f10: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
-00011f20: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
-00011f30: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
-00011f40: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
-00011f50: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
-00011f60: 636b 6574 3a0a 2020 2020 2020 2020 2020  cket:.          
-00011f70: 2020 7261 6973 6520 556e 7375 7070 6f72    raise Unsuppor
-00011f80: 7465 6445 7272 6f72 2827 5761 6c6b 2077  tedError('Walk w
-00011f90: 686f 6c65 2073 3327 2c20 7365 6c66 2e70  hole s3', self.p
-00011fa0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-00011fb0: 6c29 0a0a 2020 2020 2020 2020 6966 206e  l)..        if n
-00011fc0: 6f74 2073 656c 662e 6973 5f64 6972 2829  ot self.is_dir()
-00011fd0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00011fe0: 7475 726e 0a0a 2020 2020 2020 2020 7374  turn..        st
-00011ff0: 6163 6b20 3d20 5b6b 6579 5d0a 2020 2020  ack = [key].    
-00012000: 2020 2020 636c 6965 6e74 203d 2073 656c      client = sel
-00012010: 662e 5f63 6c69 656e 740a 2020 2020 2020  f._client.      
-00012020: 2020 7768 696c 6520 6c65 6e28 7374 6163    while len(stac
-00012030: 6b29 203e 2030 3a0a 2020 2020 2020 2020  k) > 0:.        
-00012040: 2020 2020 6375 7272 656e 7420 3d20 5f62      current = _b
-00012050: 6563 6f6d 655f 7072 6566 6978 2873 7461  ecome_prefix(sta
-00012060: 636b 2e70 6f70 2829 290a 2020 2020 2020  ck.pop()).      
-00012070: 2020 2020 2020 6469 7273 2c20 6669 6c65        dirs, file
-00012080: 7320 3d20 5b5d 2c20 5b5d 0a20 2020 2020  s = [], [].     
-00012090: 2020 2020 2020 2066 6f72 2072 6573 7020         for resp 
-000120a0: 696e 205f 6c69 7374 5f6f 626a 6563 7473  in _list_objects
-000120b0: 5f72 6563 7572 7369 7665 2863 6c69 656e  _recursive(clien
-000120c0: 742c 2062 7563 6b65 742c 2063 7572 7265  t, bucket, curre
-000120d0: 6e74 2c20 272f 2729 3a0a 2020 2020 2020  nt, '/'):.      
-000120e0: 2020 2020 2020 2020 2020 666f 7220 636f            for co
-000120f0: 6d6d 6f6e 5f70 7265 6669 7820 696e 2072  mmon_prefix in r
-00012100: 6573 702e 6765 7428 2743 6f6d 6d6f 6e50  esp.get('CommonP
-00012110: 7265 6669 7865 7327 2c20 5b5d 293a 0a20  refixes', []):. 
-00012120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012130: 2020 2064 6972 732e 6170 7065 6e64 2863     dirs.append(c
-00012140: 6f6d 6d6f 6e5f 7072 6566 6978 5b27 5072  ommon_prefix['Pr
-00012150: 6566 6978 275d 5b3a 2d31 5d29 0a20 2020  efix'][:-1]).   
-00012160: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00012170: 2063 6f6e 7465 6e74 2069 6e20 7265 7370   content in resp
-00012180: 2e67 6574 2827 436f 6e74 656e 7473 272c  .get('Contents',
-00012190: 205b 5d29 3a0a 2020 2020 2020 2020 2020   []):.          
-000121a0: 2020 2020 2020 2020 2020 6669 6c65 732e            files.
-000121b0: 6170 7065 6e64 2863 6f6e 7465 6e74 5b27  append(content['
-000121c0: 4b65 7927 5d29 0a0a 2020 2020 2020 2020  Key'])..        
-000121d0: 2020 2020 6469 7273 203d 2073 6f72 7465      dirs = sorte
-000121e0: 6428 6469 7273 290a 2020 2020 2020 2020  d(dirs).        
-000121f0: 2020 2020 7374 6163 6b2e 6578 7465 6e64      stack.extend
-00012200: 2872 6576 6572 7365 6428 6469 7273 2929  (reversed(dirs))
-00012210: 0a0a 2020 2020 2020 2020 2020 2020 726f  ..            ro
-00012220: 6f74 203d 2073 335f 7061 7468 5f6a 6f69  ot = s3_path_joi
-00012230: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00012240: 2020 2066 277b 7365 6c66 2e5f 7072 6f74     f'{self._prot
-00012250: 6f63 6f6c 5f77 6974 685f 7072 6f66 696c  ocol_with_profil
-00012260: 657d 3a2f 2f27 2c20 6275 636b 6574 2c20  e}://', bucket, 
-00012270: 6375 7272 656e 7429 5b3a 2d31 5d0a 2020  current)[:-1].  
-00012280: 2020 2020 2020 2020 2020 6469 7273 203d            dirs =
-00012290: 205b 7061 7468 5b6c 656e 2863 7572 7265   [path[len(curre
-000122a0: 6e74 293a 5d20 666f 7220 7061 7468 2069  nt):] for path i
-000122b0: 6e20 6469 7273 5d0a 2020 2020 2020 2020  n dirs].        
-000122c0: 2020 2020 6669 6c65 7320 3d20 736f 7274      files = sort
-000122d0: 6564 2870 6174 685b 6c65 6e28 6375 7272  ed(path[len(curr
-000122e0: 656e 7429 3a5d 2066 6f72 2070 6174 6820  ent):] for path 
-000122f0: 696e 2066 696c 6573 290a 2020 2020 2020  in files).      
-00012300: 2020 2020 2020 7969 656c 6420 726f 6f74        yield root
-00012310: 2c20 6469 7273 2c20 6669 6c65 730a 0a20  , dirs, files.. 
-00012320: 2020 2064 6566 206d 6435 2873 656c 662c     def md5(self,
-00012330: 2072 6563 616c 6375 6c61 7465 3a20 626f   recalculate: bo
-00012340: 6f6c 203d 2046 616c 7365 2c20 666f 6c6c  ol = False, foll
-00012350: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
-00012360: 4661 6c73 6529 202d 3e20 7374 723a 0a20  False) -> str:. 
-00012370: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-00012380: 2020 2047 6574 206d 6435 206d 6574 6120     Get md5 meta 
-00012390: 696e 666f 2069 6e20 6669 6c65 7320 7468  info in files th
-000123a0: 6174 2075 706c 6f61 6465 642f 636f 7069  at uploaded/copi
-000123b0: 6564 2076 6961 206d 6567 6669 6c65 0a0a  ed via megfile..
-000123c0: 2020 2020 2020 2020 4966 206d 6574 6120          If meta 
-000123d0: 696e 666f 2069 7320 6c6f 7374 206f 7220  info is lost or 
-000123e0: 6e6f 6e2d 6578 6973 7465 6e74 2c20 7265  non-existent, re
-000123f0: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
-00012400: 2020 203a 7061 7261 6d20 7265 6361 6c63     :param recalc
-00012410: 756c 6174 653a 2063 616c 6375 6c61 7465  ulate: calculate
-00012420: 206d 6435 2069 6e20 7265 616c 2d74 696d   md5 in real-tim
-00012430: 6520 6f72 2072 6574 7572 6e20 7333 2065  e or return s3 e
-00012440: 7461 670a 2020 2020 2020 2020 3a70 6172  tag.        :par
-00012450: 616d 2066 6f6c 6c6f 776c 696e 6b73 3a20  am followlinks: 
-00012460: 4966 2069 7320 5472 7565 2c20 6361 6c63  If is True, calc
-00012470: 756c 6174 6520 6d64 3520 666f 7220 7265  ulate md5 for re
-00012480: 616c 2066 696c 650a 2020 2020 2020 2020  al file.        
-00012490: 3a72 6574 7572 6e73 3a20 6d64 3520 6d65  :returns: md5 me
-000124a0: 7461 2069 6e66 6f0a 2020 2020 2020 2020  ta info.        
-000124b0: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
-000124c0: 6574 2c20 5f20 3d20 7061 7273 655f 7333  et, _ = parse_s3
-000124d0: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
-000124e0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-000124f0: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
-00012500: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
-00012510: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
-00012520: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
-00012530: 2020 2020 2020 2020 2020 2020 2020 2745                'E
-00012540: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
-00012550: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
-00012560: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-00012570: 0a20 2020 2020 2020 2073 7461 7420 3d20  .        stat = 
-00012580: 7365 6c66 2e73 7461 7428 666f 6c6c 6f77  self.stat(follow
-00012590: 5f73 796d 6c69 6e6b 733d 666f 6c6c 6f77  _symlinks=follow
-000125a0: 6c69 6e6b 7329 0a20 2020 2020 2020 2069  links).        i
-000125b0: 6620 7374 6174 2e69 7364 6972 3a0a 2020  f stat.isdir:.  
-000125c0: 2020 2020 2020 2020 2020 6861 7368 5f6d            hash_m
-000125d0: 6435 203d 2068 6173 686c 6962 2e6d 6435  d5 = hashlib.md5
-000125e0: 2829 2020 2320 6e6f 7365 630a 2020 2020  ()  # nosec.    
-000125f0: 2020 2020 2020 2020 666f 7220 6669 6c65          for file
-00012600: 5f6e 616d 6520 696e 2073 656c 662e 6c69  _name in self.li
-00012610: 7374 6469 7228 293a 0a20 2020 2020 2020  stdir():.       
-00012620: 2020 2020 2020 2020 2063 6875 6e6b 203d           chunk =
-00012630: 2053 3350 6174 6828 0a20 2020 2020 2020   S3Path(.       
-00012640: 2020 2020 2020 2020 2020 2020 2073 335f               s3_
-00012650: 7061 7468 5f6a 6f69 6e28 0a20 2020 2020  path_join(.     
-00012660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012670: 2020 2073 656c 662e 7061 7468 5f77 6974     self.path_wit
-00012680: 685f 7072 6f74 6f63 6f6c 2c0a 2020 2020  h_protocol,.    
-00012690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126a0: 2020 2020 6669 6c65 5f6e 616d 6529 292e      file_name)).
-000126b0: 6d64 3528 7265 6361 6c63 756c 6174 653d  md5(recalculate=
-000126c0: 7265 6361 6c63 756c 6174 6529 2e65 6e63  recalculate).enc
-000126d0: 6f64 6528 290a 2020 2020 2020 2020 2020  ode().          
-000126e0: 2020 2020 2020 6861 7368 5f6d 6435 2e75        hash_md5.u
-000126f0: 7064 6174 6528 6368 756e 6b29 0a20 2020  pdate(chunk).   
-00012700: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00012710: 6861 7368 5f6d 6435 2e68 6578 6469 6765  hash_md5.hexdige
-00012720: 7374 2829 0a20 2020 2020 2020 2069 6620  st().        if 
-00012730: 7265 6361 6c63 756c 6174 653a 0a20 2020  recalculate:.   
-00012740: 2020 2020 2020 2020 2070 6174 685f 696e           path_in
-00012750: 7374 616e 6365 203d 2073 656c 660a 2020  stance = self.  
-00012760: 2020 2020 2020 2020 2020 6966 2066 6f6c            if fol
-00012770: 6c6f 776c 696e 6b73 3a0a 2020 2020 2020  lowlinks:.      
-00012780: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00012790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127a0: 2020 2070 6174 685f 696e 7374 616e 6365     path_instance
-000127b0: 203d 2073 656c 662e 7265 6164 6c69 6e6b   = self.readlink
-000127c0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-000127d0: 2020 2065 7863 6570 7420 5333 4e6f 7441     except S3NotA
-000127e0: 4c69 6e6b 4572 726f 723a 0a20 2020 2020  LinkError:.     
-000127f0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00012800: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-00012810: 7769 7468 2070 6174 685f 696e 7374 616e  with path_instan
-00012820: 6365 2e6f 7065 6e28 2772 6227 2920 6173  ce.open('rb') as
-00012830: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
-00012840: 2020 2020 7265 7475 726e 2063 616c 6375      return calcu
-00012850: 6c61 7465 5f6d 6435 2866 290a 2020 2020  late_md5(f).    
-00012860: 2020 2020 7265 7475 726e 2073 7461 742e      return stat.
-00012870: 6578 7472 612e 6765 7428 2745 5461 6727  extra.get('ETag'
-00012880: 2c20 2727 295b 313a 2d31 5d0a 0a20 2020  , '')[1:-1]..   
-00012890: 2064 6566 2063 6f70 7928 0a20 2020 2020   def copy(.     
-000128a0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-000128b0: 2020 2020 2020 2020 2064 7374 5f75 726c           dst_url
-000128c0: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
-000128d0: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
-000128e0: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
-000128f0: 652c 0a20 2020 2020 2020 2020 2020 2063  e,.            c
-00012900: 616c 6c62 6163 6b3a 204f 7074 696f 6e61  allback: Optiona
-00012910: 6c5b 4361 6c6c 6162 6c65 5b5b 696e 745d  l[Callable[[int]
-00012920: 2c20 4e6f 6e65 5d5d 203d 204e 6f6e 6529  , None]] = None)
-00012930: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00012940: 2020 2727 2720 4669 6c65 2063 6f70 7920    ''' File copy 
-00012950: 6f6e 2053 330a 2020 2020 2020 2020 436f  on S3.        Co
-00012960: 7079 2063 6f6e 7465 6e74 206f 6620 6669  py content of fi
-00012970: 6c65 206f 6e20 6073 7263 5f70 6174 6860  le on `src_path`
-00012980: 2074 6f20 6064 7374 5f70 6174 6860 2e0a   to `dst_path`..
-00012990: 2020 2020 2020 2020 4974 2773 2063 616c          It's cal
-000129a0: 6c65 7227 7320 7265 7370 6f6e 7365 6269  ler's responsebi
-000129b0: 6c69 7479 2074 6f20 656e 7375 7265 2074  lity to ensure t
-000129c0: 6865 2073 335f 6973 6669 6c65 2873 7263  he s3_isfile(src
-000129d0: 5f75 726c 2920 3d3d 2054 7275 650a 0a20  _url) == True.. 
-000129e0: 2020 2020 2020 203a 7061 7261 6d20 6473         :param ds
-000129f0: 745f 7061 7468 3a20 5461 7267 6574 2066  t_path: Target f
-00012a00: 696c 6520 7061 7468 0a20 2020 2020 2020  ile path.       
-00012a10: 203a 7061 7261 6d20 6361 6c6c 6261 636b   :param callback
-00012a20: 3a20 4361 6c6c 6564 2070 6572 696f 6469  : Called periodi
-00012a30: 6361 6c6c 7920 6475 7269 6e67 2063 6f70  cally during cop
-00012a40: 792c 2061 6e64 2074 6865 2069 6e70 7574  y, and the input
-00012a50: 2070 6172 616d 6574 6572 2069 7320 7468   parameter is th
-00012a60: 6520 6461 7461 2073 697a 6520 2869 6e20  e data size (in 
-00012a70: 6279 7465 7329 206f 6620 636f 7079 2073  bytes) of copy s
-00012a80: 696e 6365 2074 6865 206c 6173 7420 6361  ince the last ca
-00012a90: 6c6c 0a20 2020 2020 2020 2027 2727 0a20  ll.        '''. 
-00012aa0: 2020 2020 2020 2073 7263 5f75 726c 203d         src_url =
-00012ab0: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-00012ac0: 7072 6f74 6f63 6f6c 0a20 2020 2020 2020  protocol.       
-00012ad0: 2073 7263 5f62 7563 6b65 742c 2073 7263   src_bucket, src
-00012ae0: 5f6b 6579 203d 2070 6172 7365 5f73 335f  _key = parse_s3_
-00012af0: 7572 6c28 7372 635f 7572 6c29 0a20 2020  url(src_url).   
-00012b00: 2020 2020 2064 7374 5f62 7563 6b65 742c       dst_bucket,
-00012b10: 2064 7374 5f6b 6579 203d 2070 6172 7365   dst_key = parse
-00012b20: 5f73 335f 7572 6c28 6473 745f 7572 6c29  _s3_url(dst_url)
-00012b30: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00012b40: 2073 7263 5f62 7563 6b65 743a 0a20 2020   src_bucket:.   
-00012b50: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
-00012b60: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
-00012b70: 7272 6f72 2827 456d 7074 7920 6275 636b  rror('Empty buck
-00012b80: 6574 206e 616d 653a 2025 7227 2025 2073  et name: %r' % s
-00012b90: 7263 5f75 726c 290a 2020 2020 2020 2020  rc_url).        
-00012ba0: 6966 2073 656c 662e 6973 5f64 6972 2829  if self.is_dir()
-00012bb0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00012bc0: 6973 6520 5333 4973 4144 6972 6563 746f  ise S3IsADirecto
-00012bd0: 7279 4572 726f 7228 2749 7320 6120 6469  ryError('Is a di
-00012be0: 7265 6374 6f72 793a 2025 7227 2025 2073  rectory: %r' % s
-00012bf0: 7263 5f75 726c 290a 0a20 2020 2020 2020  rc_url)..       
-00012c00: 2069 6620 6e6f 7420 6473 745f 6275 636b   if not dst_buck
-00012c10: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
-00012c20: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
-00012c30: 7446 6f75 6e64 4572 726f 7228 2745 6d70  tFoundError('Emp
-00012c40: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
-00012c50: 2572 2720 2520 6473 745f 7572 6c29 0a20  %r' % dst_url). 
-00012c60: 2020 2020 2020 2069 6620 6e6f 7420 6473         if not ds
-00012c70: 745f 6b65 7920 6f72 2064 7374 5f6b 6579  t_key or dst_key
-00012c80: 2e65 6e64 7377 6974 6828 272f 2729 3a0a  .endswith('/'):.
-00012c90: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00012ca0: 6520 5333 4973 4144 6972 6563 746f 7279  e S3IsADirectory
-00012cb0: 4572 726f 7228 2749 7320 6120 6469 7265  Error('Is a dire
-00012cc0: 6374 6f72 793a 2025 7227 2025 2064 7374  ctory: %r' % dst
-00012cd0: 5f75 726c 290a 0a20 2020 2020 2020 2069  _url)..        i
-00012ce0: 6620 666f 6c6c 6f77 6c69 6e6b 733a 0a20  f followlinks:. 
-00012cf0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00012d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d10: 7333 5f75 726c 203d 2073 656c 662e 7265  s3_url = self.re
-00012d20: 6164 6c69 6e6b 2829 2e70 6174 680a 2020  adlink().path.  
-00012d30: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00012d40: 635f 6275 636b 6574 2c20 7372 635f 6b65  c_bucket, src_ke
-00012d50: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
-00012d60: 2873 335f 7572 6c29 0a20 2020 2020 2020  (s3_url).       
-00012d70: 2020 2020 2065 7863 6570 7420 5333 4e6f       except S3No
-00012d80: 7441 4c69 6e6b 4572 726f 723a 0a20 2020  tALinkError:.   
-00012d90: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-00012da0: 730a 0a20 2020 2020 2020 2074 7279 3a0a  s..        try:.
-00012db0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012dc0: 2e5f 636c 6965 6e74 2e63 6f70 7928 0a20  ._client.copy(. 
-00012dd0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00012de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012df0: 2020 2020 2027 4275 636b 6574 273a 2073       'Bucket': s
-00012e00: 7263 5f62 7563 6b65 742c 0a20 2020 2020  rc_bucket,.     
-00012e10: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00012e20: 4b65 7927 3a20 7372 635f 6b65 792c 0a20  Key': src_key,. 
-00012e30: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00012e40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012e50: 2020 4275 636b 6574 3d64 7374 5f62 7563    Bucket=dst_buc
-00012e60: 6b65 742c 0a20 2020 2020 2020 2020 2020  ket,.           
-00012e70: 2020 2020 204b 6579 3d64 7374 5f6b 6579       Key=dst_key
-00012e80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012e90: 2020 4361 6c6c 6261 636b 3d63 616c 6c62    Callback=callb
-00012ea0: 6163 6b29 0a20 2020 2020 2020 2065 7863  ack).        exc
-00012eb0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00012ec0: 2065 7272 6f72 3a0a 2020 2020 2020 2020   error:.        
-00012ed0: 2020 2020 6572 726f 7220 3d20 7472 616e      error = tran
-00012ee0: 736c 6174 655f 7333 5f65 7272 6f72 2865  slate_s3_error(e
-00012ef0: 7272 6f72 2c20 6473 745f 7572 6c29 0a20  rror, dst_url). 
-00012f00: 2020 2020 2020 2020 2020 2023 2045 7272             # Err
-00012f10: 6f72 2063 616e 2774 2068 656c 7020 7465  or can't help te
-00012f20: 6c6c 2077 6869 6368 2069 7320 7072 6f62  ll which is prob
-00012f30: 6c65 6d61 7469 630a 2020 2020 2020 2020  lematic.        
-00012f40: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00012f50: 6528 6572 726f 722c 2053 3342 7563 6b65  e(error, S3Bucke
-00012f60: 744e 6f74 466f 756e 6445 7272 6f72 293a  tNotFoundError):
-00012f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012f80: 2069 6620 6e6f 7420 7365 6c66 2e68 6173   if not self.has
-00012f90: 6275 636b 6574 2829 3a0a 2020 2020 2020  bucket():.      
-00012fa0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00012fb0: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
-00012fc0: 6f75 6e64 4572 726f 7228 274e 6f20 7375  oundError('No su
-00012fd0: 6368 2062 7563 6b65 743a 2025 7227 2025  ch bucket: %r' %
-00012fe0: 2073 7263 5f75 726c 290a 2020 2020 2020   src_url).      
-00012ff0: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-00013000: 7461 6e63 6528 6572 726f 722c 2053 3346  tance(error, S3F
-00013010: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-00013020: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00013030: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
-00013040: 735f 6669 6c65 2829 3a0a 2020 2020 2020  s_file():.      
-00013050: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00013060: 6973 6520 5333 4669 6c65 4e6f 7446 6f75  ise S3FileNotFou
+000107b0: 2020 2020 2020 6765 6e65 7261 7465 5f73        generate_s
+000107c0: 335f 7061 7468 280a 2020 2020 2020 2020  3_path(.        
+000107d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107e0: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
+000107f0: 6f74 6f63 6f6c 5f77 6974 685f 7072 6f66  otocol_with_prof
+00010800: 696c 652c 2062 7563 6b65 742c 0a20 2020  ile, bucket,.   
+00010810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010820: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00010830: 6d6f 6e5f 7072 6566 6978 5b27 5072 6566  mon_prefix['Pref
+00010840: 6978 275d 292c 0a20 2020 2020 2020 2020  ix']),.         
+00010850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010860: 2020 2053 7461 7452 6573 756c 7428 6973     StatResult(is
+00010870: 6469 723d 5472 7565 2c20 6578 7472 613d  dir=True, extra=
+00010880: 636f 6d6d 6f6e 5f70 7265 6669 7829 290a  common_prefix)).
+00010890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108a0: 2020 2020 666f 7220 636f 6e74 656e 7420      for content 
+000108b0: 696e 2072 6573 702e 6765 7428 2743 6f6e  in resp.get('Con
+000108c0: 7465 6e74 7327 2c20 5b5d 293a 0a20 2020  tents', []):.   
+000108d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108e0: 2020 2020 2073 7263 5f75 726c 203d 2067       src_url = g
+000108f0: 656e 6572 6174 655f 7333 5f70 6174 6828  enerate_s3_path(
+00010900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010910: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00010920: 662e 5f70 726f 746f 636f 6c5f 7769 7468  f._protocol_with
+00010930: 5f70 726f 6669 6c65 2c20 6275 636b 6574  _profile, bucket
+00010940: 2c20 636f 6e74 656e 745b 274b 6579 275d  , content['Key']
+00010950: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00010960: 2020 2020 2020 2020 2020 2069 6620 666f             if fo
+00010970: 6c6c 6f77 6c69 6e6b 7320 616e 6420 5333  llowlinks and S3
+00010980: 5061 7468 2873 7263 5f75 726c 292e 6973  Path(src_url).is
+00010990: 5f73 796d 6c69 6e6b 2829 3a0a 2020 2020  _symlink():.    
+000109a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109b0: 2020 2020 2020 2020 636f 6e74 656e 745b          content[
+000109c0: 2769 736c 6e6b 275d 203d 2054 7275 650a  'islnk'] = True.
+000109d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000109e0: 2020 2020 2020 2020 2079 6965 6c64 2046           yield F
+000109f0: 696c 6545 6e74 7279 280a 2020 2020 2020  ileEntry(.      
+00010a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a10: 2020 2020 2020 636f 6e74 656e 745b 274b        content['K
+00010a20: 6579 275d 5b6c 656e 2870 7265 6669 7829  ey'][len(prefix)
+00010a30: 3a5d 2c20 7372 635f 7572 6c2c 0a20 2020  :], src_url,.   
+00010a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a50: 2020 2020 2020 2020 205f 6d61 6b65 5f73           _make_s
+00010a60: 7461 7428 636f 6e74 656e 7429 290a 0a20  tat(content)).. 
+00010a70: 2020 2020 2020 2072 6574 7572 6e20 436f         return Co
+00010a80: 6e74 6578 7449 7465 7261 746f 7228 6372  ntextIterator(cr
+00010a90: 6561 7465 5f67 656e 6572 6174 6f72 2829  eate_generator()
+00010aa0: 290a 0a20 2020 2064 6566 205f 6765 7464  )..    def _getd
+00010ab0: 6972 7374 6174 2873 656c 6629 202d 3e20  irstat(self) -> 
+00010ac0: 5374 6174 5265 7375 6c74 3a0a 2020 2020  StatResult:.    
+00010ad0: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+00010ae0: 5265 7475 726e 2053 7461 7452 6573 756c  Return StatResul
+00010af0: 7420 6f66 2067 6976 656e 2073 335f 7572  t of given s3_ur
+00010b00: 6c20 6469 7265 6374 6f72 792c 2069 6e63  l directory, inc
+00010b10: 6c75 6469 6e67 3a20 0a0a 2020 2020 2020  luding: ..      
+00010b20: 2020 312e 2044 6972 6563 746f 7279 2073    1. Directory s
+00010b30: 697a 653a 2074 6865 2073 756d 206f 6620  ize: the sum of 
+00010b40: 616c 6c20 6669 6c65 2073 697a 6520 696e  all file size in
+00010b50: 2069 742c 2069 6e63 6c75 6469 6e67 2066   it, including f
+00010b60: 696c 6520 696e 2073 7562 6469 7265 6374  ile in subdirect
+00010b70: 6f72 6965 7320 2869 6620 6578 6973 7429  ories (if exist)
+00010b80: 2e0a 2020 2020 2020 2020 5468 6520 7265  ..        The re
+00010b90: 7375 6c74 2065 7863 6c75 6465 7320 7468  sult excludes th
+00010ba0: 6520 7369 7a65 206f 6620 6469 7265 6374  e size of direct
+00010bb0: 6f72 7920 6974 7365 6c66 2e20 496e 206f  ory itself. In o
+00010bc0: 7468 6572 2077 6f72 6473 2c20 7265 7475  ther words, retu
+00010bd0: 726e 2030 2042 7974 6520 6f6e 2061 6e20  rn 0 Byte on an 
+00010be0: 656d 7074 7920 6469 7265 6374 6f72 7920  empty directory 
+00010bf0: 7061 7468 0a20 2020 2020 2020 2032 2e20  path.        2. 
+00010c00: 4c61 7374 2d6d 6f64 6966 6965 6420 7469  Last-modified ti
+00010c10: 6d65 206f 6620 6469 7265 6374 6f72 793a  me of directory:
+00010c20: 2072 6574 7572 6e20 7468 6520 6c61 7465   return the late
+00010c30: 7374 206d 6f64 6966 6965 6420 7469 6d65  st modified time
+00010c40: 206f 6620 616c 6c20 6669 6c65 2069 6e20   of all file in 
+00010c50: 6974 2e20 5468 6520 6d74 696d 6520 6f66  it. The mtime of
+00010c60: 2065 6d70 7479 2064 6972 6563 746f 7279   empty directory
+00010c70: 2069 7320 3139 3730 2d30 312d 3031 2030   is 1970-01-01 0
+00010c80: 303a 3030 3a30 300a 0a20 2020 2020 2020  0:00:00..       
+00010c90: 203a 7265 7475 726e 733a 2041 6e20 696e   :returns: An in
+00010ca0: 7420 696e 6469 6361 7465 7320 7369 7a65  t indicates size
+00010cb0: 2069 6e20 4279 7465 730a 2020 2020 2020   in Bytes.      
+00010cc0: 2020 2727 270a 2020 2020 2020 2020 6966    '''.        if
+00010cd0: 206e 6f74 2073 656c 662e 6973 5f64 6972   not self.is_dir
+00010ce0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00010cf0: 7261 6973 6520 5333 4669 6c65 4e6f 7446  raise S3FileNotF
+00010d00: 6f75 6e64 4572 726f 7228 0a20 2020 2020  oundError(.     
+00010d10: 2020 2020 2020 2020 2020 2027 4e6f 2073             'No s
+00010d20: 7563 6820 6669 6c65 206f 7220 6469 7265  uch file or dire
+00010d30: 6374 6f72 793a 2025 7227 2025 2073 656c  ctory: %r' % sel
+00010d40: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+00010d50: 6f63 6f6c 290a 0a20 2020 2020 2020 2062  ocol)..        b
+00010d60: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+00010d70: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
+00010d80: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00010d90: 6c29 0a20 2020 2020 2020 2070 7265 6669  l).        prefi
+00010da0: 7820 3d20 5f62 6563 6f6d 655f 7072 6566  x = _become_pref
+00010db0: 6978 286b 6579 290a 2020 2020 2020 2020  ix(key).        
+00010dc0: 636c 6965 6e74 203d 2073 656c 662e 5f63  client = self._c
+00010dd0: 6c69 656e 740a 2020 2020 2020 2020 7369  lient.        si
+00010de0: 7a65 203d 2030 0a20 2020 2020 2020 206d  ze = 0.        m
+00010df0: 7469 6d65 203d 2030 2e30 0a20 2020 2020  time = 0.0.     
+00010e00: 2020 2077 6974 6820 7261 6973 655f 7333     with raise_s3
+00010e10: 5f65 7272 6f72 2873 656c 662e 7061 7468  _error(self.path
+00010e20: 5f77 6974 685f 7072 6f74 6f63 6f6c 293a  _with_protocol):
+00010e30: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00010e40: 2072 6573 7020 696e 205f 6c69 7374 5f6f   resp in _list_o
+00010e50: 626a 6563 7473 5f72 6563 7572 7369 7665  bjects_recursive
+00010e60: 2863 6c69 656e 742c 2062 7563 6b65 742c  (client, bucket,
+00010e70: 2070 7265 6669 7829 3a0a 2020 2020 2020   prefix):.      
+00010e80: 2020 2020 2020 2020 2020 666f 7220 636f            for co
+00010e90: 6e74 656e 7420 696e 2072 6573 702e 6765  ntent in resp.ge
+00010ea0: 7428 2743 6f6e 7465 6e74 7327 2c20 5b5d  t('Contents', []
+00010eb0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00010ec0: 2020 2020 2020 2073 697a 6520 2b3d 2063         size += c
+00010ed0: 6f6e 7465 6e74 5b27 5369 7a65 275d 0a20  ontent['Size']. 
+00010ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ef0: 2020 206c 6173 745f 6d6f 6469 6669 6564     last_modified
+00010f00: 203d 2063 6f6e 7465 6e74 5b27 4c61 7374   = content['Last
+00010f10: 4d6f 6469 6669 6564 275d 2e74 696d 6573  Modified'].times
+00010f20: 7461 6d70 2829 0a20 2020 2020 2020 2020  tamp().         
+00010f30: 2020 2020 2020 2020 2020 2069 6620 6d74             if mt
+00010f40: 696d 6520 3c20 6c61 7374 5f6d 6f64 6966  ime < last_modif
+00010f50: 6965 643a 0a20 2020 2020 2020 2020 2020  ied:.           
+00010f60: 2020 2020 2020 2020 2020 2020 206d 7469               mti
+00010f70: 6d65 203d 206c 6173 745f 6d6f 6469 6669  me = last_modifi
+00010f80: 6564 0a0a 2020 2020 2020 2020 7265 7475  ed..        retu
+00010f90: 726e 2053 7461 7452 6573 756c 7428 7369  rn StatResult(si
+00010fa0: 7a65 3d73 697a 652c 206d 7469 6d65 3d6d  ze=size, mtime=m
+00010fb0: 7469 6d65 2c20 6973 6469 723d 5472 7565  time, isdir=True
+00010fc0: 290a 0a20 2020 2064 6566 2073 7461 7428  )..    def stat(
+00010fd0: 7365 6c66 2c20 666f 6c6c 6f77 5f73 796d  self, follow_sym
+00010fe0: 6c69 6e6b 733d 5472 7565 2920 2d3e 2053  links=True) -> S
+00010ff0: 7461 7452 6573 756c 743a 0a20 2020 2020  tatResult:.     
+00011000: 2020 2027 2727 0a20 2020 2020 2020 2047     '''.        G
+00011010: 6574 2053 7461 7452 6573 756c 7420 6f66  et StatResult of
+00011020: 2073 335f 7572 6c20 6669 6c65 2c20 696e   s3_url file, in
+00011030: 636c 7564 696e 6720 6669 6c65 2073 697a  cluding file siz
+00011040: 6520 616e 6420 6d74 696d 652c 2072 6566  e and mtime, ref
+00011050: 6572 7269 6e67 2074 6f20 7333 5f67 6574  erring to s3_get
+00011060: 7369 7a65 2061 6e64 2073 335f 6765 746d  size and s3_getm
+00011070: 7469 6d65 0a0a 2020 2020 2020 2020 4966  time..        If
+00011080: 2073 335f 7572 6c20 6973 206e 6f74 2061   s3_url is not a
+00011090: 6e20 6578 6973 7465 6e74 2070 6174 682c  n existent path,
+000110a0: 2077 6869 6368 206d 6561 6e73 2073 335f   which means s3_
+000110b0: 6578 6973 7428 7333 5f75 726c 2920 7265  exist(s3_url) re
+000110c0: 7475 726e 7320 4661 6c73 652c 2074 6865  turns False, the
+000110d0: 6e20 7261 6973 6520 5333 4669 6c65 4e6f  n raise S3FileNo
+000110e0: 7446 6f75 6e64 4572 726f 720a 2020 2020  tFoundError.    
+000110f0: 2020 2020 4966 2061 7474 656d 7074 2074      If attempt t
+00011100: 6f20 6765 7420 5374 6174 5265 7375 6c74  o get StatResult
+00011110: 206f 6620 636f 6d70 6c65 7465 2073 332c   of complete s3,
+00011120: 2073 7563 6820 6173 2073 335f 6469 725f   such as s3_dir_
+00011130: 7572 6c20 3d3d 2027 7333 3a2f 2f27 2c20  url == 's3://', 
+00011140: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
+00011150: 7446 6f75 6e64 4572 726f 720a 0a20 2020  tFoundError..   
+00011160: 2020 2020 203a 7265 7475 726e 733a 2053       :returns: S
+00011170: 7461 7452 6573 756c 740a 2020 2020 2020  tatResult.      
+00011180: 2020 3a72 6169 7365 733a 2053 3346 696c    :raises: S3Fil
+00011190: 654e 6f74 466f 756e 6445 7272 6f72 2c20  eNotFoundError, 
+000111a0: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+000111b0: 4572 726f 720a 2020 2020 2020 2020 2727  Error.        ''
+000111c0: 270a 2020 2020 2020 2020 6973 6c6e 6b20  '.        islnk 
+000111d0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+000111e0: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
+000111f0: 7273 655f 7333 5f75 726c 2873 656c 662e  rse_s3_url(self.
+00011200: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+00011210: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
+00011220: 6f74 2062 7563 6b65 743a 0a20 2020 2020  ot bucket:.     
+00011230: 2020 2020 2020 2072 6169 7365 2053 3342         raise S3B
+00011240: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
+00011250: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00011260: 2020 2020 2745 6d70 7479 2062 7563 6b65      'Empty bucke
+00011270: 7420 6e61 6d65 3a20 2572 2720 2520 7365  t name: %r' % se
+00011280: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+00011290: 746f 636f 6c29 0a0a 2020 2020 2020 2020  tocol)..        
+000112a0: 6966 206e 6f74 2073 656c 662e 6973 5f66  if not self.is_f
+000112b0: 696c 6528 293a 0a20 2020 2020 2020 2020  ile():.         
+000112c0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+000112d0: 6765 7464 6972 7374 6174 2829 0a0a 2020  getdirstat()..  
+000112e0: 2020 2020 2020 636c 6965 6e74 203d 2073        client = s
+000112f0: 656c 662e 5f63 6c69 656e 740a 2020 2020  elf._client.    
+00011300: 2020 2020 7769 7468 2072 6169 7365 5f73      with raise_s
+00011310: 335f 6572 726f 7228 7365 6c66 2e70 6174  3_error(self.pat
+00011320: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+00011330: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+00011340: 6e74 656e 7420 3d20 636c 6965 6e74 2e68  ntent = client.h
+00011350: 6561 645f 6f62 6a65 6374 2842 7563 6b65  ead_object(Bucke
+00011360: 743d 6275 636b 6574 2c20 4b65 793d 6b65  t=bucket, Key=ke
+00011370: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
+00011380: 6620 274d 6574 6164 6174 6127 2069 6e20  f 'Metadata' in 
+00011390: 636f 6e74 656e 743a 0a20 2020 2020 2020  content:.       
+000113a0: 2020 2020 2020 2020 206d 6574 6164 6174           metadat
+000113b0: 6120 3d20 6469 6374 280a 2020 2020 2020  a = dict(.      
+000113c0: 2020 2020 2020 2020 2020 2020 2020 286b                (k
+000113d0: 6579 2e6c 6f77 6572 2829 2c20 7661 6c75  ey.lower(), valu
+000113e0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+000113f0: 2020 2020 2020 2066 6f72 206b 6579 2c20         for key, 
+00011400: 7661 6c75 6520 696e 2063 6f6e 7465 6e74  value in content
+00011410: 5b27 4d65 7461 6461 7461 275d 2e69 7465  ['Metadata'].ite
+00011420: 6d73 2829 290a 2020 2020 2020 2020 2020  ms()).          
+00011430: 2020 2020 2020 6966 206d 6574 6164 6174        if metadat
+00011440: 6120 616e 6420 2773 796d 6c69 6e6b 5f74  a and 'symlink_t
+00011450: 6f27 2069 6e20 6d65 7461 6461 7461 3a0a  o' in metadata:.
+00011460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011470: 2020 2020 6973 6c6e 6b20 3d20 5472 7565      islnk = True
+00011480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011490: 2020 2020 2069 6620 6973 6c6e 6b20 616e       if islnk an
+000114a0: 6420 666f 6c6c 6f77 5f73 796d 6c69 6e6b  d follow_symlink
+000114b0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000114c0: 2020 2020 2020 2020 2020 2073 335f 7572             s3_ur
+000114d0: 6c20 3d20 6d65 7461 6461 7461 5b27 7379  l = metadata['sy
+000114e0: 6d6c 696e 6b5f 746f 275d 0a20 2020 2020  mlink_to'].     
+000114f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011500: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
+00011510: 2070 6172 7365 5f73 335f 7572 6c28 7333   parse_s3_url(s3
+00011520: 5f75 726c 290a 2020 2020 2020 2020 2020  _url).          
+00011530: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00011540: 6e74 656e 7420 3d20 636c 6965 6e74 2e68  ntent = client.h
+00011550: 6561 645f 6f62 6a65 6374 2842 7563 6b65  ead_object(Bucke
+00011560: 743d 6275 636b 6574 2c20 4b65 793d 6b65  t=bucket, Key=ke
+00011570: 7929 0a20 2020 2020 2020 2020 2020 2073  y).            s
+00011580: 7461 745f 7265 636f 7264 203d 2053 7461  tat_record = Sta
+00011590: 7452 6573 756c 7428 0a20 2020 2020 2020  tResult(.       
+000115a0: 2020 2020 2020 2020 2069 736c 6e6b 3d69           islnk=i
+000115b0: 736c 6e6b 2c0a 2020 2020 2020 2020 2020  slnk,.          
+000115c0: 2020 2020 2020 7369 7a65 3d63 6f6e 7465        size=conte
+000115d0: 6e74 5b27 436f 6e74 656e 744c 656e 6774  nt['ContentLengt
+000115e0: 6827 5d2c 0a20 2020 2020 2020 2020 2020  h'],.           
+000115f0: 2020 2020 206d 7469 6d65 3d63 6f6e 7465       mtime=conte
+00011600: 6e74 5b27 4c61 7374 4d6f 6469 6669 6564  nt['LastModified
+00011610: 275d 2e74 696d 6573 7461 6d70 2829 2c0a  '].timestamp(),.
+00011620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011630: 6578 7472 613d 636f 6e74 656e 7429 0a20  extra=content). 
+00011640: 2020 2020 2020 2072 6574 7572 6e20 7374         return st
+00011650: 6174 5f72 6563 6f72 640a 0a20 2020 2064  at_record..    d
+00011660: 6566 206c 7374 6174 2873 656c 6629 202d  ef lstat(self) -
+00011670: 3e20 5374 6174 5265 7375 6c74 3a0a 2020  > StatResult:.  
+00011680: 2020 2020 2020 2727 274c 696b 6520 5061        '''Like Pa
+00011690: 7468 2e73 7461 7428 2920 6275 742c 2069  th.stat() but, i
+000116a0: 6620 7468 6520 7061 7468 2070 6f69 6e74  f the path point
+000116b0: 7320 746f 2061 2073 796d 626f 6c69 6320  s to a symbolic 
+000116c0: 6c69 6e6b 2c20 7265 7475 726e 2074 6865  link, return the
+000116d0: 2073 796d 626f 6c69 6320 6c69 6e6b e280   symbolic link..
+000116e0: 9973 2069 6e66 6f72 6d61 7469 6f6e 2072  .s information r
+000116f0: 6174 6865 7220 7468 616e 2069 7473 2074  ather than its t
+00011700: 6172 6765 74e2 8099 732e 2727 270a 2020  arget...s.'''.  
+00011710: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00011720: 662e 7374 6174 2866 6f6c 6c6f 775f 7379  f.stat(follow_sy
+00011730: 6d6c 696e 6b73 3d46 616c 7365 290a 0a20  mlinks=False).. 
+00011740: 2020 2064 6566 2075 6e6c 696e 6b28 7365     def unlink(se
+00011750: 6c66 2c20 6d69 7373 696e 675f 6f6b 3a20  lf, missing_ok: 
+00011760: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
+00011770: 204e 6f6e 653a 0a20 2020 2020 2020 2027   None:.        '
+00011780: 2727 0a20 2020 2020 2020 2052 656d 6f76  ''.        Remov
+00011790: 6520 7468 6520 6669 6c65 206f 6e20 7333  e the file on s3
+000117a0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+000117b0: 206d 6973 7369 6e67 5f6f 6b3a 2069 6620   missing_ok: if 
+000117c0: 4661 6c73 6520 616e 6420 7461 7267 6574  False and target
+000117d0: 2066 696c 6520 6e6f 7420 6578 6973 7473   file not exists
+000117e0: 2c20 7261 6973 6520 5333 4669 6c65 4e6f  , raise S3FileNo
+000117f0: 7446 6f75 6e64 4572 726f 720a 2020 2020  tFoundError.    
+00011800: 2020 2020 3a72 6169 7365 733a 2053 3350      :raises: S3P
+00011810: 6572 6d69 7373 696f 6e45 7272 6f72 2c20  ermissionError, 
+00011820: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
+00011830: 726f 722c 2053 3349 7341 4469 7265 6374  ror, S3IsADirect
+00011840: 6f72 7945 7272 6f72 0a20 2020 2020 2020  oryError.       
+00011850: 2027 2727 0a20 2020 2020 2020 2062 7563   '''.        buc
+00011860: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
+00011870: 5f73 335f 7572 6c28 7365 6c66 2e70 6174  _s3_url(self.pat
+00011880: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+00011890: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000118a0: 6275 636b 6574 206f 7220 6e6f 7420 6b65  bucket or not ke
+000118b0: 7920 6f72 206b 6579 2e65 6e64 7377 6974  y or key.endswit
+000118c0: 6828 272f 2729 3a0a 2020 2020 2020 2020  h('/'):.        
+000118d0: 2020 2020 7261 6973 6520 5333 4973 4144      raise S3IsAD
+000118e0: 6972 6563 746f 7279 4572 726f 7228 0a20  irectoryError(. 
+000118f0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00011900: 4973 2061 2064 6972 6563 746f 7279 3a20  Is a directory: 
+00011910: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
+00011920: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+00011930: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00011940: 6c66 2e69 735f 6669 6c65 2829 3a0a 2020  lf.is_file():.  
+00011950: 2020 2020 2020 2020 2020 6966 206d 6973            if mis
+00011960: 7369 6e67 5f6f 6b3a 0a20 2020 2020 2020  sing_ok:.       
+00011970: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+00011980: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00011990: 6520 5333 4669 6c65 4e6f 7446 6f75 6e64  e S3FileNotFound
+000119a0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+000119b0: 2020 2020 2020 2027 4e6f 2073 7563 6820         'No such 
+000119c0: 6669 6c65 3a20 2572 2720 2520 7365 6c66  file: %r' % self
+000119d0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+000119e0: 636f 6c29 0a0a 2020 2020 2020 2020 7769  col)..        wi
+000119f0: 7468 2072 6169 7365 5f73 335f 6572 726f  th raise_s3_erro
+00011a00: 7228 7365 6c66 2e70 6174 685f 7769 7468  r(self.path_with
+00011a10: 5f70 726f 746f 636f 6c29 3a0a 2020 2020  _protocol):.    
+00011a20: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
+00011a30: 6965 6e74 2e64 656c 6574 655f 6f62 6a65  ient.delete_obje
+00011a40: 6374 2842 7563 6b65 743d 6275 636b 6574  ct(Bucket=bucket
+00011a50: 2c20 4b65 793d 6b65 7929 0a0a 2020 2020  , Key=key)..    
+00011a60: 6465 6620 7761 6c6b 2873 656c 662c 2066  def walk(self, f
+00011a70: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
+00011a80: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00011a90: 2020 2020 2029 202d 3e20 4974 6572 6174       ) -> Iterat
+00011aa0: 6f72 5b54 7570 6c65 5b73 7472 2c20 4c69  or[Tuple[str, Li
+00011ab0: 7374 5b73 7472 5d2c 204c 6973 745b 7374  st[str], List[st
+00011ac0: 725d 5d5d 3a0a 2020 2020 2020 2020 2727  r]]]:.        ''
+00011ad0: 270a 2020 2020 2020 2020 4974 6572 6174  '.        Iterat
+00011ae0: 6976 656c 7920 7472 6176 6572 7365 2074  ively traverse t
+00011af0: 6865 2067 6976 656e 2073 3320 6469 7265  he given s3 dire
+00011b00: 6374 6f72 792c 2069 6e20 746f 702d 626f  ctory, in top-bo
+00011b10: 7474 6f6d 206f 7264 6572 2e20 496e 206f  ttom order. In o
+00011b20: 7468 6572 2077 6f72 6473 2c20 6669 7273  ther words, firs
+00011b30: 746c 7920 7472 6176 6572 7365 2070 6172  tly traverse par
+00011b40: 656e 7420 6469 7265 6374 6f72 792c 2069  ent directory, i
+00011b50: 6620 7375 6264 6972 6563 746f 7269 6573  f subdirectories
+00011b60: 2065 7869 7374 2c20 7472 6176 6572 7365   exist, traverse
+00011b70: 2074 6865 2073 7562 6469 7265 6374 6f72   the subdirector
+00011b80: 6965 7320 696e 2061 6c70 6861 6265 7469  ies in alphabeti
+00011b90: 6361 6c20 6f72 6465 722e 0a20 2020 2020  cal order..     
+00011ba0: 2020 2045 7665 7279 2069 7465 7261 7469     Every iterati
+00011bb0: 6f6e 206f 6e20 6765 6e65 7261 746f 7220  on on generator 
+00011bc0: 7969 656c 6473 2061 2033 2d74 7570 6c65  yields a 3-tuple
+00011bd0: 3a20 2872 6f6f 742c 2064 6972 732c 2066  : (root, dirs, f
+00011be0: 696c 6573 290a 0a20 2020 2020 2020 202d  iles)..        -
+00011bf0: 2072 6f6f 743a 2043 7572 7265 6e74 2073   root: Current s
+00011c00: 3320 7061 7468 3b0a 2020 2020 2020 2020  3 path;.        
+00011c10: 2d20 6469 7273 3a20 4e61 6d65 206c 6973  - dirs: Name lis
+00011c20: 7420 6f66 2073 7562 6469 7265 6374 6f72  t of subdirector
+00011c30: 6965 7320 696e 2063 7572 7265 6e74 2064  ies in current d
+00011c40: 6972 6563 746f 7279 2e20 5468 6520 6c69  irectory. The li
+00011c50: 7374 2069 7320 736f 7274 6564 2062 7920  st is sorted by 
+00011c60: 6e61 6d65 2069 6e20 6173 6365 6e64 696e  name in ascendin
+00011c70: 6720 616c 7068 6162 6574 6963 616c 206f  g alphabetical o
+00011c80: 7264 6572 3b0a 2020 2020 2020 2020 2d20  rder;.        - 
+00011c90: 6669 6c65 733a 204e 616d 6520 6c69 7374  files: Name list
+00011ca0: 206f 6620 6669 6c65 7320 696e 2063 7572   of files in cur
+00011cb0: 7265 6e74 2064 6972 6563 746f 7279 2e20  rent directory. 
+00011cc0: 5468 6520 6c69 7374 2069 7320 736f 7274  The list is sort
+00011cd0: 6564 2062 7920 6e61 6d65 2069 6e20 6173  ed by name in as
+00011ce0: 6365 6e64 696e 6720 616c 7068 6162 6574  cending alphabet
+00011cf0: 6963 616c 206f 7264 6572 3b0a 0a20 2020  ical order;..   
+00011d00: 2020 2020 2049 6620 7333 5f75 726c 2069       If s3_url i
+00011d10: 7320 6120 6669 6c65 2070 6174 682c 2072  s a file path, r
+00011d20: 6574 7572 6e20 616e 2065 6d70 7479 2067  eturn an empty g
+00011d30: 656e 6572 6174 6f72 0a20 2020 2020 2020  enerator.       
+00011d40: 2049 6620 7333 5f75 726c 2069 7320 6120   If s3_url is a 
+00011d50: 6e6f 6e2d 6578 6973 7465 6e74 2070 6174  non-existent pat
+00011d60: 682c 2072 6574 7572 6e20 616e 2065 6d70  h, return an emp
+00011d70: 7479 2067 656e 6572 6174 6f72 0a20 2020  ty generator.   
+00011d80: 2020 2020 2049 6620 7333 5f75 726c 2069       If s3_url i
+00011d90: 7320 6120 6275 636b 6574 2070 6174 682c  s a bucket path,
+00011da0: 2062 7563 6b65 7420 7769 6c6c 2062 6520   bucket will be 
+00011db0: 7468 6520 746f 7020 6469 7265 6374 6f72  the top director
+00011dc0: 792c 2061 6e64 2077 696c 6c20 6265 2072  y, and will be r
+00011dd0: 6574 7572 6e65 6420 6174 2066 6972 7374  eturned at first
+00011de0: 2069 7465 7261 7469 6f6e 206f 6620 6765   iteration of ge
+00011df0: 6e65 7261 746f 720a 2020 2020 2020 2020  nerator.        
+00011e00: 4966 2073 335f 7572 6c20 6973 2061 6e20  If s3_url is an 
+00011e10: 656d 7074 7920 6275 636b 6574 2c20 6f6e  empty bucket, on
+00011e20: 6c79 2079 6965 6c64 206f 6e65 2033 2d74  ly yield one 3-t
+00011e30: 7570 6c65 2028 6e6f 7465 733a 2073 3320  uple (notes: s3 
+00011e40: 646f 6573 6e27 7420 6861 7665 2065 6d70  doesn't have emp
+00011e50: 7479 2064 6972 6563 746f 7279 290a 2020  ty directory).  
+00011e60: 2020 2020 2020 4966 2073 335f 7572 6c20        If s3_url 
+00011e70: 646f 6573 6e27 7420 636f 6e74 6169 6e20  doesn't contain 
+00011e80: 616e 7920 6275 636b 6574 2c20 7768 6963  any bucket, whic
+00011e90: 6820 6973 2073 335f 7572 6c20 3d3d 2027  h is s3_url == '
+00011ea0: 7333 3a2f 2f27 2c20 7261 6973 6520 556e  s3://', raise Un
+00011eb0: 7375 7070 6f72 7465 6445 7272 6f72 2e20  supportedError. 
+00011ec0: 7761 6c6b 2829 206f 6e20 636f 6d70 6c65  walk() on comple
+00011ed0: 7465 2073 3320 6973 206e 6f74 2073 7570  te s3 is not sup
+00011ee0: 706f 7274 6564 2069 6e20 6d65 6766 696c  ported in megfil
+00011ef0: 650a 0a20 2020 2020 2020 203a 7061 7261  e..        :para
+00011f00: 6d20 666f 6c6c 6f77 6c69 6e6b 733a 2077  m followlinks: w
+00011f10: 6865 7468 6572 2066 6f6c 6c6f 776c 696e  hether followlin
+00011f20: 6b73 2069 7320 5472 7565 206f 7220 4661  ks is True or Fa
+00011f30: 6c73 652c 2072 6573 756c 7420 6973 2074  lse, result is t
+00011f40: 6865 2073 616d 652e 2042 6563 6175 7365  he same. Because
+00011f50: 2073 3320 7379 6d6c 696e 6b20 6e6f 7420   s3 symlink not 
+00011f60: 7375 7070 6f72 7420 6469 722e 0a20 2020  support dir..   
+00011f70: 2020 2020 203a 7261 6973 6573 3a20 556e       :raises: Un
+00011f80: 7375 7070 6f72 7465 6445 7272 6f72 0a20  supportedError. 
+00011f90: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+00011fa0: 2041 2033 2d74 7570 6c65 2067 656e 6572   A 3-tuple gener
+00011fb0: 6174 6f72 0a20 2020 2020 2020 2027 2727  ator.        '''
+00011fc0: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
+00011fd0: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
+00011fe0: 7572 6c28 7365 6c66 2e70 6174 685f 7769  url(self.path_wi
+00011ff0: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+00012000: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
+00012010: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+00012020: 7261 6973 6520 556e 7375 7070 6f72 7465  raise Unsupporte
+00012030: 6445 7272 6f72 2827 5761 6c6b 2077 686f  dError('Walk who
+00012040: 6c65 2073 3327 2c20 7365 6c66 2e70 6174  le s3', self.pat
+00012050: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+00012060: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00012070: 2073 656c 662e 6973 5f64 6972 2829 3a0a   self.is_dir():.
+00012080: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00012090: 726e 0a0a 2020 2020 2020 2020 7374 6163  rn..        stac
+000120a0: 6b20 3d20 5b6b 6579 5d0a 2020 2020 2020  k = [key].      
+000120b0: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
+000120c0: 5f63 6c69 656e 740a 2020 2020 2020 2020  _client.        
+000120d0: 7768 696c 6520 6c65 6e28 7374 6163 6b29  while len(stack)
+000120e0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+000120f0: 2020 6375 7272 656e 7420 3d20 5f62 6563    current = _bec
+00012100: 6f6d 655f 7072 6566 6978 2873 7461 636b  ome_prefix(stack
+00012110: 2e70 6f70 2829 290a 2020 2020 2020 2020  .pop()).        
+00012120: 2020 2020 6469 7273 2c20 6669 6c65 7320      dirs, files 
+00012130: 3d20 5b5d 2c20 5b5d 0a20 2020 2020 2020  = [], [].       
+00012140: 2020 2020 2066 6f72 2072 6573 7020 696e       for resp in
+00012150: 205f 6c69 7374 5f6f 626a 6563 7473 5f72   _list_objects_r
+00012160: 6563 7572 7369 7665 2863 6c69 656e 742c  ecursive(client,
+00012170: 2062 7563 6b65 742c 2063 7572 7265 6e74   bucket, current
+00012180: 2c20 272f 2729 3a0a 2020 2020 2020 2020  , '/'):.        
+00012190: 2020 2020 2020 2020 666f 7220 636f 6d6d          for comm
+000121a0: 6f6e 5f70 7265 6669 7820 696e 2072 6573  on_prefix in res
+000121b0: 702e 6765 7428 2743 6f6d 6d6f 6e50 7265  p.get('CommonPre
+000121c0: 6669 7865 7327 2c20 5b5d 293a 0a20 2020  fixes', []):.   
+000121d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121e0: 2064 6972 732e 6170 7065 6e64 2863 6f6d   dirs.append(com
+000121f0: 6d6f 6e5f 7072 6566 6978 5b27 5072 6566  mon_prefix['Pref
+00012200: 6978 275d 5b3a 2d31 5d29 0a20 2020 2020  ix'][:-1]).     
+00012210: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+00012220: 6f6e 7465 6e74 2069 6e20 7265 7370 2e67  ontent in resp.g
+00012230: 6574 2827 436f 6e74 656e 7473 272c 205b  et('Contents', [
+00012240: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+00012250: 2020 2020 2020 2020 6669 6c65 732e 6170          files.ap
+00012260: 7065 6e64 2863 6f6e 7465 6e74 5b27 4b65  pend(content['Ke
+00012270: 7927 5d29 0a0a 2020 2020 2020 2020 2020  y'])..          
+00012280: 2020 6469 7273 203d 2073 6f72 7465 6428    dirs = sorted(
+00012290: 6469 7273 290a 2020 2020 2020 2020 2020  dirs).          
+000122a0: 2020 7374 6163 6b2e 6578 7465 6e64 2872    stack.extend(r
+000122b0: 6576 6572 7365 6428 6469 7273 2929 0a0a  eversed(dirs))..
+000122c0: 2020 2020 2020 2020 2020 2020 726f 6f74              root
+000122d0: 203d 2073 335f 7061 7468 5f6a 6f69 6e28   = s3_path_join(
+000122e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000122f0: 2066 277b 7365 6c66 2e5f 7072 6f74 6f63   f'{self._protoc
+00012300: 6f6c 5f77 6974 685f 7072 6f66 696c 657d  ol_with_profile}
+00012310: 3a2f 2f27 2c20 6275 636b 6574 2c20 6375  ://', bucket, cu
+00012320: 7272 656e 7429 5b3a 2d31 5d0a 2020 2020  rrent)[:-1].    
+00012330: 2020 2020 2020 2020 6469 7273 203d 205b          dirs = [
+00012340: 7061 7468 5b6c 656e 2863 7572 7265 6e74  path[len(current
+00012350: 293a 5d20 666f 7220 7061 7468 2069 6e20  ):] for path in 
+00012360: 6469 7273 5d0a 2020 2020 2020 2020 2020  dirs].          
+00012370: 2020 6669 6c65 7320 3d20 736f 7274 6564    files = sorted
+00012380: 2870 6174 685b 6c65 6e28 6375 7272 656e  (path[len(curren
+00012390: 7429 3a5d 2066 6f72 2070 6174 6820 696e  t):] for path in
+000123a0: 2066 696c 6573 290a 2020 2020 2020 2020   files).        
+000123b0: 2020 2020 7969 656c 6420 726f 6f74 2c20      yield root, 
+000123c0: 6469 7273 2c20 6669 6c65 730a 0a20 2020  dirs, files..   
+000123d0: 2064 6566 206d 6435 2873 656c 662c 2072   def md5(self, r
+000123e0: 6563 616c 6375 6c61 7465 3a20 626f 6f6c  ecalculate: bool
+000123f0: 203d 2046 616c 7365 2c20 666f 6c6c 6f77   = False, follow
+00012400: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
+00012410: 6c73 6529 202d 3e20 7374 723a 0a20 2020  lse) -> str:.   
+00012420: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
+00012430: 2047 6574 206d 6435 206d 6574 6120 696e   Get md5 meta in
+00012440: 666f 2069 6e20 6669 6c65 7320 7468 6174  fo in files that
+00012450: 2075 706c 6f61 6465 642f 636f 7069 6564   uploaded/copied
+00012460: 2076 6961 206d 6567 6669 6c65 0a0a 2020   via megfile..  
+00012470: 2020 2020 2020 4966 206d 6574 6120 696e        If meta in
+00012480: 666f 2069 7320 6c6f 7374 206f 7220 6e6f  fo is lost or no
+00012490: 6e2d 6578 6973 7465 6e74 2c20 7265 7475  n-existent, retu
+000124a0: 726e 204e 6f6e 650a 0a20 2020 2020 2020  rn None..       
+000124b0: 203a 7061 7261 6d20 7265 6361 6c63 756c   :param recalcul
+000124c0: 6174 653a 2063 616c 6375 6c61 7465 206d  ate: calculate m
+000124d0: 6435 2069 6e20 7265 616c 2d74 696d 6520  d5 in real-time 
+000124e0: 6f72 2072 6574 7572 6e20 7333 2065 7461  or return s3 eta
+000124f0: 670a 2020 2020 2020 2020 3a70 6172 616d  g.        :param
+00012500: 2066 6f6c 6c6f 776c 696e 6b73 3a20 4966   followlinks: If
+00012510: 2069 7320 5472 7565 2c20 6361 6c63 756c   is True, calcul
+00012520: 6174 6520 6d64 3520 666f 7220 7265 616c  ate md5 for real
+00012530: 2066 696c 650a 2020 2020 2020 2020 3a72   file.        :r
+00012540: 6574 7572 6e73 3a20 6d64 3520 6d65 7461  eturns: md5 meta
+00012550: 2069 6e66 6f0a 2020 2020 2020 2020 2727   info.        ''
+00012560: 270a 2020 2020 2020 2020 6275 636b 6574  '.        bucket
+00012570: 2c20 5f20 3d20 7061 7273 655f 7333 5f75  , _ = parse_s3_u
+00012580: 726c 2873 656c 662e 7061 7468 5f77 6974  rl(self.path_wit
+00012590: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+000125a0: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
+000125b0: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+000125c0: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
+000125d0: 466f 756e 6445 7272 6f72 280a 2020 2020  FoundError(.    
+000125e0: 2020 2020 2020 2020 2020 2020 2745 6d70              'Emp
+000125f0: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
+00012600: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
+00012610: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+00012620: 2020 2020 2020 2073 7461 7420 3d20 7365         stat = se
+00012630: 6c66 2e73 7461 7428 666f 6c6c 6f77 5f73  lf.stat(follow_s
+00012640: 796d 6c69 6e6b 733d 666f 6c6c 6f77 6c69  ymlinks=followli
+00012650: 6e6b 7329 0a20 2020 2020 2020 2069 6620  nks).        if 
+00012660: 7374 6174 2e69 7364 6972 3a0a 2020 2020  stat.isdir:.    
+00012670: 2020 2020 2020 2020 6861 7368 5f6d 6435          hash_md5
+00012680: 203d 2068 6173 686c 6962 2e6d 6435 2829   = hashlib.md5()
+00012690: 2020 2320 6e6f 7365 630a 2020 2020 2020    # nosec.      
+000126a0: 2020 2020 2020 666f 7220 6669 6c65 5f6e        for file_n
+000126b0: 616d 6520 696e 2073 656c 662e 6c69 7374  ame in self.list
+000126c0: 6469 7228 293a 0a20 2020 2020 2020 2020  dir():.         
+000126d0: 2020 2020 2020 2063 6875 6e6b 203d 2053         chunk = S
+000126e0: 3350 6174 6828 0a20 2020 2020 2020 2020  3Path(.         
+000126f0: 2020 2020 2020 2020 2020 2073 335f 7061             s3_pa
+00012700: 7468 5f6a 6f69 6e28 0a20 2020 2020 2020  th_join(.       
+00012710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012720: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
+00012730: 7072 6f74 6f63 6f6c 2c0a 2020 2020 2020  protocol,.      
+00012740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012750: 2020 6669 6c65 5f6e 616d 6529 292e 6d64    file_name)).md
+00012760: 3528 7265 6361 6c63 756c 6174 653d 7265  5(recalculate=re
+00012770: 6361 6c63 756c 6174 6529 2e65 6e63 6f64  calculate).encod
+00012780: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+00012790: 2020 2020 6861 7368 5f6d 6435 2e75 7064      hash_md5.upd
+000127a0: 6174 6528 6368 756e 6b29 0a20 2020 2020  ate(chunk).     
+000127b0: 2020 2020 2020 2072 6574 7572 6e20 6861         return ha
+000127c0: 7368 5f6d 6435 2e68 6578 6469 6765 7374  sh_md5.hexdigest
+000127d0: 2829 0a20 2020 2020 2020 2069 6620 7265  ().        if re
+000127e0: 6361 6c63 756c 6174 653a 0a20 2020 2020  calculate:.     
+000127f0: 2020 2020 2020 2070 6174 685f 696e 7374         path_inst
+00012800: 616e 6365 203d 2073 656c 660a 2020 2020  ance = self.    
+00012810: 2020 2020 2020 2020 6966 2066 6f6c 6c6f          if follo
+00012820: 776c 696e 6b73 3a0a 2020 2020 2020 2020  wlinks:.        
+00012830: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00012840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012850: 2070 6174 685f 696e 7374 616e 6365 203d   path_instance =
+00012860: 2073 656c 662e 7265 6164 6c69 6e6b 2829   self.readlink()
+00012870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012880: 2065 7863 6570 7420 5333 4e6f 7441 4c69   except S3NotALi
+00012890: 6e6b 4572 726f 723a 0a20 2020 2020 2020  nkError:.       
+000128a0: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+000128b0: 730a 2020 2020 2020 2020 2020 2020 7769  s.            wi
+000128c0: 7468 2070 6174 685f 696e 7374 616e 6365  th path_instance
+000128d0: 2e6f 7065 6e28 2772 6227 2920 6173 2066  .open('rb') as f
+000128e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000128f0: 2020 7265 7475 726e 2063 616c 6375 6c61    return calcula
+00012900: 7465 5f6d 6435 2866 290a 2020 2020 2020  te_md5(f).      
+00012910: 2020 7265 7475 726e 2073 7461 742e 6578    return stat.ex
+00012920: 7472 612e 6765 7428 2745 5461 6727 2c20  tra.get('ETag', 
+00012930: 2727 295b 313a 2d31 5d0a 0a20 2020 2064  '')[1:-1]..    d
+00012940: 6566 2063 6f70 7928 0a20 2020 2020 2020  ef copy(.       
+00012950: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00012960: 2020 2020 2020 2064 7374 5f75 726c 3a20         dst_url: 
+00012970: 5061 7468 4c69 6b65 2c0a 2020 2020 2020  PathLike,.      
+00012980: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
+00012990: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
+000129a0: 0a20 2020 2020 2020 2020 2020 2063 616c  .            cal
+000129b0: 6c62 6163 6b3a 204f 7074 696f 6e61 6c5b  lback: Optional[
+000129c0: 4361 6c6c 6162 6c65 5b5b 696e 745d 2c20  Callable[[int], 
+000129d0: 4e6f 6e65 5d5d 203d 204e 6f6e 6529 202d  None]] = None) -
+000129e0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000129f0: 2727 2720 4669 6c65 2063 6f70 7920 6f6e  ''' File copy on
+00012a00: 2053 330a 2020 2020 2020 2020 436f 7079   S3.        Copy
+00012a10: 2063 6f6e 7465 6e74 206f 6620 6669 6c65   content of file
+00012a20: 206f 6e20 6073 7263 5f70 6174 6860 2074   on `src_path` t
+00012a30: 6f20 6064 7374 5f70 6174 6860 2e0a 2020  o `dst_path`..  
+00012a40: 2020 2020 2020 4974 2773 2063 616c 6c65        It's calle
+00012a50: 7227 7320 7265 7370 6f6e 7365 6269 6c69  r's responsebili
+00012a60: 7479 2074 6f20 656e 7375 7265 2074 6865  ty to ensure the
+00012a70: 2073 335f 6973 6669 6c65 2873 7263 5f75   s3_isfile(src_u
+00012a80: 726c 2920 3d3d 2054 7275 650a 0a20 2020  rl) == True..   
+00012a90: 2020 2020 203a 7061 7261 6d20 6473 745f       :param dst_
+00012aa0: 7061 7468 3a20 5461 7267 6574 2066 696c  path: Target fil
+00012ab0: 6520 7061 7468 0a20 2020 2020 2020 203a  e path.        :
+00012ac0: 7061 7261 6d20 6361 6c6c 6261 636b 3a20  param callback: 
+00012ad0: 4361 6c6c 6564 2070 6572 696f 6469 6361  Called periodica
+00012ae0: 6c6c 7920 6475 7269 6e67 2063 6f70 792c  lly during copy,
+00012af0: 2061 6e64 2074 6865 2069 6e70 7574 2070   and the input p
+00012b00: 6172 616d 6574 6572 2069 7320 7468 6520  arameter is the 
+00012b10: 6461 7461 2073 697a 6520 2869 6e20 6279  data size (in by
+00012b20: 7465 7329 206f 6620 636f 7079 2073 696e  tes) of copy sin
+00012b30: 6365 2074 6865 206c 6173 7420 6361 6c6c  ce the last call
+00012b40: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+00012b50: 2020 2020 2073 7263 5f75 726c 203d 2073       src_url = s
+00012b60: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+00012b70: 6f74 6f63 6f6c 0a20 2020 2020 2020 2073  otocol.        s
+00012b80: 7263 5f62 7563 6b65 742c 2073 7263 5f6b  rc_bucket, src_k
+00012b90: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
+00012ba0: 6c28 7372 635f 7572 6c29 0a20 2020 2020  l(src_url).     
+00012bb0: 2020 2064 7374 5f62 7563 6b65 742c 2064     dst_bucket, d
+00012bc0: 7374 5f6b 6579 203d 2070 6172 7365 5f73  st_key = parse_s
+00012bd0: 335f 7572 6c28 6473 745f 7572 6c29 0a0a  3_url(dst_url)..
+00012be0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00012bf0: 7263 5f62 7563 6b65 743a 0a20 2020 2020  rc_bucket:.     
+00012c00: 2020 2020 2020 2072 6169 7365 2053 3342         raise S3B
+00012c10: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
+00012c20: 6f72 2827 456d 7074 7920 6275 636b 6574  or('Empty bucket
+00012c30: 206e 616d 653a 2025 7227 2025 2073 7263   name: %r' % src
+00012c40: 5f75 726c 290a 2020 2020 2020 2020 6966  _url).        if
+00012c50: 2073 656c 662e 6973 5f64 6972 2829 3a0a   self.is_dir():.
+00012c60: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00012c70: 6520 5333 4973 4144 6972 6563 746f 7279  e S3IsADirectory
+00012c80: 4572 726f 7228 2749 7320 6120 6469 7265  Error('Is a dire
+00012c90: 6374 6f72 793a 2025 7227 2025 2073 7263  ctory: %r' % src
+00012ca0: 5f75 726c 290a 0a20 2020 2020 2020 2069  _url)..        i
+00012cb0: 6620 6e6f 7420 6473 745f 6275 636b 6574  f not dst_bucket
+00012cc0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00012cd0: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
+00012ce0: 6f75 6e64 4572 726f 7228 2745 6d70 7479  oundError('Empty
+00012cf0: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
+00012d00: 2720 2520 6473 745f 7572 6c29 0a20 2020  ' % dst_url).   
+00012d10: 2020 2020 2069 6620 6e6f 7420 6473 745f       if not dst_
+00012d20: 6b65 7920 6f72 2064 7374 5f6b 6579 2e65  key or dst_key.e
+00012d30: 6e64 7377 6974 6828 272f 2729 3a0a 2020  ndswith('/'):.  
+00012d40: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00012d50: 5333 4973 4144 6972 6563 746f 7279 4572  S3IsADirectoryEr
+00012d60: 726f 7228 2749 7320 6120 6469 7265 6374  ror('Is a direct
+00012d70: 6f72 793a 2025 7227 2025 2064 7374 5f75  ory: %r' % dst_u
+00012d80: 726c 290a 0a20 2020 2020 2020 2069 6620  rl)..        if 
+00012d90: 666f 6c6c 6f77 6c69 6e6b 733a 0a20 2020  followlinks:.   
+00012da0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00012db0: 2020 2020 2020 2020 2020 2020 2020 7333                s3
+00012dc0: 5f75 726c 203d 2073 656c 662e 7265 6164  _url = self.read
+00012dd0: 6c69 6e6b 2829 2e70 6174 680a 2020 2020  link().path.    
+00012de0: 2020 2020 2020 2020 2020 2020 7372 635f              src_
+00012df0: 6275 636b 6574 2c20 7372 635f 6b65 7920  bucket, src_key 
+00012e00: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
+00012e10: 335f 7572 6c29 0a20 2020 2020 2020 2020  3_url).         
+00012e20: 2020 2065 7863 6570 7420 5333 4e6f 7441     except S3NotA
+00012e30: 4c69 6e6b 4572 726f 723a 0a20 2020 2020  LinkError:.     
+00012e40: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00012e50: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00012e60: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00012e70: 636c 6965 6e74 2e63 6f70 7928 0a20 2020  client.copy(.   
+00012e80: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+00012e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ea0: 2020 2027 4275 636b 6574 273a 2073 7263     'Bucket': src
+00012eb0: 5f62 7563 6b65 742c 0a20 2020 2020 2020  _bucket,.       
+00012ec0: 2020 2020 2020 2020 2020 2020 2027 4b65               'Ke
+00012ed0: 7927 3a20 7372 635f 6b65 792c 0a20 2020  y': src_key,.   
+00012ee0: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+00012ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f00: 4275 636b 6574 3d64 7374 5f62 7563 6b65  Bucket=dst_bucke
+00012f10: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00012f20: 2020 204b 6579 3d64 7374 5f6b 6579 2c0a     Key=dst_key,.
+00012f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f40: 4361 6c6c 6261 636b 3d63 616c 6c62 6163  Callback=callbac
+00012f50: 6b29 0a20 2020 2020 2020 2065 7863 6570  k).        excep
+00012f60: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00012f70: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00012f80: 2020 6572 726f 7220 3d20 7472 616e 736c    error = transl
+00012f90: 6174 655f 7333 5f65 7272 6f72 2865 7272  ate_s3_error(err
+00012fa0: 6f72 2c20 6473 745f 7572 6c29 0a20 2020  or, dst_url).   
+00012fb0: 2020 2020 2020 2020 2023 2045 7272 6f72           # Error
+00012fc0: 2063 616e 2774 2068 656c 7020 7465 6c6c   can't help tell
+00012fd0: 2077 6869 6368 2069 7320 7072 6f62 6c65   which is proble
+00012fe0: 6d61 7469 630a 2020 2020 2020 2020 2020  matic.          
+00012ff0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00013000: 6572 726f 722c 2053 3342 7563 6b65 744e  error, S3BucketN
+00013010: 6f74 466f 756e 6445 7272 6f72 293a 0a20  otFoundError):. 
+00013020: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00013030: 6620 6e6f 7420 7365 6c66 2e68 6173 6275  f not self.hasbu
+00013040: 636b 6574 2829 3a0a 2020 2020 2020 2020  cket():.        
+00013050: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00013060: 6520 5333 4275 636b 6574 4e6f 7446 6f75  e S3BucketNotFou
 00013070: 6e64 4572 726f 7228 274e 6f20 7375 6368  ndError('No such
-00013080: 2066 696c 653a 2025 7227 2025 2073 7263   file: %r' % src
-00013090: 5f75 726c 290a 2020 2020 2020 2020 2020  _url).          
-000130a0: 2020 7261 6973 6520 6572 726f 720a 0a20    raise error.. 
-000130b0: 2020 2064 6566 2073 796e 6328 7365 6c66     def sync(self
-000130c0: 2c20 6473 745f 7572 6c3a 2050 6174 684c  , dst_url: PathL
-000130d0: 696b 652c 2066 6f6c 6c6f 776c 696e 6b73  ike, followlinks
-000130e0: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
-000130f0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00013100: 2027 2727 0a20 2020 2020 2020 2043 6f70   '''.        Cop
-00013110: 7920 6669 6c65 2f64 6972 6563 746f 7279  y file/directory
-00013120: 206f 6e20 7372 635f 7572 6c20 746f 2064   on src_url to d
-00013130: 7374 5f75 726c 0a0a 2020 2020 2020 2020  st_url..        
-00013140: 3a70 6172 616d 2064 7374 5f75 726c 3a20  :param dst_url: 
-00013150: 4769 7665 6e20 6465 7374 696e 6174 696f  Given destinatio
-00013160: 6e20 7061 7468 0a20 2020 2020 2020 2027  n path.        '
-00013170: 2727 0a20 2020 2020 2020 2066 6f72 2073  ''.        for s
-00013180: 7263 5f66 696c 655f 7061 7468 2c20 6473  rc_file_path, ds
-00013190: 745f 6669 6c65 5f70 6174 6820 696e 205f  t_file_path in _
-000131a0: 7333 5f73 6361 6e5f 7061 6972 7328 0a20  s3_scan_pairs(. 
-000131b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000131c0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-000131d0: 6f74 6f63 6f6c 2c20 6473 745f 7572 6c29  otocol, dst_url)
-000131e0: 3a0a 2020 2020 2020 2020 2020 2020 7372  :.            sr
-000131f0: 635f 6669 6c65 5f70 6174 6820 3d20 7365  c_file_path = se
-00013200: 6c66 2e66 726f 6d5f 7061 7468 2873 7263  lf.from_path(src
-00013210: 5f66 696c 655f 7061 7468 290a 2020 2020  _file_path).    
-00013220: 2020 2020 2020 2020 6473 745f 6669 6c65          dst_file
-00013230: 5f70 6174 6820 3d20 7365 6c66 2e66 726f  _path = self.fro
-00013240: 6d5f 7061 7468 2864 7374 5f66 696c 655f  m_path(dst_file_
-00013250: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
-00013260: 2020 6966 2064 7374 5f66 696c 655f 7061    if dst_file_pa
-00013270: 7468 2e65 7869 7374 7328 2920 616e 6420  th.exists() and 
-00013280: 6973 5f73 616d 655f 6669 6c65 280a 2020  is_same_file(.  
-00013290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000132a0: 2020 7372 635f 6669 6c65 5f70 6174 682e    src_file_path.
-000132b0: 7374 6174 2829 2c20 6473 745f 6669 6c65  stat(), dst_file
-000132c0: 5f70 6174 682e 7374 6174 2829 2c20 2763  _path.stat(), 'c
-000132d0: 6f70 7927 293a 0a20 2020 2020 2020 2020  opy'):.         
-000132e0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-000132f0: 2020 2020 2020 2020 2020 2020 7372 635f              src_
-00013300: 6669 6c65 5f70 6174 682e 636f 7079 2864  file_path.copy(d
-00013310: 7374 5f66 696c 655f 7061 7468 2c20 666f  st_file_path, fo
-00013320: 6c6c 6f77 6c69 6e6b 733d 666f 6c6c 6f77  llowlinks=follow
-00013330: 6c69 6e6b 7329 0a0a 2020 2020 6465 6620  links)..    def 
-00013340: 7379 6d6c 696e 6b28 7365 6c66 2c20 6473  symlink(self, ds
-00013350: 745f 7061 7468 3a20 5061 7468 4c69 6b65  t_path: PathLike
-00013360: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00013370: 2020 2027 2727 0a20 2020 2020 2020 2043     '''.        C
-00013380: 7265 6174 6520 6120 7379 6d62 6f6c 6963  reate a symbolic
-00013390: 206c 696e 6b20 706f 696e 7469 6e67 2074   link pointing t
-000133a0: 6f20 7372 635f 7061 7468 206e 616d 6564  o src_path named
-000133b0: 2064 7374 5f70 6174 682e 0a0a 2020 2020   dst_path...    
-000133c0: 2020 2020 3a70 6172 616d 2064 7374 5f70      :param dst_p
-000133d0: 6174 683a 2044 6573 696e 6174 696f 6e20  ath: Desination 
-000133e0: 7061 7468 0a20 2020 2020 2020 203a 7261  path.        :ra
-000133f0: 6973 6573 3a20 5333 4e61 6d65 546f 6f4c  ises: S3NameTooL
-00013400: 6f6e 6745 7272 6f72 2c20 5333 4275 636b  ongError, S3Buck
-00013410: 6574 4e6f 7446 6f75 6e64 4572 726f 722c  etNotFoundError,
-00013420: 2053 3349 7341 4469 7265 6374 6f72 7945   S3IsADirectoryE
-00013430: 7272 6f72 0a20 2020 2020 2020 2027 2727  rror.        '''
-00013440: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-00013450: 7374 7228 7365 6c66 2e5f 7333 5f70 6174  str(self._s3_pat
-00013460: 6829 2e65 6e63 6f64 6528 2929 203e 2031  h).encode()) > 1
-00013470: 3032 343a 0a20 2020 2020 2020 2020 2020  024:.           
-00013480: 2072 6169 7365 2053 334e 616d 6554 6f6f   raise S3NameToo
-00013490: 4c6f 6e67 4572 726f 7228 2746 696c 6520  LongError('File 
-000134a0: 6e61 6d65 2074 6f6f 206c 6f6e 673a 2025  name too long: %
-000134b0: 7227 2025 2064 7374 5f70 6174 6829 0a20  r' % dst_path). 
-000134c0: 2020 2020 2020 2073 7263 5f62 7563 6b65         src_bucke
-000134d0: 742c 2073 7263 5f6b 6579 203d 2070 6172  t, src_key = par
-000134e0: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
-000134f0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-00013500: 6c29 0a20 2020 2020 2020 2064 7374 5f62  l).        dst_b
-00013510: 7563 6b65 742c 2064 7374 5f6b 6579 203d  ucket, dst_key =
-00013520: 2070 6172 7365 5f73 335f 7572 6c28 6473   parse_s3_url(ds
-00013530: 745f 7061 7468 290a 0a20 2020 2020 2020  t_path)..       
-00013540: 2069 6620 6e6f 7420 7372 635f 6275 636b   if not src_buck
-00013550: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
-00013560: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
-00013570: 7446 6f75 6e64 4572 726f 7228 2745 6d70  tFoundError('Emp
-00013580: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
-00013590: 2572 2720 2520 7365 6c66 2e70 6174 6829  %r' % self.path)
-000135a0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000135b0: 6473 745f 6275 636b 6574 3a0a 2020 2020  dst_bucket:.    
-000135c0: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-000135d0: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
-000135e0: 726f 7228 2745 6d70 7479 2062 7563 6b65  ror('Empty bucke
-000135f0: 7420 6e61 6d65 3a20 2572 2720 2520 6473  t name: %r' % ds
-00013600: 745f 7061 7468 290a 2020 2020 2020 2020  t_path).        
-00013610: 6966 206e 6f74 2064 7374 5f6b 6579 206f  if not dst_key o
-00013620: 7220 6473 745f 6b65 792e 656e 6473 7769  r dst_key.endswi
-00013630: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
-00013640: 2020 2020 2072 6169 7365 2053 3349 7341       raise S3IsA
-00013650: 4469 7265 6374 6f72 7945 7272 6f72 2827  DirectoryError('
-00013660: 4973 2061 2064 6972 6563 746f 7279 3a20  Is a directory: 
-00013670: 2572 2720 2520 6473 745f 7061 7468 290a  %r' % dst_path).
-00013680: 0a20 2020 2020 2020 2073 7263 5f70 6174  .        src_pat
-00013690: 6820 3d20 7365 6c66 2e5f 7333 5f70 6174  h = self._s3_pat
-000136a0: 680a 2020 2020 2020 2020 7472 793a 0a20  h.        try:. 
-000136b0: 2020 2020 2020 2020 2020 2073 7263 5f70             src_p
-000136c0: 6174 6820 3d20 7365 6c66 2e72 6561 646c  ath = self.readl
-000136d0: 696e 6b28 292e 5f73 335f 7061 7468 0a20  ink()._s3_path. 
-000136e0: 2020 2020 2020 2065 7863 6570 7420 5333         except S3
-000136f0: 4e6f 7441 4c69 6e6b 4572 726f 723a 0a20  NotALinkError:. 
-00013700: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00013710: 2020 2020 2020 2020 7769 7468 2072 6169          with rai
-00013720: 7365 5f73 335f 6572 726f 7228 6473 745f  se_s3_error(dst_
-00013730: 7061 7468 293a 0a20 2020 2020 2020 2020  path):.         
-00013740: 2020 2073 656c 662e 5f63 6c69 656e 742e     self._client.
-00013750: 7075 745f 6f62 6a65 6374 280a 2020 2020  put_object(.    
-00013760: 2020 2020 2020 2020 2020 2020 4275 636b              Buck
-00013770: 6574 3d64 7374 5f62 7563 6b65 742c 0a20  et=dst_bucket,. 
-00013780: 2020 2020 2020 2020 2020 2020 2020 204b                 K
-00013790: 6579 3d64 7374 5f6b 6579 2c0a 2020 2020  ey=dst_key,.    
-000137a0: 2020 2020 2020 2020 2020 2020 4d65 7461              Meta
-000137b0: 6461 7461 3d7b 2273 796d 6c69 6e6b 5f74  data={"symlink_t
-000137c0: 6f22 3a20 7372 635f 7061 7468 7d29 0a0a  o": src_path})..
-000137d0: 2020 2020 6465 6620 7265 6164 6c69 6e6b      def readlink
-000137e0: 2873 656c 6629 202d 3e20 2753 3350 6174  (self) -> 'S3Pat
-000137f0: 6827 3a0a 2020 2020 2020 2020 2727 270a  h':.        '''.
-00013800: 2020 2020 2020 2020 5265 7475 726e 2061          Return a
-00013810: 2053 3350 6174 6820 696e 7374 616e 6365   S3Path instance
-00013820: 2072 6570 7265 7365 6e74 696e 6720 7468   representing th
-00013830: 6520 7061 7468 2074 6f20 7768 6963 6820  e path to which 
-00013840: 7468 6520 7379 6d62 6f6c 6963 206c 696e  the symbolic lin
-00013850: 6b20 706f 696e 7473 2e0a 0a20 2020 2020  k points...     
-00013860: 2020 203a 7265 7475 726e 733a 2052 6574     :returns: Ret
-00013870: 7572 6e20 6120 5333 5061 7468 2069 6e73  urn a S3Path ins
-00013880: 7461 6e63 6520 7265 7072 6573 656e 7469  tance representi
-00013890: 6e67 2074 6865 2070 6174 6820 746f 2077  ng the path to w
-000138a0: 6869 6368 2074 6865 2073 796d 626f 6c69  hich the symboli
-000138b0: 6320 6c69 6e6b 2070 6f69 6e74 732e 0a20  c link points.. 
-000138c0: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
-000138d0: 5333 4e61 6d65 546f 6f4c 6f6e 6745 7272  S3NameTooLongErr
-000138e0: 6f72 2c20 5333 4275 636b 6574 4e6f 7446  or, S3BucketNotF
-000138f0: 6f75 6e64 4572 726f 722c 2053 3349 7341  oundError, S3IsA
-00013900: 4469 7265 6374 6f72 7945 7272 6f72 2c20  DirectoryError, 
-00013910: 5333 4e6f 7441 4c69 6e6b 4572 726f 720a  S3NotALinkError.
-00013920: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-00013930: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-00013940: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-00013950: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-00013960: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
-00013970: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
-00013980: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00013990: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-000139a0: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
-000139b0: 2020 2020 2020 2020 2745 6d70 7479 2062          'Empty b
-000139c0: 7563 6b65 7420 6e61 6d65 3a20 2572 2720  ucket name: %r' 
-000139d0: 2520 7365 6c66 2e70 6174 685f 7769 7468  % self.path_with
-000139e0: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
-000139f0: 2020 2069 6620 6e6f 7420 6b65 7920 6f72     if not key or
-00013a00: 206b 6579 2e65 6e64 7377 6974 6828 272f   key.endswith('/
-00013a10: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00013a20: 7261 6973 6520 5333 4973 4144 6972 6563  raise S3IsADirec
-00013a30: 746f 7279 4572 726f 7228 0a20 2020 2020  toryError(.     
-00013a40: 2020 2020 2020 2020 2020 2027 4973 2061             'Is a
-00013a50: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
-00013a60: 2520 7365 6c66 2e70 6174 685f 7769 7468  % self.path_with
-00013a70: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
-00013a80: 2020 206d 6574 6164 6174 6120 3d20 7365     metadata = se
-00013a90: 6c66 2e5f 7333 5f67 6574 5f6d 6574 6164  lf._s3_get_metad
-00013aa0: 6174 6128 290a 0a20 2020 2020 2020 2069  ata()..        i
-00013ab0: 6620 6e6f 7420 2773 796d 6c69 6e6b 5f74  f not 'symlink_t
-00013ac0: 6f27 2069 6e20 6d65 7461 6461 7461 3a0a  o' in metadata:.
-00013ad0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00013ae0: 6520 5333 4e6f 7441 4c69 6e6b 4572 726f  e S3NotALinkErro
-00013af0: 7228 274e 6f74 2061 206c 696e 6b3a 2025  r('Not a link: %
-00013b00: 7227 2025 2073 656c 662e 7061 7468 5f77  r' % self.path_w
-00013b10: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-00013b20: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00013b30: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00013b40: 656c 662e 6672 6f6d 5f70 6174 6828 6d65  elf.from_path(me
-00013b50: 7461 6461 7461 5b27 7379 6d6c 696e 6b5f  tadata['symlink_
-00013b60: 746f 275d 290a 0a20 2020 2064 6566 2069  to'])..    def i
-00013b70: 735f 7379 6d6c 696e 6b28 7365 6c66 2920  s_symlink(self) 
-00013b80: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
-00013b90: 2027 2727 0a20 2020 2020 2020 2054 6573   '''.        Tes
-00013ba0: 7420 7768 6574 6865 7220 6120 7061 7468  t whether a path
-00013bb0: 2069 7320 6c69 6e6b 0a0a 2020 2020 2020   is link..      
-00013bc0: 2020 3a72 6574 7572 6e73 3a20 5472 7565    :returns: True
-00013bd0: 2069 6620 6120 7061 7468 2069 7320 6c69   if a path is li
-00013be0: 6e6b 2c20 656c 7365 2046 616c 7365 0a20  nk, else False. 
-00013bf0: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
-00013c00: 5333 4e6f 7441 4c69 6e6b 4572 726f 720a  S3NotALinkError.
-00013c10: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-00013c20: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-00013c30: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-00013c40: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-00013c50: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
-00013c60: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
-00013c70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00013c80: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
-00013c90: 6966 206e 6f74 206b 6579 206f 7220 6b65  if not key or ke
-00013ca0: 792e 656e 6473 7769 7468 2827 2f27 293a  y.endswith('/'):
-00013cb0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00013cc0: 7572 6e20 4661 6c73 650a 2020 2020 2020  urn False.      
-00013cd0: 2020 6d65 7461 6461 7461 203d 2073 656c    metadata = sel
-00013ce0: 662e 5f73 335f 6765 745f 6d65 7461 6461  f._s3_get_metada
-00013cf0: 7461 2829 0a20 2020 2020 2020 2072 6574  ta().        ret
-00013d00: 7572 6e20 2773 796d 6c69 6e6b 5f74 6f27  urn 'symlink_to'
-00013d10: 2069 6e20 6d65 7461 6461 7461 0a0a 2020   in metadata..  
-00013d20: 2020 6465 6620 7361 7665 2873 656c 662c    def save(self,
-00013d30: 2066 696c 655f 6f62 6a65 6374 3a20 4269   file_object: Bi
-00013d40: 6e61 7279 494f 293a 0a20 2020 2020 2020  naryIO):.       
-00013d50: 2027 2727 5772 6974 6520 7468 6520 6f70   '''Write the op
-00013d60: 656e 6564 2062 696e 6172 7920 7374 7265  ened binary stre
-00013d70: 616d 2074 6f20 7370 6563 6966 6965 6420  am to specified 
-00013d80: 7061 7468 2c20 6275 7420 7468 6520 7374  path, but the st
-00013d90: 7265 616d 2077 6f6e 2774 2062 6520 636c  ream won't be cl
-00013da0: 6f73 6564 0a0a 2020 2020 2020 2020 3a70  osed..        :p
-00013db0: 6172 616d 2066 696c 655f 6f62 6a65 6374  aram file_object
-00013dc0: 3a20 5374 7265 616d 2074 6f20 6265 2072  : Stream to be r
-00013dd0: 6561 640a 2020 2020 2020 2020 2727 270a  ead.        '''.
-00013de0: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
-00013df0: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
-00013e00: 726c 2873 656c 662e 7061 7468 5f77 6974  rl(self.path_wit
-00013e10: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
-00013e20: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
-00013e30: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
-00013e40: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
-00013e50: 466f 756e 6445 7272 6f72 280a 2020 2020  FoundError(.    
-00013e60: 2020 2020 2020 2020 2020 2020 2745 6d70              'Emp
-00013e70: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
-00013e80: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
-00013e90: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
-00013ea0: 2020 2020 2020 2069 6620 6e6f 7420 6b65         if not ke
-00013eb0: 7920 6f72 206b 6579 2e65 6e64 7377 6974  y or key.endswit
-00013ec0: 6828 272f 2729 3a0a 2020 2020 2020 2020  h('/'):.        
-00013ed0: 2020 2020 7261 6973 6520 5333 4973 4144      raise S3IsAD
-00013ee0: 6972 6563 746f 7279 4572 726f 7228 0a20  irectoryError(. 
-00013ef0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00013f00: 4973 2061 2064 6972 6563 746f 7279 3a20  Is a directory: 
-00013f10: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
-00013f20: 7769 7468 5f70 726f 746f 636f 6c29 0a0a  with_protocol)..
-00013f30: 2020 2020 2020 2020 7769 7468 2072 6169          with rai
-00013f40: 7365 5f73 335f 6572 726f 7228 7365 6c66  se_s3_error(self
-00013f50: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-00013f60: 636f 6c29 3a0a 2020 2020 2020 2020 2020  col):.          
-00013f70: 2020 7365 6c66 2e5f 636c 6965 6e74 2e75    self._client.u
-00013f80: 706c 6f61 645f 6669 6c65 6f62 6a28 6669  pload_fileobj(fi
-00013f90: 6c65 5f6f 626a 6563 742c 2042 7563 6b65  le_object, Bucke
-00013fa0: 743d 6275 636b 6574 2c20 4b65 793d 6b65  t=bucket, Key=ke
-00013fb0: 7929 0a0a 2020 2020 6465 6620 6f70 656e  y)..    def open
-00013fc0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-00013fd0: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
-00013fe0: 6d6f 6465 3a20 7374 7220 3d20 2772 272c  mode: str = 'r',
-00013ff0: 0a20 2020 2020 2020 2020 2020 202a 2c0a  .            *,.
-00014000: 2020 2020 2020 2020 2020 2020 7333 5f6f              s3_o
-00014010: 7065 6e5f 6675 6e63 3a20 4361 6c6c 6162  pen_func: Callab
-00014020: 6c65 5b5b 7374 722c 2073 7472 5d2c 2042  le[[str, str], B
-00014030: 696e 6172 7949 4f5d 203d 2073 335f 6f70  inaryIO] = s3_op
-00014040: 656e 2c0a 2020 2020 2020 2020 2020 2020  en,.            
-00014050: 2a2a 6b77 6172 6773 2920 2d3e 2049 4f5b  **kwargs) -> IO[
-00014060: 416e 7953 7472 5d3a 2020 2320 7079 7479  AnyStr]:  # pyty
-00014070: 7065 3a20 6469 7361 626c 653d 7369 676e  pe: disable=sign
-00014080: 6174 7572 652d 6d69 736d 6174 6368 0a20  ature-mismatch. 
-00014090: 2020 2020 2020 2072 6574 7572 6e20 7333         return s3
-000140a0: 5f6f 7065 6e5f 6675 6e63 280a 2020 2020  _open_func(.    
-000140b0: 2020 2020 2020 2020 7365 6c66 2e70 6174          self.pat
-000140c0: 685f 7769 7468 5f70 726f 746f 636f 6c2c  h_with_protocol,
-000140d0: 206d 6f64 652c 0a20 2020 2020 2020 2020   mode,.         
-000140e0: 2020 202a 2a6e 6563 6573 7361 7279 5f70     **necessary_p
-000140f0: 6172 616d 7328 7333 5f6f 7065 6e5f 6675  arams(s3_open_fu
-00014100: 6e63 2c20 2a2a 6b77 6172 6773 2929 0a0a  nc, **kwargs))..
-00014110: 2020 2020 6465 6620 6162 736f 6c75 7465      def absolute
-00014120: 2873 656c 6629 202d 3e20 2753 3350 6174  (self) -> 'S3Pat
-00014130: 6827 3a0a 2020 2020 2020 2020 2727 270a  h':.        '''.
-00014140: 2020 2020 2020 2020 4d61 6b65 2074 6865          Make the
-00014150: 2070 6174 6820 6162 736f 6c75 7465 2c20   path absolute, 
-00014160: 7769 7468 6f75 7420 6e6f 726d 616c 697a  without normaliz
-00014170: 6174 696f 6e20 6f72 2072 6573 6f6c 7669  ation or resolvi
-00014180: 6e67 2073 796d 6c69 6e6b 732e 2052 6574  ng symlinks. Ret
-00014190: 7572 6e73 2061 206e 6577 2070 6174 6820  urns a new path 
-000141a0: 6f62 6a65 6374 0a20 2020 2020 2020 2027  object.        '
-000141b0: 2727 0a20 2020 2020 2020 2072 6574 7572  ''.        retur
-000141c0: 6e20 7365 6c66 0a0a 2020 2020 6465 6620  n self..    def 
-000141d0: 6377 6428 7365 6c66 2920 2d3e 2027 5333  cwd(self) -> 'S3
-000141e0: 5061 7468 273a 0a20 2020 2020 2020 2027  Path':.        '
-000141f0: 2727 5265 7475 726e 2063 7572 7265 6e74  ''Return current
-00014200: 2077 6f72 6b69 6e67 2064 6972 6563 746f   working directo
-00014210: 7279 0a0a 2020 2020 2020 2020 7265 7475  ry..        retu
-00014220: 726e 733a 2043 7572 7265 6e74 2077 6f72  rns: Current wor
-00014230: 6b69 6e67 2064 6972 6563 746f 7279 0a20  king directory. 
-00014240: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-00014250: 2020 2072 6574 7572 6e20 7365 6c66 2e66     return self.f
-00014260: 726f 6d5f 7061 7468 2873 656c 662e 7061  rom_path(self.pa
-00014270: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00014280: 290a 0a0a 636c 6173 7320 4d75 6c74 6950  )...class MultiP
-00014290: 6172 7457 7269 7465 723a 0a0a 2020 2020  artWriter:..    
-000142a0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-000142b0: 662c 2063 6c69 656e 742c 2070 6174 683a  f, client, path:
-000142c0: 2050 6174 684c 696b 6529 202d 3e20 4e6f   PathLike) -> No
-000142d0: 6e65 3a0a 2020 2020 2020 2020 7365 6c66  ne:.        self
-000142e0: 2e5f 636c 6965 6e74 203d 2063 6c69 656e  ._client = clien
-000142f0: 740a 2020 2020 2020 2020 7365 6c66 2e5f  t.        self._
-00014300: 6d75 6c74 6970 6172 745f 7570 6c6f 6164  multipart_upload
-00014310: 5f69 6e66 6f20 3d20 5b5d 0a0a 2020 2020  _info = []..    
-00014320: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-00014330: 3d20 7061 7273 655f 7333 5f75 726c 2870  = parse_s3_url(p
-00014340: 6174 6829 0a20 2020 2020 2020 2073 656c  ath).        sel
-00014350: 662e 5f62 7563 6b65 7420 3d20 6275 636b  f._bucket = buck
-00014360: 6574 0a20 2020 2020 2020 2073 656c 662e  et.        self.
-00014370: 5f6b 6579 203d 206b 6579 0a20 2020 2020  _key = key.     
-00014380: 2020 2073 656c 662e 5f75 706c 6f61 645f     self._upload_
-00014390: 6964 203d 2073 656c 662e 5f63 6c69 656e  id = self._clien
-000143a0: 742e 6372 6561 7465 5f6d 756c 7469 7061  t.create_multipa
-000143b0: 7274 5f75 706c 6f61 6428 0a20 2020 2020  rt_upload(.     
-000143c0: 2020 2020 2020 2042 7563 6b65 743d 7365         Bucket=se
-000143d0: 6c66 2e5f 6275 636b 6574 2c20 4b65 793d  lf._bucket, Key=
-000143e0: 7365 6c66 2e5f 6b65 7929 5b27 5570 6c6f  self._key)['Uplo
-000143f0: 6164 4964 275d 0a0a 2020 2020 6465 6620  adId']..    def 
-00014400: 7570 6c6f 6164 5f70 6172 7428 7365 6c66  upload_part(self
-00014410: 2c20 7061 7274 5f6e 756d 3a20 696e 742c  , part_num: int,
-00014420: 2066 696c 655f 6f62 6a3a 2069 6f2e 4279   file_obj: io.By
-00014430: 7465 7349 4f29 202d 3e20 4e6f 6e65 3a0a  tesIO) -> None:.
-00014440: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-00014450: 203d 2073 656c 662e 5f63 6c69 656e 742e   = self._client.
-00014460: 7570 6c6f 6164 5f70 6172 7428 0a20 2020  upload_part(.   
-00014470: 2020 2020 2020 2020 2042 6f64 793d 6669           Body=fi
-00014480: 6c65 5f6f 626a 2c0a 2020 2020 2020 2020  le_obj,.        
-00014490: 2020 2020 5570 6c6f 6164 4964 3d73 656c      UploadId=sel
-000144a0: 662e 5f75 706c 6f61 645f 6964 2c0a 2020  f._upload_id,.  
-000144b0: 2020 2020 2020 2020 2020 5061 7274 4e75            PartNu
-000144c0: 6d62 6572 3d70 6172 745f 6e75 6d2c 0a20  mber=part_num,. 
-000144d0: 2020 2020 2020 2020 2020 2042 7563 6b65             Bucke
-000144e0: 743d 7365 6c66 2e5f 6275 636b 6574 2c0a  t=self._bucket,.
-000144f0: 2020 2020 2020 2020 2020 2020 4b65 793d              Key=
-00014500: 7365 6c66 2e5f 6b65 792c 0a20 2020 2020  self._key,.     
-00014510: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-00014520: 662e 5f6d 756c 7469 7061 7274 5f75 706c  f._multipart_upl
-00014530: 6f61 645f 696e 666f 2e61 7070 656e 6428  oad_info.append(
-00014540: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00014550: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00014560: 5061 7274 4e75 6d62 6572 273a 2070 6172  PartNumber': par
-00014570: 745f 6e75 6d2c 0a20 2020 2020 2020 2020  t_num,.         
-00014580: 2020 2020 2020 2027 4554 6167 273a 2072         'ETag': r
-00014590: 6573 706f 6e73 655b 2745 5461 6727 5d0a  esponse['ETag'].
-000145a0: 2020 2020 2020 2020 2020 2020 7d29 0a0a              })..
-000145b0: 2020 2020 6465 6620 7570 6c6f 6164 5f70      def upload_p
-000145c0: 6172 745f 6279 5f70 6174 6873 280a 2020  art_by_paths(.  
-000145d0: 2020 2020 2020 2020 2020 7365 6c66 2c20            self, 
-000145e0: 7061 7274 5f6e 756d 3a20 696e 742c 2070  part_num: int, p
-000145f0: 6174 6873 3a20 4c69 7374 5b54 7570 6c65  aths: List[Tuple
-00014600: 5b50 6174 684c 696b 652c 2073 7472 5d5d  [PathLike, str]]
-00014610: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00014620: 2020 2066 696c 655f 6f62 6a20 3d20 696f     file_obj = io
-00014630: 2e42 7974 6573 494f 2829 0a20 2020 2020  .BytesIO().     
-00014640: 2020 2066 6f72 2070 6174 682c 2062 7974     for path, byt
-00014650: 6573 5f72 616e 6765 2069 6e20 7061 7468  es_range in path
-00014660: 733a 0a20 2020 2020 2020 2020 2020 2062  s:.            b
-00014670: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-00014680: 7365 5f73 335f 7572 6c28 7061 7468 290a  se_s3_url(path).
-00014690: 2020 2020 2020 2020 2020 2020 6966 2062              if b
-000146a0: 7974 6573 5f72 616e 6765 3a0a 2020 2020  ytes_range:.    
-000146b0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-000146c0: 5f6f 626a 2e77 7269 7465 280a 2020 2020  _obj.write(.    
-000146d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146e0: 7365 6c66 2e5f 636c 6965 6e74 2e67 6574  self._client.get
-000146f0: 5f6f 626a 6563 7428 0a20 2020 2020 2020  _object(.       
-00014700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014710: 2042 7563 6b65 743d 6275 636b 6574 2c20   Bucket=bucket, 
-00014720: 4b65 793d 6b65 792c 0a20 2020 2020 2020  Key=key,.       
-00014730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014740: 2052 616e 6765 3d62 7974 6573 5f72 616e   Range=bytes_ran
-00014750: 6765 295b 2742 6f64 7927 5d2e 7265 6164  ge)['Body'].read
-00014760: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-00014770: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00014780: 2020 2020 2020 6669 6c65 5f6f 626a 2e77        file_obj.w
-00014790: 7269 7465 280a 2020 2020 2020 2020 2020  rite(.          
-000147a0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-000147b0: 636c 6965 6e74 2e67 6574 5f6f 626a 6563  client.get_objec
-000147c0: 7428 4275 636b 6574 3d62 7563 6b65 742c  t(Bucket=bucket,
-000147d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000147e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147f0: 2020 2020 2020 2020 2020 2020 204b 6579               Key
-00014800: 3d6b 6579 295b 2742 6f64 7927 5d2e 7265  =key)['Body'].re
-00014810: 6164 2829 290a 2020 2020 2020 2020 6669  ad()).        fi
-00014820: 6c65 5f6f 626a 2e73 6565 6b28 302c 206f  le_obj.seek(0, o
-00014830: 732e 5345 454b 5f53 4554 290a 2020 2020  s.SEEK_SET).    
-00014840: 2020 2020 7365 6c66 2e75 706c 6f61 645f      self.upload_
-00014850: 7061 7274 2870 6172 745f 6e75 6d2c 2066  part(part_num, f
-00014860: 696c 655f 6f62 6a29 0a0a 2020 2020 6465  ile_obj)..    de
-00014870: 6620 7570 6c6f 6164 5f70 6172 745f 636f  f upload_part_co
-00014880: 7079 280a 2020 2020 2020 2020 2020 2020  py(.            
-00014890: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
-000148a0: 2020 7061 7274 5f6e 756d 3a20 696e 742c    part_num: int,
-000148b0: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
-000148c0: 683a 2050 6174 684c 696b 652c 0a20 2020  h: PathLike,.   
-000148d0: 2020 2020 2020 2020 2063 6f70 795f 736f           copy_so
-000148e0: 7572 6365 5f72 616e 6765 3a20 4f70 7469  urce_range: Opti
-000148f0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-00014900: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00014910: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
-00014920: 2070 6172 7365 5f73 335f 7572 6c28 7061   parse_s3_url(pa
-00014930: 7468 290a 2020 2020 2020 2020 7061 7261  th).        para
-00014940: 6d73 203d 2064 6963 7428 0a20 2020 2020  ms = dict(.     
-00014950: 2020 2020 2020 2055 706c 6f61 6449 643d         UploadId=
-00014960: 7365 6c66 2e5f 7570 6c6f 6164 5f69 642c  self._upload_id,
-00014970: 0a20 2020 2020 2020 2020 2020 2050 6172  .            Par
-00014980: 744e 756d 6265 723d 7061 7274 5f6e 756d  tNumber=part_num
-00014990: 2c0a 2020 2020 2020 2020 2020 2020 436f  ,.            Co
-000149a0: 7079 536f 7572 6365 3d7b 0a20 2020 2020  pySource={.     
-000149b0: 2020 2020 2020 2020 2020 2027 4275 636b             'Buck
-000149c0: 6574 273a 2062 7563 6b65 742c 0a20 2020  et': bucket,.   
-000149d0: 2020 2020 2020 2020 2020 2020 2027 4b65               'Ke
-000149e0: 7927 3a20 6b65 790a 2020 2020 2020 2020  y': key.        
-000149f0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-00014a00: 2020 2042 7563 6b65 743d 7365 6c66 2e5f     Bucket=self._
-00014a10: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
-00014a20: 2020 2020 4b65 793d 7365 6c66 2e5f 6b65      Key=self._ke
-00014a30: 792c 0a20 2020 2020 2020 2029 0a20 2020  y,.        ).   
-00014a40: 2020 2020 2069 6620 636f 7079 5f73 6f75       if copy_sou
-00014a50: 7263 655f 7261 6e67 653a 0a20 2020 2020  rce_range:.     
-00014a60: 2020 2020 2020 2070 6172 616d 735b 2743         params['C
-00014a70: 6f70 7953 6f75 7263 6552 616e 6765 275d  opySourceRange']
-00014a80: 203d 2063 6f70 795f 736f 7572 6365 5f72   = copy_source_r
-00014a90: 616e 6765 0a20 2020 2020 2020 2072 6573  ange.        res
-00014aa0: 706f 6e73 6520 3d20 7365 6c66 2e5f 636c  ponse = self._cl
-00014ab0: 6965 6e74 2e75 706c 6f61 645f 7061 7274  ient.upload_part
-00014ac0: 5f63 6f70 7928 2a2a 7061 7261 6d73 290a  _copy(**params).
-00014ad0: 2020 2020 2020 2020 7365 6c66 2e5f 6d75          self._mu
-00014ae0: 6c74 6970 6172 745f 7570 6c6f 6164 5f69  ltipart_upload_i
-00014af0: 6e66 6f2e 6170 7065 6e64 280a 2020 2020  nfo.append(.    
-00014b00: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00014b10: 2020 2020 2020 2020 2020 2750 6172 744e            'PartN
-00014b20: 756d 6265 7227 3a20 7061 7274 5f6e 756d  umber': part_num
-00014b30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014b40: 2020 2745 5461 6727 3a20 7265 7370 6f6e    'ETag': respon
-00014b50: 7365 5b27 436f 7079 5061 7274 5265 7375  se['CopyPartResu
-00014b60: 6c74 275d 5b27 4554 6167 275d 0a20 2020  lt']['ETag'].   
-00014b70: 2020 2020 2020 2020 207d 290a 0a20 2020           })..   
-00014b80: 2064 6566 2063 6c6f 7365 2873 656c 6629   def close(self)
-00014b90: 3a0a 2020 2020 2020 2020 7365 6c66 2e5f  :.        self._
-00014ba0: 6d75 6c74 6970 6172 745f 7570 6c6f 6164  multipart_upload
-00014bb0: 5f69 6e66 6f2e 736f 7274 286b 6579 3d6c  _info.sort(key=l
-00014bc0: 616d 6264 6120 743a 2074 5b27 5061 7274  ambda t: t['Part
-00014bd0: 4e75 6d62 6572 275d 290a 2020 2020 2020  Number']).      
-00014be0: 2020 7365 6c66 2e5f 636c 6965 6e74 2e63    self._client.c
-00014bf0: 6f6d 706c 6574 655f 6d75 6c74 6970 6172  omplete_multipar
-00014c00: 745f 7570 6c6f 6164 280a 2020 2020 2020  t_upload(.      
-00014c10: 2020 2020 2020 5570 6c6f 6164 4964 3d73        UploadId=s
-00014c20: 656c 662e 5f75 706c 6f61 645f 6964 2c0a  elf._upload_id,.
-00014c30: 2020 2020 2020 2020 2020 2020 4275 636b              Buck
-00014c40: 6574 3d73 656c 662e 5f62 7563 6b65 742c  et=self._bucket,
-00014c50: 0a20 2020 2020 2020 2020 2020 204b 6579  .            Key
-00014c60: 3d73 656c 662e 5f6b 6579 2c0a 2020 2020  =self._key,.    
-00014c70: 2020 2020 2020 2020 4d75 6c74 6970 6172          Multipar
-00014c80: 7455 706c 6f61 643d 7b27 5061 7274 7327  tUpload={'Parts'
-00014c90: 3a20 7365 6c66 2e5f 6d75 6c74 6970 6172  : self._multipar
-00014ca0: 745f 7570 6c6f 6164 5f69 6e66 6f7d 290a  t_upload_info}).
-00014cb0: 0a20 2020 2064 6566 205f 5f65 6e74 6572  .    def __enter
-00014cc0: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
-00014cd0: 2020 7265 7475 726e 2073 656c 660a 0a20    return self.. 
-00014ce0: 2020 2064 6566 205f 5f65 7869 745f 5f28     def __exit__(
-00014cf0: 7365 6c66 2c20 6578 635f 7479 7065 2c20  self, exc_type, 
-00014d00: 6578 635f 7661 6c2c 2065 7863 5f74 6229  exc_val, exc_tb)
-00014d10: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
-00014d20: 6c6f 7365 2829 0a                        lose().
+00013080: 2062 7563 6b65 743a 2025 7227 2025 2073   bucket: %r' % s
+00013090: 7263 5f75 726c 290a 2020 2020 2020 2020  rc_url).        
+000130a0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+000130b0: 6e63 6528 6572 726f 722c 2053 3346 696c  nce(error, S3Fil
+000130c0: 654e 6f74 466f 756e 6445 7272 6f72 293a  eNotFoundError):
+000130d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000130e0: 2069 6620 6e6f 7420 7365 6c66 2e69 735f   if not self.is_
+000130f0: 6669 6c65 2829 3a0a 2020 2020 2020 2020  file():.        
+00013100: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00013110: 6520 5333 4669 6c65 4e6f 7446 6f75 6e64  e S3FileNotFound
+00013120: 4572 726f 7228 274e 6f20 7375 6368 2066  Error('No such f
+00013130: 696c 653a 2025 7227 2025 2073 7263 5f75  ile: %r' % src_u
+00013140: 726c 290a 2020 2020 2020 2020 2020 2020  rl).            
+00013150: 7261 6973 6520 6572 726f 720a 0a20 2020  raise error..   
+00013160: 2064 6566 2073 796e 6328 7365 6c66 2c20   def sync(self, 
+00013170: 6473 745f 7572 6c3a 2050 6174 684c 696b  dst_url: PathLik
+00013180: 652c 2066 6f6c 6c6f 776c 696e 6b73 3a20  e, followlinks: 
+00013190: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
+000131a0: 204e 6f6e 653a 0a20 2020 2020 2020 2027   None:.        '
+000131b0: 2727 0a20 2020 2020 2020 2043 6f70 7920  ''.        Copy 
+000131c0: 6669 6c65 2f64 6972 6563 746f 7279 206f  file/directory o
+000131d0: 6e20 7372 635f 7572 6c20 746f 2064 7374  n src_url to dst
+000131e0: 5f75 726c 0a0a 2020 2020 2020 2020 3a70  _url..        :p
+000131f0: 6172 616d 2064 7374 5f75 726c 3a20 4769  aram dst_url: Gi
+00013200: 7665 6e20 6465 7374 696e 6174 696f 6e20  ven destination 
+00013210: 7061 7468 0a20 2020 2020 2020 2027 2727  path.        '''
+00013220: 0a20 2020 2020 2020 2066 6f72 2073 7263  .        for src
+00013230: 5f66 696c 655f 7061 7468 2c20 6473 745f  _file_path, dst_
+00013240: 6669 6c65 5f70 6174 6820 696e 205f 7333  file_path in _s3
+00013250: 5f73 6361 6e5f 7061 6972 7328 0a20 2020  _scan_pairs(.   
+00013260: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00013270: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+00013280: 6f63 6f6c 2c20 6473 745f 7572 6c29 3a0a  ocol, dst_url):.
+00013290: 2020 2020 2020 2020 2020 2020 7372 635f              src_
+000132a0: 6669 6c65 5f70 6174 6820 3d20 7365 6c66  file_path = self
+000132b0: 2e66 726f 6d5f 7061 7468 2873 7263 5f66  .from_path(src_f
+000132c0: 696c 655f 7061 7468 290a 2020 2020 2020  ile_path).      
+000132d0: 2020 2020 2020 6473 745f 6669 6c65 5f70        dst_file_p
+000132e0: 6174 6820 3d20 7365 6c66 2e66 726f 6d5f  ath = self.from_
+000132f0: 7061 7468 2864 7374 5f66 696c 655f 7061  path(dst_file_pa
+00013300: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+00013310: 6966 2064 7374 5f66 696c 655f 7061 7468  if dst_file_path
+00013320: 2e65 7869 7374 7328 2920 616e 6420 6973  .exists() and is
+00013330: 5f73 616d 655f 6669 6c65 280a 2020 2020  _same_file(.    
+00013340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013350: 7372 635f 6669 6c65 5f70 6174 682e 7374  src_file_path.st
+00013360: 6174 2829 2c20 6473 745f 6669 6c65 5f70  at(), dst_file_p
+00013370: 6174 682e 7374 6174 2829 2c20 2763 6f70  ath.stat(), 'cop
+00013380: 7927 293a 0a20 2020 2020 2020 2020 2020  y'):.           
+00013390: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+000133a0: 2020 2020 2020 2020 2020 7372 635f 6669            src_fi
+000133b0: 6c65 5f70 6174 682e 636f 7079 2864 7374  le_path.copy(dst
+000133c0: 5f66 696c 655f 7061 7468 2c20 666f 6c6c  _file_path, foll
+000133d0: 6f77 6c69 6e6b 733d 666f 6c6c 6f77 6c69  owlinks=followli
+000133e0: 6e6b 7329 0a0a 2020 2020 6465 6620 7379  nks)..    def sy
+000133f0: 6d6c 696e 6b28 7365 6c66 2c20 6473 745f  mlink(self, dst_
+00013400: 7061 7468 3a20 5061 7468 4c69 6b65 2920  path: PathLike) 
+00013410: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00013420: 2027 2727 0a20 2020 2020 2020 2043 7265   '''.        Cre
+00013430: 6174 6520 6120 7379 6d62 6f6c 6963 206c  ate a symbolic l
+00013440: 696e 6b20 706f 696e 7469 6e67 2074 6f20  ink pointing to 
+00013450: 7372 635f 7061 7468 206e 616d 6564 2064  src_path named d
+00013460: 7374 5f70 6174 682e 0a0a 2020 2020 2020  st_path...      
+00013470: 2020 3a70 6172 616d 2064 7374 5f70 6174    :param dst_pat
+00013480: 683a 2044 6573 696e 6174 696f 6e20 7061  h: Desination pa
+00013490: 7468 0a20 2020 2020 2020 203a 7261 6973  th.        :rais
+000134a0: 6573 3a20 5333 4e61 6d65 546f 6f4c 6f6e  es: S3NameTooLon
+000134b0: 6745 7272 6f72 2c20 5333 4275 636b 6574  gError, S3Bucket
+000134c0: 4e6f 7446 6f75 6e64 4572 726f 722c 2053  NotFoundError, S
+000134d0: 3349 7341 4469 7265 6374 6f72 7945 7272  3IsADirectoryErr
+000134e0: 6f72 0a20 2020 2020 2020 2027 2727 0a20  or.        '''. 
+000134f0: 2020 2020 2020 2069 6620 6c65 6e28 7374         if len(st
+00013500: 7228 7365 6c66 2e5f 7333 5f70 6174 6829  r(self._s3_path)
+00013510: 2e65 6e63 6f64 6528 2929 203e 2031 3032  .encode()) > 102
+00013520: 343a 0a20 2020 2020 2020 2020 2020 2072  4:.            r
+00013530: 6169 7365 2053 334e 616d 6554 6f6f 4c6f  aise S3NameTooLo
+00013540: 6e67 4572 726f 7228 2746 696c 6520 6e61  ngError('File na
+00013550: 6d65 2074 6f6f 206c 6f6e 673a 2025 7227  me too long: %r'
+00013560: 2025 2064 7374 5f70 6174 6829 0a20 2020   % dst_path).   
+00013570: 2020 2020 2073 7263 5f62 7563 6b65 742c       src_bucket,
+00013580: 2073 7263 5f6b 6579 203d 2070 6172 7365   src_key = parse
+00013590: 5f73 335f 7572 6c28 7365 6c66 2e70 6174  _s3_url(self.pat
+000135a0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+000135b0: 0a20 2020 2020 2020 2064 7374 5f62 7563  .        dst_buc
+000135c0: 6b65 742c 2064 7374 5f6b 6579 203d 2070  ket, dst_key = p
+000135d0: 6172 7365 5f73 335f 7572 6c28 6473 745f  arse_s3_url(dst_
+000135e0: 7061 7468 290a 0a20 2020 2020 2020 2069  path)..        i
+000135f0: 6620 6e6f 7420 7372 635f 6275 636b 6574  f not src_bucket
+00013600: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00013610: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
+00013620: 6f75 6e64 4572 726f 7228 2745 6d70 7479  oundError('Empty
+00013630: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
+00013640: 2720 2520 7365 6c66 2e70 6174 6829 0a20  ' % self.path). 
+00013650: 2020 2020 2020 2069 6620 6e6f 7420 6473         if not ds
+00013660: 745f 6275 636b 6574 3a0a 2020 2020 2020  t_bucket:.      
+00013670: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
+00013680: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+00013690: 7228 2745 6d70 7479 2062 7563 6b65 7420  r('Empty bucket 
+000136a0: 6e61 6d65 3a20 2572 2720 2520 6473 745f  name: %r' % dst_
+000136b0: 7061 7468 290a 2020 2020 2020 2020 6966  path).        if
+000136c0: 206e 6f74 2064 7374 5f6b 6579 206f 7220   not dst_key or 
+000136d0: 6473 745f 6b65 792e 656e 6473 7769 7468  dst_key.endswith
+000136e0: 2827 2f27 293a 0a20 2020 2020 2020 2020  ('/'):.         
+000136f0: 2020 2072 6169 7365 2053 3349 7341 4469     raise S3IsADi
+00013700: 7265 6374 6f72 7945 7272 6f72 2827 4973  rectoryError('Is
+00013710: 2061 2064 6972 6563 746f 7279 3a20 2572   a directory: %r
+00013720: 2720 2520 6473 745f 7061 7468 290a 0a20  ' % dst_path).. 
+00013730: 2020 2020 2020 2073 7263 5f70 6174 6820         src_path 
+00013740: 3d20 7365 6c66 2e5f 7333 5f70 6174 680a  = self._s3_path.
+00013750: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00013760: 2020 2020 2020 2020 2073 7263 5f70 6174           src_pat
+00013770: 6820 3d20 7365 6c66 2e72 6561 646c 696e  h = self.readlin
+00013780: 6b28 292e 5f73 335f 7061 7468 0a20 2020  k()._s3_path.   
+00013790: 2020 2020 2065 7863 6570 7420 5333 4e6f       except S3No
+000137a0: 7441 4c69 6e6b 4572 726f 723a 0a20 2020  tALinkError:.   
+000137b0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+000137c0: 2020 2020 2020 7769 7468 2072 6169 7365        with raise
+000137d0: 5f73 335f 6572 726f 7228 6473 745f 7061  _s3_error(dst_pa
+000137e0: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
+000137f0: 2073 656c 662e 5f63 6c69 656e 742e 7075   self._client.pu
+00013800: 745f 6f62 6a65 6374 280a 2020 2020 2020  t_object(.      
+00013810: 2020 2020 2020 2020 2020 4275 636b 6574            Bucket
+00013820: 3d64 7374 5f62 7563 6b65 742c 0a20 2020  =dst_bucket,.   
+00013830: 2020 2020 2020 2020 2020 2020 204b 6579               Key
+00013840: 3d64 7374 5f6b 6579 2c0a 2020 2020 2020  =dst_key,.      
+00013850: 2020 2020 2020 2020 2020 4d65 7461 6461            Metada
+00013860: 7461 3d7b 2273 796d 6c69 6e6b 5f74 6f22  ta={"symlink_to"
+00013870: 3a20 7372 635f 7061 7468 7d29 0a0a 2020  : src_path})..  
+00013880: 2020 6465 6620 7265 6164 6c69 6e6b 2873    def readlink(s
+00013890: 656c 6629 202d 3e20 2753 3350 6174 6827  elf) -> 'S3Path'
+000138a0: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
+000138b0: 2020 2020 2020 5265 7475 726e 2061 2053        Return a S
+000138c0: 3350 6174 6820 696e 7374 616e 6365 2072  3Path instance r
+000138d0: 6570 7265 7365 6e74 696e 6720 7468 6520  epresenting the 
+000138e0: 7061 7468 2074 6f20 7768 6963 6820 7468  path to which th
+000138f0: 6520 7379 6d62 6f6c 6963 206c 696e 6b20  e symbolic link 
+00013900: 706f 696e 7473 2e0a 0a20 2020 2020 2020  points...       
+00013910: 203a 7265 7475 726e 733a 2052 6574 7572   :returns: Retur
+00013920: 6e20 6120 5333 5061 7468 2069 6e73 7461  n a S3Path insta
+00013930: 6e63 6520 7265 7072 6573 656e 7469 6e67  nce representing
+00013940: 2074 6865 2070 6174 6820 746f 2077 6869   the path to whi
+00013950: 6368 2074 6865 2073 796d 626f 6c69 6320  ch the symbolic 
+00013960: 6c69 6e6b 2070 6f69 6e74 732e 0a20 2020  link points..   
+00013970: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
+00013980: 4e61 6d65 546f 6f4c 6f6e 6745 7272 6f72  NameTooLongError
+00013990: 2c20 5333 4275 636b 6574 4e6f 7446 6f75  , S3BucketNotFou
+000139a0: 6e64 4572 726f 722c 2053 3349 7341 4469  ndError, S3IsADi
+000139b0: 7265 6374 6f72 7945 7272 6f72 2c20 5333  rectoryError, S3
+000139c0: 4e6f 7441 4c69 6e6b 4572 726f 720a 2020  NotALinkError.  
+000139d0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+000139e0: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
+000139f0: 7061 7273 655f 7333 5f75 726c 2873 656c  parse_s3_url(sel
+00013a00: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+00013a10: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
+00013a20: 206e 6f74 2062 7563 6b65 743a 0a20 2020   not bucket:.   
+00013a30: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+00013a40: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
+00013a50: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00013a60: 2020 2020 2020 2745 6d70 7479 2062 7563        'Empty buc
+00013a70: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
+00013a80: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+00013a90: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
+00013aa0: 2069 6620 6e6f 7420 6b65 7920 6f72 206b   if not key or k
+00013ab0: 6579 2e65 6e64 7377 6974 6828 272f 2729  ey.endswith('/')
+00013ac0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00013ad0: 6973 6520 5333 4973 4144 6972 6563 746f  ise S3IsADirecto
+00013ae0: 7279 4572 726f 7228 0a20 2020 2020 2020  ryError(.       
+00013af0: 2020 2020 2020 2020 2027 4973 2061 2064           'Is a d
+00013b00: 6972 6563 746f 7279 3a20 2572 2720 2520  irectory: %r' % 
+00013b10: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+00013b20: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
+00013b30: 206d 6574 6164 6174 6120 3d20 7365 6c66   metadata = self
+00013b40: 2e5f 7333 5f67 6574 5f6d 6574 6164 6174  ._s3_get_metadat
+00013b50: 6128 290a 0a20 2020 2020 2020 2069 6620  a()..        if 
+00013b60: 6e6f 7420 2773 796d 6c69 6e6b 5f74 6f27  not 'symlink_to'
+00013b70: 2069 6e20 6d65 7461 6461 7461 3a0a 2020   in metadata:.  
+00013b80: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00013b90: 5333 4e6f 7441 4c69 6e6b 4572 726f 7228  S3NotALinkError(
+00013ba0: 274e 6f74 2061 206c 696e 6b3a 2025 7227  'Not a link: %r'
+00013bb0: 2025 2073 656c 662e 7061 7468 5f77 6974   % self.path_wit
+00013bc0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+00013bd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00013be0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00013bf0: 662e 6672 6f6d 5f70 6174 6828 6d65 7461  f.from_path(meta
+00013c00: 6461 7461 5b27 7379 6d6c 696e 6b5f 746f  data['symlink_to
+00013c10: 275d 290a 0a20 2020 2064 6566 2069 735f  '])..    def is_
+00013c20: 7379 6d6c 696e 6b28 7365 6c66 2920 2d3e  symlink(self) ->
+00013c30: 2062 6f6f 6c3a 0a20 2020 2020 2020 2027   bool:.        '
+00013c40: 2727 0a20 2020 2020 2020 2054 6573 7420  ''.        Test 
+00013c50: 7768 6574 6865 7220 6120 7061 7468 2069  whether a path i
+00013c60: 7320 6c69 6e6b 0a0a 2020 2020 2020 2020  s link..        
+00013c70: 3a72 6574 7572 6e73 3a20 5472 7565 2069  :returns: True i
+00013c80: 6620 6120 7061 7468 2069 7320 6c69 6e6b  f a path is link
+00013c90: 2c20 656c 7365 2046 616c 7365 0a20 2020  , else False.   
+00013ca0: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
+00013cb0: 4e6f 7441 4c69 6e6b 4572 726f 720a 2020  NotALinkError.  
+00013cc0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+00013cd0: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
+00013ce0: 7061 7273 655f 7333 5f75 726c 2873 656c  parse_s3_url(sel
+00013cf0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+00013d00: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
+00013d10: 206e 6f74 2062 7563 6b65 743a 0a20 2020   not bucket:.   
+00013d20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00013d30: 4661 6c73 650a 2020 2020 2020 2020 6966  False.        if
+00013d40: 206e 6f74 206b 6579 206f 7220 6b65 792e   not key or key.
+00013d50: 656e 6473 7769 7468 2827 2f27 293a 0a20  endswith('/'):. 
+00013d60: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00013d70: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
+00013d80: 6d65 7461 6461 7461 203d 2073 656c 662e  metadata = self.
+00013d90: 5f73 335f 6765 745f 6d65 7461 6461 7461  _s3_get_metadata
+00013da0: 2829 0a20 2020 2020 2020 2072 6574 7572  ().        retur
+00013db0: 6e20 2773 796d 6c69 6e6b 5f74 6f27 2069  n 'symlink_to' i
+00013dc0: 6e20 6d65 7461 6461 7461 0a0a 2020 2020  n metadata..    
+00013dd0: 6465 6620 7361 7665 2873 656c 662c 2066  def save(self, f
+00013de0: 696c 655f 6f62 6a65 6374 3a20 4269 6e61  ile_object: Bina
+00013df0: 7279 494f 293a 0a20 2020 2020 2020 2027  ryIO):.        '
+00013e00: 2727 5772 6974 6520 7468 6520 6f70 656e  ''Write the open
+00013e10: 6564 2062 696e 6172 7920 7374 7265 616d  ed binary stream
+00013e20: 2074 6f20 7370 6563 6966 6965 6420 7061   to specified pa
+00013e30: 7468 2c20 6275 7420 7468 6520 7374 7265  th, but the stre
+00013e40: 616d 2077 6f6e 2774 2062 6520 636c 6f73  am won't be clos
+00013e50: 6564 0a0a 2020 2020 2020 2020 3a70 6172  ed..        :par
+00013e60: 616d 2066 696c 655f 6f62 6a65 6374 3a20  am file_object: 
+00013e70: 5374 7265 616d 2074 6f20 6265 2072 6561  Stream to be rea
+00013e80: 640a 2020 2020 2020 2020 2727 270a 2020  d.        '''.  
+00013e90: 2020 2020 2020 6275 636b 6574 2c20 6b65        bucket, ke
+00013ea0: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+00013eb0: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+00013ec0: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+00013ed0: 2020 6966 206e 6f74 2062 7563 6b65 743a    if not bucket:
+00013ee0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00013ef0: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
+00013f00: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
+00013f10: 2020 2020 2020 2020 2020 2745 6d70 7479            'Empty
+00013f20: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
+00013f30: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
+00013f40: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+00013f50: 2020 2020 2069 6620 6e6f 7420 6b65 7920       if not key 
+00013f60: 6f72 206b 6579 2e65 6e64 7377 6974 6828  or key.endswith(
+00013f70: 272f 2729 3a0a 2020 2020 2020 2020 2020  '/'):.          
+00013f80: 2020 7261 6973 6520 5333 4973 4144 6972    raise S3IsADir
+00013f90: 6563 746f 7279 4572 726f 7228 0a20 2020  ectoryError(.   
+00013fa0: 2020 2020 2020 2020 2020 2020 2027 4973               'Is
+00013fb0: 2061 2064 6972 6563 746f 7279 3a20 2572   a directory: %r
+00013fc0: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
+00013fd0: 7468 5f70 726f 746f 636f 6c29 0a0a 2020  th_protocol)..  
+00013fe0: 2020 2020 2020 7769 7468 2072 6169 7365        with raise
+00013ff0: 5f73 335f 6572 726f 7228 7365 6c66 2e70  _s3_error(self.p
+00014000: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00014010: 6c29 3a0a 2020 2020 2020 2020 2020 2020  l):.            
+00014020: 7365 6c66 2e5f 636c 6965 6e74 2e75 706c  self._client.upl
+00014030: 6f61 645f 6669 6c65 6f62 6a28 6669 6c65  oad_fileobj(file
+00014040: 5f6f 626a 6563 742c 2042 7563 6b65 743d  _object, Bucket=
+00014050: 6275 636b 6574 2c20 4b65 793d 6b65 7929  bucket, Key=key)
+00014060: 0a0a 2020 2020 6465 6620 6f70 656e 280a  ..    def open(.
+00014070: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00014080: 2c0a 2020 2020 2020 2020 2020 2020 6d6f  ,.            mo
+00014090: 6465 3a20 7374 7220 3d20 2772 272c 0a20  de: str = 'r',. 
+000140a0: 2020 2020 2020 2020 2020 202a 2c0a 2020             *,.  
+000140b0: 2020 2020 2020 2020 2020 656e 636f 6469            encodi
+000140c0: 6e67 3a20 4f70 7469 6f6e 616c 5b73 7472  ng: Optional[str
+000140d0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+000140e0: 2020 2020 2020 6572 726f 7273 3a20 4f70        errors: Op
+000140f0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+00014100: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00014110: 7333 5f6f 7065 6e5f 6675 6e63 3a20 4361  s3_open_func: Ca
+00014120: 6c6c 6162 6c65 5b5b 7374 722c 2073 7472  llable[[str, str
+00014130: 5d2c 2042 696e 6172 7949 4f5d 203d 2073  ], BinaryIO] = s
+00014140: 335f 6f70 656e 2c0a 2020 2020 2020 2020  3_open,.        
+00014150: 2020 2020 2a2a 6b77 6172 6773 2920 2d3e      **kwargs) ->
+00014160: 2049 4f5b 416e 7953 7472 5d3a 2020 2320   IO[AnyStr]:  # 
+00014170: 7079 7479 7065 3a20 6469 7361 626c 653d  pytype: disable=
+00014180: 7369 676e 6174 7572 652d 6d69 736d 6174  signature-mismat
+00014190: 6368 0a20 2020 2020 2020 2072 6574 7572  ch.        retur
+000141a0: 6e20 7333 5f6f 7065 6e5f 6675 6e63 2820  n s3_open_func( 
+000141b0: 2023 2070 7974 7970 653a 2064 6973 6162   # pytype: disab
+000141c0: 6c65 3d77 726f 6e67 2d6b 6579 776f 7264  le=wrong-keyword
+000141d0: 2d61 7267 730a 2020 2020 2020 2020 2020  -args.          
+000141e0: 2020 7365 6c66 2e70 6174 685f 7769 7468    self.path_with
+000141f0: 5f70 726f 746f 636f 6c2c 0a20 2020 2020  _protocol,.     
+00014200: 2020 2020 2020 206d 6f64 652c 0a20 2020         mode,.   
+00014210: 2020 2020 2020 2020 2065 6e63 6f64 696e           encodin
+00014220: 673d 656e 636f 6469 6e67 2c0a 2020 2020  g=encoding,.    
+00014230: 2020 2020 2020 2020 6572 726f 7273 3d65          errors=e
+00014240: 7272 6f72 732c 0a20 2020 2020 2020 2020  rrors,.         
+00014250: 2020 202a 2a6e 6563 6573 7361 7279 5f70     **necessary_p
+00014260: 6172 616d 7328 7333 5f6f 7065 6e5f 6675  arams(s3_open_fu
+00014270: 6e63 2c20 2a2a 6b77 6172 6773 2929 0a0a  nc, **kwargs))..
+00014280: 2020 2020 6465 6620 6162 736f 6c75 7465      def absolute
+00014290: 2873 656c 6629 202d 3e20 2753 3350 6174  (self) -> 'S3Pat
+000142a0: 6827 3a0a 2020 2020 2020 2020 2727 270a  h':.        '''.
+000142b0: 2020 2020 2020 2020 4d61 6b65 2074 6865          Make the
+000142c0: 2070 6174 6820 6162 736f 6c75 7465 2c20   path absolute, 
+000142d0: 7769 7468 6f75 7420 6e6f 726d 616c 697a  without normaliz
+000142e0: 6174 696f 6e20 6f72 2072 6573 6f6c 7669  ation or resolvi
+000142f0: 6e67 2073 796d 6c69 6e6b 732e 2052 6574  ng symlinks. Ret
+00014300: 7572 6e73 2061 206e 6577 2070 6174 6820  urns a new path 
+00014310: 6f62 6a65 6374 0a20 2020 2020 2020 2027  object.        '
+00014320: 2727 0a20 2020 2020 2020 2072 6574 7572  ''.        retur
+00014330: 6e20 7365 6c66 0a0a 2020 2020 6465 6620  n self..    def 
+00014340: 6377 6428 7365 6c66 2920 2d3e 2027 5333  cwd(self) -> 'S3
+00014350: 5061 7468 273a 0a20 2020 2020 2020 2027  Path':.        '
+00014360: 2727 5265 7475 726e 2063 7572 7265 6e74  ''Return current
+00014370: 2077 6f72 6b69 6e67 2064 6972 6563 746f   working directo
+00014380: 7279 0a0a 2020 2020 2020 2020 7265 7475  ry..        retu
+00014390: 726e 733a 2043 7572 7265 6e74 2077 6f72  rns: Current wor
+000143a0: 6b69 6e67 2064 6972 6563 746f 7279 0a20  king directory. 
+000143b0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+000143c0: 2020 2072 6574 7572 6e20 7365 6c66 2e66     return self.f
+000143d0: 726f 6d5f 7061 7468 2873 656c 662e 7061  rom_path(self.pa
+000143e0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+000143f0: 290a 0a0a 636c 6173 7320 4d75 6c74 6950  )...class MultiP
+00014400: 6172 7457 7269 7465 723a 0a0a 2020 2020  artWriter:..    
+00014410: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00014420: 662c 2063 6c69 656e 742c 2070 6174 683a  f, client, path:
+00014430: 2050 6174 684c 696b 6529 202d 3e20 4e6f   PathLike) -> No
+00014440: 6e65 3a0a 2020 2020 2020 2020 7365 6c66  ne:.        self
+00014450: 2e5f 636c 6965 6e74 203d 2063 6c69 656e  ._client = clien
+00014460: 740a 2020 2020 2020 2020 7365 6c66 2e5f  t.        self._
+00014470: 6d75 6c74 6970 6172 745f 7570 6c6f 6164  multipart_upload
+00014480: 5f69 6e66 6f20 3d20 5b5d 0a0a 2020 2020  _info = []..    
+00014490: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
+000144a0: 3d20 7061 7273 655f 7333 5f75 726c 2870  = parse_s3_url(p
+000144b0: 6174 6829 0a20 2020 2020 2020 2073 656c  ath).        sel
+000144c0: 662e 5f62 7563 6b65 7420 3d20 6275 636b  f._bucket = buck
+000144d0: 6574 0a20 2020 2020 2020 2073 656c 662e  et.        self.
+000144e0: 5f6b 6579 203d 206b 6579 0a20 2020 2020  _key = key.     
+000144f0: 2020 2073 656c 662e 5f75 706c 6f61 645f     self._upload_
+00014500: 6964 203d 2073 656c 662e 5f63 6c69 656e  id = self._clien
+00014510: 742e 6372 6561 7465 5f6d 756c 7469 7061  t.create_multipa
+00014520: 7274 5f75 706c 6f61 6428 0a20 2020 2020  rt_upload(.     
+00014530: 2020 2020 2020 2042 7563 6b65 743d 7365         Bucket=se
+00014540: 6c66 2e5f 6275 636b 6574 2c20 4b65 793d  lf._bucket, Key=
+00014550: 7365 6c66 2e5f 6b65 7929 5b27 5570 6c6f  self._key)['Uplo
+00014560: 6164 4964 275d 0a0a 2020 2020 6465 6620  adId']..    def 
+00014570: 7570 6c6f 6164 5f70 6172 7428 7365 6c66  upload_part(self
+00014580: 2c20 7061 7274 5f6e 756d 3a20 696e 742c  , part_num: int,
+00014590: 2066 696c 655f 6f62 6a3a 2069 6f2e 4279   file_obj: io.By
+000145a0: 7465 7349 4f29 202d 3e20 4e6f 6e65 3a0a  tesIO) -> None:.
+000145b0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+000145c0: 203d 2073 656c 662e 5f63 6c69 656e 742e   = self._client.
+000145d0: 7570 6c6f 6164 5f70 6172 7428 0a20 2020  upload_part(.   
+000145e0: 2020 2020 2020 2020 2042 6f64 793d 6669           Body=fi
+000145f0: 6c65 5f6f 626a 2c0a 2020 2020 2020 2020  le_obj,.        
+00014600: 2020 2020 5570 6c6f 6164 4964 3d73 656c      UploadId=sel
+00014610: 662e 5f75 706c 6f61 645f 6964 2c0a 2020  f._upload_id,.  
+00014620: 2020 2020 2020 2020 2020 5061 7274 4e75            PartNu
+00014630: 6d62 6572 3d70 6172 745f 6e75 6d2c 0a20  mber=part_num,. 
+00014640: 2020 2020 2020 2020 2020 2042 7563 6b65             Bucke
+00014650: 743d 7365 6c66 2e5f 6275 636b 6574 2c0a  t=self._bucket,.
+00014660: 2020 2020 2020 2020 2020 2020 4b65 793d              Key=
+00014670: 7365 6c66 2e5f 6b65 792c 0a20 2020 2020  self._key,.     
+00014680: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+00014690: 662e 5f6d 756c 7469 7061 7274 5f75 706c  f._multipart_upl
+000146a0: 6f61 645f 696e 666f 2e61 7070 656e 6428  oad_info.append(
+000146b0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000146c0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000146d0: 5061 7274 4e75 6d62 6572 273a 2070 6172  PartNumber': par
+000146e0: 745f 6e75 6d2c 0a20 2020 2020 2020 2020  t_num,.         
+000146f0: 2020 2020 2020 2027 4554 6167 273a 2072         'ETag': r
+00014700: 6573 706f 6e73 655b 2745 5461 6727 5d0a  esponse['ETag'].
+00014710: 2020 2020 2020 2020 2020 2020 7d29 0a0a              })..
+00014720: 2020 2020 6465 6620 7570 6c6f 6164 5f70      def upload_p
+00014730: 6172 745f 6279 5f70 6174 6873 280a 2020  art_by_paths(.  
+00014740: 2020 2020 2020 2020 2020 7365 6c66 2c20            self, 
+00014750: 7061 7274 5f6e 756d 3a20 696e 742c 2070  part_num: int, p
+00014760: 6174 6873 3a20 4c69 7374 5b54 7570 6c65  aths: List[Tuple
+00014770: 5b50 6174 684c 696b 652c 2073 7472 5d5d  [PathLike, str]]
+00014780: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00014790: 2020 2066 696c 655f 6f62 6a20 3d20 696f     file_obj = io
+000147a0: 2e42 7974 6573 494f 2829 0a20 2020 2020  .BytesIO().     
+000147b0: 2020 2066 6f72 2070 6174 682c 2062 7974     for path, byt
+000147c0: 6573 5f72 616e 6765 2069 6e20 7061 7468  es_range in path
+000147d0: 733a 0a20 2020 2020 2020 2020 2020 2062  s:.            b
+000147e0: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+000147f0: 7365 5f73 335f 7572 6c28 7061 7468 290a  se_s3_url(path).
+00014800: 2020 2020 2020 2020 2020 2020 6966 2062              if b
+00014810: 7974 6573 5f72 616e 6765 3a0a 2020 2020  ytes_range:.    
+00014820: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+00014830: 5f6f 626a 2e77 7269 7465 280a 2020 2020  _obj.write(.    
+00014840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014850: 7365 6c66 2e5f 636c 6965 6e74 2e67 6574  self._client.get
+00014860: 5f6f 626a 6563 7428 0a20 2020 2020 2020  _object(.       
+00014870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014880: 2042 7563 6b65 743d 6275 636b 6574 2c20   Bucket=bucket, 
+00014890: 4b65 793d 6b65 792c 0a20 2020 2020 2020  Key=key,.       
+000148a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148b0: 2052 616e 6765 3d62 7974 6573 5f72 616e   Range=bytes_ran
+000148c0: 6765 295b 2742 6f64 7927 5d2e 7265 6164  ge)['Body'].read
+000148d0: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+000148e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000148f0: 2020 2020 2020 6669 6c65 5f6f 626a 2e77        file_obj.w
+00014900: 7269 7465 280a 2020 2020 2020 2020 2020  rite(.          
+00014910: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00014920: 636c 6965 6e74 2e67 6574 5f6f 626a 6563  client.get_objec
+00014930: 7428 4275 636b 6574 3d62 7563 6b65 742c  t(Bucket=bucket,
+00014940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014960: 2020 2020 2020 2020 2020 2020 204b 6579               Key
+00014970: 3d6b 6579 295b 2742 6f64 7927 5d2e 7265  =key)['Body'].re
+00014980: 6164 2829 290a 2020 2020 2020 2020 6669  ad()).        fi
+00014990: 6c65 5f6f 626a 2e73 6565 6b28 302c 206f  le_obj.seek(0, o
+000149a0: 732e 5345 454b 5f53 4554 290a 2020 2020  s.SEEK_SET).    
+000149b0: 2020 2020 7365 6c66 2e75 706c 6f61 645f      self.upload_
+000149c0: 7061 7274 2870 6172 745f 6e75 6d2c 2066  part(part_num, f
+000149d0: 696c 655f 6f62 6a29 0a0a 2020 2020 6465  ile_obj)..    de
+000149e0: 6620 7570 6c6f 6164 5f70 6172 745f 636f  f upload_part_co
+000149f0: 7079 280a 2020 2020 2020 2020 2020 2020  py(.            
+00014a00: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
+00014a10: 2020 7061 7274 5f6e 756d 3a20 696e 742c    part_num: int,
+00014a20: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+00014a30: 683a 2050 6174 684c 696b 652c 0a20 2020  h: PathLike,.   
+00014a40: 2020 2020 2020 2020 2063 6f70 795f 736f           copy_so
+00014a50: 7572 6365 5f72 616e 6765 3a20 4f70 7469  urce_range: Opti
+00014a60: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00014a70: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00014a80: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
+00014a90: 2070 6172 7365 5f73 335f 7572 6c28 7061   parse_s3_url(pa
+00014aa0: 7468 290a 2020 2020 2020 2020 7061 7261  th).        para
+00014ab0: 6d73 203d 2064 6963 7428 0a20 2020 2020  ms = dict(.     
+00014ac0: 2020 2020 2020 2055 706c 6f61 6449 643d         UploadId=
+00014ad0: 7365 6c66 2e5f 7570 6c6f 6164 5f69 642c  self._upload_id,
+00014ae0: 0a20 2020 2020 2020 2020 2020 2050 6172  .            Par
+00014af0: 744e 756d 6265 723d 7061 7274 5f6e 756d  tNumber=part_num
+00014b00: 2c0a 2020 2020 2020 2020 2020 2020 436f  ,.            Co
+00014b10: 7079 536f 7572 6365 3d7b 0a20 2020 2020  pySource={.     
+00014b20: 2020 2020 2020 2020 2020 2027 4275 636b             'Buck
+00014b30: 6574 273a 2062 7563 6b65 742c 0a20 2020  et': bucket,.   
+00014b40: 2020 2020 2020 2020 2020 2020 2027 4b65               'Ke
+00014b50: 7927 3a20 6b65 790a 2020 2020 2020 2020  y': key.        
+00014b60: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+00014b70: 2020 2042 7563 6b65 743d 7365 6c66 2e5f     Bucket=self._
+00014b80: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
+00014b90: 2020 2020 4b65 793d 7365 6c66 2e5f 6b65      Key=self._ke
+00014ba0: 792c 0a20 2020 2020 2020 2029 0a20 2020  y,.        ).   
+00014bb0: 2020 2020 2069 6620 636f 7079 5f73 6f75       if copy_sou
+00014bc0: 7263 655f 7261 6e67 653a 0a20 2020 2020  rce_range:.     
+00014bd0: 2020 2020 2020 2070 6172 616d 735b 2743         params['C
+00014be0: 6f70 7953 6f75 7263 6552 616e 6765 275d  opySourceRange']
+00014bf0: 203d 2063 6f70 795f 736f 7572 6365 5f72   = copy_source_r
+00014c00: 616e 6765 0a20 2020 2020 2020 2072 6573  ange.        res
+00014c10: 706f 6e73 6520 3d20 7365 6c66 2e5f 636c  ponse = self._cl
+00014c20: 6965 6e74 2e75 706c 6f61 645f 7061 7274  ient.upload_part
+00014c30: 5f63 6f70 7928 2a2a 7061 7261 6d73 290a  _copy(**params).
+00014c40: 2020 2020 2020 2020 7365 6c66 2e5f 6d75          self._mu
+00014c50: 6c74 6970 6172 745f 7570 6c6f 6164 5f69  ltipart_upload_i
+00014c60: 6e66 6f2e 6170 7065 6e64 280a 2020 2020  nfo.append(.    
+00014c70: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00014c80: 2020 2020 2020 2020 2020 2750 6172 744e            'PartN
+00014c90: 756d 6265 7227 3a20 7061 7274 5f6e 756d  umber': part_num
+00014ca0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014cb0: 2020 2745 5461 6727 3a20 7265 7370 6f6e    'ETag': respon
+00014cc0: 7365 5b27 436f 7079 5061 7274 5265 7375  se['CopyPartResu
+00014cd0: 6c74 275d 5b27 4554 6167 275d 0a20 2020  lt']['ETag'].   
+00014ce0: 2020 2020 2020 2020 207d 290a 0a20 2020           })..   
+00014cf0: 2064 6566 2063 6c6f 7365 2873 656c 6629   def close(self)
+00014d00: 3a0a 2020 2020 2020 2020 7365 6c66 2e5f  :.        self._
+00014d10: 6d75 6c74 6970 6172 745f 7570 6c6f 6164  multipart_upload
+00014d20: 5f69 6e66 6f2e 736f 7274 286b 6579 3d6c  _info.sort(key=l
+00014d30: 616d 6264 6120 743a 2074 5b27 5061 7274  ambda t: t['Part
+00014d40: 4e75 6d62 6572 275d 290a 2020 2020 2020  Number']).      
+00014d50: 2020 7365 6c66 2e5f 636c 6965 6e74 2e63    self._client.c
+00014d60: 6f6d 706c 6574 655f 6d75 6c74 6970 6172  omplete_multipar
+00014d70: 745f 7570 6c6f 6164 280a 2020 2020 2020  t_upload(.      
+00014d80: 2020 2020 2020 5570 6c6f 6164 4964 3d73        UploadId=s
+00014d90: 656c 662e 5f75 706c 6f61 645f 6964 2c0a  elf._upload_id,.
+00014da0: 2020 2020 2020 2020 2020 2020 4275 636b              Buck
+00014db0: 6574 3d73 656c 662e 5f62 7563 6b65 742c  et=self._bucket,
+00014dc0: 0a20 2020 2020 2020 2020 2020 204b 6579  .            Key
+00014dd0: 3d73 656c 662e 5f6b 6579 2c0a 2020 2020  =self._key,.    
+00014de0: 2020 2020 2020 2020 4d75 6c74 6970 6172          Multipar
+00014df0: 7455 706c 6f61 643d 7b27 5061 7274 7327  tUpload={'Parts'
+00014e00: 3a20 7365 6c66 2e5f 6d75 6c74 6970 6172  : self._multipar
+00014e10: 745f 7570 6c6f 6164 5f69 6e66 6f7d 290a  t_upload_info}).
+00014e20: 0a20 2020 2064 6566 205f 5f65 6e74 6572  .    def __enter
+00014e30: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
+00014e40: 2020 7265 7475 726e 2073 656c 660a 0a20    return self.. 
+00014e50: 2020 2064 6566 205f 5f65 7869 745f 5f28     def __exit__(
+00014e60: 7365 6c66 2c20 6578 635f 7479 7065 2c20  self, exc_type, 
+00014e70: 6578 635f 7661 6c2c 2065 7863 5f74 6229  exc_val, exc_tb)
+00014e80: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
+00014e90: 6c6f 7365 2829 0a                        lose().
```

## megfile/sftp.py

```diff
@@ -327,16 +327,31 @@
 
     :param path: Given path
     :param file_object: stream to be read
     '''
     return SftpPath(path).save(file_object)
 
 
-def sftp_open(path: PathLike, mode: str = 'r', buffering=-1) -> IO[AnyStr]:  # pytype: disable=signature-mismatch
-    return SftpPath(path).open(mode, buffering)
+def sftp_open(
+        path: PathLike,
+        mode: str = 'r',
+        buffering=-1,
+        encoding: Optional[str] = None,
+        errors: Optional[str] = None,
+        **kwargs) -> IO[AnyStr]:  # pytype: disable=signature-mismatch
+    '''Open a file on the path.
+
+    :param path: Given path
+    :param mode: Mode to open file
+    :param buffering: buffering is an optional integer used to set the buffering policy.
+    :param encoding: encoding is the name of the encoding used to decode or encode the file. This should only be used in text mode.
+    :param errors: errors is an optional string that specifies how encoding and decoding errors are to be handled—this cannot be used in binary mode.
+    :returns: File-Like object
+    '''
+    return SftpPath(path).open(mode, buffering, encoding, errors)
 
 
 def sftp_chmod(path: PathLike, mode: int, follow_symlinks: bool = True):
     '''
     Change the file mode and permissions, like os.chmod().
 
     :param path: Given path
```

## megfile/sftp_path.py

```diff
@@ -1056,26 +1056,41 @@
         If parent directory of path doesn't exist, it will be created.
 
         :param file_object: stream to be read
         '''
         with self.open(mode='wb') as output:
             output.write(file_object.read())
 
-    def open(self, mode: str = 'r', buffering=-1, **kwargs) -> IO[AnyStr]:  # pytype: disable=signature-mismatch
+    def open(
+            self,
+            mode: str = 'r',
+            buffering=-1,
+            encoding: Optional[str] = None,
+            errors: Optional[str] = None,
+            **kwargs) -> IO[AnyStr]:  # pytype: disable=signature-mismatch
+        '''Open a file on the path.
+
+        :param mode: Mode to open file
+        :param buffering: buffering is an optional integer used to set the buffering policy.
+        :param encoding: encoding is the name of the encoding used to decode or encode the file. This should only be used in text mode.
+        :param errors: errors is an optional string that specifies how encoding and decoding errors are to be handled—this cannot be used in binary mode.
+        :returns: File-Like object
+        '''
         if 'w' in mode or 'x' in mode or 'a' in mode:
             if self.is_dir():
                 raise IsADirectoryError(
                     'Is a directory: %r' % self.path_with_protocol)
             self.parent.mkdir(parents=True, exist_ok=True)
         elif not self.exists():
             raise FileNotFoundError(
                 'No such file: %r' % self.path_with_protocol)
         fileobj = self._client.open(self._real_path, mode, bufsize=buffering)
         if 'r' in mode and 'b' not in mode:
-            return io.TextIOWrapper(fileobj)  # type: ignore
+            return io.TextIOWrapper(
+                fileobj, encoding=encoding, errors=errors)  # type: ignore
         return fileobj  # type: ignore
 
     def chmod(self, mode: int, follow_symlinks: bool = True):
         '''
         Change the file mode and permissions, like os.chmod().
 
         :param mode: the file mode you want to change
```

## megfile/smart.py

```diff
@@ -456,15 +456,15 @@
         followlinks: bool = False,
         map_func: Callable[[Callable, Iterable], Iterator] = map):
     src_path, dst_path = get_traditional_path(src_path), get_traditional_path(
         dst_path)
     file_stats = list(
         smart_scan_stat(src_path, missing_ok=False, followlinks=followlinks))
     tbar = tqdm(total=len(file_stats), ascii=True)
-    sbar = tqdm(unit='B', ascii=True, unit_scale=True)
+    sbar = tqdm(unit='B', ascii=True, unit_scale=True, unit_divisor=1024)
 
     def tqdm_callback(current_src_path, length: int):
         sbar.update(length)
         if callback:
             callback(current_src_path, length)
 
     def callback_after_copy_file(src_file_path, dst_file_path):
@@ -581,14 +581,16 @@
         >>> import numpy as np
         >>> raw = smart_open('https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=2275743969,3715493841&fm=26&gp=0.jpg').read()
         >>> img = cv2.imdecode(np.frombuffer(raw, np.uint8), cv2.IMREAD_ANYDEPTH | cv2.IMREAD_COLOR)
 
     :param path: Given path
     :param mode: Mode to open file, supports r'[rwa][tb]?\+?'
     :param s3_open_func: Function used to open s3_url. Require the function includes 2 necessary parameters, file path and mode
+    :param encoding: encoding is the name of the encoding used to decode or encode the file. This should only be used in text mode.
+    :param errors: errors is an optional string that specifies how encoding and decoding errors are to be handled—this cannot be used in binary mode.
     :returns: File-Like object
     :raises: FileNotFoundError, IsADirectoryError, ValueError
     '''
     options = {
         's3_open_func': s3_open_func,
         'encoding': encoding,
         'errors': errors,
```

### encoding

```diff
@@ -1 +1 @@
-us-ascii
+utf-8
```

## megfile/stdio.py

```diff
@@ -1,23 +1,28 @@
-from typing import IO, AnyStr
+from typing import IO, AnyStr, Optional
 
 from megfile.interfaces import PathLike
 from megfile.stdio_path import StdioPath, is_stdio
 
 __all__ = [
     'is_stdio',
     'stdio_open',
 ]
 
 
-def stdio_open(path: PathLike, mode: str) -> IO[AnyStr]:  # pytype: disable=signature-mismatch
+def stdio_open(
+        path: PathLike,
+        mode: str,
+        encoding: Optional[str] = None,
+        errors: Optional[str] = None,
+        **kwargs) -> IO[AnyStr]:  # pytype: disable=signature-mismatch
     '''Used to read or write stdio
 
     .. note ::
 
         Essentially invoke sys.stdin.buffer | sys.stdout.buffer to read or write
 
     :param path: Given path
     :param mode: Only supports 'rb' and 'wb' now
     :return: STDReader, STDWriter
     '''
-    return StdioPath(path).open(mode)
+    return StdioPath(path).open(mode, encoding, errors)
```

## megfile/stdio_path.py

```diff
@@ -1,9 +1,9 @@
 import io
-from typing import IO, AnyStr, Union
+from typing import IO, AnyStr, Optional, Union
 
 from megfile.interfaces import BaseURIPath, PathLike
 from megfile.lib.compat import fspath
 from megfile.lib.stdio_handler import STDReader, STDWriter
 from megfile.lib.url import get_url_scheme
 from megfile.smart_path import SmartPath
 from megfile.utils import get_binary_mode
@@ -68,24 +68,30 @@
             raise ValueError(
                 'cannot open for writing: %r' % self.path_with_protocol)
 
         if 'r' in mode:
             return STDReader(mode)
         return STDWriter(self.path_with_protocol, mode)
 
-    def open(self, mode: str, **kwargs) -> IO[AnyStr]:  # pytype: disable=signature-mismatch
+    def open(
+            self,
+            mode: str,
+            encoding: Optional[str] = None,
+            errors: Optional[str] = None,
+            **kwargs) -> IO[AnyStr]:  # pytype: disable=signature-mismatch
         '''Used to read or write stdio
 
         .. note ::
 
             Essentially invoke sys.stdin.buffer | sys.stdout.buffer to read or write
 
         :param mode: Only supports 'rb' and 'wb' now
         :return: STDReader, STDWriter
         '''
         fileobj = self._open(mode)
 
         if 'b' not in mode:
-            fileobj = io.TextIOWrapper(fileobj)  # type: ignore
+            fileobj = io.TextIOWrapper(
+                fileobj, encoding=encoding, errors=errors)  # type: ignore
             fileobj.mode = mode
 
         return fileobj  # type: ignore
```

## megfile/version.py

```diff
@@ -1 +1 @@
-VERSION = "2.2.0.post1"
+VERSION = "2.2.1"
```

## megfile/lib/s3_prefetch_reader.py

```diff
@@ -1,41 +1,28 @@
 import os
-from collections import OrderedDict
-from concurrent.futures import Future, ThreadPoolExecutor
+from concurrent.futures import Future
 from io import BytesIO
-from logging import getLogger as get_logger
-from math import ceil
-from statistics import mean
 from typing import Optional
 
 from megfile.errors import S3FileChangedError, S3InvalidRangeError, patch_method, raise_s3_error, s3_should_retry
-from megfile.interfaces import Readable, Seekable
-from megfile.utils import get_human_size, process_local
+from megfile.lib.base_prefetch_reader import BACKOFF_FACTOR, BACKOFF_INITIAL, DEFAULT_BLOCK_CAPACITY, DEFAULT_BLOCK_SIZE, GLOBAL_MAX_WORKERS, NEWLINE, BasePrefetchReader, LRUCacheFutureManager
 
-DEFAULT_BLOCK_SIZE = 8 * 2**20  # 8MB
-DEFAULT_BLOCK_CAPACITY = 16
-GLOBAL_MAX_WORKERS = 128
+__all__ = [
+    'DEFAULT_BLOCK_CAPACITY',
+    'DEFAULT_BLOCK_SIZE',
+    'GLOBAL_MAX_WORKERS',
+    'BACKOFF_INITIAL',
+    'BACKOFF_FACTOR',
+    'NEWLINE',
+    'S3PrefetchReader',
+    'LRUCacheFutureManager',
+]
 
-BACKOFF_INITIAL = 64 * 2**20  # 64MB
-BACKOFF_FACTOR = 4
 
-NEWLINE = ord('\n')
-
-_logger = get_logger(__name__)
-
-
-class SeekRecord:
-
-    def __init__(self, seek_index: int):
-        self.seek_index = seek_index
-        self.seek_count = 0
-        self.read_count = 0
-
-
-class S3PrefetchReader(Readable, Seekable):
+class S3PrefetchReader(BasePrefetchReader):
     '''
     Reader to fast read the s3 content. This will divide the file content into equal parts of block_size size, and will use LRU to cache at most block_capacity blocks in memory.
     open(), seek() and read() will trigger prefetch read. The prefetch will cached block_forward blocks of data from offset position (the position after reading if the called function is read).
     '''
 
     def __init__(
             self,
@@ -45,388 +32,75 @@
             s3_client,
             block_size: int = DEFAULT_BLOCK_SIZE,
             block_capacity: int = DEFAULT_BLOCK_CAPACITY,
             block_forward: Optional[int] = None,
             max_retries: int = 10,
             max_workers: Optional[int] = None):
 
-        block_forward = self._get_block_forward(block_capacity, block_forward)
-
-        assert block_capacity > block_forward, 'block_capacity should greater than block_forward, got: block_capacity=%s, block_forward=%s' % (
-            block_capacity, block_forward)
-
         self._bucket = bucket
         self._key = key
         self._client = s3_client
-        self._max_retries = max_retries
-        self._block_size = block_size
-        self._block_capacity = block_capacity  # Max number of blocks
-        self._block_forward = block_forward  # Number of blocks every prefetch, which should be smaller than block_capacity
 
+        super().__init__(
+            block_size=block_size,
+            block_capacity=block_capacity,
+            block_forward=block_forward,
+            max_retries=max_retries,
+            max_workers=max_workers)
+
+    def _get_content_size(self):
         try:
-            first_index_response = self._fetch_response(index=0)
-            self._content_size = int(
+            start, end = 0, self._block_size - 1
+            first_index_response = self._fetch_response(start=start, end=end)
+            content_size = int(
                 first_index_response['ContentRange'].split('/')[-1])
         except S3InvalidRangeError:
             # usually when read a empty file
             # TODO: use minio test empty file: https://hub.docker.com/r/minio/minio
-            first_index_response = self._fetch_response(index=None)
-            self._content_size = int(first_index_response['ContentLength'])
+            first_index_response = self._fetch_response()
+            content_size = int(first_index_response['ContentLength'])
 
         first_future = Future()
         first_future.set_result(BytesIO(first_index_response['Body'].read()))
-        self._futures = self._get_futures()
         self._insert_futures(index=0, future=first_future)
         self._content_etag = first_index_response['ETag']
         self._content_info = first_index_response
-
-        self._block_stop = ceil(self._content_size / block_size)
-
-        self.__offset = 0
-        self._backoff_size = BACKOFF_INITIAL
-        self._block_index = None  # Current block index
-        self._seek_history = []
-
-        self._is_global_executor = False
-        if max_workers is None:
-            self._executor = process_local(
-                'S3PrefetchReader.executor',
-                ThreadPoolExecutor,
-                max_workers=GLOBAL_MAX_WORKERS)
-            self._is_global_executor = True
-        else:
-            self._executor = ThreadPoolExecutor(max_workers=max_workers)
-        self._seek_buffer(0)
-
-        _logger.debug('open file: %r, mode: %s' % (self.name, self.mode))
-
-    def _get_block_forward(
-            self, block_capacity: int, block_forward: Optional[int]):
-        self._is_auto_scaling = block_forward is None
-        if block_forward is None:
-            block_forward = block_capacity - 1
-        return block_forward
-
-    def _get_futures(self):
-        return LRUCacheFutureManager()
+        return content_size
 
     @property
     def name(self) -> str:
         return 's3://%s/%s' % (self._bucket, self._key)
 
-    @property
-    def mode(self) -> str:
-        return 'rb'
-
-    def tell(self) -> int:
-        return self._offset
-
-    @property
-    def _offset(self) -> int:
-        return self.__offset
-
-    @_offset.setter
-    def _offset(self, value: int):
-        if value > self._backoff_size:
-            _logger.debug(
-                'reading file: %r, current offset / total size: %s / %s' % (
-                    self.name, get_human_size(value),
-                    get_human_size(self._content_size)))
-        while value > self._backoff_size:
-            self._backoff_size *= BACKOFF_FACTOR
-        self.__offset = value
-
-    def seek(self, cookie: int, whence: int = os.SEEK_SET) -> int:
-        '''Change stream position.
-
-        Seek to byte offset pos relative to position indicated by whence:
-
-            0  Start of stream (the default).  pos should be >= 0;
-            1  Current position - pos may be negative;
-            2  End of stream - pos usually negative.
-
-        Returns the new absolute position.
-        '''
-        if self.closed:
-            raise IOError('file already closed: %r' % self.name)
-
-        if whence == os.SEEK_CUR:
-            target_offset = self._offset + cookie
-        elif whence == os.SEEK_END:
-            target_offset = self._content_size + cookie
-        elif whence == os.SEEK_SET:
-            target_offset = cookie
-        else:
-            raise ValueError('invalid whence: %r' % whence)
-
-        if target_offset == self._offset:
-            return target_offset
-
-        self._offset = max(min(target_offset, self._content_size), 0)
-        block_index = self._offset // self._block_size
-        block_offset = self._offset % self._block_size
-        self._seek_buffer(block_index, block_offset)
-        return self._offset
-
-    def read(self, size: Optional[int] = None) -> bytes:
-        '''Read at most size bytes, returned as a bytes object.
-
-        If the size argument is negative, read until EOF is reached.
-        Return an empty bytes object at EOF.
-        '''
-        if self.closed:
-            raise IOError('file already closed: %r' % self.name)
-
-        if len(self._seek_history) > 0:
-            self._seek_history[-1].read_count += 1
-
-        if self._offset >= self._content_size:
-            return b''
-
-        if size is None:
-            size = self._content_size - self._offset
-        else:
-            assert size >= 0, 'size should greater than 0, got: %r' % size
-            size = min(size, self._content_size - self._offset)
-
-        if self._block_forward == 1:
-            block_index = self._offset // self._block_size
-            if len(self._seek_history) > 0:
-                mean_read_count = mean(
-                    item.read_count for item in self._seek_history)
-            else:
-                mean_read_count = 0
-            if block_index not in self._futures and mean_read_count < 3:
-                # No using LRP will be better if read() are always called less than 3 times after seek()
-                return self._read(size)
-
-        data = self._buffer.read(size)
-        if len(data) == size:
-            self._offset += len(data)
-            return data
-
-        buffer = BytesIO()
-        buffer.write(data)
-        while buffer.tell() < size:
-            remain_size = size - buffer.tell()
-            data = self._next_buffer.read(remain_size)
-            buffer.write(data)
-
-        self._offset += buffer.tell()
-        return buffer.getvalue()
-
-    def readline(self, size: Optional[int] = None) -> bytes:
-        '''Next line from the file, as a bytes object.
-
-        Retain newline.  A non-negative size argument limits the maximum
-        number of bytes to return (an incomplete line may be returned then).
-        Return an empty bytes object at EOF.
-        '''
-        if self.closed:
-            raise IOError('file already closed: %r' % self.name)
-
-        if len(self._seek_history) > 0:
-            self._seek_history[-1].read_count += 1
-
-        if self._offset >= self._content_size:
-            return b''
-
-        if size is None:
-            size = self._content_size - self._offset
-        else:
-            assert size >= 0, 'size should greater than 0, got: %r' % size
-            size = min(size, self._content_size - self._offset)
-
-        data = self._buffer.readline(size)
-        if len(data) == size or (len(data) > 0 and data[-1] == NEWLINE):
-            self._offset += len(data)
-            return data
-
-        buffer = BytesIO()
-        buffer.write(data)
-        while True:
-            remain_size = size - buffer.tell()
-            data = self._next_buffer.readline(remain_size)
-            buffer.write(data)
-            if buffer.tell() == size or data[-1] == NEWLINE:
-                break
-
-        self._offset += buffer.tell()
-        return buffer.getvalue()
-
-    def _read(self, size: int):
-        if size == 0 or self._offset >= self._content_size:
-            return b''
-
-        range_str = 'bytes=%d-%d' % (self._offset, self._offset + size - 1)
-        data = self._client.get_object(
-            Bucket=self._bucket, Key=self._key, Range=range_str)['Body'].read()
-        self.seek(size, os.SEEK_CUR)
-        return data
-
-    def readinto(self, buffer: bytearray) -> int:
-        '''Read bytes into buffer.
-
-        Returns number of bytes read (0 for EOF), or None if the object
-        is set not to block and has no data to read.
-        '''
-        if self.closed:
-            raise IOError('file already closed: %r' % self.name)
-
-        if self._offset >= self._content_size:
-            return 0
-
-        size = len(buffer)
-        size = min(size, self._content_size - self._offset)
-
-        data = self._buffer.read(size)
-        buffer[:len(data)] = data
-        if len(data) == size:
-            self._offset += len(data)
-            return size
-
-        offset = len(data)
-        while offset < size:
-            remain_size = size - offset
-            data = self._next_buffer.read(remain_size)
-            buffer[offset:offset + len(data)] = data
-            offset += len(data)
-
-        self._offset += offset
-        return size
-
-    @property
-    def _is_alive(self):
-        return not self._executor._shutdown  # pytype: disable=attribute-error
-
-    @property
-    def _is_downloading(self):
-        return not self._futures.finished
-
-    @property
-    def _cached_blocks(self):
-        return list(self._futures.keys())
-
-    @property
-    def _buffer(self) -> BytesIO:
-        if self._cached_offset is not None:
-            start = self._block_index
-            stop = min(start + self._block_forward, self._block_stop)
-
-            # reversed(range(start, stop))
-            for index in range(stop - 1, start - 1, -1):
-                self._submit_future(index)
-            self._cleanup_futures()
-
-            self._cached_buffer = self._fetch_future_result(self._block_index)
-            self._cached_buffer.seek(self._cached_offset)
-            self._cached_offset = None
-
-        return self._cached_buffer
-
-    @property
-    def _next_buffer(self) -> BytesIO:
-        # Get next buffer by this function when finished reading current buffer (self._buffer)
-        # Make sure that _buffer is used before using _next_buffer(), or will make _cached_offset invalid
-        self._block_index += 1
-        self._cached_offset = 0
-        return self._buffer
-
-    def _seek_buffer(self, index: int, offset: int = 0):
-        # The corresponding block is probably not downloaded when seeked to a new position
-        # So record the offset first, set it when it is accessed
-        if self._is_auto_scaling:  # When user doesn't define forward
-            history = []
-            for item in self._seek_history:
-                if item.seek_count > self._block_capacity * 2:
-                    # seek interval is bigger than self._block_capacity * 2, drop it from self._seek_history
-                    continue
-                if index - 1 < item.seek_index < index + 2:
-                    continue
-                item.seek_count += 1
-                history.append(item)
-            history.append(SeekRecord(index))
-            self._seek_history = history
-            self._block_forward = max(
-                (self._block_capacity - 1) // len(self._seek_history), 1)
-
-        self._cached_offset = offset
-        self._block_index = index
-
-    def _fetch_response(self, index: Optional[int] = None) -> dict:
+    def _fetch_response(
+            self, start: Optional[int] = None,
+            end: Optional[int] = None) -> dict:
 
         def fetch_response() -> dict:
-            if index is None:
+            if start is None or end is None:
                 return self._client.get_object(
                     Bucket=self._bucket, Key=self._key)
 
-            range_str = 'bytes=%d-%d' % (
-                index * self._block_size, (index + 1) * self._block_size - 1)
+            range_str = f'bytes={start}-{end}'
             response = self._client.get_object(
                 Bucket=self._bucket, Key=self._key, Range=range_str)
             response['Body'] = BytesIO(response['Body'].read())
             return response
 
         fetch_response = patch_method(
             fetch_response,
             max_retries=self._max_retries,
             should_retry=s3_should_retry)
 
         with raise_s3_error(self.name):
             return fetch_response()
 
     def _fetch_buffer(self, index: int) -> BytesIO:
-        response = self._fetch_response(index=index)
+        start, end = index * self._block_size, (
+            index + 1) * self._block_size - 1
+        response = self._fetch_response(start=start, end=end)
         etag = response.get('ETag', None)
-        if etag is not None and etag != self._content_etag:
+        if etag is not None and etag != self._content_etag:  # pytype: disable=attribute-error
             raise S3FileChangedError(
                 'File changed: %r, etag before: %s, after: %s' %
-                (self.name, self._content_info, response))
+                (self.name, self._content_info, response))  # pytype: disable=attribute-error
 
         return response['Body']
-
-    def _submit_future(self, index: int):
-        if index < 0 or index >= self._block_stop:
-            return
-        self._futures.submit(self._executor, index, self._fetch_buffer, index)
-
-    def _insert_futures(self, index: int, future: Future):
-        self._futures[index] = future
-
-    def _fetch_future_result(self, index: int):
-        return self._futures.result(index)
-
-    def _cleanup_futures(self):
-        self._futures.cleanup(self._block_capacity)
-
-    def _close(self):
-        _logger.debug('close file: %r' % self.name)
-
-        if not self._is_global_executor:
-            self._executor.shutdown()
-        self._futures.clear()  # clean memory
-
-
-class LRUCacheFutureManager(OrderedDict):
-
-    def __init__(self):
-        super().__init__()
-
-    def submit(self, executor, key, *args, **kwargs):
-        if key in self:
-            self.move_to_end(key, last=True)
-            return
-        self[key] = executor.submit(*args, **kwargs)
-
-    @property
-    def finished(self):
-        return all(future.done() for future in self.values())
-
-    def result(self, key):
-        self.move_to_end(key, last=True)
-        return self[key].result()
-
-    def cleanup(self, block_capacity: int):
-        while len(self) > block_capacity:
-            _, future = self.popitem(last=False)
-            if not future.done():
-                future.cancel()
```

## megfile/utils/__init__.py

```diff
@@ -157,18 +157,23 @@
 def binary_open(open_func):
     '''
     Decorator:
     Output according to user-setting mode while calling Open
     '''
 
     @wraps(open_func)
-    def wrapper(path, mode: str = 'rb', **kwargs):
+    def wrapper(
+            path,
+            mode: str = 'rb',
+            encoding: Optional[str] = None,
+            errors: Optional[str] = None,
+            **kwargs):
         fileobj = open_func(path, get_binary_mode(mode), **kwargs)
         if 'b' not in mode:
-            fileobj = TextIOWrapper(fileobj)
+            fileobj = TextIOWrapper(fileobj, encoding=encoding, errors=errors)
             fileobj.mode = mode
         return fileobj
 
     return wrapper
 
 
 def get_human_size(size_bytes: float) -> str:
```

## Comparing `megfile-2.2.0.post1.dist-info/LICENSE` & `megfile-2.2.1.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `megfile-2.2.0.post1.dist-info/LICENSE.pyre` & `megfile-2.2.1.dist-info/LICENSE.pyre`

 * *Files identical despite different names*

## Comparing `megfile-2.2.0.post1.dist-info/METADATA` & `megfile-2.2.1.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: megfile
-Version: 2.2.0.post1
+Version: 2.2.1
 Summary: Megvii file operation library
 Home-page: https://github.com/megvii-research/megfile
 Author: megvii
 Author-email: megfile@megvii.com
 Classifier: Development Status :: 4 - Beta
 Classifier: Environment :: Console
 Classifier: Intended Audience :: Developers
```

## Comparing `megfile-2.2.0.post1.dist-info/RECORD` & `megfile-2.2.1.dist-info/RECORD`

 * *Files 18% similar despite different names*

```diff
@@ -1,45 +1,47 @@
 megfile/__init__.py,sha256=Qsi3XNP_0XYoSol-1AGutZqo0rfBnzaiZ-HVXll4fB0,5721
-megfile/cli.py,sha256=E3NoSZ8D-k3OCRXPDysFkjeHRunZXw4QvqjP5QNsgUg,12806
+megfile/cli.py,sha256=MMhdYDiArEF5WkOX6B59NH5URPt5inz4WbO8Jb1kB2o,13045
 megfile/errors.py,sha256=y0PJ4lzkm-uqgVD1EqakmN0IHBMt1CCzDbdbq84sVb4,11491
 megfile/fs.py,sha256=sjkm_LsvNCw8hj9Ee-1HSNzvg7bRHTPem8KTDDBQlCw,11621
 megfile/fs_path.py,sha256=Lz-u8XL2RMViHl_39yapAwX5XSE_ZpQsuhAvVve6rk8,38532
-megfile/http.py,sha256=Juz95GscschvmElieLIWqO2A4BrqJnrtTWTa9uzNN_4,2477
-megfile/http_path.py,sha256=XtpbYHdtHZysjkz6Xdr4fe8E6hlsV4iLNoIZaBk-_P4,5360
+megfile/http.py,sha256=a3oAuARSSaIU8VMx86Mui0N5Vh-EI0AoHnwxRU5DSMU,2032
+megfile/http_path.py,sha256=pbIlle-scbKC88XO0uV9y3sIm0HME6E_R061VTBg8w8,8966
 megfile/interfaces.py,sha256=h3tWE8hVt5S-HopaMAX6lunPJ97vzhv6jH_2HubcDNc,6219
-megfile/pathlike.py,sha256=52e6POtMfUCC3Hb9XNwBLXM3Gkz3aGP8H8AagGKlDSg,29307
+megfile/pathlike.py,sha256=aU6j-Z3Sr6XH_REuJ37_vNv6XucEW6qpASWQyzGbL9g,29258
 megfile/s3.py,sha256=6d9bBVkVdXIvmJLfpOgJkK4nVAsLR3lirrB6x1-P2y8,12437
-megfile/s3_path.py,sha256=-odQ7rg38khf1Bc8webKBZewIfKIV5I1a-qsdshLLzA,85287
-megfile/sftp.py,sha256=qzfgI-MGzNsr7adUQaiVKS7zRHGuK-Hs6o45wNIAcww,11943
-megfile/sftp_path.py,sha256=lbestqN_FXwIJbqFeHXLkq306B2zqVILFda4peKOQwY,47288
-megfile/smart.py,sha256=xjRRujYAPzXlrYxV7ZCAPXl0biUNn4730ATKc_tzIzE,32694
+megfile/s3_path.py,sha256=TH0Qh5fG93PAGXVGk1IimVtyVSu5zePZj-QNhKZfKCI,85655
+megfile/sftp.py,sha256=h2cy_XnQQOlCtHskW7rSQKG1S7Uoq7uq7X_Pyt2V16M,12590
+megfile/sftp_path.py,sha256=ELxJVsbZoOhkZJVbk9gxcM_BReiDsYC5NTdhSpEe2rk,47982
+megfile/smart.py,sha256=ECQATItNyVKb9dOovLSO4yZ0cpnIf3DvsYTfkKv4owU,32997
 megfile/smart_path.py,sha256=Rwb1McXsshi9-F6miTRqE6j8FO2j1edjmSxZF32YZ6E,6708
-megfile/stdio.py,sha256=qmi1c7VTll6Y6ya9MCd-dSKffocX2GafA-YUncZRU1Y,559
-megfile/stdio_path.py,sha256=ULMzGOj7SBMn3c7fYVSDepT_1nEUiVetc-xRt2pR5o4,2682
-megfile/version.py,sha256=wEKo6RBa-JfaOX7tcmNU28H0l1ZzziU5CEqvjD8Y1AU,25
+megfile/stdio.py,sha256=28AAQ7YLBZ51nrQDtK2th5lWhDJO3sZFKdQYNXQ_eNM,700
+megfile/stdio_path.py,sha256=QqZ5XJw4VFdP2s14MP7ooe9TgYIZtdNtu5vny5cUW5Y,2866
+megfile/version.py,sha256=Kg2YCBcAkwDFdGKviiOW6YjdyEJsHw1wJCywqrpIriQ,19
 megfile/lib/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+megfile/lib/base_prefetch_reader.py,sha256=ezqTTx37D7i33p2-8eHoZjb54fc3el3O22Us4uMPh_0,13262
 megfile/lib/combine_reader.py,sha256=XFSqEY5A5X5Uf7eQ6AXAzrvNteESSXvKNVPktGjo3KY,4546
 megfile/lib/compare.py,sha256=yG2fZve_gMg32rQVCdwixBdqgYRsjn-24TqhALQaOrA,2233
 megfile/lib/compat.py,sha256=rYjfzQ3svuY7pB37W1JGyWH1kxd9aT4RtIe90npPtXI,3033
 megfile/lib/fnmatch.py,sha256=HgdlnEWBsdFUOZqnW_v1kj1jeH_9lMcCqW85pyMu4vM,4054
 megfile/lib/glob.py,sha256=7i9dIput9rI9JIPyTZX-JDmFS7IP_THlX1k-35foAfw,9732
+megfile/lib/http_prefetch_reader.py,sha256=WUstz4976cw1the-4QM0DmMsUTaaaRWf3tiG6vOJJtI,3116
 megfile/lib/joinpath.py,sha256=D4Px6-lnDDpYs1LMUHkTIGqMPJQ0oCBGfTzREs373iU,929
 megfile/lib/lazy_handler.py,sha256=f1rip2_T57vVo0WRNXve2bAa4LArvVheMfQg1S0vFzg,1915
 megfile/lib/s3_buffered_writer.py,sha256=AGjCNQ1X16kjFbEJouavkO6ykmlAtfVKBPAD-yYwAT0,6934
 megfile/lib/s3_cached_handler.py,sha256=e4KamTLMIPKa96yp7HGF05wDl2Yfoizz9pBrz-uAQ5w,1322
 megfile/lib/s3_limited_seekable_writer.py,sha256=NSBh5cZCCtwZM0DTwfPkpOA_h0NXd9-6qjasOby5zxc,6037
 megfile/lib/s3_memory_handler.py,sha256=jLBA5HVuI-UBPYMYN-B8iX_VGr8bC9brAqY-KbEGrtw,3725
 megfile/lib/s3_pipe_handler.py,sha256=38x8oPrxlXVWqMgDOqScPj0Pt2w2cQFSNoTK27EtBSw,3384
-megfile/lib/s3_prefetch_reader.py,sha256=uffgYsNy7sfiZdoZdY67LYiQiPagtohl4BeQ6jSTwEM,15113
+megfile/lib/s3_prefetch_reader.py,sha256=ck6N0kE_70oDorma6SRePjzoG2LYnZkB56RcPJsJXEg,4066
 megfile/lib/s3_share_cache_reader.py,sha256=QyZvzVpTswgiXv-E8QhV_jFdQjCBxVcgbgybXo6d1cM,3771
 megfile/lib/shadow_handler.py,sha256=IbFyTw107t-yWH0cGrDjAJX-CS3xeEr77_PTGsnSgk4,2683
 megfile/lib/stdio_handler.py,sha256=QDWtcZxz-hzi-rqQUiSlR3NrihX1fjK_Rj9T2mdTFEg,2044
 megfile/lib/url.py,sha256=VbQLjo0s4AaV0iSk66BcjI68aUTcN9zBZ5x6-cM4Qvs,103
-megfile/utils/__init__.py,sha256=DEVSwUQ1-1rkHBIuXBxgEYiepq8W25JIWYQrC1gcFrc,9005
+megfile/utils/__init__.py,sha256=qdX8FF_dYFKwp1BIWx3JeSGd91s7AKUDSEpDv9tORcM,9162
 megfile/utils/mutex.py,sha256=-2KH3bNovKRd9zvsXq9n3bWM7rQdoG9hO7tUPxVG_Po,2538
-megfile-2.2.0.post1.dist-info/LICENSE,sha256=WNHhf_5RCaeuKWyq_K39vmp9F28LxKsB4SpomwSZ2L0,11357
-megfile-2.2.0.post1.dist-info/LICENSE.pyre,sha256=9lf5nT-5ZH25JijpYAequ0bl8E8z5JmZB1qrjiUMp84,1080
-megfile-2.2.0.post1.dist-info/METADATA,sha256=WUowRbsO-dMPhEJYA1YQY0DNYRGc2jw6kdYRYQLnoBQ,10601
-megfile-2.2.0.post1.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-megfile-2.2.0.post1.dist-info/entry_points.txt,sha256=M6ZWSSv5_5_QtIpZafy3vq7WuOJ_5dSGQQnEZbByt2Q,49
-megfile-2.2.0.post1.dist-info/top_level.txt,sha256=i3rMgdU1ZAJekAceojhA-bkm3749PzshtRmLTbeLUPQ,8
-megfile-2.2.0.post1.dist-info/RECORD,,
+megfile-2.2.1.dist-info/LICENSE,sha256=WNHhf_5RCaeuKWyq_K39vmp9F28LxKsB4SpomwSZ2L0,11357
+megfile-2.2.1.dist-info/LICENSE.pyre,sha256=9lf5nT-5ZH25JijpYAequ0bl8E8z5JmZB1qrjiUMp84,1080
+megfile-2.2.1.dist-info/METADATA,sha256=8HFhG0SoAq6x-fmwrHcAdYxcG_o5m-iHzIdqQCkjPqI,10595
+megfile-2.2.1.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+megfile-2.2.1.dist-info/entry_points.txt,sha256=M6ZWSSv5_5_QtIpZafy3vq7WuOJ_5dSGQQnEZbByt2Q,49
+megfile-2.2.1.dist-info/top_level.txt,sha256=i3rMgdU1ZAJekAceojhA-bkm3749PzshtRmLTbeLUPQ,8
+megfile-2.2.1.dist-info/RECORD,,
```

